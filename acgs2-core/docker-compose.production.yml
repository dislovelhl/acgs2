# ACGS-2 Production Environment
# Constitutional Hash: cdd01ef066bc6cf2
#
# Production-ready docker-compose configuration with security hardening.
# DO NOT use in development - use docker-compose.dev.yml instead.
#
# Security Features:
# - Non-root user execution
# - Secret management via environment
# - Network isolation
# - Resource limits
# - Health checks
# - Logging configuration

version: '3.8'

networks:
  acgs-prod:
    driver: bridge
    internal: true  # No external access by default

services:
  # ============================================================================
  # INFRASTRUCTURE SERVICES
  # ============================================================================

  redis:
    image: redis:7.2-alpine
    hostname: redis
    command: >
      redis-server
      --appendonly yes
      --requirepass "${REDIS_PASSWORD}"
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --tcp-keepalive 300
      --timeout 300
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_prod_data:/data
    networks:
      - acgs-prod
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    hostname: kafka
    ports:
      - "${KAFKA_PORT:-9092}:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: INTERNAL:PLAINTEXT,EXTERNAL:SASL_SSL
      KAFKA_ADVERTISED_LISTENERS: INTERNAL://kafka:29092,EXTERNAL://localhost:${KAFKA_PORT:-9092}
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL
      # SASL Configuration
      KAFKA_SASL_ENABLED_MECHANISMS: PLAIN
      KAFKA_SASL_MECHANISM_INTER_BROKER_PROTOCOL: PLAIN
      KAFKA_LISTENER_NAME_EXTERNAL_PLAIN_SASL_JAAS_CONFIG: |
        org.apache.kafka.common.security.plain.PlainLoginModule required
        username="${KAFKA_SASL_USERNAME}"
        password="${KAFKA_SASL_PASSWORD}";
      # SSL Configuration
      KAFKA_SSL_KEYSTORE_LOCATION: /etc/kafka/secrets/kafka.keystore.jks
      KAFKA_SSL_KEYSTORE_PASSWORD: ${KAFKA_SSL_KEYSTORE_PASSWORD}
      KAFKA_SSL_KEY_PASSWORD: ${KAFKA_SSL_KEY_PASSWORD}
      KAFKA_SSL_TRUSTSTORE_LOCATION: /etc/kafka/secrets/kafka.truststore.jks
      KAFKA_SSL_TRUSTSTORE_PASSWORD: ${KAFKA_SSL_TRUSTSTORE_PASSWORD}
    depends_on:
      zookeeper:
        condition: service_healthy
    networks:
      - acgs-prod
    volumes:
      - kafka_prod_data:/var/lib/kafka/data
      - kafka_prod_logs:/var/lib/kafka/logs
      - kafka_prod_secrets:/etc/kafka/secrets
    healthcheck:
      test: ["CMD-SHELL", "kafka-broker-api-versions.sh --bootstrap-server localhost:9092"]
      interval: 30s
      timeout: 10s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.0'
        reservations:
          memory: 1G
          cpus: '0.5'

  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    hostname: zookeeper
    ports:
      - "${ZOOKEEPER_PORT:-2181}:2181"
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
      ZOOKEEPER_INIT_LIMIT: 5
      ZOOKEEPER_SYNC_LIMIT: 2
    networks:
      - acgs-prod
    volumes:
      - zookeeper_prod_data:/var/lib/zookeeper/data
      - zookeeper_prod_logs:/var/lib/zookeeper/logs
    healthcheck:
      test: ["CMD", "bash", "-c", "echo 'ruok' | nc localhost 2181"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================================
  # SECURITY & POLICY SERVICES
  # ============================================================================

  opa:
    image: openpolicyagent/opa:0.64.0
    ports:
      - "${OPA_PORT:-8181}:8181"
    command:
      - "run"
      - "--server"
      - "--log-level=info"
      - "--set=decision_logs.console=true"
      - "--set=authz.enable=true"
      - "/policies"
    volumes:
      - ./policies:/policies:ro
      - ./enhanced_agent_bus/policies:/enhanced_policies:ro
    networks:
      - acgs-prod
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8181/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  # ============================================================================
  # APPLICATION SERVICES
  # ============================================================================

  api-gateway:
    image: acgs2/api-gateway:${TAG:-latest}
    ports:
      - "${API_GATEWAY_PORT:-8080}:8080"
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
      - API_GATEWAY_PORT=${API_GATEWAY_PORT:-8080}
      - AGENT_BUS_URL=http://agent-bus:8000
      - TENANT_MANAGEMENT_URL=http://tenant-management:8500
      - AUDIT_SERVICE_URL=http://audit-service:8300
      - REDIS_URL=redis://redis:6379/0
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - KAFKA_BOOTSTRAP_SERVERS=kafka:29092
      - OPA_URL=http://opa:8181
      - JWT_SECRET=${JWT_SECRET}
      - API_KEY_INTERNAL=${API_KEY_INTERNAL}
      - CORS_ORIGINS=${CORS_ORIGINS:-https://yourdomain.com}
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT}
      - OTEL_SERVICE_NAME=api-gateway
      - PROMETHEUS_PUSHGATEWAY_URL=${PROMETHEUS_PUSHGATEWAY_URL}
    networks:
      - acgs-prod
    depends_on:
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
      opa:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      replicas: 3
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp

  agent-bus:
    image: acgs2/enhanced-agent-bus:${TAG:-latest}
    ports:
      - "${AGENT_BUS_PORT:-8000}:8000"
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
      - REDIS_URL=redis://redis:6379/0
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - KAFKA_BOOTSTRAP_SERVERS=kafka:29092
      - OPA_URL=http://opa:8181
      - JWT_SECRET=${JWT_SECRET}
      - CONSTITUTIONAL_HASH=cdd01ef066bc6cf2
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT}
      - OTEL_SERVICE_NAME=enhanced-agent-bus
      - PROMETHEUS_PUSHGATEWAY_URL=${PROMETHEUS_PUSHGATEWAY_URL}
    networks:
      - acgs-prod
    depends_on:
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
      opa:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'
    security_opt:
      - no-new-privileges:true

  audit-service:
    image: acgs2/audit-service:${TAG:-latest}
    ports:
      - "${AUDIT_SERVICE_PORT:-8300}:8084"
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
      - AUDIT_SERVICE_PORT=${AUDIT_SERVICE_PORT:-8300}
      - REDIS_URL=redis://redis:6379/0
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - KAFKA_BOOTSTRAP_SERVERS=kafka:29092
      - JWT_SECRET=${JWT_SECRET}
      - AUDIT_ENCRYPTION_KEY=${AUDIT_ENCRYPTION_KEY}
      - ETH_L2_NETWORK=${ETH_L2_NETWORK}
      - ETH_RPC_URL=${ETH_RPC_URL}
      - AUDIT_CONTRACT_ADDRESS=${AUDIT_CONTRACT_ADDRESS}
      - BLOCKCHAIN_PRIVATE_KEY=${BLOCKCHAIN_PRIVATE_KEY}
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT}
      - OTEL_SERVICE_NAME=audit-service
      - PROMETHEUS_PUSHGATEWAY_URL=${PROMETHEUS_PUSHGATEWAY_URL}
    networks:
      - acgs-prod
    depends_on:
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
    volumes:
      - audit_prod_logs:/app/audit_logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8084/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
        reservations:
          memory: 512M
          cpus: '0.25'
    security_opt:
      - no-new-privileges:true

  tenant-management:
    image: acgs2/tenant-management:${TAG:-latest}
    ports:
      - "${TENANT_MANAGEMENT_PORT:-8500}:8500"
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
      - TENANT_MANAGEMENT_PORT=${TENANT_MANAGEMENT_PORT:-8500}
      - REDIS_URL=redis://redis:6379/0
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - KAFKA_BOOTSTRAP_SERVERS=kafka:29092
      - JWT_SECRET=${JWT_SECRET}
      - DATABASE_URL=${DATABASE_URL}
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT}
      - OTEL_SERVICE_NAME=tenant-management
      - PROMETHEUS_PUSHGATEWAY_URL=${PROMETHEUS_PUSHGATEWAY_URL}
    networks:
      - acgs-prod
    depends_on:
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
      database:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8500/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'
    security_opt:
      - no-new-privileges:true

  hitl-approvals:
    image: acgs2/hitl-approvals:${TAG:-latest}
    ports:
      - "${HITL_APPROVALS_PORT:-8200}:8200"
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
      - HITL_APPROVALS_PORT=${HITL_APPROVALS_PORT:-8200}
      - REDIS_URL=redis://redis:6379/0
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
      - SLACK_BOT_TOKEN=${SLACK_BOT_TOKEN}
      - SLACK_SIGNING_SECRET=${SLACK_SIGNING_SECRET}
      - TEAMS_WEBHOOK_URL=${TEAMS_WEBHOOK_URL}
      - PAGERDUTY_INTEGRATION_KEY=${PAGERDUTY_INTEGRATION_KEY}
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT}
      - OTEL_SERVICE_NAME=hitl-approvals
      - PROMETHEUS_PUSHGATEWAY_URL=${PROMETHEUS_PUSHGATEWAY_URL}
    networks:
      - acgs-prod
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8200/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'
    security_opt:
      - no-new-privileges:true

  compliance-docs:
    image: acgs2/compliance-docs:${TAG:-latest}
    ports:
      - "${COMPLIANCE_DOCS_PORT:-8100}:8100"
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
      - COMPLIANCE_DOCS_PORT=${COMPLIANCE_DOCS_PORT:-8100}
      - AUDIT_SERVICE_URL=http://audit-service:8084
      - TENANT_MANAGEMENT_URL=http://tenant-management:8500
      - JWT_SECRET=${JWT_SECRET}
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT}
      - OTEL_SERVICE_NAME=compliance-docs
      - PROMETHEUS_PUSHGATEWAY_URL=${PROMETHEUS_PUSHGATEWAY_URL}
    networks:
      - acgs-prod
    depends_on:
      audit-service:
        condition: service_healthy
      tenant-management:
        condition: service_healthy
    volumes:
      - compliance_prod_documents:/app/documents
      - compliance_prod_templates:/app/templates
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8100/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
        reservations:
          memory: 512M
          cpus: '0.25'
    security_opt:
      - no-new-privileges:true

  # ============================================================================
  # MONITORING & LOGGING STACK
  # ============================================================================

  prometheus:
    image: prom/prometheus:latest
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_prod_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    networks:
      - acgs-prod
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3

  grafana:
    image: grafana/grafana:latest
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_INSTALL_PLUGINS=grafana-piechart-panel,grafana-worldmap-panel
    volumes:
      - grafana_prod_data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
    networks:
      - acgs-prod
    depends_on:
      - prometheus
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  loki:
    image: grafana/loki:latest
    ports:
      - "${LOKI_PORT:-3100}:3100"
    volumes:
      - ./monitoring/loki-config.yml:/etc/loki/local-config.yaml:ro
      - loki_prod_data:/loki
    command: -config.file=/etc/loki/local-config.yaml
    networks:
      - acgs-prod
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3100/ready"]
      interval: 30s
      timeout: 10s
      retries: 3

  promtail:
    image: grafana/promtail:latest
    volumes:
      - ./monitoring/promtail-config.yml:/etc/promtail/config.yml:ro
      - /var/log:/var/log:ro
    command: -config.file=/etc/promtail/config.yml
    networks:
      - acgs-prod
    depends_on:
      - loki

  # ============================================================================
  # DATABASE (Optional - uncomment if using PostgreSQL)
  # ============================================================================

  # database:
  #   image: postgres:15-alpine
  #   environment:
  #     POSTGRES_DB: acgs2
  #     POSTGRES_USER: acgs2
  #     POSTGRES_PASSWORD: ${DB_USER_PASSWORD}
  #   volumes:
  #     - database_prod_data:/var/lib/postgresql/data
  #   networks:
  #     - acgs-prod
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U acgs2"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #   deploy:
  #     resources:
  #       limits:
  #         memory: 2G
  #         cpus: '1.0'

volumes:
  redis_prod_data:
  kafka_prod_data:
  kafka_prod_logs:
  kafka_prod_secrets:
  zookeeper_prod_data:
  zookeeper_prod_logs:
  audit_prod_logs:
  compliance_prod_documents:
  compliance_prod_templates:
  prometheus_prod_data:
  grafana_prod_data:
  loki_prod_data:
  database_prod_data:
