pipeline {
    agent any

    environment {
        DOCKER_REGISTRY = 'your-registry.com'
        KUBECONFIG = credentials('kubeconfig')
        DOCKER_CREDENTIALS = credentials('docker-credentials')
    }

    parameters {
        choice(name: 'ENVIRONMENT', choices: ['dev', 'staging', 'prod'], description: '部署环境')
        booleanParam(name: 'RUN_TESTS', defaultValue: true, description: '是否运行测试')
        booleanParam(name: 'DEPLOY', defaultValue: true, description: '是否执行部署')
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build Rust Components') {
            steps {
                script {
                    // 编译Rust代码
                    dir('enhanced_agent_bus/rust') {
                        sh 'cargo build --release'
                    }
                }
            }
        }

        stage('Build Docker Images') {
            steps {
                script {
                    // 登录Docker registry
                    sh "echo \$DOCKER_CREDENTIALS_PSW | docker login -u \$DOCKER_CREDENTIALS_USR --password-stdin \$DOCKER_REGISTRY"

                    // 构建所有服务镜像
                    def services = [
                        'rust-message-bus': 'enhanced_agent_bus/rust',
                        'deliberation-layer': 'enhanced_agent_bus/deliberation_layer',
                        'constraint-generation': 'services/core/constraint_generation_system',
                        'vector-search': 'services/integration/search_platform',
                        'audit-ledger': 'services/audit_service',
                        'adaptive-governance': 'services/policy_registry'
                    ]

                    services.each { service, context ->
                        sh "docker build -t \$DOCKER_REGISTRY/acgs2/${service}:\${BUILD_NUMBER} ./${context}"
                        sh "docker push \$DOCKER_REGISTRY/acgs2/${service}:\${BUILD_NUMBER}"
                        sh "docker tag \$DOCKER_REGISTRY/acgs2/${service}:\${BUILD_NUMBER} \$DOCKER_REGISTRY/acgs2/${service}:latest-${params.ENVIRONMENT}"
                        sh "docker push \$DOCKER_REGISTRY/acgs2/${service}:latest-${params.ENVIRONMENT}"
                    }
                }
            }
        }

        stage('Code Quality Checks') {
            when {
                expression { params.RUN_TESTS }
            }
            steps {
                script {
                    // Import validation
                    sh 'python3 tools/import_cleanup.py --check .'

                    // Python code formatting and linting
                    sh 'pip install black isort flake8 pycln'
                    sh 'black --check --diff .'
                    sh 'isort --check-only --diff .'
                    sh 'flake8 --max-line-length=100 --ignore=E501,W503 .'
                }
            }
        }

        stage('Unit Tests') {
            when {
                expression { params.RUN_TESTS }
            }
            steps {
                script {
                    // Rust单元测试
                    dir('enhanced_agent_bus/rust') {
                        sh 'cargo test'
                    }

                    // Python单元测试 (假设使用pytest)
                    sh 'pip install -r requirements.txt'
                    sh 'python -m pytest tests/unit/ -v'
                }
            }
        }

        stage('Integration Tests') {
            when {
                expression { params.RUN_TESTS }
            }
            steps {
                script {
                    // 运行集成测试
                    sh 'python enhanced_agent_bus/deliberation_layer/test_deliberation.py'

                    // 其他集成测试
                    sh 'docker-compose up -d'
                    sh 'sleep 30' // 等待服务启动
                    sh 'python -m pytest tests/integration/ -v'
                    sh 'docker-compose down'
                }
            }
        }

        stage('Deploy to Kubernetes') {
            when {
                expression { params.DEPLOY }
            }
            steps {
                script {
                    // 更新Kubernetes部署镜像标签
                    sh "sed -i 's|image: acgs2/.*:latest|image: \$DOCKER_REGISTRY/acgs2/\\1:latest-${params.ENVIRONMENT}|g' k8s/deployment.yml"

                    // 部署到Kubernetes
                    sh "kubectl apply -f k8s/namespace.yml"
                    sh "kubectl apply -f k8s/deployment.yml"
                    sh "kubectl apply -f k8s/service.yml"

                    // 等待部署完成
                    sh "kubectl rollout status deployment -n acgs2 --timeout=600s"
                }
            }
        }

        stage('Post-Deployment Tests') {
            when {
                expression { params.DEPLOY }
            }
            steps {
                script {
                    // 运行部署后验证测试
                    sh 'python scripts/health_check.py'

                    // 性能测试
                    sh 'python scripts/performance_test.py'
                }
            }
        }
    }

    post {
        success {
            script {
                echo "✅ 部署成功到 ${params.ENVIRONMENT} 环境"
                // 发送通知
                sh "curl -X POST -H 'Content-type: application/json' --data '{\"text\":\"ACGS-2 部署成功到 ${params.ENVIRONMENT} 环境\"}' https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK"
            }
        }
        failure {
            script {
                echo "❌ 部署失败，开始回滚"
                // 执行回滚
                sh "kubectl rollout undo deployment -n acgs2"
                sh "kubectl rollout status deployment -n acgs2"

                // 发送失败通知
                sh "curl -X POST -H 'Content-type: application/json' --data '{\"text\":\"ACGS-2 部署失败，已回滚\"}' https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK"
            }
        }
        always {
            // 清理工作空间
            sh 'docker system prune -f'
        }
    }
}
