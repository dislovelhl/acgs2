{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://acgs2.io/schemas/bundle-manifest.json",
  "title": "ACGS-2 Policy Bundle Manifest",
  "description": "Schema for OCI-compliant policy bundle manifests with constitutional hash enforcement",
  "type": "object",
  "required": ["version", "revision", "constitutional_hash", "roots"],
  "properties": {
    "version": {
      "type": "string",
      "pattern": "^v?\\d+\\.\\d+\\.\\d+(-[a-zA-Z0-9]+)?(\\+[a-zA-Z0-9]+)?$",
      "description": "Semantic version of the policy bundle (e.g., v1.0.0, 1.2.3-beta)",
      "examples": ["v1.0.0", "1.2.3", "2.0.0-rc1"]
    },
    "revision": {
      "type": "string",
      "minLength": 7,
      "maxLength": 40,
      "pattern": "^[a-f0-9]{7,40}$",
      "description": "Git commit SHA (short or full) for traceability",
      "examples": ["a1b2c3d", "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0"]
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of bundle creation"
    },
    "constitutional_hash": {
      "type": "string",
      "const": "cdd01ef066bc6cf2",
      "description": "ACGS-2 constitutional hash - MUST be exactly cdd01ef066bc6cf2"
    },
    "roots": {
      "type": "array",
      "items": {
        "type": "string",
        "pattern": "^[a-zA-Z_][a-zA-Z0-9_]*(/[a-zA-Z_][a-zA-Z0-9_]*)*$"
      },
      "minItems": 1,
      "description": "OPA policy root paths included in this bundle",
      "examples": [["acgs/governance", "acgs/constitutional"]]
    },
    "signatures": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/signature"
      },
      "description": "Cryptographic signatures for bundle verification"
    },
    "metadata": {
      "$ref": "#/definitions/metadata"
    },
    "dependencies": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/dependency"
      },
      "description": "Other bundles this bundle depends on"
    },
    "compatibility": {
      "$ref": "#/definitions/compatibility"
    }
  },
  "definitions": {
    "signature": {
      "type": "object",
      "required": ["keyid", "sig", "alg"],
      "properties": {
        "keyid": {
          "type": "string",
          "minLength": 8,
          "description": "Key identifier (fingerprint or ID)"
        },
        "sig": {
          "type": "string",
          "minLength": 64,
          "description": "Base64-encoded signature"
        },
        "alg": {
          "type": "string",
          "enum": ["ed25519", "rsa-pss-sha256", "ecdsa-p256-sha256"],
          "description": "Signature algorithm"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "When the signature was created"
        },
        "signer": {
          "type": "string",
          "description": "Identity of the signer (email, SPIFFE ID, etc.)"
        },
        "scope": {
          "type": "string",
          "enum": ["author", "reviewer", "approver", "release"],
          "description": "Role of the signer"
        }
      },
      "additionalProperties": false
    },
    "metadata": {
      "type": "object",
      "properties": {
        "author": {
          "type": "string",
          "description": "Author or team that created the bundle"
        },
        "tenant_id": {
          "type": "string",
          "pattern": "^[a-zA-Z0-9_-]+$",
          "description": "Tenant this bundle belongs to (for multi-tenant deployments)"
        },
        "environment": {
          "type": "string",
          "enum": ["development", "staging", "production", "disaster-recovery"],
          "description": "Target deployment environment"
        },
        "ab_test_group": {
          "type": "string",
          "description": "A/B test group identifier for gradual rollouts"
        },
        "description": {
          "type": "string",
          "maxLength": 1000,
          "description": "Human-readable description of the bundle"
        },
        "changelog": {
          "type": "string",
          "description": "What changed in this version"
        },
        "review_ticket": {
          "type": "string",
          "description": "Link to review/approval ticket (Jira, GitHub PR, etc.)"
        },
        "compliance_tags": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": [
              "eu-ai-act-art-12",
              "eu-ai-act-art-13",
              "eu-ai-act-annex-iv",
              "nist-rmf-au-2",
              "nist-rmf-ac-3",
              "nist-rmf-ca-7",
              "hipaa-164-312",
              "sox-302",
              "gdpr-art-22",
              "iso-27001-a12",
              "fedramp-ac-2"
            ]
          },
          "description": "Regulatory compliance tags this bundle addresses"
        },
        "risk_level": {
          "type": "string",
          "enum": ["low", "medium", "high", "critical"],
          "description": "Risk level of policies in this bundle"
        },
        "requires_approval": {
          "type": "boolean",
          "description": "Whether this bundle requires human approval before activation"
        },
        "approvers": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "List of required approvers"
        },
        "labels": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "description": "Arbitrary key-value labels"
        }
      },
      "additionalProperties": true
    },
    "dependency": {
      "type": "object",
      "required": ["name", "version"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Name of the dependency bundle"
        },
        "version": {
          "type": "string",
          "description": "Required version (semver constraint)"
        },
        "repository": {
          "type": "string",
          "format": "uri",
          "description": "Registry URL for the dependency"
        },
        "optional": {
          "type": "boolean",
          "default": false,
          "description": "Whether this dependency is optional"
        }
      },
      "additionalProperties": false
    },
    "compatibility": {
      "type": "object",
      "properties": {
        "opa_version": {
          "type": "string",
          "description": "Minimum OPA version required",
          "examples": [">=0.55.0"]
        },
        "acgs_version": {
          "type": "string",
          "description": "ACGS-2 version compatibility",
          "examples": [">=2.0.0"]
        },
        "breaking_changes": {
          "type": "boolean",
          "default": false,
          "description": "Whether this bundle contains breaking changes"
        },
        "migration_guide": {
          "type": "string",
          "format": "uri",
          "description": "Link to migration guide if breaking changes exist"
        }
      },
      "additionalProperties": false
    }
  },
  "examples": [
    {
      "version": "v1.0.0",
      "revision": "a1b2c3d4e5f6789012345678901234567890abcd",
      "timestamp": "2025-12-18T10:30:00Z",
      "constitutional_hash": "cdd01ef066bc6cf2",
      "roots": ["acgs/governance", "acgs/constitutional"],
      "signatures": [
        {
          "keyid": "policy-signer-01",
          "sig": "MEUCIQD...base64...==",
          "alg": "ed25519",
          "signer": "ci-bot@acgs2.io",
          "scope": "author"
        },
        {
          "keyid": "security-review-key",
          "sig": "MEYCIQ...base64...==",
          "alg": "ed25519",
          "signer": "security-team@acgs2.io",
          "scope": "reviewer"
        }
      ],
      "metadata": {
        "author": "ACGS Platform Team",
        "tenant_id": "default",
        "environment": "production",
        "description": "Core constitutional governance policies",
        "compliance_tags": ["eu-ai-act-art-12", "nist-rmf-au-2"],
        "risk_level": "high",
        "requires_approval": true,
        "approvers": ["security-team", "compliance-team"]
      },
      "compatibility": {
        "opa_version": ">=0.55.0",
        "acgs_version": ">=2.0.0"
      }
    }
  ]
}
