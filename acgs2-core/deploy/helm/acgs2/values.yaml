# Production Helm Configuration for ACGS2
# Constitutional Hash: cdd01ef066bc6cf2

global:
  env: production
  tenant_id: acgs-main
  constitutional_hash: cdd01ef066bc6cf2

image:
  repository: acgs2/agent-bus
  tag: "v3.0.0"
  pullPolicy: IfNotPresent

# RBAC Configuration
rbac:
  create: true
  serviceAccountName: acgs2-sa

# Network Policy
networkPolicy:
  enabled: true
  egress:
    - kafka
    - redis
  ingress:
    - opa

# Kyverno Policy Enforcement
kyverno:
  enabled: true
  policies:
    - restrict-root-user
    - require-ro-rootfs
    - disallow-privilege-escalation

# OPA Configuration (Pillar 1)
opa:
  enabled: True
  port: 8181
  securePort: 8443
  tls:
    enabled: True
    certSecret: opa-tls-certs
    mTLS: True
  resources:
    limits:
      cpu: 500m  # P99 <5ms
      memory: 1Gi
    requests:
      cpu: 250m
      memory: 512Mi
  bundle:
    path: "file:///policies"  # Mount new .rego policies
    pollInterval: 10s
    auth: false  # Local

# Kafka Configuration (Pillar 2)
kafka:
  bootstrapServers: "kafka-cluster-kafka-bootstrap:9093"
  securityProtocol: SSL
  ssl:
    caSecret: kafka-ca-cert
    certSecret: kafka-client-cert
  auth:
    enabled: True

# Redis Configuration (Pillar 2/3)
redis:
  url: "rediss://redis-cluster:6380/0"
  ssl:
    enabled: True
    caSecret: redis-ca-cert
  maxConnections: 100

# Security Context for Pods
securityContext:
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000
  runAsNonRoot: true

containerSecurityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: true

# MACI Role Enforcement
maci:
  enabled: True
  strictMode: True
  roles:
    executive:
      replicaCount: 3
    judicial:
      replicaCount: 2
    legislative:
      replicaCount: 2

# Monitoring and SLOs
monitoring:
  prometheus:
    enabled: True
    scrapeInterval: 15s
  grafana:
    enabled: True
    dashboardLabel: acgs2-dashboards
  alerts:
    pd_integration_key: "REDACTED"
    slo_threshold: 99.99

# Resilience and Chaos (chaos exps integration)
chaos:
  enabled: True
  engine_hash: cdd01ef066bc6cf2
  blast_radius: ["agent-bus", "opa", "kafka"]
  litmusIntegration: true  # K8s chaos-mesh compatible

istio:
  enabled: True
  rateLimit:
    qps: 100  # P99 <5ms
    burst: 200

# Ingress with TLS/mTLS (Phase 3.2 harden)
ingress:
  enabled: true
  className: "istio-ingress"
  annotations:
    cert-manager.io/cluster-issuer: "acgs-internal-issuer"
    nginx.ingress.kubernetes.io/auth-tls-verify-client: "on"
    nginx.ingress.kubernetes.io/auth-tls-secret: "acgs2/acgs2-ca-secret"
    nginx.ingress.kubernetes.io/auth-tls-verify-depth: "1"
  tls:
    - secretName: acgs2-tls
      hosts:
        - acgs2.example.com
  hosts:
    - host: acgs2.example.com
      paths:
        - path: /
          pathType: Prefix

# Pod Security Standards v1.28+ (non-root, no priv esc)
podSecurityStandards:
  enforce:
    version: v1.28
  warn:
    version: v1.28
  audit:
    version: v1.28

# Multi-Tenant Quota Configuration
# Enables namespace-based tenant isolation with configurable resource quotas
tenantQuotas:
  # Enable multi-tenant quota enforcement
  enabled: true

  # Kubernetes namespace configuration
  namespace:
    prefix: "tenant-"
    labels:
      managed-by: "acgs2"
      isolation-level: "namespace"

  # Default quota limits applied to all tenants without overrides
  defaults:
    # CPU quota (Kubernetes format: cores or millicores)
    cpu: "2"
    # Memory quota (Kubernetes format: Gi, Mi)
    memory: "4Gi"
    # Storage quota for PersistentVolumeClaims
    storage: "20Gi"
    # Maximum number of PersistentVolumeClaims
    maxPVCs: 10
    # Maximum number of pods in tenant namespace
    maxPods: 50

  # Rate limiting configuration per tenant
  rateLimits:
    # Maximum requests per rate limit window
    requestsPerWindow: 1000
    # Rate limit window duration in seconds
    windowSeconds: 60
    # Algorithm: sliding_window or token_bucket
    algorithm: "sliding_window"
    # Burst allowance above the limit (for short spikes)
    burstMultiplier: 1.2

  # Resource quota enforcement behavior
  enforcement:
    # strict: Reject pods exceeding quota immediately
    # warn: Allow pods but log warnings
    # audit: Allow pods and record for audit only
    mode: "strict"
    # Graceful handling when quota checks fail
    failOpen: false
    # Retry attempts for transient failures
    retryAttempts: 3
    # Retry delay in milliseconds
    retryDelayMs: 100

  # Per-tenant quota overrides (example)
  # Override default quotas for specific tenants
  overrides: {}
    # premium-tenant:
    #   cpu: "8"
    #   memory: "16Gi"
    #   storage: "100Gi"
    #   maxPVCs: 50
    #   maxPods: 200
    #   rateLimits:
    #     requestsPerWindow: 10000
    #     windowSeconds: 60
    # basic-tenant:
    #   cpu: "1"
    #   memory: "2Gi"
    #   storage: "10Gi"
    #   maxPVCs: 5
    #   maxPods: 20

  # Network isolation settings for tenant namespaces
  networkPolicy:
    # Enable network policy creation for tenant isolation
    enabled: true
    # Deny cross-tenant network traffic by default
    denyCrossTenant: true
    # Allow egress to these services (cluster-wide)
    allowedEgress:
      - kafka
      - redis
      - opa

  # Audit logging for quota events
  auditLogging:
    enabled: true
    # Log quota usage periodically
    usageReportingInterval: "5m"
    # Log when usage exceeds this percentage of quota
    usageAlertThreshold: 80

# OPA Bundle ref integrated in existing opa section above
