name: Quarterly Code Cleanup

on:
  schedule:
    # Run quarterly on the 1st of January, April, July, October at 00:00 UTC
    - cron: "0 0 1 1,4,7,10 *"
  workflow_dispatch:
    inputs:
      force_run:
        description: "Force run cleanup even if no changes detected"
        required: false
        default: "false"
        type: boolean

env:
  CONSTITUTIONAL_HASH: cdd01ef066bc6cf2

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          cd src/core
          pip install -r requirements_optimized.txt
          pip install black isort flake8 bandit pip-audit pycln pre-commit

      - name: Run import cleanup
        id: import_cleanup
        run: |
          cd src/core
          echo "Running import cleanup..."
          python3 tools/import_cleanup.py --fix . || true

          # Check if any files changed
          if git diff --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Run code formatting
        run: |
          cd src/core
          black .
          isort --profile black .

      - name: Run linting and security checks
        run: |
          cd src/core
          flake8 --max-line-length=100 --ignore=E501,W503 . || true
          bandit -r . -f json -o security_report.json || true
          pip-audit --requirement requirements_optimized.txt --format json -o dependency_audit.json || true

      - name: Generate cleanup report
        run: |
          cd src/core
          echo "# ACGS-2 Quarterly Cleanup Report" > CLEANUP_REPORT.md
          echo "" >> CLEANUP_REPORT.md
          echo "**Date**: $(date)" >> CLEANUP_REPORT.md
          echo "**Constitutional Hash**: $CONSTITUTIONAL_HASH" >> CLEANUP_REPORT.md
          echo "" >> CLEANUP_REPORT.md
          echo "## Import Cleanup Results" >> CLEANUP_REPORT.md
          echo "\`\`\`" >> CLEANUP_REPORT.md
          python3 tools/import_cleanup.py --check . 2>&1 | head -20 >> CLEANUP_REPORT.md || true
          echo "\`\`\`" >> CLEANUP_REPORT.md
          echo "" >> CLEANUP_REPORT.md
          echo "## Security Scan Results" >> CLEANUP_REPORT.md
          echo "\`\`\`json" >> CLEANUP_REPORT.md
          cat security_report.json | jq '.results // empty' 2>/dev/null || echo "No critical security issues found" >> CLEANUP_REPORT.md
          echo "\`\`\`" >> CLEANUP_REPORT.md
          echo "" >> CLEANUP_REPORT.md
          echo "## Dependency Audit Results" >> CLEANUP_REPORT.md
          echo "\`\`\`json" >> CLEANUP_REPORT.md
          cat dependency_audit.json | jq '.vulnerabilities // empty' 2>/dev/null || echo "No dependency vulnerabilities found" >> CLEANUP_REPORT.md
          echo "\`\`\`" >> CLEANUP_REPORT.md

      - name: Check for changes
        id: verify_changes
        run: |
          if git diff --quiet && git diff --staged --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            git add .
          fi

      - name: Create Pull Request
        if: steps.verify_changes.outputs.changes == 'true' || inputs.force_run == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            ü§ñ Automated quarterly code cleanup

            Constitutional Hash: cdd01ef066bc6cf2

            - Removed unused imports
            - Applied code formatting (Black + isort)
            - Updated security and dependency reports
            - Maintained code quality standards
          title: "ü§ñ Quarterly Code Cleanup - $(date +%B %Y)"
          body: |
            ## ü§ñ Automated Quarterly Code Cleanup

            **Date**: $(date)
            **Constitutional Hash**: `cdd01ef066bc6cf2`

            ### Changes Applied
            - ‚úÖ Import cleanup and optimization
            - ‚úÖ Code formatting (Black)
            - ‚úÖ Import sorting (isort)
            - ‚úÖ Security scanning (Bandit)
            - ‚úÖ Dependency auditing (pip-audit)

            ### Files Modified
            - Any files with unused imports removed
            - Code formatting applied to all Python files
            - Updated reports in `CLEANUP_REPORT.md`

            ### Quality Gates
            - All imports validated for usage
            - Code formatting standards enforced
            - Security vulnerabilities addressed
            - Dependencies audited for known issues

            ---
            *This PR was automatically generated by the quarterly cleanup workflow.*
          branch: automated/cleanup/$(date +%Y-%m)
          delete-branch: true
          labels: |
            automated
            cleanup
            maintenance
          assignees: ${{ github.actor }}

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Quarterly cleanup failed. Please check the workflow logs."

      - name: Notify on success
        if: success() && steps.verify_changes.outputs.changes == 'true'
        run: |
          echo "‚úÖ Quarterly cleanup completed successfully. Pull request created."

      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cleanup-reports
          path: |
            src/core/CLEANUP_REPORT.md
            src/core/security_report.json
            src/core/dependency_audit.json
