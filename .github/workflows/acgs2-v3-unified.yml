name: ACGS2 v3.0.0 Unified CI
# Constitutional Hash: cdd01ef066bc6cf2

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  security-audit:
    name: Security Audit (SCA)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Pip Audit
        run: |
          pip install pip-audit
          pip-audit -r acgs2-core/requirements_optimized.txt

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.80.0

      - name: Cargo Audit
        run: |
          cargo install cargo-audit
          cd acgs2-core/enhanced_agent_bus/rust && cargo audit

  test-python:
    name: Python Tests with Coverage (3.12)
    needs: security-audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
      - name: Install dependencies
        run: |
          pip install -e .[test]
          pip install -r acgs2-core/requirements_optimized.txt
          pip install pytest-cov pytest-xdist coverage[toml]
      - name: Run Tests with Coverage (Parallel)
        run: |
          cd acgs2-core
          pytest -n auto --dist=loadscope \
            --cov=acgs2_core \
            --cov-branch \
            --cov-report=term-missing \
            --cov-report=xml:coverage.xml \
            --cov-fail-under=85 \
            tests/
      - name: Upload Python Coverage Artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-coverage
          path: acgs2-core/coverage.xml
          retention-days: 30
      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: acgs2-core/coverage.xml
          flags: acgs2-core,claude-flow,neural-mcp
          name: ACGS2 Core Coverage
          fail_ci_if_error: false
          verbose: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  test-rust:
    name: Rust Tests (1.80.0)
    needs: security-audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.80.0
      - name: Cargo Test
        run: |
          cd acgs2-core/enhanced_agent_bus/rust && cargo test

  test-typescript:
    name: TypeScript Tests with Coverage (Node 20)
    needs: security-audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: |
            claude-flow/package-lock.json
            acgs2-neural-mcp/package-lock.json
      - name: Install claude-flow dependencies
        run: |
          cd claude-flow
          npm ci || npm install
      - name: Install acgs2-neural-mcp dependencies
        run: |
          cd acgs2-neural-mcp
          npm ci || npm install
      - name: Run claude-flow Tests with Coverage
        run: |
          cd claude-flow
          npm test -- --coverage --coverageReporters=text --coverageReporters=lcov --coverageDirectory=coverage
      - name: Run acgs2-neural-mcp Tests with Coverage
        run: |
          cd acgs2-neural-mcp
          npm test -- --coverage --coverageReporters=text --coverageReporters=lcov --coverageDirectory=coverage
      - name: Upload claude-flow Coverage Artifact
        uses: actions/upload-artifact@v4
        with:
          name: claude-flow-coverage
          path: claude-flow/coverage/lcov.info
          retention-days: 30
      - name: Upload acgs2-neural-mcp Coverage Artifact
        uses: actions/upload-artifact@v4
        with:
          name: acgs2-neural-mcp-coverage
          path: acgs2-neural-mcp/coverage/lcov.info
          retention-days: 30
      - name: Upload TypeScript Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: claude-flow/coverage/lcov.info,acgs2-neural-mcp/coverage/lcov.info
          flags: typescript,claude-flow,neural-mcp
          name: TypeScript Coverage
          fail_ci_if_error: false
          verbose: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  build-and-scan:
    name: Build and Trivy Scan
    needs: [test-python, test-rust, test-typescript]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build Optimized Image
        run: |
          docker build -t acgs2-bus:v3 -f acgs2-core/Dockerfile.optimized acgs2-core/
      - name: Trivy Scan
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: acgs2-bus:v3
          exit-code: "1"
          severity: "HIGH,CRITICAL"
          ignore-unfixed: true

  kyverno-test:
    name: Kyverno Policy Test
    needs: build-and-scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Kyverno CLI
        run: |
          curl -LO https://github.com/kyverno/kyverno/releases/download/v1.12.0/kyverno-cli_v1.12.0_linux_x86_64.tar.gz
          tar -xvf kyverno-cli_v1.12.0_linux_x86_64.tar.gz
          sudo mv kyverno /usr/local/bin/
      - name: Test K8s Manifests
        run: |
          # Simplified test against a mock policy or manifest
          kyverno test acgs2-infra/k8s/

  slsa-provenance:
    name: SLSA Provenance (Structure)
    needs: build-and-scan
    runs-on: ubuntu-latest
    steps:
      - name: Generate SLSA Metadata
        run: |
          echo "Generating SLSA L4 provenance metadata..."
          # This would eventually integrate with SLSA generator actions
