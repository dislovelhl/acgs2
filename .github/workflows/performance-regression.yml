name: Performance Regression Tests
# Performance validation for 10K+ RPS with P99 < 1ms

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      users:
        description: "Number of concurrent users"
        required: false
        default: "1000"
      run_time:
        description: "Test duration (e.g., 1m, 5m)"
        required: false
        default: "1m"

env:
  PYTHON_VERSION: "3.12"
  LOCUST_USERS: ${{ github.event.inputs.users || '1000' }}
  LOCUST_RUN_TIME: ${{ github.event.inputs.run_time || '1m' }}
  # Global PYTHONPATH for all jobs - required for src.core.* imports
  PYTHONPATH: ${{ github.workspace }}

jobs:
  performance-baseline:
    name: Performance Baseline Check
    runs-on: ubuntu-latest
    continue-on-error: true # Non-blocking until load testing infrastructure is set up
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[test,loadtest]
          pip install -r src/core/config/requirements_optimized.txt
          pip install locust

      - name: Verify Locust installation
        run: |
          locust --version

      - name: Validate load test file syntax
        run: |
          python -m py_compile src/core/testing/performance_10k_rps.py
          python -m py_compile src/core/testing/load_test.py

  rust-extensions:
    name: Build Rust Extensions
    runs-on: ubuntu-latest
    continue-on-error: true # Non-blocking until Rust extensions are properly configured
    steps:
      - uses: actions/checkout@v6

      - name: Set up Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain 1.80.0
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          source "$HOME/.cargo/env"
          rustup component add clippy

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            src/core/rust-perf/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock', '**/Cargo.toml') }}

      - name: Clippy check (memory safety)
        run: |
          cd src/core/rust-perf
          cargo clippy --all-targets --all-features

      - name: Cargo test
        run: |
          cd src/core/rust-perf
          cargo test

  performance-smoke-test:
    name: Performance Smoke Test
    needs: [performance-baseline, rust-extensions]
    runs-on: ubuntu-latest
    continue-on-error: true # Non-blocking - API Gateway may not be fully available in CI
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[test,loadtest]
          pip install -r src/core/config/requirements_optimized.txt
          pip install locust
          # Install shared module dependencies
          pip install structlog orjson pydantic-settings pybreaker prometheus-client

      - name: Set up Rust and build extensions
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain 1.80.0
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          source "$HOME/.cargo/env"

      - name: Install maturin and build Rust extensions
        run: |
          pip install maturin
          cd src/core/rust-perf
          maturin build --release
          pip install target/wheels/*.whl || echo "Rust extension install skipped - wheel may not exist"

      - name: Install API Gateway dependencies
        run: |
          pip install -r src/core/services/api_gateway/requirements.txt

      - name: Pre-flight import check
        run: |
          cd src/core/services/api_gateway
          echo "Testing imports with PYTHONPATH=$PYTHONPATH"
          python -c "import sys; print('sys.path:', sys.path[:3])"
          python -c "from src.core.shared.config import settings; print('Config import OK')"
          python -c "import main; print('Main import OK')"
        env:
          PYTHONPATH: ${{ github.workspace }}
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          ACGS2_ENV: development
          JWT_SECRET: test-secret-for-ci-only

      - name: Start API Gateway
        run: |
          cd src/core/services/api_gateway
          echo "Starting API Gateway..."
          uvicorn main:app --host 0.0.0.0 --port 8080 > /tmp/uvicorn.log 2>&1 &
          echo $! > /tmp/uvicorn.pid
          sleep 5
          echo "=== Initial uvicorn output ==="
          cat /tmp/uvicorn.log || true
        env:
          PYTHONPATH: ${{ github.workspace }}
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          ACGS2_ENV: development
          JWT_SECRET: test-secret-for-ci-only

      - name: Health check
        run: |
          echo "Waiting for API Gateway to be ready..."
          for i in $(seq 1 30); do
            if curl -sf http://localhost:8080/health >/dev/null 2>&1; then
              echo "API Gateway is ready!"
              curl -s http://localhost:8080/health | jq . || cat
              exit 0
            fi
            echo "Attempt $i/30 - API Gateway not ready yet..."
            if [ -f /tmp/uvicorn.pid ] && ! ps -p $(cat /tmp/uvicorn.pid) > /dev/null 2>&1; then
              echo "ERROR: uvicorn process died"
              echo "=== UVICORN LOG ==="
              cat /tmp/uvicorn.log || echo "No log file"
              exit 1
            fi
            sleep 2
          done
          echo "API Gateway failed to start within 60 seconds"
          echo "=== UVICORN LOG ==="
          cat /tmp/uvicorn.log || echo "No log file"
          exit 1

      - name: Run smoke test (100 users, 30s)
        run: |
          mkdir -p results
          locust -f src/core/testing/load_test.py \
            --headless \
            --users 100 \
            --spawn-rate 10 \
            --run-time 30s \
            --host http://localhost:8080 \
            --csv=results/smoke \
            --html=results/smoke.html \
            --exit-code-on-error 1 || true

      - name: Upload smoke test results
        uses: actions/upload-artifact@v4
        if: always() && hashFiles('results/*') != ''
        with:
          name: smoke-test-results
          path: results/

  performance-regression:
    name: Performance Regression Gate
    needs: performance-smoke-test
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[test,loadtest]
          pip install -r src/core/config/requirements_optimized.txt
          pip install locust
          # Install shared module dependencies
          pip install structlog orjson pydantic-settings pybreaker prometheus-client

      - name: Set up Rust and build extensions
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain 1.80.0
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          source "$HOME/.cargo/env"

      - name: Install maturin and build Rust extensions
        run: |
          pip install maturin
          cd src/core/rust-perf
          maturin build --release
          pip install target/wheels/*.whl || echo "Rust extension install skipped - wheel may not exist"

      - name: Install API Gateway dependencies
        run: |
          pip install -r src/core/services/api_gateway/requirements.txt

      - name: Increase file descriptor limits
        run: |
          ulimit -n 65535 || true

      - name: Pre-flight import check
        run: |
          cd src/core/services/api_gateway
          echo "Testing imports with PYTHONPATH=$PYTHONPATH"
          python -c "import sys; print('sys.path:', sys.path[:3])"
          python -c "from src.core.shared.config import settings; print('Config import OK')"
          python -c "import main; print('Main import OK')"
        env:
          PYTHONPATH: ${{ github.workspace }}
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          ACGS2_ENV: development
          JWT_SECRET: test-secret-for-ci-only

      - name: Start API Gateway
        run: |
          cd src/core/services/api_gateway
          echo "Starting API Gateway..."
          uvicorn main:app --host 0.0.0.0 --port 8080 --workers 4 > /tmp/uvicorn.log 2>&1 &
          echo $! > /tmp/uvicorn.pid
          sleep 10
          echo "=== Initial uvicorn output ==="
          cat /tmp/uvicorn.log || true
        env:
          PYTHONPATH: ${{ github.workspace }}
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          ACGS2_ENV: development
          JWT_SECRET: test-secret-for-ci-only

      - name: Health check
        run: |
          echo "Waiting for API Gateway to be ready..."
          for i in $(seq 1 30); do
            if curl -sf http://localhost:8080/health >/dev/null 2>&1; then
              echo "API Gateway is ready!"
              curl -s http://localhost:8080/health | jq . || cat
              exit 0
            fi
            echo "Attempt $i/30 - API Gateway not ready yet..."
            if [ -f /tmp/uvicorn.pid ] && ! ps -p $(cat /tmp/uvicorn.pid) > /dev/null 2>&1; then
              echo "ERROR: uvicorn process died"
              echo "=== UVICORN LOG ==="
              cat /tmp/uvicorn.log || echo "No log file"
              exit 1
            fi
            sleep 2
          done
          echo "API Gateway failed to start within 60 seconds"
          echo "=== UVICORN LOG ==="
          cat /tmp/uvicorn.log || echo "No log file"
          exit 1

      - name: Run performance regression test
        run: |
          mkdir -p results
          locust -f src/core/testing/performance_10k_rps.py \
            --headless \
            --users ${{ env.LOCUST_USERS }} \
            --spawn-rate 100 \
            --run-time ${{ env.LOCUST_RUN_TIME }} \
            --host http://localhost:8080 \
            --csv=results/regression \
            --html=results/regression.html \
            --exit-code-on-error 1

      - name: Validate performance thresholds
        run: |
          echo "=== Performance Validation ==="
          echo "Checking P99 latency < 1ms and throughput targets..."

          if [ ! -f results/regression_stats.csv ]; then
            echo "ERROR: No results file found"
            exit 1
          fi

          cat results/regression_stats.csv

          echo ""
          echo "=== Regression test completed ==="
          echo "Review results/regression.html for detailed analysis"

      - name: Upload regression test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: regression-test-results
          path: results/
          retention-days: 30

      - name: Comment PR with results
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            let summary = 'Performance regression test completed.\n\n';
            summary += 'See artifacts for detailed results.';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
