# Secrets Allow-list Configuration

**File:** `.secrets-allowlist.yaml`
**Constitutional Hash:** `cdd01ef066bc6cf2`
**Used by:** `scripts/check-secrets-pre-commit.py`

## Overview

This configuration file defines the allow-list for ACGS-2's custom secrets detection pre-commit hook. It distinguishes safe development placeholders from real secrets using a three-tier system.

## Three-Tier Allow-list System

### Tier 1: Pattern-Based (Broad)
Global patterns that identify safe placeholders across all files.

**Examples:**
- `dev-*` - Development prefixes
- `test-*` - Test data
- `your-*` - Instructional placeholders
- `<...>` - Angle bracket placeholders

### Tier 2: Path-Based (Targeted)
Files and directories excluded from strict scanning.

**Examples:**
- `.env.example` - Example configuration files
- `tests/fixtures/` - Test fixture directories
- `*.md` - Documentation files

### Tier 3: Value-Based (Precise)
Specific known-safe values with full documentation.

**Examples:**
- `dev-jwt-secret-min-32-chars-required` - From `.env.dev`
- `dev_password` - Development Redis password
- `mlflow_password` - Development ML database password

## Configuration Sections

### `placeholder_patterns`
Defines patterns that indicate safe/fake secrets:
- `prefixes`: Value prefixes (e.g., "dev-", "test-")
- `markers`: Content markers (e.g., "<", "xxx", "example")
- `redaction_patterns`: Regex patterns for redacted values

### `excluded_paths`
Paths to exclude from scanning:
- `directories`: Excluded directories (e.g., "node_modules/", ".venv/")
- `test_paths`: Test fixture paths
- `file_patterns`: File name patterns to exclude

### `known_safe_values`
Documented safe values by category:
- `development`: Development environment placeholders
- `generic`: Generic placeholder values
- `empty_values`: Empty or null values
- `test_fixtures`: Test-specific values

Each entry includes:
- `value`: The actual safe value
- `context`: Where it's used
- `why_safe`: Explanation of safety
- `production_mitigation`: How it's handled in production

### `file_specific_rules`
Override scanning behavior for specific files:
- `scan_level`: VERY_STRICT, STRICT, RELAXED, VERY_RELAXED
- Additional file-specific flags

### `skip_extensions`
Binary/media file extensions to skip entirely for performance.

### `feature_flags`
Enable/disable specific checks (entropy, base64, hex strings, etc.)

### `performance`
Performance tuning settings (file size limits, line length limits, etc.)

## Usage

The configuration is automatically loaded by `scripts/check-secrets-pre-commit.py`. If the file is missing or invalid, the script falls back to hardcoded defaults.

### Testing Your Changes

```bash
# Manually run the hook with verbose output
python scripts/check-secrets-pre-commit.py --verbose

# Run pre-commit hooks
pre-commit run check-acgs2-secrets --all-files
```

### Validating YAML Syntax

```bash
# Validate YAML syntax
yamllint .secrets-allowlist.yaml

# Or use Python
python -c "import yaml; yaml.safe_load(open('.secrets-allowlist.yaml'))"
```

## When to Update This File

### Add New Placeholder Patterns
When introducing new safe placeholder conventions:

```yaml
placeholder_patterns:
  prefixes:
    - "ci-"       # New: CI/CD placeholders
    - "staging-"  # New: Staging environment values
```

### Add File Exclusions
When adding new test fixtures or example files:

```yaml
excluded_paths:
  test_paths:
    - "e2e/fixtures/"  # New: E2E test fixtures
```

### Document New Safe Values
When adding development placeholders to `.env.dev`:

```yaml
known_safe_values:
  development:
    - value: "dev-new-service-key"
      context: ".env.dev NEW_SERVICE_KEY"
      why_safe: "Development placeholder for new service integration"
      production_mitigation: "Real key loaded from Vault in production"
```

## Best Practices

### DO ✅
- Document WHY each exception is safe
- Include production mitigation notes
- Test changes before committing
- Review quarterly and remove obsolete entries
- Use specific values over broad patterns when possible

### DON'T ❌
- Add real production secrets (use environment variables + secrets_manager)
- Use overly broad patterns that could miss real secrets
- Add exceptions without clear justification
- Forget to test after making changes

## Integration with Secrets Manager

This allow-list complements the patterns from `acgs2-core/shared/secrets_manager.py`:

- **secrets_manager.py**: Defines WHAT secrets to look for (CREDENTIAL_PATTERNS)
- **.secrets-allowlist.yaml**: Defines WHICH values are safe (placeholder detection)

Together they provide:
1. Runtime validation (secrets_manager.py)
2. Pre-commit validation (check-secrets-pre-commit.py)
3. Placeholder detection (this config file)

## Troubleshooting

### "Allow-list config not found" Warning

The script will use hardcoded defaults. To fix:
```bash
# Ensure file exists in repository root
ls -la .secrets-allowlist.yaml

# Check file permissions
chmod 644 .secrets-allowlist.yaml
```

### "Failed to load allow-list config" Error

YAML syntax error. Validate:
```bash
python -c "import yaml; print(yaml.safe_load(open('.secrets-allowlist.yaml')))"
```

### PyYAML Not Installed

Install PyYAML:
```bash
pip install pyyaml
```

Or the script will fall back to defaults (with warning).

## Metadata

- **Version:** 1.0.0
- **Last Updated:** 2026-01-03
- **Review Frequency:** Quarterly
- **Next Review:** 2026-04-03
- **Constitutional Hash:** cdd01ef066bc6cf2

## Related Documentation

- [Secrets Detection](docs/SECRETS_DETECTION.md) - Overall secrets detection strategy
- [Hook Strategy](hook-strategy.md) - Pre-commit hook design
- [Secrets Manager](acgs2-core/shared/secrets_manager.py) - Runtime secrets validation

## Support

For questions or issues:
1. Check documentation: `docs/SECRETS_DETECTION.md`
2. Review examples in this README
3. Check existing patterns in `.secrets-allowlist.yaml`
4. Contact ACGS-2 Security Team
