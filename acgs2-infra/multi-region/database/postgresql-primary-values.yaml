postgresql:
  primary:
    configuration: |
      wal_level = replica
      max_wal_senders = 10
      max_replication_slots = 5
      wal_keep_size = 512MB
    pgHbaConfiguration: |
      host replication replication_user all scram-sha-256
    extraEnvVars:
      - name: POSTGRESQL_REPLICATION_MODE
        value: "primary"

  replication:
    enabled: true
    user: replication_user
    password: "${POSTGRESQL_REPLICATION_PASSWORD}"
    readReplicas: 0

  metrics:
    enabled: true
    customMetrics:
      pg_replication_slots:
        query: "SELECT slot_name, active, pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn) as retained_bytes FROM pg_replication_slots;"
        metrics:
          - slot_name:
              usage: "LABEL"
              description: "Name of the replication slot"
          - active:
              usage: "GAUGE"
              description: "Whether the slot is active"
          - retained_bytes:
              usage: "GAUGE"
              description: "Bytes of WAL retained by this slot"
