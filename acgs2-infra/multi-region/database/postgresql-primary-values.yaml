# Bitnami PostgreSQL Helm Chart Values for Primary Database (Region 1)
# This configuration sets up PostgreSQL with streaming replication enabled

# Global settings
global:
  postgresql:
    auth:
      postgresPassword: "postgres-password"  # Change in production
      username: "acgs2"
      password: "acgs2-password"  # Change in production
      database: "acgs2"
      replicationUsername: "replication_user"
      replicationPassword: "replication-password"  # Change in production

# PostgreSQL specific configuration
postgresql:
  # Enable PostgreSQL server
  enabled: true

  # Image configuration
  image:
    registry: docker.io
    repository: bitnami/postgresql
    tag: 16.2.0
    digest: ""
    pullPolicy: IfNotPresent
    pullSecrets: []
    debug: false

  # Architecture: standalone for primary
  architecture: standalone

  # Authentication configuration
  auth:
    enablePostgresUser: true
    postgresPassword: "postgres-password"
    username: "acgs2"
    password: "acgs2-password"
    database: "acgs2"
    replicationUsername: "replication_user"
    replicationPassword: "replication-password"
    existingSecret: ""

  # Container ports
  containerPorts:
    postgresql: 5432

  # Replication configuration
  replication:
    enabled: true
    user: replication_user
    password: replication-password
    readReplicas: 0  # No local read replicas, cross-region standby instead
    synchronizeWal: false  # Asynchronous replication
    numSynchronousReplicas: 0

  # PostgreSQL configuration overrides
  postgresqlConfiguration: |
    # WAL configuration for replication
    wal_level = replica
    max_wal_senders = 10
    max_replication_slots = 5
    wal_keep_size = 512MB
    wal_sender_timeout = 60s
    wal_receiver_timeout = 60s

    # Connection configuration
    max_connections = 100
    shared_preload_libraries = 'pg_stat_statements'
    pg_stat_statements.track = all
    pg_stat_statements.max = 10000

    # Logging for replication monitoring
    log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
    log_statement = 'ddl'
    log_replication_commands = on

    # Performance tuning
    shared_buffers = 256MB
    effective_cache_size = 1GB
    maintenance_work_mem = 64MB
    checkpoint_completion_target = 0.9
    wal_buffers = 16MB
    default_statistics_target = 100

  # PostgreSQL HBA (Host-Based Authentication) configuration
  pgHbaConfiguration: |
    # Allow local connections
    local   all             all                                     trust
    host    all             all             127.0.0.1/32            trust
    host    all             all             ::1/128                 trust

    # Allow replication connections from standby (cross-region)
    # Note: Use service DNS names for Kubernetes stability
    host    replication     replication_user    postgresql-standby.database.svc.cluster.local   scram-sha-256

    # Allow application connections
    host    acgs2           acgs2           0.0.0.0/0               scram-sha-256
    host    all             all             0.0.0.0/0               md5

  # InitDB scripts for database setup
  initdb:
    scripts:
      init-acgs2.sql: |
        -- ACGS-2 Database Initialization
        CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
        CREATE EXTENSION IF NOT EXISTS uuid-ossp;

        -- Create replication slot for standby
        SELECT pg_create_physical_replication_slot('acgs2_standby_slot');

        -- Create audit schema and tables
        CREATE SCHEMA IF NOT EXISTS audit;

        -- Governance audit table
        CREATE TABLE IF NOT EXISTS audit.governance_decisions (
          id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
          decision_id VARCHAR(255) NOT NULL,
          tenant_id VARCHAR(100),
          policy_hash VARCHAR(64) NOT NULL,
          constitutional_hash VARCHAR(64) NOT NULL,
          decision VARCHAR(50) NOT NULL,
          confidence_score DECIMAL(3,2),
          input_hash VARCHAR(64),
          decision_metadata JSONB,
          created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
          region VARCHAR(50) DEFAULT 'us-east-1'
        );

        -- Create indexes for performance
        CREATE INDEX IF NOT EXISTS idx_governance_tenant ON audit.governance_decisions(tenant_id);
        CREATE INDEX IF NOT EXISTS idx_governance_decision ON audit.governance_decisions(decision_id);
        CREATE INDEX IF NOT EXISTS idx_governance_created ON audit.governance_decisions(created_at DESC);

        -- Row Level Security for multi-tenant isolation
        ALTER TABLE audit.governance_decisions ENABLE ROW LEVEL SECURITY;

        -- Policy: Users can only see their tenant's data
        CREATE POLICY tenant_isolation ON audit.governance_decisions
          FOR ALL USING (tenant_id = current_setting('app.tenant_id', true));

  # Primary specific configuration
  primary:
    # Node affinity for primary database (prefer certain nodes)
    affinity:
      nodeAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
                - key: acgs2/database-role
                  operator: In
                  values:
                    - primary
                - key: topology.kubernetes.io/zone
                  operator: In
                  values:
                    - us-east-1a
                    - us-east-1b

    # Pod disruption budget for primary
    podDisruptionBudget:
      enabled: true
      minAvailable: 1

    # Priority class for primary (higher priority)
    priorityClassName: "system-cluster-critical"

    # Resource limits for primary
    resources:
      limits:
        cpu: 2000m
        memory: 4Gi
      requests:
        cpu: 500m
        memory: 1Gi

    # Persistence configuration
    persistence:
      enabled: true
      size: 50Gi
      storageClass: "gp3"
      accessModes:
        - ReadWriteOnce
      annotations: {}

    # Extra volumes for primary
    extraVolumes:
      - name: postgresql-data
        persistentVolumeClaim:
          claimName: data-postgresql-0

    # Extra volume mounts
    extraVolumeMounts:
      - name: postgresql-data
        mountPath: /bitnami/postgresql

  # Metrics configuration
  metrics:
    enabled: true
    image:
      registry: docker.io
      repository: bitnami/postgresql-exporter
      tag: latest
      pullPolicy: IfNotPresent
    customMetrics:
      # Replication lag monitoring
      pg_replication_lag:
        query: |
          SELECT
            application_name,
            EXTRACT(EPOCH FROM (now() - replay_timestamp)) as lag_seconds
          FROM pg_stat_replication
          WHERE application_name = 'walreceiver'
        metrics:
          - application_name:
              usage: "LABEL"
              description: "Application name"
          - lag_seconds:
              usage: "GAUGE"
              description: "Replication lag in seconds"

      # Replication slots monitoring
      pg_replication_slots:
        query: |
          SELECT
            slot_name,
            active,
            pg_wal_lss_diff(pg_current_wal_lss(), restart_lss) as retained_bytes
          FROM pg_replication_slots
        metrics:
          - slot_name:
              usage: "LABEL"
              description: "Replication slot name"
          - active:
              usage: "GAUGE"
              description: "Whether the slot is active"
          - retained_bytes:
              usage: "GAUGE"
              description: "Bytes of WAL retained by this slot"

  # Service configuration
  service:
    type: ClusterIP
    ports:
      postgresql: 5432
    annotations:
      # Service annotations for cross-cluster discovery
      service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
      service.beta.kubernetes.io/aws-load-balancer-type: "nlb"

  # Network policy
  networkPolicy:
    enabled: true
    allowExternal: false  # Only allow internal cluster access
    additionalRules: []

  # Security context
  securityContext:
    enabled: true
    fsGroup: 1001
    runAsUser: 1001

  containerSecurityContext:
    enabled: true
    runAsUser: 1001
    runAsNonRoot: true
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL

  # Pod security context
  podSecurityContext:
    enabled: true
    fsGroup: 1001

  # RBAC configuration
  rbac:
    create: true

  # Service account
  serviceAccount:
    create: true
    name: postgresql-primary
    annotations: {}

  # TLS configuration (optional, can be added later)
  tls:
    enabled: false

  # Backup configuration (can be added later)
  backup:
    enabled: false

# Volume permissions init container
volumePermissions:
  enabled: true
  image:
    registry: docker.io
    repository: bitnami/bitnami-shell
    tag: "11"
    pullPolicy: IfNotPresent
  resources:
    limits: {}
    requests: {}

# Diagnostic mode (for troubleshooting)
diagnosticMode:
  enabled: false
