<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GDPR Data Flow Mapping - {{ organization_name | default_value }}</title>
    <style>
        :root {
            --primary-color: #1a4480;
            --secondary-color: #2c608a;
            --success-color: #2e8540;
            --warning-color: #e66f0e;
            --danger-color: #d63e04;
            --info-color: #00bcd4;
            --light-gray: #f5f7f8;
            --border-color: #dfe1e2;
            --gdpr-blue: #003399;
            --flow-color: #00838f;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #1b1b1b;
            background-color: #fff;
            font-size: 11pt;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 40px;
        }

        /* Header Styles */
        .report-header {
            text-align: center;
            border-bottom: 4px solid var(--flow-color);
            padding-bottom: 30px;
            margin-bottom: 40px;
        }

        .report-header h1 {
            color: var(--flow-color);
            font-size: 24pt;
            margin-bottom: 5px;
        }

        .report-header h2 {
            color: var(--secondary-color);
            font-size: 16pt;
            font-weight: normal;
            margin-bottom: 10px;
        }

        .report-header .regulation-ref {
            color: #71767a;
            font-size: 10pt;
            font-style: italic;
        }

        .report-meta {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .report-meta-item {
            text-align: center;
        }

        .report-meta-label {
            font-size: 9pt;
            color: #71767a;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .report-meta-value {
            font-size: 11pt;
            color: var(--primary-color);
            font-weight: 600;
        }

        /* Section Styles */
        .section {
            margin-bottom: 40px;
            page-break-inside: avoid;
        }

        .section-title {
            color: var(--flow-color);
            font-size: 16pt;
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .subsection-title {
            color: var(--secondary-color);
            font-size: 13pt;
            margin: 20px 0 15px 0;
        }

        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 10pt;
        }

        th, td {
            border: 1px solid var(--border-color);
            padding: 12px;
            text-align: left;
            vertical-align: top;
        }

        th {
            background-color: var(--flow-color);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 9pt;
            letter-spacing: 0.5px;
        }

        tr:nth-child(even) {
            background-color: var(--light-gray);
        }

        tr:hover {
            background-color: #e0f7fa;
        }

        /* Summary Box */
        .summary-box {
            background-color: var(--light-gray);
            border: 1px solid var(--border-color);
            border-left: 4px solid var(--flow-color);
            padding: 20px;
            margin: 20px 0;
        }

        .summary-stats {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 15px 20px;
            background: white;
            border-radius: 8px;
            min-width: 130px;
        }

        .stat-value {
            font-size: 24pt;
            font-weight: 700;
            color: var(--flow-color);
        }

        .stat-label {
            font-size: 9pt;
            color: #71767a;
            text-transform: uppercase;
        }

        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 3px;
            font-size: 9pt;
            font-weight: 600;
        }

        .status-encrypted { background-color: #d4edda; color: var(--success-color); }
        .status-not-encrypted { background-color: #f8d7da; color: var(--danger-color); }
        .status-cross-border { background-color: #fff3cd; color: #856404; }
        .status-internal { background-color: #cce5ff; color: #004085; }

        /* Data Category Tags */
        .category-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 8pt;
            font-weight: 500;
            margin: 2px;
            background-color: #e0f7fa;
            color: var(--flow-color);
        }

        .category-special {
            background-color: #f8d7da;
            color: var(--danger-color);
        }

        /* Flow Card */
        .flow-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .flow-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .flow-title {
            color: var(--flow-color);
            font-size: 14pt;
            margin: 0;
        }

        .flow-id {
            color: #71767a;
            font-size: 10pt;
            font-family: monospace;
        }

        /* Flow Diagram */
        .flow-diagram {
            background: linear-gradient(135deg, #f5f7f8 0%, #e8f5e9 100%);
            border-radius: 8px;
            padding: 30px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .flow-node {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 15px 25px;
            text-align: center;
            min-width: 150px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .flow-node.source {
            border-color: var(--success-color);
            border-left: 4px solid var(--success-color);
        }

        .flow-node.destination {
            border-color: var(--primary-color);
            border-left: 4px solid var(--primary-color);
        }

        .flow-node.cross-border {
            border-color: var(--warning-color);
            border-left: 4px solid var(--warning-color);
        }

        .flow-node-label {
            font-size: 8pt;
            color: #71767a;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .flow-node-value {
            font-weight: 600;
            color: #1b1b1b;
        }

        .flow-arrow {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--flow-color);
        }

        .flow-arrow-icon {
            font-size: 24pt;
        }

        .flow-arrow-label {
            font-size: 8pt;
            color: #71767a;
            margin-top: 5px;
        }

        /* Flow Details Grid */
        .flow-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 15px;
        }

        .flow-detail-item {
            background: var(--light-gray);
            padding: 15px;
            border-radius: 4px;
        }

        .flow-detail-label {
            font-size: 9pt;
            color: #71767a;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .flow-detail-value {
            color: #1b1b1b;
            font-weight: 500;
        }

        /* Security Indicator */
        .security-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            border-radius: 4px;
            margin-top: 15px;
        }

        .security-indicator.encrypted {
            background-color: #d4edda;
            border: 1px solid var(--success-color);
        }

        .security-indicator.not-encrypted {
            background-color: #f8d7da;
            border: 1px solid var(--danger-color);
        }

        .security-icon {
            font-size: 20pt;
        }

        /* Transfer Warning */
        .transfer-warning {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            font-size: 10pt;
        }

        .transfer-warning strong {
            color: #856404;
        }

        /* Overview Diagram */
        .overview-diagram {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 30px;
            margin: 20px 0;
        }

        .diagram-title {
            text-align: center;
            color: var(--flow-color);
            font-size: 14pt;
            margin-bottom: 20px;
        }

        .diagram-legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px dashed var(--border-color);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 9pt;
            color: #71767a;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        .legend-source { background-color: var(--success-color); }
        .legend-destination { background-color: var(--primary-color); }
        .legend-cross-border { background-color: var(--warning-color); }

        /* Footer */
        .report-footer {
            margin-top: 60px;
            padding-top: 20px;
            border-top: 2px solid var(--border-color);
            text-align: center;
            font-size: 9pt;
            color: #71767a;
        }

        .legal-notice {
            background-color: #f5f7f8;
            padding: 15px;
            margin-top: 20px;
            border-radius: 4px;
            font-size: 8pt;
        }

        /* Print Styles */
        @media print {
            .container {
                max-width: 100%;
                padding: 20px;
            }

            .section {
                page-break-inside: avoid;
            }

            .flow-card {
                page-break-inside: avoid;
            }

            tr {
                page-break-inside: avoid;
            }
        }

        /* Flow Summary Table */
        .flow-matrix {
            overflow-x: auto;
        }

        .flow-matrix table th:first-child,
        .flow-matrix table td:first-child {
            position: sticky;
            left: 0;
            background-color: inherit;
            z-index: 1;
        }

        /* Data Categories Summary */
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .category-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 15px;
            text-align: center;
        }

        .category-card.special {
            background-color: #fff5f5;
            border-color: var(--danger-color);
        }

        .category-count {
            font-size: 18pt;
            font-weight: 700;
            color: var(--flow-color);
        }

        .category-card.special .category-count {
            color: var(--danger-color);
        }

        .category-name {
            font-size: 9pt;
            color: #71767a;
            text-transform: uppercase;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Report Header -->
        <header class="report-header">
            <h1>Data Flow Mapping</h1>
            <h2>Personal Data Processing Flows</h2>
            <p class="regulation-ref">Supporting GDPR Article 30 Records of Processing Activities</p>
            <div class="report-meta">
                <div class="report-meta-item">
                    <div class="report-meta-label">Organization</div>
                    <div class="report-meta-value">{{ organization_name | default_value('Organization Name') }}</div>
                </div>
                <div class="report-meta-item">
                    <div class="report-meta-label">Document Version</div>
                    <div class="report-meta-value">{{ document_version | default_value('1.0') }}</div>
                </div>
                <div class="report-meta-item">
                    <div class="report-meta-label">Generated</div>
                    <div class="report-meta-value">{{ generated_at | format_datetime }}</div>
                </div>
                <div class="report-meta-item">
                    <div class="report-meta-label">Reporting Period</div>
                    <div class="report-meta-value">
                        {{ reporting_period_start | format_date }} - {{ reporting_period_end | format_date }}
                    </div>
                </div>
            </div>
        </header>

        <!-- Executive Summary -->
        <section class="section">
            <h2 class="section-title">1. Executive Summary</h2>
            <div class="summary-box">
                <p>
                    This document provides a comprehensive mapping of personal data flows within {{ organization_name | default_value('the organization') }}.
                    It supports GDPR Article 30 compliance by documenting how personal data moves through systems,
                    identifying data sources, destinations, and any cross-border transfers.
                </p>
                <div class="summary-stats">
                    <div class="stat-item">
                        <div class="stat-value">{{ data_flows | length if data_flows else '0' }}</div>
                        <div class="stat-label">Total Data Flows</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">
                            {% set cross_border_count = 0 %}
                            {% for flow in data_flows %}
                                {% if flow.crosses_border %}
                                    {% set cross_border_count = cross_border_count + 1 %}
                                {% endif %}
                            {% endfor %}
                            {{ cross_border_count }}
                        </div>
                        <div class="stat-label">Cross-Border</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">
                            {% set encrypted_count = 0 %}
                            {% for flow in data_flows %}
                                {% if flow.encryption_in_transit %}
                                    {% set encrypted_count = encrypted_count + 1 %}
                                {% endif %}
                            {% endfor %}
                            {{ encrypted_count }}
                        </div>
                        <div class="stat-label">Encrypted in Transit</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">
                            {% set unique_sources = [] %}
                            {% for flow in data_flows %}
                                {% if flow.data_source not in unique_sources %}
                                    {% if unique_sources.append(flow.data_source) %}{% endif %}
                                {% endif %}
                            {% endfor %}
                            {{ unique_sources | length }}
                        </div>
                        <div class="stat-label">Unique Sources</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Data Flow Overview -->
        <section class="section">
            <h2 class="section-title">2. Data Flow Overview</h2>
            <p>
                The following diagram provides a high-level overview of data flows, showing how personal data
                moves from sources through processing activities to various destinations.
            </p>

            <div class="overview-diagram">
                <div class="diagram-title">Personal Data Flow Summary</div>

                <!-- Flow Summary Table -->
                <div class="flow-matrix">
                    <table>
                        <thead>
                            <tr>
                                <th>Flow ID</th>
                                <th>Name</th>
                                <th>Source</th>
                                <th>Destination</th>
                                <th>Data Categories</th>
                                <th>Cross-Border</th>
                                <th>Encrypted</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for flow in data_flows %}
                            <tr>
                                <td><code>{{ flow.flow_id }}</code></td>
                                <td><strong>{{ flow.name }}</strong></td>
                                <td>{{ flow.data_source }}</td>
                                <td>{{ flow.data_destination }}</td>
                                <td>
                                    {% for category in flow.data_categories %}
                                    {% if category in ['biometric', 'health', 'racial_ethnic', 'political_opinions', 'religious_beliefs', 'trade_union', 'sexual_orientation', 'criminal_records'] %}
                                    <span class="category-tag category-special">{{ category | replace('_', ' ') | title }}</span>
                                    {% else %}
                                    <span class="category-tag">{{ category | replace('_', ' ') | title }}</span>
                                    {% endif %}
                                    {% endfor %}
                                </td>
                                <td>
                                    {% if flow.crosses_border %}
                                    <span class="status-badge status-cross-border">Yes</span>
                                    {% else %}
                                    <span class="status-badge status-internal">No</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if flow.encryption_in_transit %}
                                    <span class="status-badge status-encrypted">Yes</span>
                                    {% else %}
                                    <span class="status-badge status-not-encrypted">No</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="7" style="text-align: center; font-style: italic; color: #71767a;">
                                    No data flows documented. Please add data flow mappings.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="diagram-legend">
                    <div class="legend-item">
                        <div class="legend-color legend-source"></div>
                        <span>Data Source</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-destination"></div>
                        <span>Data Destination</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-cross-border"></div>
                        <span>Cross-Border Transfer</span>
                    </div>
                </div>
            </div>

            <!-- Cross-Border Transfers Alert -->
            {% set cross_border_flows = [] %}
            {% for flow in data_flows %}
                {% if flow.crosses_border %}
                    {% if cross_border_flows.append(flow) %}{% endif %}
                {% endif %}
            {% endfor %}
            {% if cross_border_flows %}
            <div class="transfer-warning">
                <strong>Cross-Border Transfers Identified (Article 44-49):</strong>
                <br>
                {{ cross_border_flows | length }} data flow(s) involve transfers outside the European Economic Area.
                Appropriate safeguards must be documented and maintained. See Section 4 for details.
            </div>
            {% endif %}
        </section>

        <!-- Data Categories Summary -->
        <section class="section">
            <h2 class="section-title">3. Data Categories in Transit</h2>
            <p>
                This section summarizes the categories of personal data that flow through the organization,
                identifying any special category data (Article 9) that requires additional safeguards.
            </p>

            {% set all_categories = {} %}
            {% for flow in data_flows %}
                {% for category in flow.data_categories %}
                    {% if category in all_categories %}
                        {% set _ = all_categories.update({category: all_categories[category] + 1}) %}
                    {% else %}
                        {% set _ = all_categories.update({category: 1}) %}
                    {% endif %}
                {% endfor %}
            {% endfor %}

            {% set special_categories = ['biometric', 'health', 'racial_ethnic', 'political_opinions', 'religious_beliefs', 'trade_union', 'sexual_orientation', 'criminal_records'] %}

            <div class="categories-grid">
                {% for category, count in all_categories.items() %}
                <div class="category-card {% if category in special_categories %}special{% endif %}">
                    <div class="category-count">{{ count }}</div>
                    <div class="category-name">{{ category | replace('_', ' ') | title }}</div>
                    {% if category in special_categories %}
                    <small style="color: var(--danger-color); font-size: 8pt;">Special Category (Art. 9)</small>
                    {% endif %}
                </div>
                {% else %}
                <div class="category-card" style="grid-column: 1 / -1;">
                    <p style="color: #71767a; font-style: italic;">No data categories documented in flows.</p>
                </div>
                {% endfor %}
            </div>

            <h3 class="subsection-title">Data Category Reference</h3>
            <table>
                <thead>
                    <tr>
                        <th>Category</th>
                        <th>Type</th>
                        <th>GDPR Reference</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Basic Identity</td>
                        <td><span class="category-tag">Standard</span></td>
                        <td>Article 4(1)</td>
                        <td>Name, date of birth, gender, nationality</td>
                    </tr>
                    <tr>
                        <td>Contact Details</td>
                        <td><span class="category-tag">Standard</span></td>
                        <td>Article 4(1)</td>
                        <td>Email, phone, address</td>
                    </tr>
                    <tr>
                        <td>Financial</td>
                        <td><span class="category-tag">Standard</span></td>
                        <td>Article 4(1)</td>
                        <td>Bank details, payment information, salary</td>
                    </tr>
                    <tr>
                        <td>Online Identifiers</td>
                        <td><span class="category-tag">Standard</span></td>
                        <td>Article 4(1), Recital 30</td>
                        <td>IP addresses, cookies, device IDs</td>
                    </tr>
                    <tr>
                        <td>Location</td>
                        <td><span class="category-tag">Standard</span></td>
                        <td>Article 4(1)</td>
                        <td>GPS coordinates, location history</td>
                    </tr>
                    <tr>
                        <td>Health</td>
                        <td><span class="category-tag category-special">Special</span></td>
                        <td>Article 9(1)</td>
                        <td>Medical records, health conditions</td>
                    </tr>
                    <tr>
                        <td>Biometric</td>
                        <td><span class="category-tag category-special">Special</span></td>
                        <td>Article 9(1)</td>
                        <td>Fingerprints, facial recognition, iris scans</td>
                    </tr>
                    <tr>
                        <td>Racial/Ethnic Origin</td>
                        <td><span class="category-tag category-special">Special</span></td>
                        <td>Article 9(1)</td>
                        <td>Race, ethnicity, cultural origin</td>
                    </tr>
                    <tr>
                        <td>Political Opinions</td>
                        <td><span class="category-tag category-special">Special</span></td>
                        <td>Article 9(1)</td>
                        <td>Political views, party affiliation</td>
                    </tr>
                    <tr>
                        <td>Religious Beliefs</td>
                        <td><span class="category-tag category-special">Special</span></td>
                        <td>Article 9(1)</td>
                        <td>Religious beliefs, philosophical beliefs</td>
                    </tr>
                    <tr>
                        <td>Trade Union Membership</td>
                        <td><span class="category-tag category-special">Special</span></td>
                        <td>Article 9(1)</td>
                        <td>Trade union membership status</td>
                    </tr>
                    <tr>
                        <td>Sexual Orientation</td>
                        <td><span class="category-tag category-special">Special</span></td>
                        <td>Article 9(1)</td>
                        <td>Sexual orientation, sex life</td>
                    </tr>
                    <tr>
                        <td>Criminal Records</td>
                        <td><span class="category-tag category-special">Special</span></td>
                        <td>Article 10</td>
                        <td>Criminal convictions, offences</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- Detailed Data Flows -->
        <section class="section">
            <h2 class="section-title">4. Detailed Data Flow Mapping</h2>
            <p>
                This section provides detailed documentation for each identified data flow,
                including sources, destinations, data categories, and security measures.
            </p>

            {% for flow in data_flows %}
            <div class="flow-card">
                <div class="flow-header">
                    <div>
                        <h3 class="flow-title">{{ flow.name }}</h3>
                        <span class="flow-id">Flow ID: {{ flow.flow_id }}</span>
                    </div>
                    <div>
                        {% if flow.encryption_in_transit %}
                        <span class="status-badge status-encrypted">Encrypted</span>
                        {% else %}
                        <span class="status-badge status-not-encrypted">Not Encrypted</span>
                        {% endif %}
                        {% if flow.crosses_border %}
                        <span class="status-badge status-cross-border">Cross-Border</span>
                        {% endif %}
                    </div>
                </div>

                <!-- Flow Diagram -->
                <div class="flow-diagram">
                    <div class="flow-node source">
                        <div class="flow-node-label">Data Source</div>
                        <div class="flow-node-value">{{ flow.data_source }}</div>
                    </div>

                    <div class="flow-arrow">
                        <span class="flow-arrow-icon">&#8594;</span>
                        <span class="flow-arrow-label">{{ flow.transfer_method | default_value('Transfer') }}</span>
                    </div>

                    <div class="flow-node {% if flow.crosses_border %}cross-border{% else %}destination{% endif %}">
                        <div class="flow-node-label">
                            {% if flow.crosses_border %}Third Country Destination{% else %}Destination{% endif %}
                        </div>
                        <div class="flow-node-value">{{ flow.data_destination }}</div>
                    </div>
                </div>

                <!-- Flow Details -->
                <div class="flow-details">
                    <div class="flow-detail-item">
                        <div class="flow-detail-label">Description</div>
                        <div class="flow-detail-value">{{ flow.description | default_value('No description provided') }}</div>
                    </div>

                    <div class="flow-detail-item">
                        <div class="flow-detail-label">Processing Activity</div>
                        <div class="flow-detail-value">
                            <code>{{ flow.processing_activity_id }}</code>
                        </div>
                    </div>

                    <div class="flow-detail-item">
                        <div class="flow-detail-label">Transfer Method</div>
                        <div class="flow-detail-value">{{ flow.transfer_method | default_value('Not specified') }}</div>
                    </div>

                    <div class="flow-detail-item">
                        <div class="flow-detail-label">Data Categories</div>
                        <div class="flow-detail-value">
                            {% for category in flow.data_categories %}
                            {% if category in ['biometric', 'health', 'racial_ethnic', 'political_opinions', 'religious_beliefs', 'trade_union', 'sexual_orientation', 'criminal_records'] %}
                            <span class="category-tag category-special">{{ category | replace('_', ' ') | title }}</span>
                            {% else %}
                            <span class="category-tag">{{ category | replace('_', ' ') | title }}</span>
                            {% endif %}
                            {% else %}
                            <span style="color: #71767a; font-style: italic;">No categories specified</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Security Status -->
                <div class="security-indicator {% if flow.encryption_in_transit %}encrypted{% else %}not-encrypted{% endif %}">
                    <span class="security-icon">
                        {% if flow.encryption_in_transit %}&#128274;{% else %}&#128275;{% endif %}
                    </span>
                    <div>
                        <strong>Encryption in Transit:</strong>
                        {% if flow.encryption_in_transit %}
                        Data is encrypted during transmission using TLS/SSL or equivalent encryption.
                        {% else %}
                        Data is NOT encrypted during transmission. This represents a security risk and should be addressed.
                        {% endif %}
                    </div>
                </div>

                <!-- Cross-Border Transfer Details -->
                {% if flow.crosses_border %}
                <div class="transfer-warning">
                    <strong>International Transfer (Articles 44-49):</strong>
                    <br>
                    This data flow involves the transfer of personal data outside the European Economic Area.
                    Appropriate safeguards must be in place before the transfer can lawfully occur.
                    <br><br>
                    <strong>Required Documentation:</strong>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>Adequacy decision, or</li>
                        <li>Standard Contractual Clauses (SCCs), or</li>
                        <li>Binding Corporate Rules (BCRs), or</li>
                        <li>Approved certification mechanism, or</li>
                        <li>Derogation under Article 49</li>
                    </ul>
                </div>
                {% endif %}
            </div>
            {% else %}
            <div class="summary-box">
                <p style="text-align: center; font-style: italic;">
                    No data flows documented. Data flow information will be displayed here
                    when data_flows data is provided to the template.
                </p>
            </div>
            {% endfor %}
        </section>

        <!-- Security Measures Summary -->
        <section class="section">
            <h2 class="section-title">5. Data Flow Security Assessment</h2>
            <p>
                This section summarizes the security posture of data flows, highlighting areas
                that require attention to ensure compliance with GDPR Article 32 (Security of Processing).
            </p>

            {% set total_flows = data_flows | length %}
            {% set encrypted_flows = 0 %}
            {% set cross_border_flows_count = 0 %}
            {% for flow in data_flows %}
                {% if flow.encryption_in_transit %}
                    {% set encrypted_flows = encrypted_flows + 1 %}
                {% endif %}
                {% if flow.crosses_border %}
                    {% set cross_border_flows_count = cross_border_flows_count + 1 %}
                {% endif %}
            {% endfor %}

            <table>
                <thead>
                    <tr>
                        <th>Security Metric</th>
                        <th>Count</th>
                        <th>Percentage</th>
                        <th>Status</th>
                        <th>Recommendation</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Encryption in Transit</strong></td>
                        <td>{{ encrypted_flows }} / {{ total_flows }}</td>
                        <td>
                            {% if total_flows > 0 %}
                            {{ ((encrypted_flows / total_flows) * 100) | round(0) }}%
                            {% else %}
                            N/A
                            {% endif %}
                        </td>
                        <td>
                            {% if total_flows == 0 %}
                            <span class="status-badge status-internal">N/A</span>
                            {% elif encrypted_flows == total_flows %}
                            <span class="status-badge status-encrypted">Compliant</span>
                            {% elif encrypted_flows >= (total_flows * 0.9) %}
                            <span class="status-badge status-cross-border">Attention Needed</span>
                            {% else %}
                            <span class="status-badge status-not-encrypted">Non-Compliant</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if encrypted_flows < total_flows %}
                            Implement TLS 1.2+ for all unencrypted flows
                            {% else %}
                            Maintain current encryption standards
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Cross-Border Transfers</strong></td>
                        <td>{{ cross_border_flows_count }} / {{ total_flows }}</td>
                        <td>
                            {% if total_flows > 0 %}
                            {{ ((cross_border_flows_count / total_flows) * 100) | round(0) }}%
                            {% else %}
                            N/A
                            {% endif %}
                        </td>
                        <td>
                            {% if cross_border_flows_count == 0 %}
                            <span class="status-badge status-encrypted">No Transfers</span>
                            {% else %}
                            <span class="status-badge status-cross-border">Safeguards Required</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if cross_border_flows_count > 0 %}
                            Document transfer mechanisms (SCCs, BCRs, etc.)
                            {% else %}
                            Continue monitoring for any new transfers
                            {% endif %}
                        </td>
                    </tr>
                </tbody>
            </table>

            <h3 class="subsection-title">GDPR Article 32 - Security of Processing</h3>
            <p>
                Data flows should implement appropriate technical measures including:
            </p>
            <ul style="margin: 15px 0; padding-left: 25px;">
                <li style="margin-bottom: 8px;"><strong>Pseudonymisation</strong> and encryption of personal data</li>
                <li style="margin-bottom: 8px;"><strong>Confidentiality, integrity, availability</strong> and resilience of processing systems</li>
                <li style="margin-bottom: 8px;"><strong>Ability to restore</strong> availability and access to personal data in a timely manner</li>
                <li style="margin-bottom: 8px;"><strong>Regular testing</strong> and evaluation of security measures</li>
            </ul>
        </section>

        <!-- Article Reference -->
        <section class="section">
            <h2 class="section-title">Appendix: GDPR Data Flow Requirements</h2>

            <h3 class="subsection-title">Article 30 - Records of Processing Activities</h3>
            <p>
                Data flow mapping supports Article 30 compliance by documenting:
            </p>
            <ul style="margin: 15px 0; padding-left: 25px;">
                <li style="margin-bottom: 8px;">Categories of personal data processed</li>
                <li style="margin-bottom: 8px;">Categories of recipients to whom data is disclosed</li>
                <li style="margin-bottom: 8px;">Transfers to third countries with safeguards documentation</li>
            </ul>

            <h3 class="subsection-title">Articles 44-49 - International Transfers</h3>
            <p>
                Any transfer of personal data to a third country or international organisation shall take place only if:
            </p>
            <ol style="margin: 15px 0; padding-left: 25px;">
                <li style="margin-bottom: 8px;">The Commission has decided that the third country ensures an adequate level of protection (Article 45)</li>
                <li style="margin-bottom: 8px;">Appropriate safeguards are in place (Article 46) including:
                    <ul style="margin: 8px 0; padding-left: 20px;">
                        <li>Binding corporate rules</li>
                        <li>Standard contractual clauses (SCCs)</li>
                        <li>Approved code of conduct</li>
                        <li>Approved certification mechanism</li>
                    </ul>
                </li>
                <li style="margin-bottom: 8px;">A derogation applies under Article 49</li>
            </ol>

            <h3 class="subsection-title">Article 32 - Security of Processing</h3>
            <p>
                Data flows must implement appropriate security measures, taking into account:
            </p>
            <ul style="margin: 15px 0; padding-left: 25px;">
                <li style="margin-bottom: 8px;">The state of the art and costs of implementation</li>
                <li style="margin-bottom: 8px;">The nature, scope, context and purposes of processing</li>
                <li style="margin-bottom: 8px;">The risks to the rights and freedoms of natural persons</li>
            </ul>
        </section>

        <!-- Report Footer -->
        <footer class="report-footer">
            <p>
                <strong>GDPR Data Flow Mapping Report</strong>
                <br>
                {{ organization_name | default_value('Organization') }} | Generated: {{ generated_at | format_datetime }}
                <br>
                Document Version: {{ document_version | default_value('1.0') }} | Generator Version: {{ generator_version | default_value('1.0.0') }}
            </p>
            <div class="legal-notice">
                <strong>Legal Notice:</strong> This document has been generated to support GDPR compliance by
                documenting personal data flows. It should be reviewed regularly and updated whenever data flows
                change. This documentation should be made available to the supervisory authority on request.
                <br><br>
                Data flow mapping is an essential component of the records of processing activities required
                under Article 30 GDPR and supports compliance with international transfer requirements under
                Articles 44-49.
                <br><br>
                ACGS-2 Enterprise Guardrails Platform - Compliance Documentation Service
            </div>
        </footer>
    </div>
</body>
</html>
