{
  "file_path": "acgs2-core/tests/playground/test_app.py",
  "main_branch_history": [],
  "task_views": {
    "056-reduce-excessive-any-type-usage-in-python-codebase": {
      "task_id": "056-reduce-excessive-any-type-usage-in-python-codebase",
      "branch_point": {
        "commit_hash": "fc6e42927298263034acf989773f3200e422ad17",
        "content": "\"\"\"\nACGS-2 Policy Playground - Backend API Tests\n\nComprehensive test coverage for playground FastAPI endpoints including:\n- POST /api/validate - Policy syntax validation\n- POST /api/evaluate - Policy evaluation with input\n- GET /api/examples - Example policies retrieval\n- Health check endpoints\n\nFollows patterns from test_opa_service.py and test_policy_cli.py\n\"\"\"\n\nimport importlib.util\nimport os\nimport sys\nfrom typing import Any, Dict\nfrom unittest.mock import AsyncMock, MagicMock\n\nimport pytest\n\n# Add parent directories to path for imports\n# This allows importing cli.opa_service and other modules\n_base_dir = os.path.abspath(os.path.join(os.path.dirname(__file__), \"../..\"))\nif _base_dir not in sys.path:\n    sys.path.insert(0, _base_dir)\n\n\ndef _load_playground_app():\n    \"\"\"Load playground.app module dynamically from file path.\"\"\"\n    app_path = os.path.join(_base_dir, \"playground\", \"app.py\")\n    spec = importlib.util.spec_from_file_location(\"playground_app\", app_path)\n    module = importlib.util.module_from_spec(spec)\n    sys.modules[\"playground_app\"] = module\n    spec.loader.exec_module(module)\n    return module\n\n\n# Load playground app module\n_playground_app_module = None\n\n\n# =============================================================================\n# Mock Classes for Testing\n# =============================================================================\n\n\nclass MockPolicyValidationResult:\n    \"\"\"Mock PolicyValidationResult for testing.\"\"\"\n\n    def __init__(\n        self,\n        is_valid: bool = True,\n        errors: list = None,\n        warnings: list = None,\n        metadata: dict = None,\n    ):\n        self.is_valid = is_valid\n        self.errors = errors or []\n        self.warnings = warnings or []\n        self.metadata = metadata or {}\n\n\nclass MockPolicyEvaluationResult:\n    \"\"\"Mock PolicyEvaluationResult for testing.\"\"\"\n\n    def __init__(\n        self,\n        success: bool = True,\n        result: Any = None,\n        allowed: bool = None,\n        reason: str = \"\",\n        metadata: dict = None,\n    ):\n        self.success = success\n        self.result = result\n        self.allowed = allowed\n        self.reason = reason\n        self.metadata = metadata or {}\n\n\nclass MockOPAService:\n    \"\"\"Mock OPAService for testing playground without real OPA.\"\"\"\n\n    def __init__(self, opa_url: str = \"http://localhost:8181\", timeout: float = 10.0):\n        self.opa_url = opa_url\n        self.timeout = timeout\n        self._async_client = MagicMock()\n\n    async def _ensure_async_client(self):\n        \"\"\"Mock async client initialization.\"\"\"\n        return self._async_client\n\n    async def aclose(self):\n        \"\"\"Mock async close.\"\"\"\n        pass\n\n    async def async_health_check(self) -> Dict[str, Any]:\n        \"\"\"Mock health check.\"\"\"\n        return {\"status\": \"healthy\", \"opa_url\": self.opa_url}\n\n    async def async_validate_policy(self, policy_content: str) -> MockPolicyValidationResult:\n        \"\"\"Mock policy validation.\"\"\"\n        if not policy_content.strip():\n            return MockPolicyValidationResult(\n                is_valid=False,\n                errors=[\"Policy content is empty\"],\n            )\n        if \"syntax_error\" in policy_content:\n            return MockPolicyValidationResult(\n                is_valid=False,\n                errors=[\"Line 1, Col 1: rego_parse_error: unexpected keyword\"],\n            )\n        return MockPolicyValidationResult(is_valid=True)\n\n    async def async_evaluate_policy(\n        self,\n        policy_content: str,\n        input_data: Dict[str, Any],\n        policy_path: str = \"data\",\n    ) -> MockPolicyEvaluationResult:\n        \"\"\"Mock policy evaluation.\"\"\"\n        if \"error_policy\" in policy_content:\n            return MockPolicyEvaluationResult(\n                success=False,\n                reason=\"Policy upload failed\",\n            )\n        return MockPolicyEvaluationResult(\n            success=True,\n            result={\"allow\": True},\n            allowed=True,\n            reason=\"Policy evaluated successfully\",\n        )\n\n\n# =============================================================================\n# Fixtures\n# =============================================================================\n\n\n@pytest.fixture\ndef mock_opa_service():\n    \"\"\"Create a mock OPA service for testing.\"\"\"\n    return MockOPAService()\n\n\n@pytest.fixture\ndef valid_policy():\n    \"\"\"Sample valid Rego policy.\"\"\"\n    return \"\"\"package playground.test\n\ndefault allow := false\n\nallow {\n    input.user.role == \"admin\"\n}\n\"\"\"\n\n\n@pytest.fixture\ndef invalid_policy():\n    \"\"\"Sample invalid Rego policy with syntax error.\"\"\"\n    return \"\"\"package playground.test\n\ndefault allow := syntax_error {\n    invalid syntax here\n\"\"\"\n\n\n@pytest.fixture\ndef sample_input():\n    \"\"\"Sample input data for policy evaluation.\"\"\"\n    return {\"user\": {\"id\": \"user-123\", \"role\": \"admin\"}}\n\n\n@pytest.fixture\ndef playground_app_module():\n    \"\"\"Load and return the playground app module.\"\"\"\n    global _playground_app_module\n    if _playground_app_module is None:\n        _playground_app_module = _load_playground_app()\n    return _playground_app_module\n\n\n@pytest.fixture\ndef app_with_mock_opa(mock_opa_service, playground_app_module):\n    \"\"\"\n    Create FastAPI app with mocked OPA service.\n\n    Directly patches the app module's opa_service global variable.\n    \"\"\"\n    from fastapi.testclient import TestClient\n\n    app_module = playground_app_module\n\n    # Store original and patch\n    original_opa_service = app_module.opa_service\n    app_module.opa_service = mock_opa_service\n\n    try:\n        client = TestClient(app_module.app, raise_server_exceptions=False)\n        yield client\n    finally:\n        # Restore original\n        app_module.opa_service = original_opa_service\n\n\n@pytest.fixture\ndef test_client_no_opa(playground_app_module):\n    \"\"\"\n    Create FastAPI test client without OPA service initialized.\n\n    Useful for testing service unavailable scenarios.\n    \"\"\"\n    from fastapi.testclient import TestClient\n\n    app_module = playground_app_module\n\n    original_opa_service = app_module.opa_service\n    app_module.opa_service = None\n\n    try:\n        client = TestClient(app_module.app, raise_server_exceptions=False)\n        yield client\n    finally:\n        app_module.opa_service = original_opa_service\n\n\n# =============================================================================\n# Validate Endpoint Tests\n# =============================================================================\n\n\nclass TestValidateEndpoint:\n    \"\"\"Tests for POST /api/validate endpoint.\"\"\"\n\n    def test_validate_valid_policy(self, app_with_mock_opa, valid_policy):\n        \"\"\"Test validation of a valid policy returns success.\"\"\"\n        response = app_with_mock_opa.post(\n            \"/api/validate\",\n            json={\"policy\": valid_policy},\n        )\n\n        assert response.status_code == 200\n        data = response.json()\n        assert data[\"valid\"] is True\n        assert data[\"errors\"] == []\n\n    def test_validate_invalid_policy(self, app_with_mock_opa, invalid_policy):\n        \"\"\"Test validation of an invalid policy returns errors.\"\"\"\n        response = app_with_mock_opa.post(\n            \"/api/validate\",\n            json={\"policy\": invalid_policy},\n        )\n\n        assert response.status_code == 200\n        data = response.json()\n        assert data[\"valid\"] is False\n        assert len(data[\"errors\"]) > 0\n\n    def test_validate_empty_policy(self, app_with_mock_opa):\n        \"\"\"Test validation of empty policy returns error.\"\"\"\n        response = app_with_mock_opa.post(\n            \"/api/validate\",\n            json={\"policy\": \"\"},\n        )\n\n        assert response.status_code == 200\n        data = response.json()\n        assert data[\"valid\"] is False\n        assert any(\"empty\" in err.lower() for err in data[\"errors\"])\n\n    def test_validate_whitespace_only_policy(self, app_with_mock_opa):\n        \"\"\"Test validation of whitespace-only policy returns error.\"\"\"\n        response = app_with_mock_opa.post(\n            \"/api/validate\",\n            json={\"policy\": \"   \\n\\t  \"},\n        )\n\n        assert response.status_code == 200\n        data = response.json()\n        assert data[\"valid\"] is False\n\n    def test_validate_missing_policy_field(self, app_with_mock_opa):\n        \"\"\"Test validation with missing policy field returns 422.\"\"\"\n        response = app_with_mock_opa.post(\n            \"/api/validate\",\n            json={},\n        )\n\n        assert response.status_code == 422\n\n    def test_validate_opa_not_initialized(self, test_client_no_opa, valid_policy):\n        \"\"\"Test validation when OPA service is not initialized.\"\"\"\n        response = test_client_no_opa.post(\n            \"/api/validate\",\n            json={\"policy\": valid_policy},\n        )\n\n        assert response.status_code == 503\n        data = response.json()\n        assert \"not initialized\" in data[\"detail\"].lower()\n\n\nclass TestValidateEndpointWithOPAErrors:\n    \"\"\"Tests for validate endpoint handling OPA errors.\"\"\"\n\n    def test_validate_opa_connection_error(self):\n        \"\"\"Test validation when OPA connection fails.\"\"\"\n        from fastapi.testclient import TestClient\n\n        import playground.app as app_module\n\n        mock_service = MagicMock()\n        mock_service.async_validate_policy = AsyncMock(side_effect=Exception(\"Connection refused\"))\n\n        original = app_module.opa_service\n        app_module.opa_service = mock_service\n\n        try:\n            client = TestClient(app_module.app, raise_server_exceptions=False)\n            response = client.post(\n                \"/api/validate\",\n                json={\"policy\": \"package test\\n\"},\n            )\n\n            assert response.status_code == 500\n        finally:\n            app_module.opa_service = original\n\n    def test_validate_with_opa_connection_error_class(self):\n        \"\"\"Test validation with OPAConnectionError raises 503.\"\"\"\n        from cli.opa_service import OPAConnectionError\n        from fastapi.testclient import TestClient\n\n        import playground.app as app_module\n\n        mock_service = MagicMock()\n        mock_service.async_validate_policy = AsyncMock(\n            side_effect=OPAConnectionError(\"http://localhost:8181\", \"Connection refused\")\n        )\n\n        original = app_module.opa_service\n        app_module.opa_service = mock_service\n\n        try:\n            client = TestClient(app_module.app, raise_server_exceptions=False)\n            response = client.post(\n                \"/api/validate\",\n                json={\"policy\": \"package test\\n\"},\n            )\n\n            assert response.status_code == 503\n            data = response.json()\n            assert \"unavailable\" in data[\"detail\"].lower()\n        finally:\n            app_module.opa_service = original\n\n\n# =============================================================================\n# Evaluate Endpoint Tests\n# =============================================================================\n\n\nclass TestEvaluateEndpoint:\n    \"\"\"Tests for POST /api/evaluate endpoint.\"\"\"\n\n    def test_evaluate_policy_success(self, app_with_mock_opa, valid_policy, sample_input):\n        \"\"\"Test successful policy evaluation.\"\"\"\n        response = app_with_mock_opa.post(\n            \"/api/evaluate\",\n            json={\n                \"policy\": valid_policy,\n                \"input\": sample_input,\n            },\n        )\n\n        assert response.status_code == 200\n        data = response.json()\n        assert data[\"success\"] is True\n        assert \"result\" in data\n\n    def test_evaluate_policy_with_allow_result(self, app_with_mock_opa, valid_policy, sample_input):\n        \"\"\"Test evaluation returns allowed field when present.\"\"\"\n        response = app_with_mock_opa.post(\n            \"/api/evaluate\",\n            json={\n                \"policy\": valid_policy,\n                \"input\": sample_input,\n            },\n        )\n\n        assert response.status_code == 200\n        data = response.json()\n        assert data[\"success\"] is True\n        assert data[\"allowed\"] is True\n\n    def test_evaluate_policy_with_custom_path(self, app_with_mock_opa, valid_policy, sample_input):\n        \"\"\"Test evaluation with custom policy path.\"\"\"\n        response = app_with_mock_opa.post(\n            \"/api/evaluate\",\n            json={\n                \"policy\": valid_policy,\n                \"input\": sample_input,\n                \"path\": \"playground.test.allow\",\n            },\n        )\n\n        assert response.status_code == 200\n        data = response.json()\n        assert data[\"success\"] is True\n\n    def test_evaluate_policy_empty_input(self, app_with_mock_opa, valid_policy):\n        \"\"\"Test evaluation with empty input object.\"\"\"\n        response = app_with_mock_opa.post(\n            \"/api/evaluate\",\n            json={\n                \"policy\": valid_policy,\n                \"input\": {},\n            },\n        )\n\n        assert response.status_code == 200\n        data = response.json()\n        assert data[\"success\"] is True\n\n    def test_evaluate_policy_no_input_field(self, app_with_mock_opa, valid_policy):\n        \"\"\"Test evaluation without input field uses empty dict.\"\"\"\n        response = app_with_mock_opa.post(\n            \"/api/evaluate\",\n            json={\n                \"policy\": valid_policy,\n            },\n        )\n\n        assert response.status_code == 200\n        data = response.json()\n        assert data[\"success\"] is True\n\n    def test_evaluate_policy_failure(self, app_with_mock_opa):\n        \"\"\"Test evaluation failure returns error details.\"\"\"\n        response = app_with_mock_opa.post(\n            \"/api/evaluate\",\n            json={\n                \"policy\": \"error_policy package test\\n\",\n                \"input\": {},\n            },\n        )\n\n        assert response.status_code == 200\n        data = response.json()\n        assert data[\"success\"] is False\n        assert data[\"error\"] is not None\n\n    def test_evaluate_missing_policy_field(self, app_with_mock_opa):\n        \"\"\"Test evaluation with missing policy field returns 422.\"\"\"\n        response = app_with_mock_opa.post(\n            \"/api/evaluate\",\n            json={\"input\": {}},\n        )\n\n        assert response.status_code == 422\n\n    def test_evaluate_opa_not_initialized(self, test_client_no_opa, valid_policy):\n        \"\"\"Test evaluation when OPA service is not initialized.\"\"\"\n        response = test_client_no_opa.post(\n            \"/api/evaluate\",\n            json={\"policy\": valid_policy, \"input\": {}},\n        )\n\n        assert response.status_code == 503\n\n    def test_evaluate_complex_input(self, app_with_mock_opa, valid_policy):\n        \"\"\"Test evaluation with complex nested input.\"\"\"\n        complex_input = {\n            \"user\": {\n                \"id\": \"user-123\",\n                \"roles\": [\"admin\", \"editor\"],\n                \"metadata\": {\n                    \"created\": \"2024-01-01\",\n                    \"tags\": [\"verified\"],\n                },\n            },\n            \"resource\": {\n                \"type\": \"document\",\n                \"permissions\": [\"read\", \"write\"],\n            },\n        }\n\n        response = app_with_mock_opa.post(\n            \"/api/evaluate\",\n            json={\n                \"policy\": valid_policy,\n                \"input\": complex_input,\n            },\n        )\n\n        assert response.status_code == 200\n        data = response.json()\n        assert data[\"success\"] is True\n\n\nclass TestEvaluateEndpointWithOPAErrors:\n    \"\"\"Tests for evaluate endpoint handling OPA errors.\"\"\"\n\n    def test_evaluate_opa_connection_error(self):\n        \"\"\"Test evaluation when OPA connection fails.\"\"\"\n        from cli.opa_service import OPAConnectionError\n        from fastapi.testclient import TestClient\n\n        import playground.app as app_module\n\n        mock_service = MagicMock()\n        mock_service.async_evaluate_policy = AsyncMock(\n            side_effect=OPAConnectionError(\"http://localhost:8181\", \"Connection refused\")\n        )\n\n        original = app_module.opa_service\n        app_module.opa_service = mock_service\n\n        try:\n            client = TestClient(app_module.app, raise_server_exceptions=False)\n            response = client.post(\n                \"/api/evaluate\",\n                json={\"policy\": \"package test\\n\", \"input\": {}},\n            )\n\n            assert response.status_code == 503\n        finally:\n            app_module.opa_service = original\n\n\n# =============================================================================\n# Examples Endpoint Tests\n# =============================================================================\n\n\nclass TestExamplesEndpoint:\n    \"\"\"Tests for GET /api/examples endpoint.\"\"\"\n\n    def test_get_examples_returns_list(self, app_with_mock_opa):\n        \"\"\"Test examples endpoint returns a list of examples.\"\"\"\n        response = app_with_mock_opa.get(\"/api/examples\")\n\n        assert response.status_code == 200\n        data = response.json()\n        assert isinstance(data, list)\n        assert len(data) >= 5  # Spec requires at least 5 examples\n\n    def test_get_examples_have_required_fields(self, app_with_mock_opa):\n        \"\"\"Test each example has all required fields.\"\"\"\n        response = app_with_mock_opa.get(\"/api/examples\")\n\n        assert response.status_code == 200\n        data = response.json()\n\n        required_fields = [\n            \"id\",\n            \"name\",\n            \"description\",\n            \"category\",\n            \"policy\",\n            \"test_input\",\n            \"expected_result\",\n            \"explanation\",\n            \"difficulty\",\n            \"tags\",\n        ]\n\n        for example in data:\n            for field in required_fields:\n                assert (\n                    field in example\n                ), f\"Missing field '{field}' in example '{example.get('id', 'unknown')}'\"\n\n    def test_get_examples_have_valid_policies(self, app_with_mock_opa):\n        \"\"\"Test each example has non-empty policy content.\"\"\"\n        response = app_with_mock_opa.get(\"/api/examples\")\n\n        assert response.status_code == 200\n        data = response.json()\n\n        for example in data:\n            assert example[\"policy\"].strip(), f\"Empty policy in example '{example['id']}'\"\n            assert (\n                \"package\" in example[\"policy\"]\n            ), f\"Policy missing package declaration in '{example['id']}'\"\n\n    def test_get_examples_filter_by_category(self, app_with_mock_opa):\n        \"\"\"Test filtering examples by category.\"\"\"\n        response = app_with_mock_opa.get(\"/api/examples?category=RBAC\")\n\n        assert response.status_code == 200\n        data = response.json()\n        # May return empty if no RBAC examples or filtered differently\n        assert isinstance(data, list)\n\n    def test_get_examples_filter_by_difficulty(self, app_with_mock_opa):\n        \"\"\"Test filtering examples by difficulty.\"\"\"\n        response = app_with_mock_opa.get(\"/api/examples?difficulty=beginner\")\n\n        assert response.status_code == 200\n        data = response.json()\n        assert isinstance(data, list)\n        # All returned examples should have beginner difficulty\n        for example in data:\n            assert example[\"difficulty\"] == \"beginner\"\n\n    def test_get_examples_filter_by_tag(self, app_with_mock_opa):\n        \"\"\"Test filtering examples by tag.\"\"\"\n        response = app_with_mock_opa.get(\"/api/examples?tag=rbac\")\n\n        assert response.status_code == 200\n        data = response.json()\n        assert isinstance(data, list)\n        # All returned examples should have the tag\n        for example in data:\n            assert \"rbac\" in example[\"tags\"]\n\n    def test_get_examples_categories_diverse(self, app_with_mock_opa):\n        \"\"\"Test examples cover multiple categories.\"\"\"\n        response = app_with_mock_opa.get(\"/api/examples\")\n\n        assert response.status_code == 200\n        data = response.json()\n\n        categories = {example[\"category\"] for example in data}\n        # Spec requires diverse examples covering multiple categories\n        assert len(categories) >= 3, f\"Expected at least 3 categories, got {categories}\"\n\n\nclass TestExampleByIdEndpoint:\n    \"\"\"Tests for GET /api/examples/{example_id} endpoint.\"\"\"\n\n    def test_get_example_by_valid_id(self, app_with_mock_opa):\n        \"\"\"Test getting a specific example by ID.\"\"\"\n        # First get all examples to find a valid ID\n        response = app_with_mock_opa.get(\"/api/examples\")\n        examples = response.json()\n        example_id = examples[0][\"id\"]\n\n        # Now fetch by ID\n        response = app_with_mock_opa.get(f\"/api/examples/{example_id}\")\n\n        assert response.status_code == 200\n        data = response.json()\n        assert data[\"id\"] == example_id\n\n    def test_get_example_by_invalid_id(self, app_with_mock_opa):\n        \"\"\"Test getting an example with non-existent ID returns 404.\"\"\"\n        response = app_with_mock_opa.get(\"/api/examples/nonexistent-id-12345\")\n\n        assert response.status_code == 404\n        data = response.json()\n        assert \"not found\" in data[\"detail\"].lower()\n\n\nclass TestExampleCategoriesEndpoint:\n    \"\"\"Tests for GET /api/examples/categories/list endpoint.\"\"\"\n\n    def test_get_categories_list(self, app_with_mock_opa):\n        \"\"\"Test getting examples grouped by category.\"\"\"\n        response = app_with_mock_opa.get(\"/api/examples/categories/list\")\n\n        assert response.status_code == 200\n        data = response.json()\n        assert isinstance(data, dict)\n        # Should have at least some categories\n        assert len(data) > 0\n\n\n# =============================================================================\n# Health Check Endpoint Tests\n# =============================================================================\n\n\nclass TestHealthEndpoints:\n    \"\"\"Tests for health check endpoints.\"\"\"\n\n    def test_liveness_check(self, app_with_mock_opa):\n        \"\"\"Test liveness probe returns alive status.\"\"\"\n        response = app_with_mock_opa.get(\"/health/live\")\n\n        assert response.status_code == 200\n        data = response.json()\n        assert data[\"status\"] == \"alive\"\n        assert data[\"service\"] == \"policy-playground\"\n\n    def test_readiness_check_with_opa(self, app_with_mock_opa):\n        \"\"\"Test readiness probe with OPA service initialized.\"\"\"\n        response = app_with_mock_opa.get(\"/health/ready\")\n\n        assert response.status_code == 200\n        data = response.json()\n        assert data[\"service\"] == \"policy-playground\"\n        # Status depends on mock OPA health\n\n    def test_readiness_check_without_opa(self, test_client_no_opa):\n        \"\"\"Test readiness probe without OPA service initialized.\"\"\"\n        response = test_client_no_opa.get(\"/health/ready\")\n\n        assert response.status_code == 200\n        data = response.json()\n        assert data[\"status\"] == \"not_ready\"\n        assert data[\"opa_status\"] == \"not_initialized\"\n\n    def test_general_health_check(self, app_with_mock_opa):\n        \"\"\"Test general health endpoint.\"\"\"\n        response = app_with_mock_opa.get(\"/health\")\n\n        assert response.status_code == 200\n        data = response.json()\n        assert \"status\" in data\n        assert \"service\" in data\n\n\n# =============================================================================\n# Root Endpoint Tests\n# =============================================================================\n\n\nclass TestRootEndpoint:\n    \"\"\"Tests for root endpoint.\"\"\"\n\n    def test_root_returns_api_info(self, app_with_mock_opa):\n        \"\"\"Test root endpoint returns API information.\"\"\"\n        response = app_with_mock_opa.get(\"/\")\n\n        assert response.status_code == 200\n        data = response.json()\n        assert \"service\" in data\n        assert \"version\" in data\n        assert \"endpoints\" in data\n        assert \"validate\" in data[\"endpoints\"]\n        assert \"evaluate\" in data[\"endpoints\"]\n        assert \"examples\" in data[\"endpoints\"]\n\n\n# =============================================================================\n# CORS Tests\n# =============================================================================\n\n\nclass TestCORSConfiguration:\n    \"\"\"Tests for CORS middleware configuration.\"\"\"\n\n    def test_cors_allows_localhost(self, app_with_mock_opa):\n        \"\"\"Test CORS allows requests from localhost.\"\"\"\n        response = app_with_mock_opa.options(\n            \"/api/validate\",\n            headers={\n                \"Origin\": \"http://localhost:8080\",\n                \"Access-Control-Request-Method\": \"POST\",\n            },\n        )\n\n        # CORS preflight should succeed\n        assert response.status_code in [200, 204]\n\n    def test_cors_headers_present(self, app_with_mock_opa):\n        \"\"\"Test CORS headers are present in response.\"\"\"\n        response = app_with_mock_opa.post(\n            \"/api/validate\",\n            json={\"policy\": \"package test\\n\"},\n            headers={\"Origin\": \"http://localhost:8080\"},\n        )\n\n        # Response should have CORS headers\n        assert response.status_code == 200\n\n\n# =============================================================================\n# Request/Response Model Tests\n# =============================================================================\n\n\nclass TestRequestModels:\n    \"\"\"Tests for request body validation.\"\"\"\n\n    def test_validate_request_requires_policy(self, app_with_mock_opa):\n        \"\"\"Test validate endpoint requires policy field.\"\"\"\n        response = app_with_mock_opa.post(\n            \"/api/validate\",\n            json={},\n        )\n\n        assert response.status_code == 422\n        data = response.json()\n        assert \"detail\" in data\n\n    def test_evaluate_request_requires_policy(self, app_with_mock_opa):\n        \"\"\"Test evaluate endpoint requires policy field.\"\"\"\n        response = app_with_mock_opa.post(\n            \"/api/evaluate\",\n            json={\"input\": {}},\n        )\n\n        assert response.status_code == 422\n\n    def test_evaluate_request_input_optional(self, app_with_mock_opa):\n        \"\"\"Test evaluate endpoint allows missing input field.\"\"\"\n        response = app_with_mock_opa.post(\n            \"/api/evaluate\",\n            json={\"policy\": \"package test\\ndefault allow := true\"},\n        )\n\n        assert response.status_code == 200\n\n    def test_evaluate_request_path_optional(self, app_with_mock_opa):\n        \"\"\"Test evaluate endpoint allows missing path field.\"\"\"\n        response = app_with_mock_opa.post(\n            \"/api/evaluate\",\n            json={\"policy\": \"package test\\ndefault allow := true\", \"input\": {}},\n        )\n\n        assert response.status_code == 200\n\n\n# =============================================================================\n# Edge Cases and Error Handling\n# =============================================================================\n\n\nclass TestEdgeCases:\n    \"\"\"Tests for edge cases and error handling.\"\"\"\n\n    def test_validate_very_long_policy(self, app_with_mock_opa):\n        \"\"\"Test validation with very long policy content.\"\"\"\n        # Generate a long policy with many rules\n        rules = \"\\n\".join([f\"rule_{i} {{ input.x == {i} }}\" for i in range(1000)])\n        long_policy = f\"package test\\n\\n{rules}\"\n\n        response = app_with_mock_opa.post(\n            \"/api/validate\",\n            json={\"policy\": long_policy},\n        )\n\n        assert response.status_code == 200\n\n    def test_evaluate_with_special_characters_in_input(self, app_with_mock_opa):\n        \"\"\"Test evaluation with special characters in input.\"\"\"\n        response = app_with_mock_opa.post(\n            \"/api/evaluate\",\n            json={\n                \"policy\": \"package test\\ndefault allow := true\",\n                \"input\": {\n                    \"name\": \"Test <script>alert('xss')</script>\",\n                    \"description\": \"Contains 'quotes' and \\\"double quotes\\\"\",\n                },\n            },\n        )\n\n        assert response.status_code == 200\n\n    def test_evaluate_with_unicode_input(self, app_with_mock_opa):\n        \"\"\"Test evaluation with Unicode characters in input.\"\"\"\n        response = app_with_mock_opa.post(\n            \"/api/evaluate\",\n            json={\n                \"policy\": \"package test\\ndefault allow := true\",\n                \"input\": {\n                    \"name\": \"Test User\",\n                    \"greeting\": \"Hello World\",\n                },\n            },\n        )\n\n        assert response.status_code == 200\n\n    def test_validate_policy_with_comments(self, app_with_mock_opa):\n        \"\"\"Test validation with policy containing comments.\"\"\"\n        policy_with_comments = \"\"\"package test\n# This is a comment\ndefault allow := false\n\n# Another comment\nallow {\n    input.user == \"admin\"  # inline comment\n}\n\"\"\"\n        response = app_with_mock_opa.post(\n            \"/api/validate\",\n            json={\"policy\": policy_with_comments},\n        )\n\n        assert response.status_code == 200\n\n\n# =============================================================================\n# Example Content Tests\n# =============================================================================\n\n\nclass TestExampleContent:\n    \"\"\"Tests for example policy content quality.\"\"\"\n\n    def test_examples_have_test_input(self, app_with_mock_opa):\n        \"\"\"Test all examples have test_input field with data.\"\"\"\n        response = app_with_mock_opa.get(\"/api/examples\")\n\n        assert response.status_code == 200\n        data = response.json()\n\n        for example in data:\n            assert (\n                example[\"test_input\"] is not None\n            ), f\"Example '{example['id']}' missing test_input\"\n            # test_input should be a dict (can be empty but should exist)\n            assert isinstance(\n                example[\"test_input\"], dict\n            ), f\"Example '{example['id']}' test_input is not a dict\"\n\n    def test_examples_have_expected_result(self, app_with_mock_opa):\n        \"\"\"Test all examples have expected_result field.\"\"\"\n        response = app_with_mock_opa.get(\"/api/examples\")\n\n        assert response.status_code == 200\n        data = response.json()\n\n        for example in data:\n            assert (\n                example[\"expected_result\"] is not None\n            ), f\"Example '{example['id']}' missing expected_result\"\n\n    def test_examples_have_explanation(self, app_with_mock_opa):\n        \"\"\"Test all examples have non-empty explanation.\"\"\"\n        response = app_with_mock_opa.get(\"/api/examples\")\n\n        assert response.status_code == 200\n        data = response.json()\n\n        for example in data:\n            assert example[\n                \"explanation\"\n            ].strip(), f\"Example '{example['id']}' has empty explanation\"\n\n    def test_examples_have_valid_difficulty(self, app_with_mock_opa):\n        \"\"\"Test all examples have valid difficulty level.\"\"\"\n        valid_difficulties = [\"beginner\", \"intermediate\", \"advanced\"]\n\n        response = app_with_mock_opa.get(\"/api/examples\")\n\n        assert response.status_code == 200\n        data = response.json()\n\n        for example in data:\n            assert (\n                example[\"difficulty\"] in valid_difficulties\n            ), f\"Example '{example['id']}' has invalid difficulty '{example['difficulty']}'\"\n\n\nif __name__ == \"__main__\":\n    pytest.main([__file__, \"-v\"])\n",
        "timestamp": "2026-01-04T05:35:58.374613"
      },
      "worktree_state": null,
      "task_intent": {
        "title": "056-reduce-excessive-any-type-usage-in-python-codebase",
        "description": "Found 373 occurrences of ': Any' type annotations across 120+ Python files, with high concentrations in integration-service (16 occurrences), acgs2-core/breakthrough (79 occurrences), and acgs2-core/enhanced_agent_bus (50+ occurrences). Excessive use of 'Any' defeats the purpose of type hints and can mask type-related bugs.",
        "from_plan": true
      },
      "commits_behind_main": 0,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2026-01-03T19:36:18.273884",
  "last_updated": "2026-01-04T05:35:59.129830"
}