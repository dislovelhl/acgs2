{
  "file_path": "analytics-dashboard/src/components/charts/AreaChart.tsx",
  "main_branch_history": [],
  "task_views": {
    "052-replace-recharts-with-lightweight-chart-library": {
      "task_id": "052-replace-recharts-with-lightweight-chart-library",
      "branch_point": {
        "commit_hash": "fc6e42927298263034acf989773f3200e422ad17",
        "content": "/**\n * AreaChart Component\n *\n * A reusable area chart component using visx primitives.\n * Supports area bands (y0 to y1) with gradients and custom styling.\n *\n * Features:\n * - Area band rendering (between two y values)\n * - Gradient fills\n * - Interactive tooltips\n * - Time or linear scales\n * - Customizable axes\n */\n\nimport { useMemo, useCallback } from 'react';\nimport { AreaClosed, Bar, Line } from '@visx/shape';\nimport { scaleTime, scaleLinear } from '@visx/scale';\nimport { AxisBottom, AxisLeft } from '@visx/axis';\nimport { LinearGradient } from '@visx/gradient';\nimport { useTooltip, TooltipWithBounds, defaultStyles } from '@visx/tooltip';\nimport { localPoint } from '@visx/event';\nimport { bisector } from 'd3-array';\nimport type { DataPoint, ChartMargin, AxisConfig } from './types';\n\nconst DEFAULT_MARGIN: ChartMargin = { top: 10, right: 10, left: 40, bottom: 30 };\n\nconst tooltipStyles = {\n  ...defaultStyles,\n  backgroundColor: 'white',\n  border: '1px solid #E5E7EB',\n  borderRadius: '0.5rem',\n  padding: '0.75rem',\n  fontSize: '0.875rem',\n};\n\nexport interface AreaChartProps<T extends DataPoint = DataPoint> {\n  /** Chart data */\n  data: T[];\n  /** Chart width in pixels */\n  width: number;\n  /** Chart height in pixels */\n  height: number;\n  /** Data key for x-axis (should be Date or number) */\n  xKey: keyof T | string;\n  /** Data key for bottom of area (y0) */\n  y0Key: keyof T | string;\n  /** Data key for top of area (y1) */\n  y1Key: keyof T | string;\n  /** Fill color or gradient ID (e.g., \"url(#gradient)\") */\n  fill?: string;\n  /** Stroke color for area outline */\n  stroke?: string;\n  /** Stroke width */\n  strokeWidth?: number;\n  /** Chart margins */\n  margin?: Partial<ChartMargin>;\n  /** X-axis configuration */\n  xAxis?: AxisConfig;\n  /** Y-axis configuration */\n  yAxis?: AxisConfig;\n  /** Custom tooltip renderer */\n  tooltip?: (data: T) => React.ReactNode;\n  /** Scale type for x-axis */\n  xScaleType?: 'time' | 'linear';\n  /** Gradient configuration */\n  gradient?: {\n    id: string;\n    from: string;\n    to: string;\n    fromOpacity?: number;\n    toOpacity?: number;\n  };\n  /** Show grid lines */\n  showGrid?: boolean;\n  /** Grid color */\n  gridColor?: string;\n}\n\n/**\n * AreaChart - Renders an area chart with band between y0 and y1\n *\n * Supports gradient fills, time-based and linear x-axes,\n * and interactive tooltips.\n */\nexport function AreaChart<T extends DataPoint = DataPoint>({\n  data,\n  width,\n  height,\n  xKey,\n  y0Key,\n  y1Key,\n  fill = '#8B5CF6',\n  stroke = 'none',\n  strokeWidth = 0,\n  margin: marginOverride,\n  xAxis = {},\n  yAxis = {},\n  tooltip: customTooltip,\n  xScaleType = 'time',\n  gradient,\n  showGrid = false,\n  gridColor = '#E5E7EB',\n}: AreaChartProps<T>): JSX.Element {\n  const margin = { ...DEFAULT_MARGIN, ...marginOverride };\n\n  const {\n    showTooltip,\n    hideTooltip,\n    tooltipData,\n    tooltipLeft = 0,\n    tooltipTop = 0,\n  } = useTooltip<T>();\n\n  // Calculate bounds\n  const xMax = width - margin.left - margin.right;\n  const yMax = height - margin.top - margin.bottom;\n\n  // Get accessor function for x values\n  const getX = useCallback((d: T) => {\n    const value = d[xKey as keyof T];\n    if (value instanceof Date) return value;\n    if (typeof value === 'number') return value;\n    if (typeof value === 'string') return new Date(value);\n    return new Date();\n  }, [xKey]);\n\n  // Create scales\n  const xScale = useMemo(() => {\n    const domain = [\n      Math.min(...data.map((d) => {\n        const val = getX(d);\n        return val instanceof Date ? val.getTime() : val;\n      })),\n      Math.max(...data.map((d) => {\n        const val = getX(d);\n        return val instanceof Date ? val.getTime() : val;\n      })),\n    ];\n\n    if (xScaleType === 'time') {\n      return scaleTime({\n        domain,\n        range: [0, xMax],\n      });\n    }\n\n    return scaleLinear({\n      domain,\n      range: [0, xMax],\n    });\n  }, [data, xMax, xScaleType, getX]);\n\n  const yScale = useMemo(() => {\n    const allValues = data.flatMap((d) => {\n      const y0 = d[y0Key as keyof T];\n      const y1 = d[y1Key as keyof T];\n      return [\n        typeof y0 === 'number' ? y0 : 0,\n        typeof y1 === 'number' ? y1 : 0,\n      ];\n    });\n\n    let domain: [number, number];\n    if (yAxis.domain) {\n      const [min, max] = yAxis.domain;\n      domain = [\n        min === 'auto' || min === 'dataMin' ? Math.min(...allValues) : min,\n        max === 'auto' || max === 'dataMax' ? Math.max(...allValues) : max,\n      ];\n    } else {\n      domain = [Math.min(...allValues), Math.max(...allValues)];\n    }\n\n    return scaleLinear({\n      domain,\n      range: [yMax, 0],\n      nice: true,\n    });\n  }, [data, y0Key, y1Key, yMax, yAxis.domain]);\n\n  // Bisector for finding nearest data point\n  const bisectDate = useMemo(\n    () => bisector<T, Date | number>((d) => {\n      const val = getX(d);\n      return val instanceof Date ? val.getTime() : val;\n    }).left,\n    [getX]\n  );\n\n  // Handle mouse move for tooltip\n  const handleTooltip = useCallback(\n    (event: React.TouchEvent<SVGRectElement> | React.MouseEvent<SVGRectElement>) => {\n      const { x } = localPoint(event) || { x: 0 };\n      const x0Val = xScale.invert(x - margin.left);\n      const x0 = x0Val instanceof Date ? x0Val : new Date(x0Val);\n      const index = bisectDate(data, x0, 1);\n      const d0 = data[index - 1];\n      const d1 = data[index];\n      let d = d0;\n      if (d1) {\n        const x0Time = x0 instanceof Date ? x0.getTime() : x0;\n        const d0X = getX(d0);\n        const d1X = getX(d1);\n        const d0Time = d0X instanceof Date ? d0X.getTime() : d0X;\n        const d1Time = d1X instanceof Date ? d1X.getTime() : d1X;\n        d = x0Time - d0Time > d1Time - x0Time ? d1 : d0;\n      }\n\n      const xValue = getX(d);\n      const xPos = xValue instanceof Date ? xScale(xValue) : xScale(xValue);\n\n      // Use middle of area for Y position\n      const y0Value = d[y0Key as keyof T];\n      const y1Value = d[y1Key as keyof T];\n      const y0Num = typeof y0Value === 'number' ? y0Value : 0;\n      const y1Num = typeof y1Value === 'number' ? y1Value : 0;\n      const yPos = yScale((y0Num + y1Num) / 2);\n\n      showTooltip({\n        tooltipData: d,\n        tooltipLeft: xPos,\n        tooltipTop: yPos,\n      });\n    },\n    [showTooltip, xScale, yScale, data, bisectDate, margin.left, y0Key, y1Key, getX]\n  );\n\n  // Default tooltip renderer\n  const renderTooltip = useCallback((data: T) => {\n    if (customTooltip) {\n      return customTooltip(data);\n    }\n\n    const y0 = data[y0Key as keyof T];\n    const y1 = data[y1Key as keyof T];\n\n    return (\n      <div>\n        <div className=\"space-y-1 text-xs\">\n          <div className=\"flex items-center justify-between gap-4\">\n            <span className=\"text-gray-600\">Range:</span>\n            <span className=\"font-semibold text-gray-700\">\n              {typeof y0 === 'number' ? y0.toFixed(2) : y0} -{' '}\n              {typeof y1 === 'number' ? y1.toFixed(2) : y1}\n            </span>\n          </div>\n        </div>\n      </div>\n    );\n  }, [customTooltip, y0Key, y1Key]);\n\n  const fillValue = gradient ? `url(#${gradient.id})` : fill;\n\n  return (\n    <div style={{ position: 'relative' }}>\n      <svg width={width} height={height}>\n        {/* Gradient definition */}\n        {gradient && (\n          <LinearGradient\n            id={gradient.id}\n            from={gradient.from}\n            to={gradient.to}\n            fromOpacity={gradient.fromOpacity ?? 0.2}\n            toOpacity={gradient.toOpacity ?? 0.05}\n            vertical\n          />\n        )}\n\n        <g transform={`translate(${margin.left},${margin.top})`}>\n          {/* Grid lines */}\n          {showGrid && (\n            <g>\n              {yScale.ticks(5).map((tick, i) => (\n                <Line\n                  key={`grid-${i}`}\n                  from={{ x: 0, y: yScale(tick) }}\n                  to={{ x: xMax, y: yScale(tick) }}\n                  stroke={gridColor}\n                  strokeWidth={1}\n                  strokeDasharray=\"2 2\"\n                />\n              ))}\n            </g>\n          )}\n\n          {/* Area */}\n          <AreaClosed\n            data={data}\n            x={(d) => {\n              const xValue = getX(d);\n              return xValue instanceof Date ? xScale(xValue) : xScale(xValue);\n            }}\n            y0={(d) => {\n              const value = d[y0Key as keyof T];\n              return typeof value === 'number' ? yScale(value) : 0;\n            }}\n            y1={(d) => {\n              const value = d[y1Key as keyof T];\n              return typeof value === 'number' ? yScale(value) : 0;\n            }}\n            fill={fillValue}\n            stroke={stroke}\n            strokeWidth={strokeWidth}\n          />\n\n          {/* Active indicator on hover */}\n          {tooltipData && (\n            <circle\n              cx={tooltipLeft}\n              cy={tooltipTop}\n              r={4}\n              fill={fill}\n              stroke=\"white\"\n              strokeWidth={2}\n              pointerEvents=\"none\"\n            />\n          )}\n\n          {/* X-axis */}\n          {(xAxis.show !== false) && (\n            <AxisBottom\n              top={yMax}\n              scale={xScale}\n              stroke={xAxis.stroke || '#E5E7EB'}\n              tickStroke={xAxis.tickStroke || 'transparent'}\n              tickFormat={xAxis.tickFormatter as ((value: Date | { valueOf(): number }) => string) | undefined}\n              tickLabelProps={() => ({\n                fill: xAxis.tickColor || '#6B7280',\n                fontSize: xAxis.tickFontSize || 11,\n                textAnchor: 'middle',\n              })}\n            />\n          )}\n\n          {/* Y-axis */}\n          {(yAxis.show !== false) && (\n            <AxisLeft\n              scale={yScale}\n              stroke={yAxis.stroke || '#E5E7EB'}\n              tickStroke={yAxis.tickStroke || 'transparent'}\n              tickFormat={yAxis.tickFormatter as ((value: number | { valueOf(): number }) => string) | undefined}\n              tickLabelProps={() => ({\n                fill: yAxis.tickColor || '#6B7280',\n                fontSize: yAxis.tickFontSize || 11,\n                textAnchor: 'end',\n                dx: -4,\n              })}\n            />\n          )}\n\n          {/* Invisible overlay for tooltip */}\n          <Bar\n            x={0}\n            y={0}\n            width={xMax}\n            height={yMax}\n            fill=\"transparent\"\n            onTouchStart={handleTooltip}\n            onTouchMove={handleTooltip}\n            onMouseMove={handleTooltip}\n            onMouseLeave={hideTooltip}\n          />\n        </g>\n      </svg>\n\n      {/* Tooltip */}\n      {tooltipData && (\n        <TooltipWithBounds\n          key={Math.random()}\n          top={tooltipTop + margin.top}\n          left={tooltipLeft + margin.left}\n          style={tooltipStyles}\n        >\n          {renderTooltip(tooltipData)}\n        </TooltipWithBounds>\n      )}\n    </div>\n  );\n}\n\nexport default AreaChart;\n",
        "timestamp": "2026-01-04T05:36:13.611399"
      },
      "worktree_state": null,
      "task_intent": {
        "title": "052-replace-recharts-with-lightweight-chart-library",
        "description": "Replace recharts (~500KB unparsed, ~150KB gzipped) with a lightweight charting library like visx (~40KB) or uPlot (~30KB) to reduce bundle size and improve dashboard performance. Used in PredictionWidget (analytics-dashboard) and MetricsChart (observability dashboard).",
        "from_plan": true
      },
      "commits_behind_main": 0,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2026-01-03T19:36:23.197365",
  "last_updated": "2026-01-04T05:36:13.643369"
}