{
  "file_path": "src/core/services/hitl_approvals/main.py",
  "main_branch_history": [],
  "task_views": {
    "060-document-error-codes-and-troubleshooting-for-commo": {
      "task_id": "060-document-error-codes-and-troubleshooting-for-commo",
      "branch_point": {
        "commit_hash": "fc6e42927298263034acf989773f3200e422ad17",
        "content": "\"\"\"Constitutional Hash: cdd01ef066bc6cf2\nHITL Approvals Service - Main FastAPI Application\n\nHuman-in-the-Loop approval workflow engine for ACGS-2 AI governance.\n\"\"\"\n\nimport logging\nfrom contextlib import asynccontextmanager\n\nfrom fastapi import FastAPI\nfrom fastapi.middleware.cors import CORSMiddleware\nfrom fastapi.middleware.trustedhost import TrustedHostMiddleware\n\nfrom app.api.routes import router\nfrom app.config.settings import settings\nfrom app.core.approval_chain import approval_engine\nfrom app.notifications.base import notification_manager\nfrom app.notifications.pagerduty import PagerDutyProvider\nfrom app.notifications.slack import SlackProvider\nfrom app.notifications.teams import TeamsProvider\nfrom shared.logging import create_correlation_middleware, init_service_logging\nfrom shared.metrics import create_metrics_endpoint, set_service_info\n\n# Initialize structured logging\n\nlogger = init_service_logging(\"hitl-approvals\")\n\nlogger = logging.getLogger(__name__)\n\n\nfrom app.database import Base, engine\n\n\n@asynccontextmanager\nasync def lifespan(app: FastAPI):\n    \"\"\"Application lifespan context manager\"\"\"\n    # Startup\n    logger.info(\"Starting HITL Approvals Service...\")\n\n    try:\n        # Initialize database\n        async with engine.begin() as conn:\n            # TODO: Use Alembic for migrations in production\n            await conn.run_sync(Base.metadata.create_all)\n        logger.info(\"Database initialized\")\n\n        # Initialize approval chain engine\n        await approval_engine.initialize()\n        logger.info(\"Approval chain engine initialized\")\n\n        # Initialize notification providers\n        await initialize_notifications()\n        logger.info(\"Notification providers initialized\")\n\n        logger.info(\"HITL Approvals Service started successfully\")\n\n    except Exception as e:\n        logger.error(f\"Failed to start HITL Approvals Service: {e}\")\n        raise\n\n    yield\n\n    # Shutdown\n    logger.info(\"Shutting down HITL Approvals Service...\")\n\n    try:\n        await approval_engine.shutdown()\n        logger.info(\"Approval chain engine shutdown complete\")\n\n        # Close notification provider connections\n        await shutdown_notifications()\n        logger.info(\"Notification providers shutdown complete\")\n\n        logger.info(\"HITL Approvals Service shutdown complete\")\n\n    except Exception as e:\n        logger.error(f\"Error during shutdown: {e}\")\n\n\nasync def initialize_notifications():\n    \"\"\"Initialize notification providers\"\"\"\n    # Slack provider\n    if settings.notifications.slack_webhook_url:\n        slack_provider = SlackProvider(\n            {\n                \"webhook_url\": settings.notifications.slack_webhook_url,\n                \"retry_attempts\": settings.notifications.notification_retry_attempts,\n                \"retry_delay\": settings.notifications.notification_retry_delay,\n            }\n        )\n        notification_manager.register_provider(\"slack\", slack_provider)\n        logger.info(\"Slack notification provider configured\")\n    else:\n        logger.warning(\"Slack webhook URL not configured, Slack notifications disabled\")\n\n    # Microsoft Teams provider\n    if settings.notifications.ms_teams_webhook_url:\n        teams_provider = TeamsProvider(\n            {\n                \"webhook_url\": settings.notifications.ms_teams_webhook_url,\n                \"retry_attempts\": settings.notifications.notification_retry_attempts,\n                \"retry_delay\": settings.notifications.notification_retry_delay,\n            }\n        )\n        notification_manager.register_provider(\"teams\", teams_provider)\n        logger.info(\"Microsoft Teams notification provider configured\")\n    else:\n        logger.warning(\"Microsoft Teams webhook URL not configured, Teams notifications disabled\")\n\n    # PagerDuty provider\n    if settings.notifications.pagerduty_routing_key:\n        pagerduty_provider = PagerDutyProvider(\n            {\n                \"routing_key\": settings.notifications.pagerduty_routing_key,\n                \"retry_attempts\": settings.notifications.notification_retry_attempts,\n                \"retry_delay\": settings.notifications.notification_retry_delay,\n            }\n        )\n        notification_manager.register_provider(\"pagerduty\", pagerduty_provider)\n        logger.info(\"PagerDuty notification provider configured\")\n    else:\n        logger.warning(\"PagerDuty routing key not configured, PagerDuty notifications disabled\")\n\n    configured_providers = notification_manager.get_configured_providers()\n    logger.info(f\"Configured notification providers: {configured_providers}\")\n\n\nasync def shutdown_notifications():\n    \"\"\"Shutdown notification providers\"\"\"\n    for provider_name, provider in notification_manager.providers.items():\n        try:\n            if hasattr(provider, \"close\"):\n                await provider.close()\n                logger.debug(f\"Closed notification provider: {provider_name}\")\n        except Exception as e:\n            logger.error(f\"Error closing notification provider {provider_name}: {e}\")\n\n\n# Create FastAPI application\napp = FastAPI(\n    title=\"HITL Approvals Service\",\n    description=\"Human-in-the-Loop approval workflow engine for ACGS-2 AI governance\",\n    version=settings.service_version,\n    lifespan=lifespan,\n    docs_url=\"/docs\",\n    redoc_url=\"/redoc\",\n)\n\n# Configure CORS based on environment for security\nimport os\n\ncors_origins = os.getenv(\"CORS_ALLOWED_ORIGINS\", \"\").split(\",\")\nif not cors_origins or cors_origins == [\"\"]:\n    # Default secure configuration - no external origins allowed\n    cors_origins = []\n\n# Allow localhost for development (but not in production)\nif os.getenv(\"ENVIRONMENT\", \"\").lower() == \"development\":\n    cors_origins.extend(\n        [\n            \"http://localhost:3000\",\n            \"http://localhost:8080\",\n            \"http://127.0.0.1:3000\",\n            \"http://127.0.0.1:8080\",\n        ]\n    )\n\nlogger.info(f\"CORS configured with origins: {cors_origins}\")\n\n# Add middleware with secure CORS configuration\napp.add_middleware(\n    CORSMiddleware,\n    allow_origins=cors_origins,\n    allow_credentials=True,\n    allow_methods=[\"GET\", \"POST\", \"PUT\", \"DELETE\", \"OPTIONS\"],\n    allow_headers=[\"Authorization\", \"Content-Type\", \"X-Correlation-ID\"],\n)\n\napp.add_middleware(\n    TrustedHostMiddleware,\n    allowed_hosts=[\"*\"],  # Configure appropriately for production\n)\n\n# Add correlation ID middleware\napp.middleware(\"http\")(create_correlation_middleware())\n\n# Initialize metrics\nset_service_info(\"hitl-approvals\", settings.service_version)\n\n# Add metrics endpoint\napp.add_api_route(\"/metrics\", create_metrics_endpoint())\n\n# Include API routes\napp.include_router(router, prefix=\"/hitl/approvals\", tags=[\"approvals\"])\n\nfrom app.api.ui import router as ui_router\n\n# Include web interface routes (no prefix for web interface)\nfrom app.api.web_interface import router as web_router\n\napp.include_router(web_router, tags=[\"web-interface\"])\napp.include_router(ui_router, tags=[\"mobile-ui\"])\n\n\n@app.get(\"/\")\nasync def root():\n    \"\"\"Root endpoint\"\"\"\n    return {\n        \"service\": \"HITL Approvals Service\",\n        \"version\": settings.service_version,\n        \"status\": \"running\",\n        \"configured_providers\": notification_manager.get_configured_providers(),\n    }\n\n\nif __name__ == \"__main__\":\n    import uvicorn\n\n    uvicorn.run(\n        \"main:app\", host=settings.host, port=settings.port, reload=settings.debug, log_level=\"info\"\n    )\n",
        "timestamp": "2026-01-04T05:35:51.134105"
      },
      "worktree_state": null,
      "task_intent": {
        "title": "060-document-error-codes-and-troubleshooting-for-commo",
        "description": "The codebase has 13 TODO/FIXME comments across critical files including webhooks.py, approval_chain_engine.py, and config_validator.py. Additionally, there's no centralized documentation for error codes, failure modes, or troubleshooting guides. Users encountering errors have no reference for resolution.",
        "from_plan": true
      },
      "commits_behind_main": 0,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2026-01-03T19:36:08.648367",
  "last_updated": "2026-01-04T05:35:51.178768"
}