{
  "file_path": "acgs2-core/services/compliance_docs/tests/test_security_headers.py",
  "main_branch_history": [],
  "task_views": {
    "046-add-security-headers-middleware-to-fastapi-service": {
      "task_id": "046-add-security-headers-middleware-to-fastapi-service",
      "branch_point": {
        "commit_hash": "4a99fe22e8e0087919301b1aa185d4e2c6da716c",
        "content": "",
        "timestamp": "2026-01-03T19:07:31.669524"
      },
      "worktree_state": {
        "content": "\"\"\"\nIntegration tests for security headers in compliance-docs service.\n\nTests verify:\n- All six security headers are present on all HTTP responses\n- GET /health endpoint returns security headers\n- GET /ready endpoint returns security headers\n- GET / root endpoint returns security headers\n- POST endpoints return security headers\n- Strict CSP configuration appropriate for documentation service\n- Security headers work alongside CORS middleware\n\nConstitutional Hash: cdd01ef066bc6cf2\n\"\"\"\n\nimport sys\nfrom pathlib import Path\n\nimport pytest\nfrom fastapi.testclient import TestClient\n\n# Add paths for imports\nsys.path.insert(0, str(Path(__file__).parent.parent.parent.parent))\n\nfrom services.compliance_docs.src.main import app  # noqa: E402\n\n# ============================================================================\n# Fixtures\n# ============================================================================\n\n\n@pytest.fixture\ndef client() -> TestClient:\n    \"\"\"Create a test client for the compliance-docs service.\"\"\"\n    return TestClient(app)\n\n\n# ============================================================================\n# Basic Security Headers Tests\n# ============================================================================\n\n\nclass TestSecurityHeadersPresence:\n    \"\"\"Test that all security headers are present on responses.\"\"\"\n\n    def test_health_endpoint_has_all_security_headers(self, client: TestClient):\n        \"\"\"Test GET /health endpoint returns all six security headers.\"\"\"\n        response = client.get(\"/health\")\n\n        # Verify response is successful\n        assert response.status_code == 200\n\n        # Verify all 6 security headers are present\n        assert \"Content-Security-Policy\" in response.headers\n        assert \"X-Content-Type-Options\" in response.headers\n        assert \"X-Frame-Options\" in response.headers\n        assert \"Strict-Transport-Security\" in response.headers\n        assert \"X-XSS-Protection\" in response.headers\n        assert \"Referrer-Policy\" in response.headers\n\n    def test_ready_endpoint_has_all_security_headers(self, client: TestClient):\n        \"\"\"Test GET /ready endpoint returns all six security headers.\"\"\"\n        response = client.get(\"/ready\")\n\n        # Verify response is successful\n        assert response.status_code == 200\n\n        # Verify all 6 security headers are present\n        assert \"Content-Security-Policy\" in response.headers\n        assert \"X-Content-Type-Options\" in response.headers\n        assert \"X-Frame-Options\" in response.headers\n        assert \"Strict-Transport-Security\" in response.headers\n        assert \"X-XSS-Protection\" in response.headers\n        assert \"Referrer-Policy\" in response.headers\n\n    def test_root_endpoint_has_all_security_headers(self, client: TestClient):\n        \"\"\"Test GET / root endpoint returns all six security headers.\"\"\"\n        response = client.get(\"/\")\n\n        # Verify response is successful\n        assert response.status_code == 200\n\n        # Verify all 6 security headers are present\n        assert \"Content-Security-Policy\" in response.headers\n        assert \"X-Content-Type-Options\" in response.headers\n        assert \"X-Frame-Options\" in response.headers\n        assert \"Strict-Transport-Security\" in response.headers\n        assert \"X-XSS-Protection\" in response.headers\n        assert \"Referrer-Policy\" in response.headers\n\n    def test_docs_endpoint_has_security_headers(self, client: TestClient):\n        \"\"\"Test GET /docs endpoint returns security headers.\"\"\"\n        response = client.get(\"/docs\")\n\n        # Verify all 6 security headers are present\n        assert \"Content-Security-Policy\" in response.headers\n        assert \"X-Content-Type-Options\" in response.headers\n        assert \"X-Frame-Options\" in response.headers\n        assert \"Strict-Transport-Security\" in response.headers\n        assert \"X-XSS-Protection\" in response.headers\n        assert \"Referrer-Policy\" in response.headers\n\n    def test_euaiact_validation_endpoint_has_security_headers(self, client: TestClient):\n        \"\"\"Test POST /api/v1/euaiact/validate endpoint returns security headers.\"\"\"\n        # Test EU AI Act validation endpoint\n        response = client.post(\n            \"/api/v1/euaiact/validate\",\n            json={\n                \"system_name\": \"test-system\",\n                \"system_version\": \"1.0.0\",\n                \"high_risk_category\": \"BIOMETRIC_IDENTIFICATION\",\n                \"system_description\": \"Test system\",\n                \"context\": {},\n            },\n        )\n\n        # Verify security headers are present regardless of response status\n        assert \"Content-Security-Policy\" in response.headers\n        assert \"X-Content-Type-Options\" in response.headers\n        assert \"X-Frame-Options\" in response.headers\n        assert \"Strict-Transport-Security\" in response.headers\n        assert \"X-XSS-Protection\" in response.headers\n        assert \"Referrer-Policy\" in response.headers\n\n\n# ============================================================================\n# Specific Security Headers Tests\n# ============================================================================\n\n\nclass TestIndividualSecurityHeaders:\n    \"\"\"Test individual security header values.\"\"\"\n\n    def test_content_security_policy_header(self, client: TestClient):\n        \"\"\"Test Content-Security-Policy header is properly configured with strict settings.\"\"\"\n        response = client.get(\"/\")\n\n        csp = response.headers.get(\"Content-Security-Policy\")\n        assert csp is not None\n\n        # Verify CSP contains strict base directives\n        assert \"default-src 'self'\" in csp\n        assert \"script-src 'self'\" in csp\n        assert \"connect-src 'self'\" in csp\n\n        # Verify strict CSP doesn't allow unsafe directives (no unsafe-inline, unsafe-eval)\n        # These are only allowed in development mode\n        # For production strict mode, these should not be present\n\n    def test_x_content_type_options_header(self, client: TestClient):\n        \"\"\"Test X-Content-Type-Options header prevents MIME sniffing.\"\"\"\n        response = client.get(\"/\")\n\n        assert response.headers.get(\"X-Content-Type-Options\") == \"nosniff\"\n\n    def test_x_frame_options_header(self, client: TestClient):\n        \"\"\"Test X-Frame-Options header prevents clickjacking.\"\"\"\n        response = client.get(\"/\")\n\n        assert response.headers.get(\"X-Frame-Options\") == \"DENY\"\n\n    def test_strict_transport_security_header(self, client: TestClient):\n        \"\"\"Test Strict-Transport-Security header enforces HTTPS with production settings.\"\"\"\n        response = client.get(\"/\")\n\n        hsts = response.headers.get(\"Strict-Transport-Security\")\n        assert hsts is not None\n\n        # Production strict mode should have long max-age\n        assert \"max-age=\" in hsts\n\n        # Should include subdomains\n        assert \"includeSubDomains\" in hsts\n\n        # Should include preload for strict production\n        assert \"preload\" in hsts\n\n    def test_x_xss_protection_header(self, client: TestClient):\n        \"\"\"Test X-XSS-Protection header is set correctly.\"\"\"\n        response = client.get(\"/\")\n\n        assert response.headers.get(\"X-XSS-Protection\") == \"1; mode=block\"\n\n    def test_referrer_policy_header(self, client: TestClient):\n        \"\"\"Test Referrer-Policy header controls referrer information.\"\"\"\n        response = client.get(\"/\")\n\n        assert response.headers.get(\"Referrer-Policy\") == \"strict-origin-when-cross-origin\"\n\n\n# ============================================================================\n# HTTP Method Tests\n# ============================================================================\n\n\nclass TestSecurityHeadersOnDifferentMethods:\n    \"\"\"Test security headers are present across different HTTP methods.\"\"\"\n\n    def test_get_request_has_security_headers(self, client: TestClient):\n        \"\"\"Test GET requests have security headers.\"\"\"\n        response = client.get(\"/health\")\n\n        assert response.status_code == 200\n        assert \"Content-Security-Policy\" in response.headers\n        assert \"X-Content-Type-Options\" in response.headers\n        assert \"X-Frame-Options\" in response.headers\n        assert \"Strict-Transport-Security\" in response.headers\n        assert \"X-XSS-Protection\" in response.headers\n        assert \"Referrer-Policy\" in response.headers\n\n    def test_post_request_has_security_headers(self, client: TestClient):\n        \"\"\"Test POST requests have security headers.\"\"\"\n        response = client.post(\n            \"/api/v1/euaiact/validate\",\n            json={\n                \"system_name\": \"test-system\",\n                \"system_version\": \"1.0.0\",\n                \"high_risk_category\": \"BIOMETRIC_IDENTIFICATION\",\n            },\n        )\n\n        # Verify security headers are present\n        assert \"Content-Security-Policy\" in response.headers\n        assert \"X-Content-Type-Options\" in response.headers\n        assert \"X-Frame-Options\" in response.headers\n        assert \"Strict-Transport-Security\" in response.headers\n        assert \"X-XSS-Protection\" in response.headers\n        assert \"Referrer-Policy\" in response.headers\n\n    def test_options_request_has_security_headers(self, client: TestClient):\n        \"\"\"Test OPTIONS requests (CORS preflight) have security headers.\"\"\"\n        response = client.options(\"/health\")\n\n        # Security headers should be present even on OPTIONS\n        assert \"X-Content-Type-Options\" in response.headers\n        assert \"X-Frame-Options\" in response.headers\n\n\n# ============================================================================\n# Compliance Docs Service Specific CSP Tests\n# ============================================================================\n\n\nclass TestComplianceDocsServiceStrictCSP:\n    \"\"\"Test strict CSP configuration specific to compliance-docs service.\"\"\"\n\n    def test_csp_has_strict_default_src(self, client: TestClient):\n        \"\"\"Test CSP has strict default-src 'self' only.\"\"\"\n        response = client.get(\"/\")\n\n        csp = response.headers.get(\"Content-Security-Policy\")\n        assert csp is not None\n\n        # Strict CSP should only allow 'self'\n        assert \"default-src 'self'\" in csp\n\n    def test_csp_has_strict_script_src(self, client: TestClient):\n        \"\"\"Test CSP has strict script-src without unsafe-inline or unsafe-eval.\"\"\"\n        response = client.get(\"/\")\n\n        csp = response.headers.get(\"Content-Security-Policy\")\n        assert csp is not None\n\n        # Should have script-src 'self'\n        assert \"script-src 'self'\" in csp\n\n    def test_csp_has_strict_connect_src(self, client: TestClient):\n        \"\"\"Test CSP has strict connect-src 'self' only (no external connections).\"\"\"\n        response = client.get(\"/\")\n\n        csp = response.headers.get(\"Content-Security-Policy\")\n        assert csp is not None\n\n        # Strict mode should only allow connections to self (no https: wildcard)\n        assert \"connect-src 'self'\" in csp\n\n    def test_csp_has_frame_ancestors_none(self, client: TestClient):\n        \"\"\"Test CSP has frame-ancestors 'none' for strict protection.\"\"\"\n        response = client.get(\"/\")\n\n        csp = response.headers.get(\"Content-Security-Policy\")\n        assert csp is not None\n\n        # Strict CSP should prevent framing\n        assert \"frame-ancestors 'none'\" in csp\n\n    def test_csp_has_form_action_self(self, client: TestClient):\n        \"\"\"Test CSP restricts form actions to self.\"\"\"\n        response = client.get(\"/\")\n\n        csp = response.headers.get(\"Content-Security-Policy\")\n        assert csp is not None\n\n        # Strict CSP should restrict form submissions\n        assert \"form-action 'self'\" in csp\n\n    def test_csp_allows_data_images(self, client: TestClient):\n        \"\"\"Test CSP allows data: URIs for images (for embedded compliance logos).\"\"\"\n        response = client.get(\"/\")\n\n        csp = response.headers.get(\"Content-Security-Policy\")\n        assert csp is not None\n\n        # Should allow self and data: for images\n        assert \"img-src\" in csp\n        assert \"'self'\" in csp\n        assert \"data:\" in csp\n\n\n# ============================================================================\n# Middleware Integration Tests\n# ============================================================================\n\n\nclass TestSecurityHeadersWithCORS:\n    \"\"\"Test security headers work alongside CORS middleware.\"\"\"\n\n    def test_security_headers_and_cors_headers_coexist(self, client: TestClient):\n        \"\"\"Test both security and CORS headers are present.\"\"\"\n        response = client.get(\"/health\")\n\n        # Security headers should be present\n        assert \"Content-Security-Policy\" in response.headers\n        assert \"X-Content-Type-Options\" in response.headers\n        assert \"X-Frame-Options\" in response.headers\n        assert \"Strict-Transport-Security\" in response.headers\n        assert \"X-XSS-Protection\" in response.headers\n        assert \"Referrer-Policy\" in response.headers\n\n        # CORS headers should also be present (case-insensitive check)\n        headers_lower = {k.lower(): v for k, v in response.headers.items()}\n        assert \"access-control-allow-origin\" in headers_lower\n\n    def test_cors_preflight_has_security_headers(self, client: TestClient):\n        \"\"\"Test CORS preflight OPTIONS requests have security headers.\"\"\"\n        response = client.options(\n            \"/api/v1/euaiact/validate\",\n            headers={\n                \"Origin\": \"http://localhost:3000\",\n                \"Access-Control-Request-Method\": \"POST\",\n            },\n        )\n\n        # Security headers should be present even on preflight\n        assert \"X-Content-Type-Options\" in response.headers\n        assert \"X-Frame-Options\" in response.headers\n\n\n# ============================================================================\n# Edge Cases and Consistency Tests\n# ============================================================================\n\n\nclass TestSecurityHeadersEdgeCases:\n    \"\"\"Test edge cases and consistency of security headers.\"\"\"\n\n    def test_all_endpoints_have_consistent_headers(self, client: TestClient):\n        \"\"\"Test all endpoints have the same security headers.\"\"\"\n        endpoints = [\n            (\"/\", \"GET\"),\n            (\"/health\", \"GET\"),\n            (\"/ready\", \"GET\"),\n            (\"/docs\", \"GET\"),\n        ]\n\n        # Collect headers from all endpoints\n        all_headers = {}\n        for path, method in endpoints:\n            if method == \"GET\":\n                response = client.get(path)\n\n            # Extract security headers\n            security_headers = {\n                \"Content-Security-Policy\": response.headers.get(\"Content-Security-Policy\"),\n                \"X-Content-Type-Options\": response.headers.get(\"X-Content-Type-Options\"),\n                \"X-Frame-Options\": response.headers.get(\"X-Frame-Options\"),\n                \"X-XSS-Protection\": response.headers.get(\"X-XSS-Protection\"),\n                \"Referrer-Policy\": response.headers.get(\"Referrer-Policy\"),\n            }\n            all_headers[path] = security_headers\n\n        # Verify consistency across endpoints\n        # All endpoints should have the same values for headers\n        first_endpoint = list(all_headers.values())[0]\n        for endpoint_headers in all_headers.values():\n            assert (\n                endpoint_headers[\"X-Content-Type-Options\"]\n                == first_endpoint[\"X-Content-Type-Options\"]\n            )\n            assert endpoint_headers[\"X-Frame-Options\"] == first_endpoint[\"X-Frame-Options\"]\n            assert endpoint_headers[\"X-XSS-Protection\"] == first_endpoint[\"X-XSS-Protection\"]\n            assert endpoint_headers[\"Referrer-Policy\"] == first_endpoint[\"Referrer-Policy\"]\n            # CSP should be consistent too\n            assert (\n                endpoint_headers[\"Content-Security-Policy\"]\n                == first_endpoint[\"Content-Security-Policy\"]\n            )\n\n    def test_404_response_has_security_headers(self, client: TestClient):\n        \"\"\"Test 404 responses still have security headers.\"\"\"\n        response = client.get(\"/nonexistent-endpoint\")\n\n        assert response.status_code == 404\n\n        # Security headers should be present even on error responses\n        assert \"Content-Security-Policy\" in response.headers\n        assert \"X-Content-Type-Options\" in response.headers\n        assert \"X-Frame-Options\" in response.headers\n        assert \"Strict-Transport-Security\" in response.headers\n        assert \"X-XSS-Protection\" in response.headers\n        assert \"Referrer-Policy\" in response.headers\n\n    def test_422_validation_error_has_security_headers(self, client: TestClient):\n        \"\"\"Test validation error responses have security headers.\"\"\"\n        # Send invalid request to trigger validation error\n        response = client.post(\"/api/v1/euaiact/validate\", json={})\n\n        # Should get validation error\n        assert response.status_code == 422\n\n        # Even with validation error, security headers should be present\n        assert \"Content-Security-Policy\" in response.headers\n        assert \"X-Content-Type-Options\" in response.headers\n        assert \"X-Frame-Options\" in response.headers\n        assert \"Strict-Transport-Security\" in response.headers\n        assert \"X-XSS-Protection\" in response.headers\n        assert \"Referrer-Policy\" in response.headers\n\n\n# ============================================================================\n# Compliance Verification Tests\n# ============================================================================\n\n\nclass TestSecurityHeadersCompliance:\n    \"\"\"Test compliance with security header requirements.\"\"\"\n\n    def test_all_six_required_headers_present(self, client: TestClient):\n        \"\"\"Test all six required security headers are present.\"\"\"\n        response = client.get(\"/\")\n\n        required_headers = [\n            \"Content-Security-Policy\",\n            \"X-Content-Type-Options\",\n            \"X-Frame-Options\",\n            \"Strict-Transport-Security\",\n            \"X-XSS-Protection\",\n            \"Referrer-Policy\",\n        ]\n\n        for header in required_headers:\n            assert header in response.headers, f\"Missing required header: {header}\"\n\n    def test_headers_have_non_empty_values(self, client: TestClient):\n        \"\"\"Test security headers have non-empty values.\"\"\"\n        response = client.get(\"/\")\n\n        security_headers = [\n            \"Content-Security-Policy\",\n            \"X-Content-Type-Options\",\n            \"X-Frame-Options\",\n            \"Strict-Transport-Security\",\n            \"X-XSS-Protection\",\n            \"Referrer-Policy\",\n        ]\n\n        for header in security_headers:\n            value = response.headers.get(header)\n            assert value is not None, f\"Header {header} is None\"\n            assert len(value) > 0, f\"Header {header} is empty\"\n\n    def test_production_strict_hsts(self, client: TestClient):\n        \"\"\"Test HSTS is configured for strict production with preload.\"\"\"\n        response = client.get(\"/\")\n\n        hsts = response.headers.get(\"Strict-Transport-Security\")\n        assert hsts is not None\n\n        # Extract max-age value\n        max_age_str = None\n        for part in hsts.split(\";\"):\n            part = part.strip()\n            if part.startswith(\"max-age=\"):\n                max_age_str = part.split(\"=\")[1]\n                break\n\n        assert max_age_str is not None\n        max_age = int(max_age_str)\n\n        # Production strict should have max-age = 1 year (31536000 seconds)\n        assert max_age >= 31536000, \"HSTS max-age should be at least 1 year for production\"\n\n        # Should include subdomains\n        assert \"includeSubDomains\" in hsts\n\n        # Should include preload for strict production\n        assert \"preload\" in hsts\n\n    def test_csp_strict_configuration_for_documentation_service(self, client: TestClient):\n        \"\"\"Test CSP is configured with strict settings appropriate for documentation service.\"\"\"\n        response = client.get(\"/\")\n\n        csp = response.headers.get(\"Content-Security-Policy\")\n        assert csp is not None\n\n        # Verify strict production CSP characteristics\n        assert \"default-src 'self'\" in csp\n        assert \"script-src 'self'\" in csp\n        assert \"connect-src 'self'\" in csp\n        assert \"frame-ancestors 'none'\" in csp\n        assert \"form-action 'self'\" in csp\n\n        # Documentation service shouldn't need external resources\n        # Should NOT have https: wildcard in connect-src\n        # (unlike integration-service which needs external API connections)\n\n\n# ============================================================================\n# EU AI Act Endpoint Specific Tests\n# ============================================================================\n\n\nclass TestEUAIActEndpointSecurityHeaders:\n    \"\"\"Test security headers on EU AI Act specific endpoints.\"\"\"\n\n    def test_validate_endpoint_post_has_security_headers(self, client: TestClient):\n        \"\"\"Test POST /api/v1/euaiact/validate has all security headers.\"\"\"\n        response = client.post(\n            \"/api/v1/euaiact/validate\",\n            json={\n                \"system_name\": \"test-ai-system\",\n                \"system_version\": \"2.0.0\",\n                \"high_risk_category\": \"CRITICAL_INFRASTRUCTURE\",\n                \"system_description\": \"Critical infrastructure AI system\",\n                \"context\": {\"deployment\": \"production\"},\n            },\n        )\n\n        # Should return success\n        assert response.status_code == 200\n\n        # Verify all security headers present\n        assert \"Content-Security-Policy\" in response.headers\n        assert \"X-Content-Type-Options\" in response.headers\n        assert \"X-Frame-Options\" in response.headers\n        assert \"Strict-Transport-Security\" in response.headers\n        assert \"X-XSS-Protection\" in response.headers\n        assert \"Referrer-Policy\" in response.headers\n\n    def test_validate_endpoint_response_body_and_headers(self, client: TestClient):\n        \"\"\"Test validation endpoint returns both valid response and security headers.\"\"\"\n        response = client.post(\n            \"/api/v1/euaiact/validate\",\n            json={\n                \"system_name\": \"governance-ai\",\n                \"system_version\": \"1.0.0\",\n                \"high_risk_category\": \"BIOMETRIC_IDENTIFICATION\",\n            },\n        )\n\n        # Should return success with findings\n        assert response.status_code == 200\n        data = response.json()\n        assert \"system_name\" in data\n        assert \"overall_status\" in data\n        assert \"findings\" in data\n\n        # Security headers should be present\n        assert response.headers.get(\"X-Content-Type-Options\") == \"nosniff\"\n        assert response.headers.get(\"X-Frame-Options\") == \"DENY\"\n        assert response.headers.get(\"X-XSS-Protection\") == \"1; mode=block\"\n\n\nif __name__ == \"__main__\":\n    pytest.main([__file__, \"-v\"])\n",
        "last_modified": "2026-01-03T19:08:32.487960"
      },
      "task_intent": {
        "title": "046-add-security-headers-middleware-to-fastapi-service",
        "description": "Multiple FastAPI services (integration-service, compliance-docs, observability dashboard) lack security headers middleware. Missing headers include Content-Security-Policy, X-Content-Type-Options, X-Frame-Options, Strict-Transport-Security, X-XSS-Protection, and Referrer-Policy.",
        "from_plan": true
      },
      "commits_behind_main": 11,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2026-01-03T19:07:31.724245",
  "last_updated": "2026-01-03T19:07:31.736813"
}