{
  "file_path": "src/core/docs/security/SECURITY_HEADERS.md",
  "main_branch_history": [],
  "task_views": {
    "046-add-security-headers-middleware-to-fastapi-service": {
      "task_id": "046-add-security-headers-middleware-to-fastapi-service",
      "branch_point": {
        "commit_hash": "4a99fe22e8e0087919301b1aa185d4e2c6da716c",
        "content": "",
        "timestamp": "2026-01-03T19:07:31.669524"
      },
      "worktree_state": {
        "content": "# ACGS-2 Security Headers Middleware\n\n> **Constitutional Hash**: `cdd01ef066bc6cf2`\n> **Version**: 1.0.0\n> **Last Updated**: 2026-01-03\n> **Module**: `src/core/shared/security/security_headers.py`\n\n## Overview\n\nThe Security Headers Middleware provides enterprise-grade HTTP security headers for all FastAPI services in the ACGS-2 ecosystem. This middleware implements defense-in-depth protection against common web attacks including XSS, clickjacking, MIME sniffing, and downgrade attacks.\n\n## Security Headers Implemented\n\nThe middleware implements six critical security headers:\n\n| Header | Purpose | Default Value |\n|--------|---------|---------------|\n| **Content-Security-Policy** | Controls resource loading to prevent XSS attacks | Configurable per service type |\n| **X-Content-Type-Options** | Prevents MIME sniffing attacks | `nosniff` |\n| **X-Frame-Options** | Prevents clickjacking attacks | `DENY` |\n| **Strict-Transport-Security** | Enforces HTTPS connections | Environment-dependent |\n| **X-XSS-Protection** | Enables browser XSS filtering | `1; mode=block` |\n| **Referrer-Policy** | Controls referrer information leakage | `strict-origin-when-cross-origin` |\n\n## Architecture\n\n```\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                     FastAPI Application                      \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502\n\u2502  \u2502              CORS Middleware (First)                   \u2502 \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502\n\u2502  \u2502         Security Headers Middleware (After CORS)       \u2502 \u2502\n\u2502  \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502 \u2502\n\u2502  \u2502  \u2502  SecurityHeadersConfig                           \u2502  \u2502 \u2502\n\u2502  \u2502  \u2502  - Environment: dev/staging/production           \u2502  \u2502 \u2502\n\u2502  \u2502  \u2502  - CSP Directives: custom per service           \u2502  \u2502 \u2502\n\u2502  \u2502  \u2502  - HSTS Settings: environment-aware             \u2502  \u2502 \u2502\n\u2502  \u2502  \u2502  - Frame Options: DENY/SAMEORIGIN               \u2502  \u2502 \u2502\n\u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502 \u2502\n\u2502  \u2502                                                          \u2502 \u2502\n\u2502  \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502 \u2502\n\u2502  \u2502  \u2502  Response Header Injection                       \u2502  \u2502 \u2502\n\u2502  \u2502  \u2502  - Content-Security-Policy                       \u2502  \u2502 \u2502\n\u2502  \u2502  \u2502  - X-Content-Type-Options                        \u2502  \u2502 \u2502\n\u2502  \u2502  \u2502  - X-Frame-Options                               \u2502  \u2502 \u2502\n\u2502  \u2502  \u2502  - Strict-Transport-Security                     \u2502  \u2502 \u2502\n\u2502  \u2502  \u2502  - X-XSS-Protection                              \u2502  \u2502 \u2502\n\u2502  \u2502  \u2502  - Referrer-Policy                               \u2502  \u2502 \u2502\n\u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502 \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502\n\u2502  \u2502              Application Routes                        \u2502 \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n```\n\n## Configuration Options\n\n### SecurityHeadersConfig\n\nThe `SecurityHeadersConfig` dataclass provides flexible configuration options:\n\n```python\n@dataclass\nclass SecurityHeadersConfig:\n    \"\"\"Configuration for security headers middleware.\"\"\"\n\n    # Environment setting (affects HSTS and CSP)\n    environment: str = \"production\"  # Options: development, staging, production\n\n    # Content Security Policy directives\n    custom_csp_directives: Dict[str, List[str]] = field(default_factory=dict)\n\n    # HSTS (HTTP Strict Transport Security) settings\n    enable_hsts: bool = True\n    hsts_max_age: int = 31536000  # 1 year in seconds\n    hsts_include_subdomains: bool = True\n    hsts_preload: bool = False\n\n    # Frame options\n    frame_options: str = \"DENY\"  # Options: DENY, SAMEORIGIN\n\n    # Referrer policy\n    referrer_policy: str = \"strict-origin-when-cross-origin\"\n\n    # XSS Protection\n    enable_xss_protection: bool = True\n```\n\n### Environment-Specific Behavior\n\nThe middleware automatically adjusts security settings based on the environment:\n\n#### Development Environment\n```python\nconfig = SecurityHeadersConfig.for_development()\n```\n\n- **HSTS**: Disabled (no forced HTTPS)\n- **CSP**: Relaxed policy with `unsafe-inline` and `unsafe-eval` for development tools\n- **Use Case**: Local development, debugging, and testing\n\n**CSP Directives**:\n```\ndefault-src 'self';\nscript-src 'self' 'unsafe-inline' 'unsafe-eval';\nconnect-src 'self';\nimg-src 'self' data: https:;\nstyle-src 'self' 'unsafe-inline'\n```\n\n#### Staging Environment\n```python\nconfig = SecurityHeadersConfig(environment=\"staging\")\n```\n\n- **HSTS**: Enabled with 1-day max-age\n- **CSP**: Moderate security, allows testing\n- **Use Case**: Pre-production testing and QA\n\n**HSTS Header**: `max-age=86400`\n\n#### Production Environment\n```python\nconfig = SecurityHeadersConfig.for_production()\n# or\nconfig = SecurityHeadersConfig.for_production(strict=True)\n```\n\n- **HSTS**: Enabled with 1-year max-age, includeSubDomains, and optional preload\n- **CSP**: Strict policy, no unsafe directives\n- **Use Case**: Production deployments\n\n**HSTS Header (standard)**: `max-age=31536000; includeSubDomains`\n**HSTS Header (strict)**: `max-age=31536000; includeSubDomains; preload`\n\n**CSP Directives (strict)**:\n```\ndefault-src 'self';\nscript-src 'self';\nconnect-src 'self';\nimg-src 'self' data:;\nstyle-src 'self';\nframe-ancestors 'none';\nform-action 'self'\n```\n\n## Service-Specific Configurations\n\n### Integration Service (Webhooks & External APIs)\n\nThe integration service requires external HTTPS connections for webhooks and third-party integrations:\n\n```python\nfrom shared.security import SecurityHeadersConfig, SecurityHeadersMiddleware\n\n# Configure for integration service\nsecurity_config = SecurityHeadersConfig.for_integration_service()\napp.add_middleware(SecurityHeadersMiddleware, config=security_config)\n```\n\n**CSP Directives**:\n```\ndefault-src 'self';\nscript-src 'self';\nconnect-src 'self' https:;  # Allows external HTTPS connections\nimg-src 'self' data: https:  # Allows external images from webhooks\n```\n\n**Files Modified**:\n- `integration-service/src/main.py`\n\n### Compliance Documentation Service\n\nThe compliance docs service uses the strictest security configuration:\n\n```python\nfrom shared.security import SecurityHeadersConfig, SecurityHeadersMiddleware\n\n# Configure strict production security\nsecurity_config = SecurityHeadersConfig.for_production(strict=True)\napp.add_middleware(SecurityHeadersMiddleware, config=security_config)\n```\n\n**CSP Directives**:\n```\ndefault-src 'self';\nscript-src 'self';  # No unsafe-inline, no unsafe-eval\nconnect-src 'self';  # No external connections\nimg-src 'self' data:;\nstyle-src 'self';\nframe-ancestors 'none';  # Cannot be embedded\nform-action 'self'\n```\n\n**Files Modified**:\n- `src/core/services/compliance_docs/src/main.py`\n\n### Observability Dashboard (WebSocket Support)\n\nThe observability dashboard requires WebSocket connections for real-time updates:\n\n```python\nfrom shared.security import SecurityHeadersConfig, SecurityHeadersMiddleware\n\n# Configure for WebSocket service\nsecurity_config = SecurityHeadersConfig.for_websocket_service()\napp.add_middleware(SecurityHeadersMiddleware, config=security_config)\n```\n\n**CSP Directives**:\n```\ndefault-src 'self';\nscript-src 'self';\nconnect-src 'self' ws: wss:;  # Allows WebSocket connections\nimg-src 'self' data:;\nstyle-src 'self'\n```\n\n**Files Modified**:\n- `acgs2-observability/monitoring/dashboard_api.py`\n\n## Adding Middleware to New Services\n\n### Step 1: Import the Middleware\n\nFor services within `src/core`:\n```python\nfrom shared.security import SecurityHeadersConfig, SecurityHeadersMiddleware\n```\n\nFor services outside `src/core` (e.g., `acgs2-observability`):\n```python\nimport sys\nfrom pathlib import Path\n\n# Add src/core to path\ncore_path = Path(__file__).parent.parent / \"src/core\"\nif str(core_path) not in sys.path:\n    sys.path.insert(0, str(core_path))\n\nfrom shared.security import SecurityHeadersConfig, SecurityHeadersMiddleware\n```\n\n### Step 2: Configure the Middleware\n\nChoose the appropriate configuration factory method:\n\n```python\n# For general production services\nconfig = SecurityHeadersConfig.for_production()\n\n# For strict security (documentation, compliance services)\nconfig = SecurityHeadersConfig.for_production(strict=True)\n\n# For services with external API calls\nconfig = SecurityHeadersConfig.for_integration_service()\n\n# For services with WebSocket connections\nconfig = SecurityHeadersConfig.for_websocket_service()\n\n# For development\nconfig = SecurityHeadersConfig.for_development()\n\n# For custom configuration\nconfig = SecurityHeadersConfig(\n    environment=\"production\",\n    custom_csp_directives={\n        \"connect-src\": [\"'self'\", \"https://api.example.com\"],\n        \"img-src\": [\"'self'\", \"data:\", \"https://cdn.example.com\"]\n    },\n    hsts_max_age=63072000,  # 2 years\n    hsts_preload=True,\n    frame_options=\"SAMEORIGIN\"\n)\n```\n\n### Step 3: Add Middleware to FastAPI App\n\n**IMPORTANT**: Add security headers middleware **AFTER** CORS middleware:\n\n```python\nfrom fastapi import FastAPI\nfrom fastapi.middleware.cors import CORSMiddleware\n\napp = FastAPI()\n\n# 1. Add CORS middleware first\napp.add_middleware(\n    CORSMiddleware,\n    allow_origins=[\"*\"],\n    allow_credentials=True,\n    allow_methods=[\"*\"],\n    allow_headers=[\"*\"],\n)\n\n# 2. Add security headers middleware after CORS\nsecurity_config = SecurityHeadersConfig.for_production()\napp.add_middleware(SecurityHeadersMiddleware, config=security_config)\n\n# 3. Add routes\n@app.get(\"/\")\nasync def root():\n    return {\"message\": \"Hello World\"}\n```\n\n### Step 4: Environment-Aware Configuration\n\nUse environment variables to control security settings:\n\n```python\nimport os\n\nenvironment = os.getenv(\"APP_ENV\", \"production\")\n\nif environment == \"development\":\n    security_config = SecurityHeadersConfig.for_development()\nelif environment == \"staging\":\n    security_config = SecurityHeadersConfig(environment=\"staging\")\nelse:  # production\n    security_config = SecurityHeadersConfig.for_production(strict=True)\n\napp.add_middleware(SecurityHeadersMiddleware, config=security_config)\n```\n\n### Step 5: Add Logging (Recommended)\n\n```python\nimport logging\n\nlogger = logging.getLogger(__name__)\n\nsecurity_config = SecurityHeadersConfig.for_production()\napp.add_middleware(SecurityHeadersMiddleware, config=security_config)\nlogger.info(\n    f\"Security headers middleware configured (environment: {environment})\"\n)\n```\n\n## Custom CSP Configuration\n\n### Understanding CSP Directives\n\nContent Security Policy directives control what resources the browser can load:\n\n| Directive | Purpose | Example Values |\n|-----------|---------|----------------|\n| `default-src` | Fallback for other directives | `'self'`, `'none'` |\n| `script-src` | JavaScript sources | `'self'`, `'unsafe-inline'`, `https://cdn.example.com` |\n| `connect-src` | AJAX, WebSocket, EventSource | `'self'`, `https:`, `ws:`, `wss:` |\n| `img-src` | Image sources | `'self'`, `data:`, `https:` |\n| `style-src` | CSS sources | `'self'`, `'unsafe-inline'` |\n| `font-src` | Font sources | `'self'`, `data:` |\n| `frame-src` | IFrame sources | `'self'`, `https://example.com` |\n| `frame-ancestors` | Who can embed this page | `'none'`, `'self'` |\n| `form-action` | Form submission targets | `'self'` |\n| `base-uri` | `<base>` element URLs | `'self'` |\n\n### Adding Custom Directives\n\n```python\n# Example: Allow specific CDN for fonts and images\ncustom_csp = {\n    \"font-src\": [\"'self'\", \"https://fonts.googleapis.com\"],\n    \"img-src\": [\"'self'\", \"data:\", \"https://cdn.example.com\"],\n    \"style-src\": [\"'self'\", \"https://fonts.googleapis.com\"]\n}\n\nconfig = SecurityHeadersConfig(\n    environment=\"production\",\n    custom_csp_directives=custom_csp\n)\n```\n\n### Merging Custom Directives with Defaults\n\nCustom directives **replace** the default directives for that key:\n\n```python\n# Default config for production:\n# connect-src: 'self'\n\n# Custom config:\ncustom_csp = {\n    \"connect-src\": [\"'self'\", \"https://api.example.com\", \"wss://ws.example.com\"]\n}\n\nconfig = SecurityHeadersConfig(\n    environment=\"production\",\n    custom_csp_directives=custom_csp\n)\n\n# Resulting CSP connect-src: 'self' https://api.example.com wss://ws.example.com\n```\n\n### Special CSP Values\n\n- **`'self'`**: Same origin as the document (note the single quotes)\n- **`'none'`**: Don't allow any sources\n- **`'unsafe-inline'`**: Allow inline scripts/styles (not recommended for production)\n- **`'unsafe-eval'`**: Allow eval() and similar functions (not recommended for production)\n- **`data:`**: Allow data: URIs\n- **`https:`**: Allow any HTTPS URL\n- **`ws:`** / **`wss:`**: Allow WebSocket connections (insecure/secure)\n\n## Testing Approach\n\n### Unit Tests\n\nThe security headers middleware includes comprehensive unit tests:\n\n**Test File**: `src/core/shared/security/tests/test_security_headers.py`\n\n**Coverage Areas**:\n- Configuration defaults and customization\n- Environment-specific factory methods\n- CSP header generation\n- HSTS header generation\n- Middleware integration with FastAPI\n- Edge cases and boundary conditions\n- Constitutional compliance\n\n**Running Unit Tests**:\n```bash\ncd src/core\npytest shared/security/tests/test_security_headers.py -v\n```\n\n### Integration Tests\n\nEach service has integration tests to verify security headers on all endpoints:\n\n**Test Files**:\n- `integration-service/tests/test_security_headers.py`\n- `src/core/services/compliance_docs/tests/test_security_headers.py`\n- `acgs2-observability/tests/monitoring/test_dashboard_security.py`\n\n**Coverage Areas**:\n- All 6 security headers present on all endpoints\n- Correct CSP configuration for service type\n- CORS and security headers coexistence\n- Headers on different HTTP methods (GET, POST, OPTIONS)\n- Headers on error responses (404, 500)\n\n**Running Integration Tests**:\n```bash\n# Integration Service\ncd integration-service\npytest tests/test_security_headers.py -v\n\n# Compliance Docs Service\ncd src/core/services/compliance_docs\npytest tests/test_security_headers.py -v\n\n# Observability Dashboard\ncd acgs2-observability\npytest tests/monitoring/test_dashboard_security.py -v\n```\n\n### Manual Testing with cURL\n\n#### Test All Headers are Present\n\n```bash\n# Test integration service\ncurl -I http://localhost:8000/health\n\n# Expected headers:\n# Content-Security-Policy: default-src 'self'; script-src 'self'; connect-src 'self' https:; ...\n# X-Content-Type-Options: nosniff\n# X-Frame-Options: DENY\n# Strict-Transport-Security: max-age=31536000; includeSubDomains\n# X-XSS-Protection: 1; mode=block\n# Referrer-Policy: strict-origin-when-cross-origin\n```\n\n#### Test Specific Header\n\n```bash\n# Test CSP header\ncurl -I http://localhost:8000/health | grep -i content-security-policy\n\n# Test HSTS header\ncurl -I http://localhost:8000/health | grep -i strict-transport-security\n```\n\n#### Test on Different Endpoints\n\n```bash\n# Test on root endpoint\ncurl -I http://localhost:8000/\n\n# Test on API endpoint\ncurl -I http://localhost:8000/api/v1/example\n\n# Test on health endpoint\ncurl -I http://localhost:8000/health\n```\n\n### Browser Developer Tools\n\n1. Open browser Developer Tools (F12)\n2. Navigate to the **Network** tab\n3. Load a page from your service\n4. Click on any request\n5. View the **Headers** section\n6. Verify all 6 security headers are present under **Response Headers**\n\n### Automated Security Scanning\n\nUse security scanning tools to verify headers:\n\n#### Security Headers Checker (securityheaders.com)\n```bash\n# If service is publicly accessible\n# Visit: https://securityheaders.com/?q=https://your-service.com\n```\n\n#### OWASP ZAP\n```bash\n# Run OWASP ZAP against your service\ndocker run -t owasp/zap2docker-stable zap-baseline.py -t http://localhost:8000\n```\n\n## Security Headers Verification Checklist\n\n### Pre-Deployment Checklist\n\n- [ ] **Middleware Imported**: Security headers middleware imported in `main.py`\n- [ ] **Middleware Configured**: Appropriate configuration factory method used\n- [ ] **Middleware Registered**: Middleware added to FastAPI app **after** CORS\n- [ ] **Environment Variable**: `APP_ENV` or equivalent environment variable set\n- [ ] **CSP Customized**: CSP directives customized for service requirements\n- [ ] **HSTS Enabled**: HSTS enabled for staging/production environments\n- [ ] **Logging Added**: Middleware configuration logged on startup\n\n### Testing Checklist\n\n- [ ] **Unit Tests Pass**: All unit tests in `test_security_headers.py` pass\n- [ ] **Integration Tests Pass**: All integration tests for the service pass\n- [ ] **Manual Testing**: Headers verified with cURL or browser dev tools\n- [ ] **All Endpoints**: Headers present on all endpoints (/, /health, /docs, API endpoints)\n- [ ] **All Methods**: Headers present on GET, POST, PUT, DELETE, OPTIONS requests\n- [ ] **Error Responses**: Headers present on 404, 500, and other error responses\n- [ ] **CORS Compatible**: Security headers don't interfere with CORS functionality\n- [ ] **WebSocket Compatible**: (If applicable) WebSocket connections work with security headers\n\n### Header-Specific Checklist\n\n#### Content-Security-Policy (CSP)\n- [ ] CSP header present\n- [ ] `default-src` directive defined\n- [ ] `script-src` appropriate for service (no `unsafe-eval` in production)\n- [ ] `connect-src` allows required external connections\n- [ ] `img-src` allows required image sources\n- [ ] `frame-ancestors` set to `'none'` for non-embeddable services\n- [ ] No `unsafe-inline` or `unsafe-eval` in production (unless absolutely necessary)\n\n#### X-Content-Type-Options\n- [ ] Header present with value `nosniff`\n\n#### X-Frame-Options\n- [ ] Header present with value `DENY` or `SAMEORIGIN`\n- [ ] Value appropriate for service (DENY for non-embeddable, SAMEORIGIN if needed)\n\n#### Strict-Transport-Security (HSTS)\n- [ ] Header present in staging/production environments\n- [ ] Header absent or short max-age in development\n- [ ] `max-age` value appropriate (86400 for staging, 31536000 for production)\n- [ ] `includeSubDomains` directive present in production\n- [ ] `preload` directive present only if registered with browsers\n\n#### X-XSS-Protection\n- [ ] Header present with value `1; mode=block`\n\n#### Referrer-Policy\n- [ ] Header present with value `strict-origin-when-cross-origin` or stricter\n\n### Production Readiness Checklist\n\n- [ ] **All Headers Present**: All 6 security headers present on production service\n- [ ] **Environment Detection**: Production environment correctly detected\n- [ ] **HSTS Production Settings**: HSTS has 1-year max-age and includeSubDomains\n- [ ] **Strict CSP**: CSP does not include unsafe-inline or unsafe-eval\n- [ ] **External Connections**: CSP allows only required external connections\n- [ ] **Frame Protection**: X-Frame-Options set to DENY (or SAMEORIGIN with justification)\n- [ ] **Monitoring**: Security header presence monitored in observability dashboard\n- [ ] **Documentation**: Service-specific CSP requirements documented\n- [ ] **Tests in CI**: Security header tests run in CI/CD pipeline\n- [ ] **Constitutional Compliance**: Constitutional hash (`cdd01ef066bc6cf2`) present\n\n## Troubleshooting\n\n### Headers Not Appearing\n\n**Symptom**: Security headers not present in HTTP responses\n\n**Possible Causes**:\n1. Middleware not registered with FastAPI app\n2. Middleware added before CORS (headers might be overwritten)\n3. Import path incorrect (especially for services outside src/core)\n\n**Solutions**:\n```python\n# 1. Verify middleware is registered\napp.add_middleware(SecurityHeadersMiddleware, config=security_config)\n\n# 2. Ensure middleware is AFTER CORS\napp.add_middleware(CORSMiddleware, ...)  # First\napp.add_middleware(SecurityHeadersMiddleware, ...)  # Second\n\n# 3. Verify import path\nfrom shared.security import SecurityHeadersMiddleware  # For src/core services\n\n# For external services:\nsys.path.insert(0, str(Path(__file__).parent.parent / \"src/core\"))\nfrom shared.security import SecurityHeadersMiddleware\n```\n\n### CSP Blocking Resources\n\n**Symptom**: Browser console shows CSP violations, resources not loading\n\n**Possible Causes**:\n1. CSP too restrictive for service requirements\n2. External resources not whitelisted in CSP\n\n**Solutions**:\n```python\n# Check browser console for CSP violation reports\n# Example: \"Refused to load script from 'https://cdn.example.com' because it violates CSP\"\n\n# Add required sources to CSP\ncustom_csp = {\n    \"script-src\": [\"'self'\", \"https://cdn.example.com\"],\n    \"connect-src\": [\"'self'\", \"https://api.example.com\"]\n}\n\nconfig = SecurityHeadersConfig(\n    environment=\"production\",\n    custom_csp_directives=custom_csp\n)\n```\n\n### WebSocket Connection Fails\n\n**Symptom**: WebSocket connections fail with CSP error\n\n**Solution**:\n```python\n# Use WebSocket configuration\nconfig = SecurityHeadersConfig.for_websocket_service()\n\n# Or add WebSocket to custom CSP\ncustom_csp = {\n    \"connect-src\": [\"'self'\", \"ws:\", \"wss:\"]\n}\n```\n\n### HSTS Issues in Development\n\n**Symptom**: Browser forces HTTPS in development, can't access http://localhost\n\n**Solution**:\n```python\n# Disable HSTS in development\nconfig = SecurityHeadersConfig.for_development()\n# This automatically sets enable_hsts=False\n\n# Or manually disable\nconfig = SecurityHeadersConfig(\n    environment=\"development\",\n    enable_hsts=False\n)\n```\n\n### Frame Embedding Issues\n\n**Symptom**: Service cannot be embedded in iframe when needed\n\n**Solution**:\n```python\n# Change frame-options from DENY to SAMEORIGIN\nconfig = SecurityHeadersConfig(\n    environment=\"production\",\n    frame_options=\"SAMEORIGIN\"\n)\n\n# Or allow specific origins via CSP frame-ancestors\ncustom_csp = {\n    \"frame-ancestors\": [\"'self'\", \"https://trusted-domain.com\"]\n}\n```\n\n## Performance Considerations\n\n### Middleware Overhead\n\nThe security headers middleware has **minimal performance impact**:\n\n- **Response Time**: < 1ms per request\n- **Memory**: ~1KB per configuration instance\n- **CPU**: Negligible (simple string concatenation and header setting)\n\n### Caching\n\nSecurity headers are **not cached** by the middleware. Headers are computed once during configuration and added to every response. This ensures:\n\n- Consistent headers across all responses\n- No stale header issues\n- No memory overhead from caching\n\n### Best Practices\n\n1. **Configure Once**: Create configuration instance once at startup, not per request\n2. **Avoid Dynamic CSP**: Don't generate CSP directives dynamically per request\n3. **Use Factory Methods**: Use provided factory methods (faster than custom config)\n\n```python\n# Good: Configure once at startup\nsecurity_config = SecurityHeadersConfig.for_production()\napp.add_middleware(SecurityHeadersMiddleware, config=security_config)\n\n# Bad: Don't create config in request handler\n@app.middleware(\"http\")\nasync def add_headers(request, call_next):\n    config = SecurityHeadersConfig.for_production()  # \u274c Created per request\n    # ...\n```\n\n## Migration from Other Security Header Solutions\n\n### From Manual Header Setting\n\n**Before**:\n```python\n@app.middleware(\"http\")\nasync def add_security_headers(request: Request, call_next):\n    response = await call_next(request)\n    response.headers[\"X-Content-Type-Options\"] = \"nosniff\"\n    response.headers[\"X-Frame-Options\"] = \"DENY\"\n    response.headers[\"X-XSS-Protection\"] = \"1; mode=block\"\n    # ... more headers\n    return response\n```\n\n**After**:\n```python\nfrom shared.security import SecurityHeadersMiddleware, SecurityHeadersConfig\n\nsecurity_config = SecurityHeadersConfig.for_production()\napp.add_middleware(SecurityHeadersMiddleware, config=security_config)\n```\n\n### From Starlette-Security or Similar\n\n**Before**:\n```python\nfrom starlette_security import SecurityHeadersMiddleware as StarletteSecurityHeaders\n\napp.add_middleware(\n    StarletteSecurityHeaders,\n    content_security_policy=\"default-src 'self'\",\n    strict_transport_security=\"max-age=31536000\"\n)\n```\n\n**After**:\n```python\nfrom shared.security import SecurityHeadersMiddleware, SecurityHeadersConfig\n\nsecurity_config = SecurityHeadersConfig.for_production()\napp.add_middleware(SecurityHeadersMiddleware, config=security_config)\n```\n\n## Environment Variables Reference\n\nThe middleware supports environment-based configuration:\n\n| Variable | Purpose | Default | Example |\n|----------|---------|---------|---------|\n| `APP_ENV` | Environment name | `production` | `development`, `staging`, `production` |\n| `SECURITY_HEADERS_ENV` | Override environment | `None` | `production` |\n| `CSP_CONNECT_SRC` | Custom CSP connect-src | `None` | `'self' https: ws: wss:` |\n| `CSP_SCRIPT_SRC` | Custom CSP script-src | `None` | `'self' https://cdn.example.com` |\n| `HSTS_MAX_AGE` | HSTS max-age in seconds | `31536000` | `63072000` |\n| `HSTS_PRELOAD` | Enable HSTS preload | `false` | `true`, `false` |\n| `FRAME_OPTIONS` | X-Frame-Options value | `DENY` | `DENY`, `SAMEORIGIN` |\n\n### Environment Variable Configuration\n\n```python\nfrom shared.security import SecurityHeadersConfig\n\n# Load configuration from environment variables\nconfig = SecurityHeadersConfig.from_env()\napp.add_middleware(SecurityHeadersMiddleware, config=config)\n```\n\n## Security Considerations\n\n### Defense in Depth\n\nSecurity headers are **one layer** of defense. They should be combined with:\n\n- **Input Validation**: Validate and sanitize all user input\n- **Output Encoding**: Encode output to prevent XSS\n- **Authentication**: Strong authentication mechanisms\n- **Authorization**: Proper access control\n- **HTTPS**: Always use HTTPS in production\n- **Rate Limiting**: Protect against DoS attacks\n- **WAF**: Web Application Firewall for additional protection\n\n### CSP Reporting\n\nTo monitor CSP violations, add a report-uri directive:\n\n```python\ncustom_csp = {\n    \"default-src\": [\"'self'\"],\n    \"report-uri\": [\"/api/csp-report\"]\n}\n\nconfig = SecurityHeadersConfig(\n    environment=\"production\",\n    custom_csp_directives=custom_csp\n)\n```\n\n### HSTS Preloading\n\nBefore enabling HSTS preload:\n\n1. **Test Thoroughly**: Ensure all subdomains support HTTPS\n2. **Commit for Long Term**: HSTS preload is difficult to undo\n3. **Register**: Submit to https://hstspreload.org/\n4. **Monitor**: Check preload list inclusion status\n\n```python\n# Only enable preload after thorough testing\nconfig = SecurityHeadersConfig(\n    environment=\"production\",\n    hsts_max_age=63072000,  # 2 years required for preload\n    hsts_include_subdomains=True,  # Required for preload\n    hsts_preload=True  # Enable preload directive\n)\n```\n\n### Referrer Policy Impact\n\nDifferent referrer policies have different privacy/functionality tradeoffs:\n\n| Policy | Privacy | Analytics | Cross-Origin |\n|--------|---------|-----------|--------------|\n| `no-referrer` | High | \u274c No referrer | \u274c No referrer |\n| `strict-origin-when-cross-origin` | Medium | \u2705 Same-origin | \u2705 Origin only |\n| `no-referrer-when-downgrade` | Low | \u2705 Full referrer | \u2705 Full referrer (HTTPS only) |\n\nDefault: `strict-origin-when-cross-origin` (balanced approach)\n\n## Constitutional Compliance\n\nAll security headers middleware implementation follows constitutional governance requirements:\n\n**Constitutional Hash**: `cdd01ef066bc6cf2`\n\n### Compliance Requirements\n\n- \u2705 All security headers must include constitutional hash in module documentation\n- \u2705 Security configurations must be auditable and traceable\n- \u2705 Security header changes must be logged for audit trails\n- \u2705 Security headers must not interfere with constitutional compliance features\n- \u2705 Test coverage must include constitutional compliance verification\n\n### Audit Trail\n\nAll security header configurations are logged:\n\n```python\nlogger.info(\n    f\"[{CONSTITUTIONAL_HASH}] Security headers middleware configured \"\n    f\"(environment: {environment})\"\n)\n```\n\n## References\n\n### Standards and Specifications\n\n- [Content Security Policy Level 3 (W3C)](https://www.w3.org/TR/CSP3/)\n- [HTTP Strict Transport Security (RFC 6797)](https://tools.ietf.org/html/rfc6797)\n- [X-Content-Type-Options (Microsoft)](https://docs.microsoft.com/en-us/previous-versions/windows/internet-explorer/ie-developer/compatibility/gg622941(v=vs.85))\n- [X-Frame-Options (RFC 7034)](https://tools.ietf.org/html/rfc7034)\n- [Referrer Policy (W3C)](https://www.w3.org/TR/referrer-policy/)\n\n### Security Resources\n\n- [OWASP Secure Headers Project](https://owasp.org/www-project-secure-headers/)\n- [Mozilla Web Security Guidelines](https://infosec.mozilla.org/guidelines/web_security)\n- [Security Headers Best Practices](https://securityheaders.com/)\n- [CSP Evaluator (Google)](https://csp-evaluator.withgoogle.com/)\n\n### Internal Documentation\n\n- [ACGS-2 Security Documentation](./README.md)\n- [STRIDE Threat Model](./STRIDE_THREAT_MODEL.md)\n- [Security Hardening Guide](./SECURITY_HARDENING.md)\n- [Service Development Guidelines](../SERVICE_DEVELOPMENT_GUIDELINES.md)\n\n## Changelog\n\n### Version 1.0.0 (2026-01-03)\n\n**Initial Release**\n\n- \u2705 Security headers middleware implementation\n- \u2705 Six security headers: CSP, X-Content-Type-Options, X-Frame-Options, HSTS, X-XSS-Protection, Referrer-Policy\n- \u2705 Environment-aware configuration (development, staging, production)\n- \u2705 Service-specific factory methods (integration, WebSocket, strict production)\n- \u2705 Comprehensive unit tests (90+ test cases)\n- \u2705 Integration tests for all three services\n- \u2705 Documentation and verification checklist\n\n**Services Integrated**:\n- \u2705 Integration Service (`integration-service/src/main.py`)\n- \u2705 Compliance Docs Service (`src/core/services/compliance_docs/src/main.py`)\n- \u2705 Observability Dashboard (`acgs2-observability/monitoring/dashboard_api.py`)\n\n**Test Coverage**:\n- \u2705 Unit tests: `src/core/shared/security/tests/test_security_headers.py`\n- \u2705 Integration tests: 3 service test files with 100+ total test cases\n\n---\n\n**Constitutional Hash**: `cdd01ef066bc6cf2`\n**For questions or issues**: Contact the ACGS-2 Security Team\n",
        "last_modified": "2026-01-03T19:08:32.487249"
      },
      "task_intent": {
        "title": "046-add-security-headers-middleware-to-fastapi-service",
        "description": "Multiple FastAPI services (integration-service, compliance-docs, observability dashboard) lack security headers middleware. Missing headers include Content-Security-Policy, X-Content-Type-Options, X-Frame-Options, Strict-Transport-Security, X-XSS-Protection, and Referrer-Policy.",
        "from_plan": true
      },
      "commits_behind_main": 11,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2026-01-03T19:07:31.701034",
  "last_updated": "2026-01-03T19:07:31.709350"
}