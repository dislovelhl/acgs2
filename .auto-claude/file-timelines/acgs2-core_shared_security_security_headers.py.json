{
  "file_path": "acgs2-core/shared/security/security_headers.py",
  "main_branch_history": [],
  "task_views": {
    "046-add-security-headers-middleware-to-fastapi-service": {
      "task_id": "046-add-security-headers-middleware-to-fastapi-service",
      "branch_point": {
        "commit_hash": "4a99fe22e8e0087919301b1aa185d4e2c6da716c",
        "content": "",
        "timestamp": "2026-01-03T19:07:31.669524"
      },
      "worktree_state": {
        "content": "\"\"\"\nACGS-2 Security Headers Middleware\nConstitutional Hash: cdd01ef066bc6cf2\n\nSecurity headers middleware for FastAPI applications providing defense-in-depth\nagainst common web attacks including XSS, clickjacking, MIME sniffing, and downgrade attacks.\n\nImplements enterprise-grade security headers:\n- Content-Security-Policy: Controls resource loading to prevent XSS\n- X-Content-Type-Options: Prevents MIME sniffing attacks\n- X-Frame-Options: Prevents clickjacking attacks\n- Strict-Transport-Security: Enforces HTTPS connections\n- X-XSS-Protection: Enables browser XSS filtering\n- Referrer-Policy: Controls referrer information leakage\n\nEnvironment Support:\n- Development: Relaxed CSP, shorter HSTS max-age\n- Staging: Moderate security, testing-friendly\n- Production: Strict security headers, long HSTS max-age\n\nUsage:\n    from shared.security.security_headers import SecurityHeadersMiddleware, SecurityHeadersConfig\n\n    # Basic usage with defaults\n    app.add_middleware(SecurityHeadersMiddleware)\n\n    # Custom configuration for production\n    config = SecurityHeadersConfig(\n        environment=\"production\",\n        custom_csp_directives={\"connect-src\": [\"'self'\", \"wss://example.com\"]}\n    )\n    app.add_middleware(SecurityHeadersMiddleware, config=config)\n\n    # WebSocket-enabled configuration\n    config = SecurityHeadersConfig.for_websocket_service()\n    app.add_middleware(SecurityHeadersMiddleware, config=config)\n\"\"\"\n\nimport logging\nimport os\nfrom dataclasses import dataclass, field\nfrom typing import Callable, Dict, List, Optional\n\nfrom fastapi import Request\nfrom starlette.middleware.base import BaseHTTPMiddleware\nfrom starlette.responses import Response\n\n# Constitutional hash for governance compliance\nCONSTITUTIONAL_HASH = \"cdd01ef066bc6cf2\"\n\nlogger = logging.getLogger(__name__)\n\n\n@dataclass\nclass SecurityHeadersConfig:\n    \"\"\"\n    Configuration for security headers middleware.\n\n    Attributes:\n        environment: Deployment environment (development, staging, production)\n        enable_hsts: Enable Strict-Transport-Security header\n        hsts_max_age: HSTS max-age in seconds\n        hsts_include_subdomains: Include subdomains in HSTS\n        hsts_preload: Enable HSTS preload\n        custom_csp_directives: Custom Content-Security-Policy directives\n        frame_options: X-Frame-Options value (DENY, SAMEORIGIN)\n        referrer_policy: Referrer-Policy value\n        enable_xss_protection: Enable X-XSS-Protection header\n    \"\"\"\n\n    environment: str = \"production\"\n    enable_hsts: bool = True\n    hsts_max_age: int = 31536000  # 1 year in seconds\n    hsts_include_subdomains: bool = True\n    hsts_preload: bool = False\n    custom_csp_directives: Optional[Dict[str, List[str]]] = None\n    frame_options: str = \"DENY\"\n    referrer_policy: str = \"strict-origin-when-cross-origin\"\n    enable_xss_protection: bool = True\n\n    @classmethod\n    def from_env(cls) -> \"SecurityHeadersConfig\":\n        \"\"\"\n        Create configuration from environment variables.\n\n        Environment Variables:\n            APP_ENV: Application environment (development, staging, production)\n            SECURITY_HSTS_ENABLED: Enable HSTS (default: true for production)\n            SECURITY_HSTS_MAX_AGE: HSTS max-age in seconds\n            SECURITY_FRAME_OPTIONS: X-Frame-Options value\n\n        Returns:\n            SecurityHeadersConfig instance\n        \"\"\"\n        environment = os.getenv(\"APP_ENV\", \"production\").lower()\n\n        # Environment-specific defaults\n        if environment == \"development\":\n            hsts_enabled = os.getenv(\"SECURITY_HSTS_ENABLED\", \"false\").lower() == \"true\"\n            hsts_max_age = int(os.getenv(\"SECURITY_HSTS_MAX_AGE\", \"300\"))  # 5 minutes\n        elif environment == \"staging\":\n            hsts_enabled = os.getenv(\"SECURITY_HSTS_ENABLED\", \"true\").lower() == \"true\"\n            hsts_max_age = int(os.getenv(\"SECURITY_HSTS_MAX_AGE\", \"86400\"))  # 1 day\n        else:  # production\n            hsts_enabled = os.getenv(\"SECURITY_HSTS_ENABLED\", \"true\").lower() == \"true\"\n            hsts_max_age = int(os.getenv(\"SECURITY_HSTS_MAX_AGE\", \"31536000\"))  # 1 year\n\n        frame_options = os.getenv(\"SECURITY_FRAME_OPTIONS\", \"DENY\")\n\n        return cls(\n            environment=environment,\n            enable_hsts=hsts_enabled,\n            hsts_max_age=hsts_max_age,\n            frame_options=frame_options,\n        )\n\n    @classmethod\n    def for_development(cls) -> \"SecurityHeadersConfig\":\n        \"\"\"\n        Create development-friendly configuration.\n\n        Features:\n        - Relaxed CSP allowing localhost and eval (for dev tools)\n        - Short HSTS max-age (5 minutes)\n        - HSTS disabled by default\n\n        Returns:\n            SecurityHeadersConfig for development\n        \"\"\"\n        return cls(\n            environment=\"development\",\n            enable_hsts=False,\n            hsts_max_age=300,  # 5 minutes\n            hsts_include_subdomains=False,\n            custom_csp_directives={\n                \"default-src\": [\"'self'\"],\n                \"script-src\": [\"'self'\", \"'unsafe-inline'\", \"'unsafe-eval'\", \"localhost:*\"],\n                \"connect-src\": [\"'self'\", \"localhost:*\", \"ws://localhost:*\"],\n            },\n        )\n\n    @classmethod\n    def for_production(cls, strict: bool = True) -> \"SecurityHeadersConfig\":\n        \"\"\"\n        Create production-grade configuration.\n\n        Args:\n            strict: Use strict CSP settings\n\n        Features:\n        - Strict CSP with minimal allowed sources\n        - Long HSTS max-age (1 year)\n        - HSTS with subdomains and preload\n        - Frame options DENY\n\n        Returns:\n            SecurityHeadersConfig for production\n        \"\"\"\n        csp_directives = None\n        if strict:\n            csp_directives = {\n                \"default-src\": [\"'self'\"],\n                \"script-src\": [\"'self'\"],\n                \"style-src\": [\"'self'\"],\n                \"img-src\": [\"'self'\", \"data:\"],\n                \"font-src\": [\"'self'\"],\n                \"connect-src\": [\"'self'\"],\n                \"frame-ancestors\": [\"'none'\"],\n            }\n\n        return cls(\n            environment=\"production\",\n            enable_hsts=True,\n            hsts_max_age=31536000,  # 1 year\n            hsts_include_subdomains=True,\n            hsts_preload=True,\n            custom_csp_directives=csp_directives,\n            frame_options=\"DENY\",\n        )\n\n    @classmethod\n    def for_websocket_service(cls) -> \"SecurityHeadersConfig\":\n        \"\"\"\n        Create configuration for services using WebSockets.\n\n        Features:\n        - CSP allows WebSocket connections (ws:// and wss://)\n        - Production-grade HSTS\n        - Suitable for real-time dashboards and observability tools\n\n        Returns:\n            SecurityHeadersConfig for WebSocket services\n        \"\"\"\n        return cls(\n            environment=\"production\",\n            enable_hsts=True,\n            hsts_max_age=31536000,\n            custom_csp_directives={\n                \"default-src\": [\"'self'\"],\n                \"script-src\": [\"'self'\"],\n                \"style-src\": [\"'self'\", \"'unsafe-inline'\"],  # Allow inline styles for UI\n                \"connect-src\": [\"'self'\", \"ws:\", \"wss:\"],  # Allow WebSocket connections\n                \"img-src\": [\"'self'\", \"data:\"],\n            },\n        )\n\n    @classmethod\n    def for_integration_service(cls) -> \"SecurityHeadersConfig\":\n        \"\"\"\n        Create configuration for integration services.\n\n        Features:\n        - CSP allows external API connections\n        - Suitable for webhook handlers and third-party integrations\n        - Production-grade security with integration flexibility\n\n        Returns:\n            SecurityHeadersConfig for integration services\n        \"\"\"\n        return cls(\n            environment=\"production\",\n            enable_hsts=True,\n            hsts_max_age=31536000,\n            custom_csp_directives={\n                \"default-src\": [\"'self'\"],\n                \"script-src\": [\"'self'\"],\n                \"connect-src\": [\"'self'\", \"https:\"],  # Allow HTTPS external connections\n                \"img-src\": [\"'self'\", \"data:\", \"https:\"],\n            },\n        )\n\n    def get_csp_header_value(self) -> str:\n        \"\"\"\n        Build Content-Security-Policy header value.\n\n        Returns:\n            CSP header value string\n        \"\"\"\n        # Default CSP directives\n        default_directives = {\n            \"default-src\": [\"'self'\"],\n            \"script-src\": [\"'self'\"],\n            \"style-src\": [\"'self'\"],\n            \"img-src\": [\"'self'\", \"data:\"],\n            \"font-src\": [\"'self'\"],\n            \"connect-src\": [\"'self'\"],\n            \"frame-ancestors\": [\"'none'\"],\n            \"base-uri\": [\"'self'\"],\n            \"form-action\": [\"'self'\"],\n        }\n\n        # Merge custom directives\n        directives = default_directives.copy()\n        if self.custom_csp_directives:\n            directives.update(self.custom_csp_directives)\n\n        # Build CSP string\n        csp_parts = []\n        for directive, sources in directives.items():\n            sources_str = \" \".join(sources)\n            csp_parts.append(f\"{directive} {sources_str}\")\n\n        return \"; \".join(csp_parts)\n\n    def get_hsts_header_value(self) -> Optional[str]:\n        \"\"\"\n        Build Strict-Transport-Security header value.\n\n        Returns:\n            HSTS header value string or None if disabled\n        \"\"\"\n        if not self.enable_hsts:\n            return None\n\n        hsts_parts = [f\"max-age={self.hsts_max_age}\"]\n\n        if self.hsts_include_subdomains:\n            hsts_parts.append(\"includeSubDomains\")\n\n        if self.hsts_preload:\n            hsts_parts.append(\"preload\")\n\n        return \"; \".join(hsts_parts)\n\n\nclass SecurityHeadersMiddleware(BaseHTTPMiddleware):\n    \"\"\"\n    Middleware for adding security headers to all HTTP responses.\n\n    Implements:\n    - Content-Security-Policy: Controls resource loading\n    - X-Content-Type-Options: Prevents MIME sniffing\n    - X-Frame-Options: Prevents clickjacking\n    - Strict-Transport-Security: Enforces HTTPS\n    - X-XSS-Protection: Enables XSS filtering\n    - Referrer-Policy: Controls referrer information\n\n    Usage:\n        app.add_middleware(SecurityHeadersMiddleware)\n\n        # With custom config\n        config = SecurityHeadersConfig.for_production()\n        app.add_middleware(SecurityHeadersMiddleware, config=config)\n    \"\"\"\n\n    def __init__(self, app, config: Optional[SecurityHeadersConfig] = None):\n        \"\"\"\n        Initialize security headers middleware.\n\n        Args:\n            app: FastAPI application instance\n            config: SecurityHeadersConfig instance (default: from environment)\n        \"\"\"\n        super().__init__(app)\n        self.config = config or SecurityHeadersConfig.from_env()\n\n        logger.info(\n            f\"Security headers middleware initialized for environment: {self.config.environment}\"\n        )\n        logger.debug(f\"HSTS enabled: {self.config.enable_hsts}\")\n        logger.debug(f\"Frame options: {self.config.frame_options}\")\n\n    async def dispatch(self, request: Request, call_next: Callable) -> Response:\n        \"\"\"\n        Process request and add security headers to response.\n\n        Args:\n            request: Incoming HTTP request\n            call_next: Next middleware in chain\n\n        Returns:\n            Response with security headers added\n        \"\"\"\n        # Process request\n        response = await call_next(request)\n\n        # Add security headers\n        self._add_security_headers(response)\n\n        return response\n\n    def _add_security_headers(self, response: Response) -> None:\n        \"\"\"\n        Add all security headers to response.\n\n        Args:\n            response: HTTP response to modify\n        \"\"\"\n        # Content-Security-Policy\n        csp_value = self.config.get_csp_header_value()\n        response.headers[\"Content-Security-Policy\"] = csp_value\n\n        # X-Content-Type-Options\n        response.headers[\"X-Content-Type-Options\"] = \"nosniff\"\n\n        # X-Frame-Options\n        response.headers[\"X-Frame-Options\"] = self.config.frame_options\n\n        # Strict-Transport-Security (if enabled)\n        hsts_value = self.config.get_hsts_header_value()\n        if hsts_value:\n            response.headers[\"Strict-Transport-Security\"] = hsts_value\n\n        # X-XSS-Protection\n        if self.config.enable_xss_protection:\n            response.headers[\"X-XSS-Protection\"] = \"1; mode=block\"\n\n        # Referrer-Policy\n        response.headers[\"Referrer-Policy\"] = self.config.referrer_policy\n\n\ndef add_security_headers(\n    app,\n    environment: Optional[str] = None,\n    config: Optional[SecurityHeadersConfig] = None,\n) -> None:\n    \"\"\"\n    Convenience function to add security headers middleware to a FastAPI app.\n\n    Args:\n        app: FastAPI application instance\n        environment: Environment name (development, staging, production)\n        config: Custom SecurityHeadersConfig (overrides environment)\n\n    Example:\n        from shared.security.security_headers import add_security_headers\n\n        app = FastAPI()\n        add_security_headers(app, environment=\"production\")\n    \"\"\"\n    if config is None:\n        if environment == \"development\":\n            config = SecurityHeadersConfig.for_development()\n        elif environment == \"production\":\n            config = SecurityHeadersConfig.for_production()\n        else:\n            config = SecurityHeadersConfig.from_env()\n\n    app.add_middleware(SecurityHeadersMiddleware, config=config)\n\n    logger.info(f\"Added security headers middleware with environment: {config.environment}\")\n",
        "last_modified": "2026-01-03T19:08:32.488975"
      },
      "task_intent": {
        "title": "046-add-security-headers-middleware-to-fastapi-service",
        "description": "Multiple FastAPI services (integration-service, compliance-docs, observability dashboard) lack security headers middleware. Missing headers include Content-Security-Policy, X-Content-Type-Options, X-Frame-Options, Strict-Transport-Security, X-XSS-Protection, and Referrer-Policy.",
        "from_plan": true
      },
      "commits_behind_main": 11,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2026-01-03T19:07:31.751814",
  "last_updated": "2026-01-03T19:07:31.759931"
}