{
  "file_path": "analytics-dashboard/src/test/integration/dashboard_api_integration.test.tsx",
  "main_branch_history": [],
  "task_views": {
    "054-extract-duplicated-loadingstate-and-api-config-in-": {
      "task_id": "054-extract-duplicated-loadingstate-and-api-config-in-",
      "branch_point": {
        "commit_hash": "4a99fe22e8e0087919301b1aa185d4e2c6da716c",
        "content": "/**\n * Dashboard \u2192 Analytics-API Integration Tests\n *\n * Comprehensive integration tests verifying the dashboard's\n * interaction with all analytics-api endpoints.\n *\n * These tests verify:\n * 1. InsightWidget displays AI-generated insights from /insights\n * 2. AnomalyWidget lists detected anomalies from /anomalies\n * 3. PredictionWidget shows forecast chart from /predictions\n * 4. QueryInterface processes natural language via /query\n * 5. PDF export functionality via /export/pdf\n * 6. Layout persistence via localStorage\n */\n\nimport { describe, it, expect, vi, beforeEach, afterEach } from \"vitest\";\nimport { render, screen, waitFor, fireEvent, within } from \"@testing-library/react\";\nimport userEvent from \"@testing-library/user-event\";\nimport { http, HttpResponse } from \"msw\";\nimport { server } from \"../mocks/server\";\nimport App from \"../../App\";\n\n// localStorage key for layout persistence\nconst LAYOUT_STORAGE_KEY = \"acgs-analytics-dashboard-layout\";\nconst API_BASE_URL = \"http://localhost:8080\";\n\n// Mock recharts components for testing\nvi.mock(\"recharts\", async () => {\n  const actual = await vi.importActual(\"recharts\");\n  return {\n    ...actual,\n    ResponsiveContainer: ({ children }: { children: React.ReactNode }) => (\n      <div data-testid=\"responsive-container\">{children}</div>\n    ),\n    ComposedChart: ({ children }: { children: React.ReactNode }) => (\n      <div data-testid=\"composed-chart\">{children}</div>\n    ),\n    Line: () => <div data-testid=\"line-chart\" />,\n    Area: () => <div data-testid=\"area-chart\" />,\n    XAxis: () => null,\n    YAxis: () => null,\n    Tooltip: () => null,\n  };\n});\n\n// Mock react-grid-layout\nvi.mock(\"react-grid-layout\", async () => {\n  const actual = await vi.importActual(\"react-grid-layout\");\n  return {\n    ...actual,\n    Responsive: ({ children, onLayoutChange, layouts }: {\n      children: React.ReactNode;\n      onLayoutChange?: (layout: unknown[], layouts: unknown) => void;\n      layouts: unknown;\n    }) => (\n      <div data-testid=\"responsive-grid\" data-layouts={JSON.stringify(layouts)}>\n        {children}\n        <button\n          data-testid=\"trigger-layout-change\"\n          onClick={() => onLayoutChange?.([], layouts)}\n          style={{ display: \"none\" }}\n        >\n          Trigger Layout Change\n        </button>\n      </div>\n    ),\n    WidthProvider: (Component: React.ComponentType) => Component,\n  };\n});\n\ndescribe(\"Dashboard \u2192 Analytics-API Integration\", () => {\n  beforeEach(() => {\n    localStorage.clear();\n  });\n\n  afterEach(() => {\n    localStorage.clear();\n  });\n\n  describe(\"Full Dashboard Load\", () => {\n    it(\"renders dashboard with all components\", async () => {\n      render(<App />);\n\n      // Header\n      await waitFor(() => {\n        expect(screen.getByText(\"ACGS-2 Analytics Dashboard\")).toBeInTheDocument();\n      });\n\n      // QueryInterface\n      expect(screen.getByText(\"Ask About Governance\")).toBeInTheDocument();\n\n      // Grid layout with widgets\n      expect(screen.getByTestId(\"responsive-grid\")).toBeInTheDocument();\n    });\n\n    it(\"loads data from all API endpoints concurrently\", async () => {\n      render(<App />);\n\n      // Wait for all widgets to load their data\n      await waitFor(() => {\n        // InsightWidget loaded\n        expect(screen.getByText(/Governance compliance improved/)).toBeInTheDocument();\n      });\n\n      await waitFor(() => {\n        // AnomalyWidget loaded\n        expect(screen.getByText(\"3 found\")).toBeInTheDocument();\n      });\n\n      await waitFor(() => {\n        // PredictionWidget loaded (chart rendered)\n        expect(screen.getByTestId(\"composed-chart\")).toBeInTheDocument();\n      });\n    });\n  });\n\n  describe(\"Integration Test 1: InsightWidget displays AI-generated insights\", () => {\n    it(\"fetches and displays insights from /insights endpoint\", async () => {\n      render(<App />);\n\n      await waitFor(() => {\n        // Summary section\n        expect(screen.getByText(\"Summary\")).toBeInTheDocument();\n        expect(screen.getByText(/Governance compliance improved by 15%/)).toBeInTheDocument();\n      });\n\n      // Business impact section\n      expect(screen.getByText(\"Business Impact\")).toBeInTheDocument();\n      expect(screen.getByText(/Lower violation rates indicate/)).toBeInTheDocument();\n\n      // Recommended action section\n      expect(screen.getByText(\"Recommended Action\")).toBeInTheDocument();\n      expect(screen.getByText(/Continue current training/)).toBeInTheDocument();\n\n      // Confidence and model metadata\n      expect(screen.getByText(\"85%\")).toBeInTheDocument();\n      expect(screen.getByText(\"gpt-4o\")).toBeInTheDocument();\n    });\n  });\n\n  describe(\"Integration Test 2: AnomalyWidget lists detected anomalies\", () => {\n    it(\"fetches and displays anomalies from /anomalies endpoint\", async () => {\n      render(<App />);\n\n      await waitFor(() => {\n        expect(screen.getByText(\"3 found\")).toBeInTheDocument();\n      });\n\n      // Check anomaly details\n      expect(screen.getByText(\"Unusual spike in policy violations detected\")).toBeInTheDocument();\n      expect(screen.getByText(\"Moderate increase in access control violations\")).toBeInTheDocument();\n      expect(screen.getByText(\"Minor anomaly in user activity patterns\")).toBeInTheDocument();\n\n      // Severity labels\n      expect(screen.getByText(\"CRITICAL\")).toBeInTheDocument();\n      expect(screen.getByText(\"MEDIUM\")).toBeInTheDocument();\n      expect(screen.getByText(\"LOW\")).toBeInTheDocument();\n\n      // Affected metrics\n      expect(screen.getByText(/violation count: 45/i)).toBeInTheDocument();\n    });\n\n    it(\"filters anomalies by severity\", async () => {\n      render(<App />);\n\n      await waitFor(() => {\n        expect(screen.getByText(\"3 found\")).toBeInTheDocument();\n      });\n\n      // Click critical filter\n      const criticalButton = screen.getByRole(\"button\", { name: \"critical\" });\n      fireEvent.click(criticalButton);\n\n      await waitFor(() => {\n        // Only critical anomaly should be visible\n        expect(screen.getByText(\"Unusual spike in policy violations detected\")).toBeInTheDocument();\n      });\n\n      // Other anomalies should be filtered out\n      expect(screen.queryByText(\"Moderate increase in access control violations\")).not.toBeInTheDocument();\n    });\n  });\n\n  describe(\"Integration Test 3: PredictionWidget shows forecast chart\", () => {\n    it(\"fetches and displays predictions from /predictions endpoint\", async () => {\n      render(<App />);\n\n      await waitFor(() => {\n        // Chart rendered\n        expect(screen.getByTestId(\"composed-chart\")).toBeInTheDocument();\n      });\n\n      // Trend badge\n      expect(screen.getByText(\"stable\")).toBeInTheDocument();\n\n      // Summary statistics\n      expect(screen.getByText(\"Mean/Day\")).toBeInTheDocument();\n      expect(screen.getByText(\"10.5\")).toBeInTheDocument();\n      expect(screen.getByText(\"13.2\")).toBeInTheDocument();\n      expect(screen.getByText(\"7.8\")).toBeInTheDocument();\n      expect(screen.getByText(\"315\")).toBeInTheDocument();\n\n      // Metadata\n      expect(screen.getByText(\"30 days\")).toBeInTheDocument();\n    });\n\n    it(\"shows insufficient data state when model not trained\", async () => {\n      server.use(\n        http.get(`${API_BASE_URL}/predictions`, () => {\n          return HttpResponse.json({\n            forecast_timestamp: new Date().toISOString(),\n            historical_days: 7,\n            forecast_days: 0,\n            model_trained: false,\n            predictions: [],\n            summary: {\n              status: \"error\",\n              mean_predicted_violations: null,\n              max_predicted_violations: null,\n              min_predicted_violations: null,\n              total_predicted_violations: null,\n              trend_direction: null,\n              reason: \"Insufficient historical data\",\n            },\n            error_message: \"Collect at least 2 weeks of governance events.\",\n          });\n        })\n      );\n\n      render(<App />);\n\n      await waitFor(() => {\n        expect(screen.getByText(\"Insufficient Data for Predictions\")).toBeInTheDocument();\n      });\n    });\n  });\n\n  describe(\"Integration Test 4: QueryInterface with natural language input\", () => {\n    it(\"processes natural language query via /query endpoint\", async () => {\n      const user = userEvent.setup();\n      render(<App />);\n\n      // Find query input\n      const input = screen.getByPlaceholderText(/Ask a question about governance data/i);\n\n      // Type and submit query\n      await user.type(input, \"Show violations this week\");\n      await user.click(screen.getByRole(\"button\", { name: /submit query/i }));\n\n      // Wait for response\n      await waitFor(() => {\n        expect(screen.getByText(\"Answer\")).toBeInTheDocument();\n      });\n\n      // Check answer content\n      expect(screen.getByText(/There were 23 policy violations this week/)).toBeInTheDocument();\n\n      // Check related data\n      expect(screen.getByText(\"Related Data\")).toBeInTheDocument();\n    });\n\n    it(\"handles sample query suggestions\", async () => {\n      const user = userEvent.setup();\n      render(<App />);\n\n      // Click sample query\n      const sampleQuery = screen.getByText(\"Show violations this week\");\n      await user.click(sampleQuery);\n\n      await waitFor(() => {\n        expect(screen.getByText(\"Answer\")).toBeInTheDocument();\n      });\n    });\n\n    it(\"shows error state on query failure\", async () => {\n      server.use(\n        http.post(`${API_BASE_URL}/query`, () => {\n          return HttpResponse.json(\n            { detail: \"Query processing failed\" },\n            { status: 500 }\n          );\n        })\n      );\n\n      const user = userEvent.setup();\n      render(<App />);\n\n      const input = screen.getByPlaceholderText(/Ask a question about governance data/i);\n      await user.type(input, \"Test query\");\n      await user.click(screen.getByRole(\"button\", { name: /submit query/i }));\n\n      await waitFor(() => {\n        expect(screen.getByText(\"Query Failed\")).toBeInTheDocument();\n      });\n    });\n  });\n\n  describe(\"Integration Test 5: PDF Export\", () => {\n    it(\"triggers PDF download from /export/pdf endpoint\", async () => {\n      // This test verifies the API endpoint works\n      // Actual browser download behavior cannot be tested in jsdom\n\n      // Verify endpoint returns PDF\n      const response = await fetch(`${API_BASE_URL}/export/pdf`, {\n        method: \"POST\",\n      });\n\n      // MSW handler should return PDF blob\n      expect(response.headers.get(\"content-type\")).toBe(\"application/pdf\");\n    });\n  });\n\n  describe(\"Integration Test 6: Layout Persistence\", () => {\n    it(\"saves layout to localStorage when changed\", async () => {\n      render(<App />);\n\n      await waitFor(() => {\n        expect(screen.getByTestId(\"responsive-grid\")).toBeInTheDocument();\n      });\n\n      // Trigger layout change (simulated via mock)\n      fireEvent.click(screen.getByTestId(\"trigger-layout-change\"));\n\n      // Check localStorage was updated\n      expect(localStorage.getItem(LAYOUT_STORAGE_KEY)).not.toBeNull();\n    });\n\n    it(\"restores layout from localStorage on reload\", async () => {\n      // Pre-populate localStorage\n      const savedLayout = {\n        lg: [\n          { i: \"insights\", x: 0, y: 0, w: 12, h: 10 },\n          { i: \"anomalies\", x: 0, y: 10, w: 6, h: 10 },\n          { i: \"predictions\", x: 6, y: 10, w: 6, h: 12 },\n        ],\n        md: [],\n        sm: [],\n        xs: [],\n        xxs: [],\n      };\n      localStorage.setItem(LAYOUT_STORAGE_KEY, JSON.stringify(savedLayout));\n\n      render(<App />);\n\n      await waitFor(() => {\n        const grid = screen.getByTestId(\"responsive-grid\");\n        const layouts = JSON.parse(grid.getAttribute(\"data-layouts\") || \"{}\");\n        expect(layouts.lg[0].w).toBe(12); // Custom width\n      });\n    });\n\n    it(\"handles corrupted localStorage gracefully\", async () => {\n      localStorage.setItem(LAYOUT_STORAGE_KEY, \"invalid json\");\n\n      // Should not throw\n      render(<App />);\n\n      await waitFor(() => {\n        expect(screen.getByTestId(\"responsive-grid\")).toBeInTheDocument();\n      });\n    });\n\n    it(\"resets to default layout when button clicked\", async () => {\n      const user = userEvent.setup();\n\n      // Set custom layout\n      localStorage.setItem(\n        LAYOUT_STORAGE_KEY,\n        JSON.stringify({ lg: [{ i: \"insights\", x: 6, y: 0, w: 6, h: 8 }] })\n      );\n\n      render(<App />);\n\n      await waitFor(() => {\n        expect(screen.getByTestId(\"responsive-grid\")).toBeInTheDocument();\n      });\n\n      // Click reset\n      await user.click(screen.getByRole(\"button\", { name: /reset to default layout/i }));\n\n      // Check layout was reset\n      const savedLayout = JSON.parse(localStorage.getItem(LAYOUT_STORAGE_KEY) || \"{}\");\n      expect(savedLayout.lg[0].x).toBe(0); // Default x position\n    });\n\n    it(\"toggles layout lock state\", async () => {\n      const user = userEvent.setup();\n      render(<App />);\n\n      await waitFor(() => {\n        expect(screen.getByText(\"Unlocked\")).toBeInTheDocument();\n      });\n\n      // Lock\n      await user.click(screen.getByRole(\"button\", { name: /unlock layout/i }));\n      expect(screen.getByText(\"Locked\")).toBeInTheDocument();\n\n      // Unlock\n      await user.click(screen.getByRole(\"button\", { name: /lock layout/i }));\n      expect(screen.getByText(\"Unlocked\")).toBeInTheDocument();\n    });\n  });\n\n  describe(\"Error Handling\", () => {\n    it(\"handles multiple endpoint failures gracefully\", async () => {\n      // All endpoints fail\n      server.use(\n        http.get(`${API_BASE_URL}/insights`, () => {\n          return HttpResponse.json({ detail: \"Error\" }, { status: 500 });\n        }),\n        http.get(`${API_BASE_URL}/anomalies`, () => {\n          return HttpResponse.json({ detail: \"Error\" }, { status: 500 });\n        }),\n        http.get(`${API_BASE_URL}/predictions`, () => {\n          return HttpResponse.json({ detail: \"Error\" }, { status: 500 });\n        })\n      );\n\n      render(<App />);\n\n      // Dashboard should still render\n      await waitFor(() => {\n        expect(screen.getByText(\"ACGS-2 Analytics Dashboard\")).toBeInTheDocument();\n      });\n\n      // Each widget should show error state with retry button\n      await waitFor(() => {\n        const retryButtons = screen.getAllByText(\"Try Again\");\n        expect(retryButtons.length).toBe(3);\n      });\n    });\n\n    it(\"recovers from error state when retry succeeds\", async () => {\n      // Start with failing endpoint\n      server.use(\n        http.get(`${API_BASE_URL}/insights`, () => {\n          return HttpResponse.json({ detail: \"Error\" }, { status: 500 });\n        })\n      );\n\n      render(<App />);\n\n      await waitFor(() => {\n        expect(screen.getAllByText(\"Try Again\").length).toBeGreaterThan(0);\n      });\n\n      // Reset to working handler\n      server.resetHandlers();\n\n      // Click retry on first \"Try Again\" button\n      fireEvent.click(screen.getAllByText(\"Try Again\")[0]);\n\n      // Should recover and show content\n      await waitFor(\n        () => {\n          expect(screen.getByText(/Governance compliance improved/)).toBeInTheDocument();\n        },\n        { timeout: 5000 }\n      );\n    });\n  });\n\n  describe(\"Refresh Functionality\", () => {\n    it(\"refreshes all widgets when refresh buttons are clicked\", async () => {\n      render(<App />);\n\n      // Wait for initial load\n      await waitFor(() => {\n        expect(screen.getByText(/Governance compliance improved/)).toBeInTheDocument();\n      });\n\n      // Find and click InsightWidget refresh button\n      const refreshButtons = screen.getAllByRole(\"button\", { name: /refresh/i });\n      expect(refreshButtons.length).toBeGreaterThanOrEqual(3);\n\n      // Click first refresh button (InsightWidget)\n      fireEvent.click(refreshButtons[0]);\n\n      // Should still show content after refresh completes\n      await waitFor(() => {\n        expect(screen.getByText(/Governance compliance improved/)).toBeInTheDocument();\n      });\n    });\n  });\n});\n",
        "timestamp": "2026-01-03T18:35:24.567548"
      },
      "worktree_state": {
        "content": "/**\n * Dashboard \u2192 Analytics-API Integration Tests\n *\n * Comprehensive integration tests verifying the dashboard's\n * interaction with all analytics-api endpoints.\n *\n * These tests verify:\n * 1. InsightWidget displays AI-generated insights from /insights\n * 2. AnomalyWidget lists detected anomalies from /anomalies\n * 3. PredictionWidget shows forecast chart from /predictions\n * 4. QueryInterface processes natural language via /query\n * 5. PDF export functionality via /export/pdf\n * 6. Layout persistence via localStorage\n */\n\nimport { describe, it, expect, vi, beforeEach, afterEach } from \"vitest\";\nimport { render, screen, waitFor, fireEvent, within } from \"@testing-library/react\";\nimport userEvent from \"@testing-library/user-event\";\nimport { http, HttpResponse } from \"msw\";\nimport { server } from \"../mocks/server\";\nimport App from \"../../App\";\nimport { API_BASE_URL } from \"../../lib\";\n\n// localStorage key for layout persistence\nconst LAYOUT_STORAGE_KEY = \"acgs-analytics-dashboard-layout\";\n\n// Mock recharts components for testing\nvi.mock(\"recharts\", async () => {\n  const actual = await vi.importActual(\"recharts\");\n  return {\n    ...actual,\n    ResponsiveContainer: ({ children }: { children: React.ReactNode }) => (\n      <div data-testid=\"responsive-container\">{children}</div>\n    ),\n    ComposedChart: ({ children }: { children: React.ReactNode }) => (\n      <div data-testid=\"composed-chart\">{children}</div>\n    ),\n    Line: () => <div data-testid=\"line-chart\" />,\n    Area: () => <div data-testid=\"area-chart\" />,\n    XAxis: () => null,\n    YAxis: () => null,\n    Tooltip: () => null,\n  };\n});\n\n// Mock react-grid-layout\nvi.mock(\"react-grid-layout\", async () => {\n  const actual = await vi.importActual(\"react-grid-layout\");\n  return {\n    ...actual,\n    Responsive: ({ children, onLayoutChange, layouts }: {\n      children: React.ReactNode;\n      onLayoutChange?: (layout: unknown[], layouts: unknown) => void;\n      layouts: unknown;\n    }) => (\n      <div data-testid=\"responsive-grid\" data-layouts={JSON.stringify(layouts)}>\n        {children}\n        <button\n          data-testid=\"trigger-layout-change\"\n          onClick={() => onLayoutChange?.([], layouts)}\n          style={{ display: \"none\" }}\n        >\n          Trigger Layout Change\n        </button>\n      </div>\n    ),\n    WidthProvider: (Component: React.ComponentType) => Component,\n  };\n});\n\ndescribe(\"Dashboard \u2192 Analytics-API Integration\", () => {\n  beforeEach(() => {\n    localStorage.clear();\n  });\n\n  afterEach(() => {\n    localStorage.clear();\n  });\n\n  describe(\"Full Dashboard Load\", () => {\n    it(\"renders dashboard with all components\", async () => {\n      render(<App />);\n\n      // Header\n      await waitFor(() => {\n        expect(screen.getByText(\"ACGS-2 Analytics Dashboard\")).toBeInTheDocument();\n      });\n\n      // QueryInterface\n      expect(screen.getByText(\"Ask About Governance\")).toBeInTheDocument();\n\n      // Grid layout with widgets\n      expect(screen.getByTestId(\"responsive-grid\")).toBeInTheDocument();\n    });\n\n    it(\"loads data from all API endpoints concurrently\", async () => {\n      render(<App />);\n\n      // Wait for all widgets to load their data\n      await waitFor(() => {\n        // InsightWidget loaded\n        expect(screen.getByText(/Governance compliance improved/)).toBeInTheDocument();\n      });\n\n      await waitFor(() => {\n        // AnomalyWidget loaded\n        expect(screen.getByText(\"3 found\")).toBeInTheDocument();\n      });\n\n      await waitFor(() => {\n        // PredictionWidget loaded (chart rendered)\n        expect(screen.getByTestId(\"composed-chart\")).toBeInTheDocument();\n      });\n    });\n  });\n\n  describe(\"Integration Test 1: InsightWidget displays AI-generated insights\", () => {\n    it(\"fetches and displays insights from /insights endpoint\", async () => {\n      render(<App />);\n\n      await waitFor(() => {\n        // Summary section\n        expect(screen.getByText(\"Summary\")).toBeInTheDocument();\n        expect(screen.getByText(/Governance compliance improved by 15%/)).toBeInTheDocument();\n      });\n\n      // Business impact section\n      expect(screen.getByText(\"Business Impact\")).toBeInTheDocument();\n      expect(screen.getByText(/Lower violation rates indicate/)).toBeInTheDocument();\n\n      // Recommended action section\n      expect(screen.getByText(\"Recommended Action\")).toBeInTheDocument();\n      expect(screen.getByText(/Continue current training/)).toBeInTheDocument();\n\n      // Confidence and model metadata\n      expect(screen.getByText(\"85%\")).toBeInTheDocument();\n      expect(screen.getByText(\"gpt-4o\")).toBeInTheDocument();\n    });\n  });\n\n  describe(\"Integration Test 2: AnomalyWidget lists detected anomalies\", () => {\n    it(\"fetches and displays anomalies from /anomalies endpoint\", async () => {\n      render(<App />);\n\n      await waitFor(() => {\n        expect(screen.getByText(\"3 found\")).toBeInTheDocument();\n      });\n\n      // Check anomaly details\n      expect(screen.getByText(\"Unusual spike in policy violations detected\")).toBeInTheDocument();\n      expect(screen.getByText(\"Moderate increase in access control violations\")).toBeInTheDocument();\n      expect(screen.getByText(\"Minor anomaly in user activity patterns\")).toBeInTheDocument();\n\n      // Severity labels\n      expect(screen.getByText(\"CRITICAL\")).toBeInTheDocument();\n      expect(screen.getByText(\"MEDIUM\")).toBeInTheDocument();\n      expect(screen.getByText(\"LOW\")).toBeInTheDocument();\n\n      // Affected metrics\n      expect(screen.getByText(/violation count: 45/i)).toBeInTheDocument();\n    });\n\n    it(\"filters anomalies by severity\", async () => {\n      render(<App />);\n\n      await waitFor(() => {\n        expect(screen.getByText(\"3 found\")).toBeInTheDocument();\n      });\n\n      // Click critical filter\n      const criticalButton = screen.getByRole(\"button\", { name: \"critical\" });\n      fireEvent.click(criticalButton);\n\n      await waitFor(() => {\n        // Only critical anomaly should be visible\n        expect(screen.getByText(\"Unusual spike in policy violations detected\")).toBeInTheDocument();\n      });\n\n      // Other anomalies should be filtered out\n      expect(screen.queryByText(\"Moderate increase in access control violations\")).not.toBeInTheDocument();\n    });\n  });\n\n  describe(\"Integration Test 3: PredictionWidget shows forecast chart\", () => {\n    it(\"fetches and displays predictions from /predictions endpoint\", async () => {\n      render(<App />);\n\n      await waitFor(() => {\n        // Chart rendered\n        expect(screen.getByTestId(\"composed-chart\")).toBeInTheDocument();\n      });\n\n      // Trend badge\n      expect(screen.getByText(\"stable\")).toBeInTheDocument();\n\n      // Summary statistics\n      expect(screen.getByText(\"Mean/Day\")).toBeInTheDocument();\n      expect(screen.getByText(\"10.5\")).toBeInTheDocument();\n      expect(screen.getByText(\"13.2\")).toBeInTheDocument();\n      expect(screen.getByText(\"7.8\")).toBeInTheDocument();\n      expect(screen.getByText(\"315\")).toBeInTheDocument();\n\n      // Metadata\n      expect(screen.getByText(\"30 days\")).toBeInTheDocument();\n    });\n\n    it(\"shows insufficient data state when model not trained\", async () => {\n      server.use(\n        http.get(`${API_BASE_URL}/predictions`, () => {\n          return HttpResponse.json({\n            forecast_timestamp: new Date().toISOString(),\n            historical_days: 7,\n            forecast_days: 0,\n            model_trained: false,\n            predictions: [],\n            summary: {\n              status: \"error\",\n              mean_predicted_violations: null,\n              max_predicted_violations: null,\n              min_predicted_violations: null,\n              total_predicted_violations: null,\n              trend_direction: null,\n              reason: \"Insufficient historical data\",\n            },\n            error_message: \"Collect at least 2 weeks of governance events.\",\n          });\n        })\n      );\n\n      render(<App />);\n\n      await waitFor(() => {\n        expect(screen.getByText(\"Insufficient Data for Predictions\")).toBeInTheDocument();\n      });\n    });\n  });\n\n  describe(\"Integration Test 4: QueryInterface with natural language input\", () => {\n    it(\"processes natural language query via /query endpoint\", async () => {\n      const user = userEvent.setup();\n      render(<App />);\n\n      // Find query input\n      const input = screen.getByPlaceholderText(/Ask a question about governance data/i);\n\n      // Type and submit query\n      await user.type(input, \"Show violations this week\");\n      await user.click(screen.getByRole(\"button\", { name: /submit query/i }));\n\n      // Wait for response\n      await waitFor(() => {\n        expect(screen.getByText(\"Answer\")).toBeInTheDocument();\n      });\n\n      // Check answer content\n      expect(screen.getByText(/There were 23 policy violations this week/)).toBeInTheDocument();\n\n      // Check related data\n      expect(screen.getByText(\"Related Data\")).toBeInTheDocument();\n    });\n\n    it(\"handles sample query suggestions\", async () => {\n      const user = userEvent.setup();\n      render(<App />);\n\n      // Click sample query\n      const sampleQuery = screen.getByText(\"Show violations this week\");\n      await user.click(sampleQuery);\n\n      await waitFor(() => {\n        expect(screen.getByText(\"Answer\")).toBeInTheDocument();\n      });\n    });\n\n    it(\"shows error state on query failure\", async () => {\n      server.use(\n        http.post(`${API_BASE_URL}/query`, () => {\n          return HttpResponse.json(\n            { detail: \"Query processing failed\" },\n            { status: 500 }\n          );\n        })\n      );\n\n      const user = userEvent.setup();\n      render(<App />);\n\n      const input = screen.getByPlaceholderText(/Ask a question about governance data/i);\n      await user.type(input, \"Test query\");\n      await user.click(screen.getByRole(\"button\", { name: /submit query/i }));\n\n      await waitFor(() => {\n        expect(screen.getByText(\"Query Failed\")).toBeInTheDocument();\n      });\n    });\n  });\n\n  describe(\"Integration Test 5: PDF Export\", () => {\n    it(\"triggers PDF download from /export/pdf endpoint\", async () => {\n      // This test verifies the API endpoint works\n      // Actual browser download behavior cannot be tested in jsdom\n\n      // Verify endpoint returns PDF\n      const response = await fetch(`${API_BASE_URL}/export/pdf`, {\n        method: \"POST\",\n      });\n\n      // MSW handler should return PDF blob\n      expect(response.headers.get(\"content-type\")).toBe(\"application/pdf\");\n    });\n  });\n\n  describe(\"Integration Test 6: Layout Persistence\", () => {\n    it(\"saves layout to localStorage when changed\", async () => {\n      render(<App />);\n\n      await waitFor(() => {\n        expect(screen.getByTestId(\"responsive-grid\")).toBeInTheDocument();\n      });\n\n      // Trigger layout change (simulated via mock)\n      fireEvent.click(screen.getByTestId(\"trigger-layout-change\"));\n\n      // Check localStorage was updated\n      expect(localStorage.getItem(LAYOUT_STORAGE_KEY)).not.toBeNull();\n    });\n\n    it(\"restores layout from localStorage on reload\", async () => {\n      // Pre-populate localStorage\n      const savedLayout = {\n        lg: [\n          { i: \"insights\", x: 0, y: 0, w: 12, h: 10 },\n          { i: \"anomalies\", x: 0, y: 10, w: 6, h: 10 },\n          { i: \"predictions\", x: 6, y: 10, w: 6, h: 12 },\n        ],\n        md: [],\n        sm: [],\n        xs: [],\n        xxs: [],\n      };\n      localStorage.setItem(LAYOUT_STORAGE_KEY, JSON.stringify(savedLayout));\n\n      render(<App />);\n\n      await waitFor(() => {\n        const grid = screen.getByTestId(\"responsive-grid\");\n        const layouts = JSON.parse(grid.getAttribute(\"data-layouts\") || \"{}\");\n        expect(layouts.lg[0].w).toBe(12); // Custom width\n      });\n    });\n\n    it(\"handles corrupted localStorage gracefully\", async () => {\n      localStorage.setItem(LAYOUT_STORAGE_KEY, \"invalid json\");\n\n      // Should not throw\n      render(<App />);\n\n      await waitFor(() => {\n        expect(screen.getByTestId(\"responsive-grid\")).toBeInTheDocument();\n      });\n    });\n\n    it(\"resets to default layout when button clicked\", async () => {\n      const user = userEvent.setup();\n\n      // Set custom layout\n      localStorage.setItem(\n        LAYOUT_STORAGE_KEY,\n        JSON.stringify({ lg: [{ i: \"insights\", x: 6, y: 0, w: 6, h: 8 }] })\n      );\n\n      render(<App />);\n\n      await waitFor(() => {\n        expect(screen.getByTestId(\"responsive-grid\")).toBeInTheDocument();\n      });\n\n      // Click reset\n      await user.click(screen.getByRole(\"button\", { name: /reset to default layout/i }));\n\n      // Check layout was reset\n      const savedLayout = JSON.parse(localStorage.getItem(LAYOUT_STORAGE_KEY) || \"{}\");\n      expect(savedLayout.lg[0].x).toBe(0); // Default x position\n    });\n\n    it(\"toggles layout lock state\", async () => {\n      const user = userEvent.setup();\n      render(<App />);\n\n      await waitFor(() => {\n        expect(screen.getByText(\"Unlocked\")).toBeInTheDocument();\n      });\n\n      // Lock\n      await user.click(screen.getByRole(\"button\", { name: /unlock layout/i }));\n      expect(screen.getByText(\"Locked\")).toBeInTheDocument();\n\n      // Unlock\n      await user.click(screen.getByRole(\"button\", { name: /lock layout/i }));\n      expect(screen.getByText(\"Unlocked\")).toBeInTheDocument();\n    });\n  });\n\n  describe(\"Error Handling\", () => {\n    it(\"handles multiple endpoint failures gracefully\", async () => {\n      // All endpoints fail\n      server.use(\n        http.get(`${API_BASE_URL}/insights`, () => {\n          return HttpResponse.json({ detail: \"Error\" }, { status: 500 });\n        }),\n        http.get(`${API_BASE_URL}/anomalies`, () => {\n          return HttpResponse.json({ detail: \"Error\" }, { status: 500 });\n        }),\n        http.get(`${API_BASE_URL}/predictions`, () => {\n          return HttpResponse.json({ detail: \"Error\" }, { status: 500 });\n        })\n      );\n\n      render(<App />);\n\n      // Dashboard should still render\n      await waitFor(() => {\n        expect(screen.getByText(\"ACGS-2 Analytics Dashboard\")).toBeInTheDocument();\n      });\n\n      // Each widget should show error state with retry button\n      await waitFor(() => {\n        const retryButtons = screen.getAllByText(\"Try Again\");\n        expect(retryButtons.length).toBe(3);\n      });\n    });\n\n    it(\"recovers from error state when retry succeeds\", async () => {\n      // Start with failing endpoint\n      server.use(\n        http.get(`${API_BASE_URL}/insights`, () => {\n          return HttpResponse.json({ detail: \"Error\" }, { status: 500 });\n        })\n      );\n\n      render(<App />);\n\n      await waitFor(() => {\n        expect(screen.getAllByText(\"Try Again\").length).toBeGreaterThan(0);\n      });\n\n      // Reset to working handler\n      server.resetHandlers();\n\n      // Click retry on first \"Try Again\" button\n      fireEvent.click(screen.getAllByText(\"Try Again\")[0]);\n\n      // Should recover and show content\n      await waitFor(\n        () => {\n          expect(screen.getByText(/Governance compliance improved/)).toBeInTheDocument();\n        },\n        { timeout: 5000 }\n      );\n    });\n  });\n\n  describe(\"Refresh Functionality\", () => {\n    it(\"refreshes all widgets when refresh buttons are clicked\", async () => {\n      render(<App />);\n\n      // Wait for initial load\n      await waitFor(() => {\n        expect(screen.getByText(/Governance compliance improved/)).toBeInTheDocument();\n      });\n\n      // Find and click InsightWidget refresh button\n      const refreshButtons = screen.getAllByRole(\"button\", { name: /refresh/i });\n      expect(refreshButtons.length).toBeGreaterThanOrEqual(3);\n\n      // Click first refresh button (InsightWidget)\n      fireEvent.click(refreshButtons[0]);\n\n      // Should still show content after refresh completes\n      await waitFor(() => {\n        expect(screen.getByText(/Governance compliance improved/)).toBeInTheDocument();\n      });\n    });\n  });\n});\n",
        "last_modified": "2026-01-03T19:10:12.025913"
      },
      "task_intent": {
        "title": "054-extract-duplicated-loadingstate-and-api-config-in-",
        "description": "The analytics-dashboard has 4 widget components (PredictionWidget, AnomalyWidget, InsightWidget, QueryInterface) that each independently define the same LoadingState type and API_BASE_URL constant. This pattern is repeated across 7+ files when including tests, leading to maintenance burden and potential inconsistencies.",
        "from_plan": true
      },
      "commits_behind_main": 0,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2026-01-03T18:35:24.610763",
  "last_updated": "2026-01-03T18:35:24.612594"
}