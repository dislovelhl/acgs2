{
  "file_path": "acgs2-observability/tests/monitoring/test_dashboard_security.py",
  "main_branch_history": [],
  "task_views": {
    "046-add-security-headers-middleware-to-fastapi-service": {
      "task_id": "046-add-security-headers-middleware-to-fastapi-service",
      "branch_point": {
        "commit_hash": "4a99fe22e8e0087919301b1aa185d4e2c6da716c",
        "content": "",
        "timestamp": "2026-01-03T19:07:31.669524"
      },
      "worktree_state": {
        "content": "\"\"\"\nIntegration tests for security headers in observability dashboard.\n\nTests verify:\n- All six security headers are present on all HTTP responses\n- GET /health endpoint returns security headers\n- GET /dashboard/overview endpoint returns security headers\n- GET /dashboard/metrics endpoint returns security headers\n- WebSocket upgrade respects security requirements\n- CSP header allows WebSocket connections for real-time updates\n- Security headers work alongside CORS middleware\n\nConstitutional Hash: cdd01ef066bc6cf2\n\"\"\"\n\nimport sys\nfrom pathlib import Path\n\nimport pytest\n\n# Add paths for imports\nsys.path.insert(0, str(Path(__file__).parent.parent.parent))\n\n# Import the dashboard app\ntry:\n    from monitoring.dashboard_api import create_dashboard_app\n\n    FASTAPI_AVAILABLE = True\nexcept ImportError:\n    FASTAPI_AVAILABLE = False\n\n# Import TestClient if FastAPI is available\nif FASTAPI_AVAILABLE:\n    from fastapi.testclient import TestClient\n\n\n# ============================================================================\n# Fixtures\n# ============================================================================\n\n\n@pytest.fixture\ndef client():\n    \"\"\"Create a test client for the observability dashboard.\"\"\"\n    if not FASTAPI_AVAILABLE:\n        pytest.skip(\"FastAPI not available\")\n\n    app = create_dashboard_app()\n    return TestClient(app)\n\n\n# ============================================================================\n# Basic Security Headers Tests\n# ============================================================================\n\n\nclass TestSecurityHeadersPresence:\n    \"\"\"Test that all security headers are present on responses.\"\"\"\n\n    def test_health_endpoint_has_all_security_headers(self, client):\n        \"\"\"Test GET /health endpoint returns all six security headers.\"\"\"\n        response = client.get(\"/health\")\n\n        # Verify response is successful\n        assert response.status_code == 200\n\n        # Verify all 6 security headers are present\n        assert \"Content-Security-Policy\" in response.headers\n        assert \"X-Content-Type-Options\" in response.headers\n        assert \"X-Frame-Options\" in response.headers\n        assert \"Strict-Transport-Security\" in response.headers\n        assert \"X-XSS-Protection\" in response.headers\n        assert \"Referrer-Policy\" in response.headers\n\n    def test_dashboard_overview_has_all_security_headers(self, client):\n        \"\"\"Test GET /dashboard/overview endpoint returns all six security headers.\"\"\"\n        response = client.get(\"/dashboard/overview\")\n\n        # Verify all 6 security headers are present\n        assert \"Content-Security-Policy\" in response.headers\n        assert \"X-Content-Type-Options\" in response.headers\n        assert \"X-Frame-Options\" in response.headers\n        assert \"Strict-Transport-Security\" in response.headers\n        assert \"X-XSS-Protection\" in response.headers\n        assert \"Referrer-Policy\" in response.headers\n\n    def test_dashboard_health_has_security_headers(self, client):\n        \"\"\"Test GET /dashboard/health endpoint returns security headers.\"\"\"\n        response = client.get(\"/dashboard/health\")\n\n        # Verify all 6 security headers are present\n        assert \"Content-Security-Policy\" in response.headers\n        assert \"X-Content-Type-Options\" in response.headers\n        assert \"X-Frame-Options\" in response.headers\n        assert \"Strict-Transport-Security\" in response.headers\n        assert \"X-XSS-Protection\" in response.headers\n        assert \"Referrer-Policy\" in response.headers\n\n    def test_dashboard_metrics_has_security_headers(self, client):\n        \"\"\"Test GET /dashboard/metrics endpoint returns security headers.\"\"\"\n        response = client.get(\"/dashboard/metrics\")\n\n        # Verify all 6 security headers are present\n        assert \"Content-Security-Policy\" in response.headers\n        assert \"X-Content-Type-Options\" in response.headers\n        assert \"X-Frame-Options\" in response.headers\n        assert \"Strict-Transport-Security\" in response.headers\n        assert \"X-XSS-Protection\" in response.headers\n        assert \"Referrer-Policy\" in response.headers\n\n    def test_dashboard_alerts_has_security_headers(self, client):\n        \"\"\"Test GET /dashboard/alerts endpoint returns security headers.\"\"\"\n        response = client.get(\"/dashboard/alerts\")\n\n        # Verify all 6 security headers are present\n        assert \"Content-Security-Policy\" in response.headers\n        assert \"X-Content-Type-Options\" in response.headers\n        assert \"X-Frame-Options\" in response.headers\n        assert \"Strict-Transport-Security\" in response.headers\n        assert \"X-XSS-Protection\" in response.headers\n        assert \"Referrer-Policy\" in response.headers\n\n    def test_dashboard_services_has_security_headers(self, client):\n        \"\"\"Test GET /dashboard/services endpoint returns security headers.\"\"\"\n        response = client.get(\"/dashboard/services\")\n\n        # Verify all 6 security headers are present\n        assert \"Content-Security-Policy\" in response.headers\n        assert \"X-Content-Type-Options\" in response.headers\n        assert \"X-Frame-Options\" in response.headers\n        assert \"Strict-Transport-Security\" in response.headers\n        assert \"X-XSS-Protection\" in response.headers\n        assert \"Referrer-Policy\" in response.headers\n\n    def test_dashboard_memory_has_security_headers(self, client):\n        \"\"\"Test GET /dashboard/memory endpoint returns security headers.\"\"\"\n        response = client.get(\"/dashboard/memory\")\n\n        # Verify all 6 security headers are present\n        assert \"Content-Security-Policy\" in response.headers\n        assert \"X-Content-Type-Options\" in response.headers\n        assert \"X-Frame-Options\" in response.headers\n        assert \"Strict-Transport-Security\" in response.headers\n        assert \"X-XSS-Protection\" in response.headers\n        assert \"Referrer-Policy\" in response.headers\n\n\n# ============================================================================\n# Specific Security Headers Tests\n# ============================================================================\n\n\nclass TestIndividualSecurityHeaders:\n    \"\"\"Test individual security header values.\"\"\"\n\n    def test_content_security_policy_header(self, client):\n        \"\"\"Test Content-Security-Policy header is properly configured for WebSocket support.\"\"\"\n        response = client.get(\"/dashboard/overview\")\n\n        csp = response.headers.get(\"Content-Security-Policy\")\n        assert csp is not None\n\n        # Verify CSP contains base directives\n        assert \"default-src 'self'\" in csp\n        assert \"script-src 'self'\" in csp\n\n        # Verify CSP allows WebSocket connections for /dashboard/ws endpoint\n        assert \"connect-src\" in csp\n        # Should allow both self and WebSocket protocols\n        csp_lower = csp.lower()\n        assert \"'self'\" in csp_lower\n        # WebSocket protocols should be allowed\n        assert \"ws:\" in csp_lower or \"wss:\" in csp_lower\n\n    def test_x_content_type_options_header(self, client):\n        \"\"\"Test X-Content-Type-Options header prevents MIME sniffing.\"\"\"\n        response = client.get(\"/dashboard/overview\")\n\n        assert response.headers.get(\"X-Content-Type-Options\") == \"nosniff\"\n\n    def test_x_frame_options_header(self, client):\n        \"\"\"Test X-Frame-Options header prevents clickjacking.\"\"\"\n        response = client.get(\"/dashboard/overview\")\n\n        assert response.headers.get(\"X-Frame-Options\") == \"DENY\"\n\n    def test_strict_transport_security_header(self, client):\n        \"\"\"Test Strict-Transport-Security header enforces HTTPS.\"\"\"\n        response = client.get(\"/dashboard/overview\")\n\n        hsts = response.headers.get(\"Strict-Transport-Security\")\n        assert hsts is not None\n\n        # Should have long max-age for production\n        assert \"max-age=\" in hsts\n\n        # Should include subdomains\n        assert \"includeSubDomains\" in hsts\n\n    def test_x_xss_protection_header(self, client):\n        \"\"\"Test X-XSS-Protection header is set correctly.\"\"\"\n        response = client.get(\"/dashboard/overview\")\n\n        assert response.headers.get(\"X-XSS-Protection\") == \"1; mode=block\"\n\n    def test_referrer_policy_header(self, client):\n        \"\"\"Test Referrer-Policy header controls referrer information.\"\"\"\n        response = client.get(\"/dashboard/overview\")\n\n        assert response.headers.get(\"Referrer-Policy\") == \"strict-origin-when-cross-origin\"\n\n\n# ============================================================================\n# HTTP Method Tests\n# ============================================================================\n\n\nclass TestSecurityHeadersOnDifferentMethods:\n    \"\"\"Test security headers are present across different HTTP methods.\"\"\"\n\n    def test_get_request_has_security_headers(self, client):\n        \"\"\"Test GET requests have security headers.\"\"\"\n        response = client.get(\"/health\")\n\n        assert response.status_code == 200\n        assert \"Content-Security-Policy\" in response.headers\n        assert \"X-Content-Type-Options\" in response.headers\n        assert \"X-Frame-Options\" in response.headers\n        assert \"Strict-Transport-Security\" in response.headers\n        assert \"X-XSS-Protection\" in response.headers\n        assert \"Referrer-Policy\" in response.headers\n\n    def test_options_request_has_security_headers(self, client):\n        \"\"\"Test OPTIONS requests (CORS preflight) have security headers.\"\"\"\n        response = client.options(\"/health\")\n\n        # Security headers should be present even on OPTIONS\n        assert \"X-Content-Type-Options\" in response.headers\n        assert \"X-Frame-Options\" in response.headers\n\n\n# ============================================================================\n# WebSocket-Specific CSP Tests\n# ============================================================================\n\n\nclass TestWebSocketServiceCSP:\n    \"\"\"Test CSP configuration specific to WebSocket service.\"\"\"\n\n    def test_csp_allows_websocket_connections(self, client):\n        \"\"\"Test CSP allows WebSocket connections for real-time dashboard updates.\"\"\"\n        response = client.get(\"/dashboard/overview\")\n\n        csp = response.headers.get(\"Content-Security-Policy\")\n        assert csp is not None\n\n        # WebSocket service needs ws: and wss: in connect-src\n        csp_lower = csp.lower()\n        assert \"connect-src\" in csp_lower\n        # Should allow WebSocket protocols\n        assert \"ws:\" in csp_lower or \"wss:\" in csp_lower\n\n    def test_csp_allows_self_connections(self, client):\n        \"\"\"Test CSP allows connections to self for API calls.\"\"\"\n        response = client.get(\"/dashboard/overview\")\n\n        csp = response.headers.get(\"Content-Security-Policy\")\n        assert csp is not None\n\n        # Should allow self\n        assert \"'self'\" in csp\n\n    def test_csp_has_base_security_directives(self, client):\n        \"\"\"Test CSP has essential security directives.\"\"\"\n        response = client.get(\"/dashboard/overview\")\n\n        csp = response.headers.get(\"Content-Security-Policy\")\n        assert csp is not None\n\n        # Base security directives\n        assert \"default-src 'self'\" in csp\n        assert \"script-src 'self'\" in csp\n\n    def test_csp_allows_data_images(self, client):\n        \"\"\"Test CSP allows data: URIs for images (for dashboard charts and icons).\"\"\"\n        response = client.get(\"/dashboard/overview\")\n\n        csp = response.headers.get(\"Content-Security-Policy\")\n        assert csp is not None\n\n        # Should allow data: URIs for images\n        assert \"img-src\" in csp\n        assert \"data:\" in csp\n\n\n# ============================================================================\n# WebSocket Endpoint Tests\n# ============================================================================\n\n\nclass TestWebSocketSecurityHeaders:\n    \"\"\"Test WebSocket endpoint respects security requirements.\"\"\"\n\n    def test_websocket_upgrade_request(self, client):\n        \"\"\"Test WebSocket upgrade request handling.\"\"\"\n        # Note: TestClient doesn't fully support WebSocket testing,\n        # so we test what we can - the HTTP response headers before upgrade\n        # In production, the WebSocket connection would be established after\n        # the initial HTTP upgrade request\n\n        # Test that we can at least access the WebSocket endpoint\n        # The actual WebSocket connection requires a proper WebSocket client\n        # but we can verify the endpoint exists and security headers are configured\n\n        # This is a basic connectivity test - in production environments,\n        # use a proper WebSocket testing client\n        pass\n\n    def test_websocket_csp_configuration(self, client):\n        \"\"\"Test CSP configuration allows WebSocket upgrade.\"\"\"\n        response = client.get(\"/dashboard/overview\")\n\n        csp = response.headers.get(\"Content-Security-Policy\")\n        assert csp is not None\n\n        # The CSP should allow WebSocket connections\n        csp_lower = csp.lower()\n        # Check for ws: or wss: in the policy\n        has_ws = \"ws:\" in csp_lower or \"wss:\" in csp_lower\n        assert has_ws, \"CSP should allow WebSocket connections (ws: or wss:)\"\n\n\n# ============================================================================\n# Middleware Integration Tests\n# ============================================================================\n\n\nclass TestSecurityHeadersWithCORS:\n    \"\"\"Test security headers work alongside CORS middleware.\"\"\"\n\n    def test_security_headers_and_cors_headers_coexist(self, client):\n        \"\"\"Test both security and CORS headers are present.\"\"\"\n        response = client.get(\"/health\")\n\n        # Security headers should be present\n        assert \"Content-Security-Policy\" in response.headers\n        assert \"X-Content-Type-Options\" in response.headers\n        assert \"X-Frame-Options\" in response.headers\n        assert \"Strict-Transport-Security\" in response.headers\n        assert \"X-XSS-Protection\" in response.headers\n        assert \"Referrer-Policy\" in response.headers\n\n        # CORS headers should also be present (case-insensitive check)\n        headers_lower = {k.lower(): v for k, v in response.headers.items()}\n        assert \"access-control-allow-origin\" in headers_lower\n\n    def test_cors_preflight_has_security_headers(self, client):\n        \"\"\"Test CORS preflight OPTIONS requests have security headers.\"\"\"\n        response = client.options(\n            \"/dashboard/overview\",\n            headers={\n                \"Origin\": \"http://localhost:3000\",\n                \"Access-Control-Request-Method\": \"GET\",\n            },\n        )\n\n        # Security headers should be present even on preflight\n        assert \"X-Content-Type-Options\" in response.headers\n        assert \"X-Frame-Options\" in response.headers\n\n\n# ============================================================================\n# Edge Cases and Consistency Tests\n# ============================================================================\n\n\nclass TestSecurityHeadersEdgeCases:\n    \"\"\"Test edge cases and consistency of security headers.\"\"\"\n\n    def test_all_endpoints_have_consistent_headers(self, client):\n        \"\"\"Test all dashboard endpoints have the same security headers.\"\"\"\n        endpoints = [\n            (\"/health\", \"GET\"),\n            (\"/dashboard/overview\", \"GET\"),\n            (\"/dashboard/health\", \"GET\"),\n            (\"/dashboard/metrics\", \"GET\"),\n            (\"/dashboard/alerts\", \"GET\"),\n            (\"/dashboard/services\", \"GET\"),\n        ]\n\n        # Collect headers from all endpoints\n        all_headers = {}\n        for path, method in endpoints:\n            if method == \"GET\":\n                response = client.get(path)\n\n            # Extract security headers\n            security_headers = {\n                \"Content-Security-Policy\": response.headers.get(\"Content-Security-Policy\"),\n                \"X-Content-Type-Options\": response.headers.get(\"X-Content-Type-Options\"),\n                \"X-Frame-Options\": response.headers.get(\"X-Frame-Options\"),\n                \"X-XSS-Protection\": response.headers.get(\"X-XSS-Protection\"),\n                \"Referrer-Policy\": response.headers.get(\"Referrer-Policy\"),\n            }\n            all_headers[path] = security_headers\n\n        # Verify consistency across endpoints\n        # All endpoints should have the same values for most headers\n        first_endpoint = list(all_headers.values())[0]\n        for endpoint_headers in all_headers.values():\n            assert (\n                endpoint_headers[\"X-Content-Type-Options\"]\n                == first_endpoint[\"X-Content-Type-Options\"]\n            )\n            assert endpoint_headers[\"X-Frame-Options\"] == first_endpoint[\"X-Frame-Options\"]\n            assert endpoint_headers[\"X-XSS-Protection\"] == first_endpoint[\"X-XSS-Protection\"]\n            assert endpoint_headers[\"Referrer-Policy\"] == first_endpoint[\"Referrer-Policy\"]\n\n    def test_404_response_has_security_headers(self, client):\n        \"\"\"Test 404 responses still have security headers.\"\"\"\n        response = client.get(\"/nonexistent-endpoint\")\n\n        assert response.status_code == 404\n\n        # Security headers should be present even on error responses\n        assert \"Content-Security-Policy\" in response.headers\n        assert \"X-Content-Type-Options\" in response.headers\n        assert \"X-Frame-Options\" in response.headers\n        assert \"Strict-Transport-Security\" in response.headers\n        assert \"X-XSS-Protection\" in response.headers\n        assert \"Referrer-Policy\" in response.headers\n\n    def test_500_error_has_security_headers(self, client):\n        \"\"\"Test error responses have security headers.\"\"\"\n        # Note: This test would require triggering a 500 error\n        # which may not be straightforward without specific error conditions\n        # For now, we test what we can with 404\n        pass\n\n\n# ============================================================================\n# Compliance Verification Tests\n# ============================================================================\n\n\nclass TestSecurityHeadersCompliance:\n    \"\"\"Test compliance with security header requirements.\"\"\"\n\n    def test_all_six_required_headers_present(self, client):\n        \"\"\"Test all six required security headers are present.\"\"\"\n        response = client.get(\"/dashboard/overview\")\n\n        required_headers = [\n            \"Content-Security-Policy\",\n            \"X-Content-Type-Options\",\n            \"X-Frame-Options\",\n            \"Strict-Transport-Security\",\n            \"X-XSS-Protection\",\n            \"Referrer-Policy\",\n        ]\n\n        for header in required_headers:\n            assert header in response.headers, f\"Missing required header: {header}\"\n\n    def test_headers_have_non_empty_values(self, client):\n        \"\"\"Test security headers have non-empty values.\"\"\"\n        response = client.get(\"/dashboard/overview\")\n\n        security_headers = [\n            \"Content-Security-Policy\",\n            \"X-Content-Type-Options\",\n            \"X-Frame-Options\",\n            \"Strict-Transport-Security\",\n            \"X-XSS-Protection\",\n            \"Referrer-Policy\",\n        ]\n\n        for header in security_headers:\n            value = response.headers.get(header)\n            assert value is not None, f\"Header {header} is None\"\n            assert len(value) > 0, f\"Header {header} is empty\"\n\n    def test_production_grade_hsts(self, client):\n        \"\"\"Test HSTS is configured for production.\"\"\"\n        response = client.get(\"/dashboard/overview\")\n\n        hsts = response.headers.get(\"Strict-Transport-Security\")\n        assert hsts is not None\n\n        # Extract max-age value\n        max_age_str = None\n        for part in hsts.split(\";\"):\n            part = part.strip()\n            if part.startswith(\"max-age=\"):\n                max_age_str = part.split(\"=\")[1]\n                break\n\n        assert max_age_str is not None\n        max_age = int(max_age_str)\n\n        # Production should have max-age >= 1 day for observability dashboard\n        assert max_age >= 86400, \"HSTS max-age should be at least 1 day\"\n\n    def test_csp_configuration_for_websocket_service(self, client):\n        \"\"\"Test CSP is configured appropriately for WebSocket-enabled service.\"\"\"\n        response = client.get(\"/dashboard/overview\")\n\n        csp = response.headers.get(\"Content-Security-Policy\")\n        assert csp is not None\n\n        # Verify WebSocket service CSP characteristics\n        assert \"default-src 'self'\" in csp\n        assert \"script-src 'self'\" in csp\n\n        # Must allow WebSocket connections\n        csp_lower = csp.lower()\n        assert (\n            \"ws:\" in csp_lower or \"wss:\" in csp_lower\n        ), \"CSP must allow WebSocket connections for real-time dashboard updates\"\n\n\n# ============================================================================\n# Dashboard-Specific Endpoint Tests\n# ============================================================================\n\n\nclass TestDashboardEndpointSecurityHeaders:\n    \"\"\"Test security headers on dashboard-specific endpoints.\"\"\"\n\n    def test_overview_endpoint_returns_data_with_headers(self, client):\n        \"\"\"Test /dashboard/overview returns both data and security headers.\"\"\"\n        response = client.get(\"/dashboard/overview\")\n\n        # Should return success\n        assert response.status_code == 200\n\n        # Should have response body\n        data = response.json()\n        assert data is not None\n\n        # Verify all security headers present\n        assert \"Content-Security-Policy\" in response.headers\n        assert \"X-Content-Type-Options\" in response.headers\n        assert \"X-Frame-Options\" in response.headers\n        assert \"Strict-Transport-Security\" in response.headers\n        assert \"X-XSS-Protection\" in response.headers\n        assert \"Referrer-Policy\" in response.headers\n\n    def test_metrics_endpoint_returns_data_with_headers(self, client):\n        \"\"\"Test /dashboard/metrics returns both data and security headers.\"\"\"\n        response = client.get(\"/dashboard/metrics\")\n\n        # Should return success\n        assert response.status_code == 200\n\n        # Should have response body\n        data = response.json()\n        assert data is not None\n\n        # Security headers should be present\n        assert response.headers.get(\"X-Content-Type-Options\") == \"nosniff\"\n        assert response.headers.get(\"X-Frame-Options\") == \"DENY\"\n        assert response.headers.get(\"X-XSS-Protection\") == \"1; mode=block\"\n\n    def test_health_endpoint_returns_data_with_headers(self, client):\n        \"\"\"Test /dashboard/health returns both data and security headers.\"\"\"\n        response = client.get(\"/dashboard/health\")\n\n        # Should return success\n        assert response.status_code == 200\n\n        # Should have response body\n        data = response.json()\n        assert data is not None\n\n        # Security headers should be present\n        assert response.headers.get(\"X-Content-Type-Options\") == \"nosniff\"\n        assert response.headers.get(\"X-Frame-Options\") == \"DENY\"\n        assert response.headers.get(\"Referrer-Policy\") == \"strict-origin-when-cross-origin\"\n\n    def test_alerts_endpoint_returns_data_with_headers(self, client):\n        \"\"\"Test /dashboard/alerts returns both data and security headers.\"\"\"\n        response = client.get(\"/dashboard/alerts\")\n\n        # Should return success (200) with list of alerts (may be empty)\n        assert response.status_code == 200\n\n        # Should have response body (list)\n        data = response.json()\n        assert isinstance(data, list)\n\n        # Security headers should be present\n        assert response.headers.get(\"X-Content-Type-Options\") == \"nosniff\"\n        assert response.headers.get(\"X-Frame-Options\") == \"DENY\"\n\n\nif __name__ == \"__main__\":\n    pytest.main([__file__, \"-v\"])\n",
        "last_modified": "2026-01-03T19:08:32.490740"
      },
      "task_intent": {
        "title": "046-add-security-headers-middleware-to-fastapi-service",
        "description": "Multiple FastAPI services (integration-service, compliance-docs, observability dashboard) lack security headers middleware. Missing headers include Content-Security-Policy, X-Content-Type-Options, X-Frame-Options, Strict-Transport-Security, X-XSS-Protection, and Referrer-Policy.",
        "from_plan": true
      },
      "commits_behind_main": 11,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2026-01-03T19:07:31.778338",
  "last_updated": "2026-01-03T19:07:31.781531"
}