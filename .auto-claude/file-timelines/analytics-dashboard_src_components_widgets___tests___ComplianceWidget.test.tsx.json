{
  "file_path": "analytics-dashboard/src/components/widgets/__tests__/ComplianceWidget.test.tsx",
  "main_branch_history": [],
  "task_views": {
    "034-add-compliancewidget-to-analytics-dashboard": {
      "task_id": "034-add-compliancewidget-to-analytics-dashboard",
      "branch_point": {
        "commit_hash": "fc6e42927298263034acf989773f3200e422ad17",
        "content": "/**\n * ComplianceWidget Component Tests\n *\n * Tests for the ComplianceWidget component including:\n * - Initial loading state\n * - Displaying compliance data\n * - Severity filtering\n * - Empty state handling (100% compliance)\n * - Error handling and retry\n * - Integration with analytics-api /compliance endpoint\n */\n\nimport { describe, it, expect } from \"vitest\";\nimport { render, screen, waitFor, fireEvent } from \"@testing-library/react\";\nimport { http, HttpResponse } from \"msw\";\nimport { server } from \"../../../test/mocks/server\";\nimport { errorHandlers } from \"../../../test/mocks/handlers\";\nimport { ComplianceWidget } from \"../ComplianceWidget\";\n\nconst API_BASE_URL = \"http://localhost:8080\";\n\ndescribe(\"ComplianceWidget\", () => {\n  describe(\"Loading State\", () => {\n    it(\"shows loading skeleton on initial render\", async () => {\n      render(<ComplianceWidget />);\n\n      // Should show Compliance Status header during loading\n      expect(screen.getByText(\"Compliance Status\")).toBeInTheDocument();\n\n      // Should have loading animation elements\n      const loadingElements = document.querySelectorAll(\".animate-pulse\");\n      expect(loadingElements.length).toBeGreaterThan(0);\n    });\n  });\n\n  describe(\"Successful API Integration\", () => {\n    it(\"displays compliance data from /compliance endpoint\", async () => {\n      render(<ComplianceWidget />);\n\n      await waitFor(() => {\n        expect(\n          screen.getByText(\"Unencrypted PII detected in production database\")\n        ).toBeInTheDocument();\n      });\n\n      // Should show all violations\n      expect(\n        screen.getByText(\"Admin API endpoint accessible without MFA\")\n      ).toBeInTheDocument();\n      expect(\n        screen.getByText(\"Critical security patch overdue by 12 days\")\n      ).toBeInTheDocument();\n      expect(\n        screen.getByText(\"Log retention policy set to 60 days\")\n      ).toBeInTheDocument();\n      expect(\n        screen.getByText(\"Alert threshold set too high (50 attempts)\")\n      ).toBeInTheDocument();\n    });\n\n    it(\"shows compliance rate percentage\", async () => {\n      render(<ComplianceWidget />);\n\n      await waitFor(() => {\n        expect(screen.getByText(\"84.5%\")).toBeInTheDocument();\n      });\n    });\n\n    it(\"displays trend indicator\", async () => {\n      render(<ComplianceWidget />);\n\n      await waitFor(() => {\n        expect(screen.getByText(\"Improving\")).toBeInTheDocument();\n      });\n    });\n\n    it(\"shows severity breakdown\", async () => {\n      render(<ComplianceWidget />);\n\n      await waitFor(() => {\n        expect(screen.getByText(\"2\")).toBeInTheDocument(); // critical count\n      });\n\n      expect(screen.getByText(\"5\")).toBeInTheDocument(); // high count\n      expect(screen.getByText(\"8\")).toBeInTheDocument(); // medium count\n      expect(screen.getByText(\"12\")).toBeInTheDocument(); // low count\n\n      // Check for severity labels\n      expect(screen.getByText(\"Critical\")).toBeInTheDocument();\n      expect(screen.getByText(\"High\")).toBeInTheDocument();\n      expect(screen.getByText(\"Medium\")).toBeInTheDocument();\n      expect(screen.getByText(\"Low\")).toBeInTheDocument();\n    });\n\n    it(\"displays recent violations\", async () => {\n      render(<ComplianceWidget />);\n\n      await waitFor(() => {\n        // Check for violation rules\n        expect(\n          screen.getByText(\"Sensitive data must be encrypted at rest\")\n        ).toBeInTheDocument();\n      });\n\n      expect(\n        screen.getByText(\"API access requires multi-factor authentication\")\n      ).toBeInTheDocument();\n      expect(\n        screen.getByText(\"Security patches must be applied within 30 days\")\n      ).toBeInTheDocument();\n      expect(\n        screen.getByText(\"Access logs must be retained for 90 days\")\n      ).toBeInTheDocument();\n      expect(\n        screen.getByText(\"Failed login attempts must trigger alerts\")\n      ).toBeInTheDocument();\n\n      // Check for severity labels in violations\n      expect(screen.getByText(\"CRITICAL\")).toBeInTheDocument();\n      expect(screen.getByText(\"HIGH\")).toBeInTheDocument();\n      expect(screen.getAllByText(\"MEDIUM\").length).toBeGreaterThan(0);\n      expect(screen.getByText(\"LOW\")).toBeInTheDocument();\n\n      // Check for frameworks\n      expect(screen.getAllByText(\"SOC2\").length).toBeGreaterThan(0);\n      expect(screen.getAllByText(\"HIPAA\").length).toBeGreaterThan(0);\n      expect(screen.getByText(\"PCI-DSS\")).toBeInTheDocument();\n    });\n  });\n\n  describe(\"Severity Filtering\", () => {\n    it(\"shows all severity filter buttons\", async () => {\n      render(<ComplianceWidget />);\n\n      await waitFor(() => {\n        expect(\n          screen.getByRole(\"button\", { name: \"All\" })\n        ).toBeInTheDocument();\n      });\n\n      expect(\n        screen.getByRole(\"button\", { name: \"critical\" })\n      ).toBeInTheDocument();\n      expect(\n        screen.getByRole(\"button\", { name: \"high\" })\n      ).toBeInTheDocument();\n      expect(\n        screen.getByRole(\"button\", { name: \"medium\" })\n      ).toBeInTheDocument();\n      expect(screen.getByRole(\"button\", { name: \"low\" })).toBeInTheDocument();\n    });\n\n    it(\"filters violations by severity when filter is clicked\", async () => {\n      render(<ComplianceWidget />);\n\n      await waitFor(() => {\n        expect(\n          screen.getByText(\"Unencrypted PII detected in production database\")\n        ).toBeInTheDocument();\n      });\n\n      // Click on \"critical\" filter\n      fireEvent.click(screen.getByRole(\"button\", { name: \"critical\" }));\n\n      // Wait for filtered results\n      await waitFor(() => {\n        // Should only show critical violation\n        expect(\n          screen.getByText(\"Unencrypted PII detected in production database\")\n        ).toBeInTheDocument();\n      });\n\n      // Other violations should not be visible\n      expect(\n        screen.queryByText(\"Admin API endpoint accessible without MFA\")\n      ).not.toBeInTheDocument();\n    });\n  });\n\n  describe(\"Empty State\", () => {\n    it(\"shows 100% compliant message when no violations detected\", async () => {\n      // Override handler to return 100% compliance with no violations\n      server.use(\n        http.get(`${API_BASE_URL}/compliance`, () => {\n          return HttpResponse.json({\n            analysis_timestamp: new Date().toISOString(),\n            overall_score: 100,\n            trend: \"stable\" as const,\n            violations_by_severity: {\n              critical: 0,\n              high: 0,\n              medium: 0,\n              low: 0,\n            },\n            total_violations: 0,\n            recent_violations: [],\n            frameworks_analyzed: [\"SOC2\", \"HIPAA\", \"PCI-DSS\", \"GDPR\"],\n          });\n        })\n      );\n\n      render(<ComplianceWidget />);\n\n      await waitFor(() => {\n        expect(screen.getByText(\"100% Compliant\")).toBeInTheDocument();\n      });\n\n      expect(\n        screen.getByText(\"No policy violations detected\")\n      ).toBeInTheDocument();\n    });\n  });\n\n  describe(\"Error Handling\", () => {\n    it(\"displays error message when API fails\", async () => {\n      server.use(errorHandlers.complianceError);\n\n      render(<ComplianceWidget />);\n\n      await waitFor(() => {\n        expect(\n          screen.getByText(/Compliance service unavailable/)\n        ).toBeInTheDocument();\n      });\n\n      expect(screen.getByText(\"Try Again\")).toBeInTheDocument();\n    });\n\n    it(\"retries fetch when Try Again is clicked\", async () => {\n      server.use(errorHandlers.complianceError);\n\n      render(<ComplianceWidget />);\n\n      await waitFor(() => {\n        expect(screen.getByText(\"Try Again\")).toBeInTheDocument();\n      });\n\n      // Reset handlers\n      server.resetHandlers();\n\n      // Click retry\n      fireEvent.click(screen.getByText(\"Try Again\"));\n\n      await waitFor(\n        () => {\n          expect(screen.getByText(\"84.5%\")).toBeInTheDocument();\n        },\n        { timeout: 5000 }\n      );\n    });\n  });\n\n  describe(\"Refresh Functionality\", () => {\n    it(\"has a refresh button that reloads data\", async () => {\n      render(<ComplianceWidget />);\n\n      await waitFor(() => {\n        expect(screen.getByText(\"84.5%\")).toBeInTheDocument();\n      });\n\n      const refreshButton = screen.getByRole(\"button\", {\n        name: /refresh compliance data/i,\n      });\n      expect(refreshButton).toBeInTheDocument();\n\n      fireEvent.click(refreshButton);\n\n      await waitFor(() => {\n        expect(refreshButton).toBeEnabled();\n      });\n    });\n  });\n\n  describe(\"Accessibility\", () => {\n    it(\"has accessible button labels\", async () => {\n      render(<ComplianceWidget />);\n\n      await waitFor(() => {\n        expect(screen.getByText(\"84.5%\")).toBeInTheDocument();\n      });\n\n      expect(\n        screen.getByRole(\"button\", { name: /refresh compliance data/i })\n      ).toBeInTheDocument();\n    });\n\n    it(\"has proper heading structure\", async () => {\n      render(<ComplianceWidget />);\n\n      await waitFor(() => {\n        expect(screen.getByRole(\"heading\", { level: 3 })).toHaveTextContent(\n          \"Compliance Status\"\n        );\n      });\n    });\n  });\n});\n",
        "timestamp": "2026-01-04T05:36:41.954466"
      },
      "worktree_state": null,
      "task_intent": {
        "title": "034-add-compliancewidget-to-analytics-dashboard",
        "description": "Create a ComplianceWidget component showing real-time compliance status, compliance rate trends, and policy violation summaries. Follows the established widget pattern with loading/error/empty states, severity coloring, and refresh functionality.",
        "from_plan": true
      },
      "commits_behind_main": 0,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2026-01-03T19:36:40.466301",
  "last_updated": "2026-01-04T05:36:41.998501"
}