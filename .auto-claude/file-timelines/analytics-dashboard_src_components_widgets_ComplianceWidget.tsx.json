{
  "file_path": "analytics-dashboard/src/components/widgets/ComplianceWidget.tsx",
  "main_branch_history": [],
  "task_views": {
    "034-add-compliancewidget-to-analytics-dashboard": {
      "task_id": "034-add-compliancewidget-to-analytics-dashboard",
      "branch_point": {
        "commit_hash": "fc6e42927298263034acf989773f3200e422ad17",
        "content": "/**\n * ComplianceWidget Component\n *\n * Displays real-time compliance status including:\n * - Overall compliance rate with progress indicator\n * - Compliance trend (improving/stable/declining)\n * - Policy violations grouped by severity\n * - Recent violations list with details\n */\n\nimport { useCallback, useEffect, useState } from \"react\";\nimport {\n  AlertCircle,\n  AlertTriangle,\n  CheckCircle2,\n  Minus,\n  RefreshCw,\n  Shield,\n  TrendingDown,\n  TrendingUp,\n  XOctagon,\n} from \"lucide-react\";\n\n/** Severity levels for compliance violations */\ntype Severity = \"critical\" | \"high\" | \"medium\" | \"low\";\n\n/** Compliance trend direction */\ntype ComplianceTrend = \"improving\" | \"stable\" | \"declining\";\n\n/** Individual compliance violation/finding */\ninterface ComplianceViolation {\n  id: string;\n  rule: string;\n  severity: Severity;\n  description: string;\n  timestamp: string;\n  framework?: string;\n  evidence?: Record<string, unknown>;\n}\n\n/** Violations grouped by severity level */\ninterface ViolationsBySeverity {\n  critical: number;\n  high: number;\n  medium: number;\n  low: number;\n}\n\n/** Compliance data structure from the API */\ninterface ComplianceData {\n  analysis_timestamp: string;\n  overall_score: number;\n  trend: ComplianceTrend;\n  violations_by_severity: ViolationsBySeverity;\n  total_violations: number;\n  recent_violations: ComplianceViolation[];\n  frameworks_analyzed: string[];\n}\n\n/** Widget loading state */\ntype LoadingState = \"idle\" | \"loading\" | \"success\" | \"error\";\n\n/** API URL from environment */\nconst API_BASE_URL =\n  import.meta.env.VITE_ANALYTICS_API_URL || \"http://localhost:8080\";\n\n/**\n * Gets the appropriate icon for a severity level\n */\nfunction getSeverityIcon(severity: Severity): JSX.Element {\n  switch (severity) {\n    case \"critical\":\n      return <XOctagon className=\"h-4 w-4 text-red-600\" />;\n    case \"high\":\n      return <AlertTriangle className=\"h-4 w-4 text-orange-600\" />;\n    case \"medium\":\n      return <AlertCircle className=\"h-4 w-4 text-yellow-600\" />;\n    case \"low\":\n      return <CheckCircle2 className=\"h-4 w-4 text-blue-600\" />;\n    default:\n      return <AlertCircle className=\"h-4 w-4 text-gray-600\" />;\n  }\n}\n\n/**\n * Gets the color classes for a severity level\n */\nfunction getSeverityColors(severity: Severity): {\n  bg: string;\n  border: string;\n  text: string;\n  badge: string;\n} {\n  switch (severity) {\n    case \"critical\":\n      return {\n        bg: \"bg-red-50\",\n        border: \"border-red-200\",\n        text: \"text-red-800\",\n        badge: \"bg-red-100 text-red-800\",\n      };\n    case \"high\":\n      return {\n        bg: \"bg-orange-50\",\n        border: \"border-orange-200\",\n        text: \"text-orange-800\",\n        badge: \"bg-orange-100 text-orange-800\",\n      };\n    case \"medium\":\n      return {\n        bg: \"bg-yellow-50\",\n        border: \"border-yellow-200\",\n        text: \"text-yellow-800\",\n        badge: \"bg-yellow-100 text-yellow-800\",\n      };\n    case \"low\":\n      return {\n        bg: \"bg-blue-50\",\n        border: \"border-blue-200\",\n        text: \"text-blue-800\",\n        badge: \"bg-blue-100 text-blue-800\",\n      };\n    default:\n      return {\n        bg: \"bg-gray-50\",\n        border: \"border-gray-200\",\n        text: \"text-gray-800\",\n        badge: \"bg-gray-100 text-gray-800\",\n      };\n  }\n}\n\n/**\n * Gets the icon for compliance trend\n */\nfunction getTrendIcon(trend: ComplianceTrend): JSX.Element {\n  switch (trend) {\n    case \"improving\":\n      return <TrendingUp className=\"h-4 w-4 text-green-600\" />;\n    case \"declining\":\n      return <TrendingDown className=\"h-4 w-4 text-red-600\" />;\n    case \"stable\":\n      return <Minus className=\"h-4 w-4 text-gray-600\" />;\n    default:\n      return <Minus className=\"h-4 w-4 text-gray-600\" />;\n  }\n}\n\n/**\n * Gets the color class for compliance trend\n */\nfunction getTrendColor(trend: ComplianceTrend): string {\n  switch (trend) {\n    case \"improving\":\n      return \"text-green-600\";\n    case \"declining\":\n      return \"text-red-600\";\n    case \"stable\":\n      return \"text-gray-600\";\n    default:\n      return \"text-gray-600\";\n  }\n}\n\n/**\n * Formats the timestamp for display\n */\nfunction formatTimestamp(timestamp: string): string {\n  try {\n    const date = new Date(timestamp);\n    return date.toLocaleString(undefined, {\n      dateStyle: \"short\",\n      timeStyle: \"short\",\n    });\n  } catch {\n    return \"Unknown\";\n  }\n}\n\n/**\n * ComplianceWidget - Displays real-time compliance status and violations\n *\n * Features:\n * - Fetches compliance data from the analytics API\n * - Shows loading, error, and success states\n * - Displays overall compliance rate with progress indicator\n * - Shows compliance trend (improving/stable/declining)\n * - Lists violations grouped by severity\n * - Supports severity filtering\n * - Displays recent violations with details\n */\nexport function ComplianceWidget(): JSX.Element {\n  const [data, setData] = useState<ComplianceData | null>(null);\n  const [loadingState, setLoadingState] = useState<LoadingState>(\"idle\");\n  const [error, setError] = useState<string | null>(null);\n  const [severityFilter, setSeverityFilter] = useState<Severity | null>(null);\n\n  /**\n   * Fetches compliance data from the API\n   */\n  const fetchCompliance = useCallback(async () => {\n    setLoadingState(\"loading\");\n    setError(null);\n\n    try {\n      const url = new URL(`${API_BASE_URL}/compliance`);\n      if (severityFilter) {\n        url.searchParams.set(\"severity\", severityFilter);\n      }\n\n      const response = await fetch(url.toString(), {\n        method: \"GET\",\n        headers: {\n          Accept: \"application/json\",\n        },\n      });\n\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}));\n        throw new Error(\n          errorData.detail || `Failed to fetch compliance data: ${response.status}`\n        );\n      }\n\n      const responseData: ComplianceData = await response.json();\n      setData(responseData);\n      setLoadingState(\"success\");\n    } catch (err) {\n      const message =\n        err instanceof Error ? err.message : \"Failed to load compliance data\";\n      setError(message);\n      setLoadingState(\"error\");\n    }\n  }, [severityFilter]);\n\n  // Fetch compliance data on mount and when filter changes\n  useEffect(() => {\n    fetchCompliance();\n  }, [fetchCompliance]);\n\n  /**\n   * Handle refresh button click\n   */\n  const handleRefresh = () => {\n    fetchCompliance();\n  };\n\n  /**\n   * Handle severity filter change\n   */\n  const handleFilterChange = (severity: Severity | null) => {\n    setSeverityFilter(severity);\n  };\n\n  // Loading state\n  if (loadingState === \"loading\" && !data) {\n    return (\n      <div className=\"h-full rounded-lg bg-white p-4 shadow\">\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-2\">\n            <Shield className=\"h-5 w-5 text-blue-600\" />\n            <h3 className=\"text-lg font-semibold text-gray-900\">\n              Compliance Status\n            </h3>\n          </div>\n        </div>\n        <div className=\"mt-4 space-y-3\">\n          <div className=\"h-4 w-3/4 animate-pulse rounded bg-gray-200\" />\n          <div className=\"h-4 w-full animate-pulse rounded bg-gray-200\" />\n          <div className=\"h-4 w-5/6 animate-pulse rounded bg-gray-200\" />\n        </div>\n      </div>\n    );\n  }\n\n  // Error state\n  if (loadingState === \"error\") {\n    return (\n      <div className=\"h-full rounded-lg bg-white p-4 shadow\">\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-2\">\n            <Shield className=\"h-5 w-5 text-blue-600\" />\n            <h3 className=\"text-lg font-semibold text-gray-900\">\n              Compliance Status\n            </h3>\n          </div>\n          <button\n            onClick={handleRefresh}\n            className=\"rounded p-1 text-gray-400 transition-colors hover:bg-gray-100 hover:text-gray-600\"\n            title=\"Retry\"\n            aria-label=\"Retry loading compliance data\"\n          >\n            <RefreshCw className=\"h-4 w-4\" />\n          </button>\n        </div>\n        <div className=\"mt-4 flex flex-col items-center justify-center py-8\">\n          <AlertCircle className=\"h-8 w-8 text-red-500\" />\n          <p className=\"mt-2 text-center text-sm text-red-600\">{error}</p>\n          <button\n            onClick={handleRefresh}\n            className=\"mt-4 rounded-md bg-red-50 px-4 py-2 text-sm font-medium text-red-700 transition-colors hover:bg-red-100\"\n          >\n            Try Again\n          </button>\n        </div>\n      </div>\n    );\n  }\n\n  // Empty state (100% compliance - no violations)\n  if (data && data.total_violations === 0) {\n    return (\n      <div className=\"flex h-full flex-col rounded-lg bg-white p-4 shadow\">\n        {/* Header */}\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-2\">\n            <Shield className=\"h-5 w-5 text-blue-600\" />\n            <h3 className=\"text-lg font-semibold text-gray-900\">\n              Compliance Status\n            </h3>\n          </div>\n          <button\n            onClick={handleRefresh}\n            disabled={loadingState === \"loading\"}\n            className=\"rounded p-1 text-gray-400 transition-colors hover:bg-gray-100 hover:text-gray-600 disabled:cursor-not-allowed disabled:opacity-50\"\n            title=\"Refresh compliance data\"\n            aria-label=\"Refresh compliance data\"\n          >\n            <RefreshCw\n              className={`h-4 w-4 ${loadingState === \"loading\" ? \"animate-spin\" : \"\"}`}\n            />\n          </button>\n        </div>\n\n        {/* Empty state - 100% compliance */}\n        <div className=\"flex flex-1 flex-col items-center justify-center py-8\">\n          <CheckCircle2 className=\"h-12 w-12 text-green-500\" />\n          <p className=\"mt-3 text-lg font-medium text-gray-900\">\n            100% Compliant\n          </p>\n          <p className=\"mt-1 text-center text-sm text-gray-500\">\n            No policy violations detected\n          </p>\n          <p className=\"text-center text-xs text-gray-400\">\n            Last checked: {formatTimestamp(data.analysis_timestamp)}\n          </p>\n        </div>\n      </div>\n    );\n  }\n\n  // Success state with compliance data\n  return (\n    <div className=\"flex h-full flex-col rounded-lg bg-white p-4 shadow\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-2\">\n          <Shield className=\"h-5 w-5 text-blue-600\" />\n          <h3 className=\"text-lg font-semibold text-gray-900\">\n            Compliance Status\n          </h3>\n        </div>\n        <button\n          onClick={handleRefresh}\n          disabled={loadingState === \"loading\"}\n          className=\"rounded p-1 text-gray-400 transition-colors hover:bg-gray-100 hover:text-gray-600 disabled:cursor-not-allowed disabled:opacity-50\"\n          title=\"Refresh compliance data\"\n          aria-label=\"Refresh compliance data\"\n        >\n          <RefreshCw\n            className={`h-4 w-4 ${loadingState === \"loading\" ? \"animate-spin\" : \"\"}`}\n          />\n        </button>\n      </div>\n\n      {/* Compliance Score and Trend */}\n      {data && (\n        <div className=\"mt-4\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <p className=\"text-3xl font-bold text-gray-900\">\n                {data.overall_score.toFixed(1)}%\n              </p>\n              <p className=\"text-sm text-gray-500\">Overall Compliance</p>\n            </div>\n            <div className=\"flex items-center gap-1\">\n              {getTrendIcon(data.trend)}\n              <span className={`text-sm font-medium capitalize ${getTrendColor(data.trend)}`}>\n                {data.trend}\n              </span>\n            </div>\n          </div>\n\n          {/* Progress bar */}\n          <div className=\"mt-2 h-2 w-full rounded-full bg-gray-200\">\n            <div\n              className={`h-2 rounded-full transition-all ${\n                data.overall_score >= 90\n                  ? \"bg-green-600\"\n                  : data.overall_score >= 70\n                    ? \"bg-yellow-600\"\n                    : \"bg-red-600\"\n              }`}\n              style={{ width: `${data.overall_score}%` }}\n            />\n          </div>\n        </div>\n      )}\n\n      {/* Violations by Severity */}\n      {data && data.total_violations > 0 && (\n        <div className=\"mt-4 grid grid-cols-4 gap-2\">\n          {([\"critical\", \"high\", \"medium\", \"low\"] as const).map((severity) => {\n            const count = data.violations_by_severity[severity];\n            const colors = getSeverityColors(severity);\n            return (\n              <div\n                key={severity}\n                className={`rounded-lg border p-2 text-center ${colors.bg} ${colors.border}`}\n              >\n                <p className={`text-lg font-bold ${colors.text}`}>{count}</p>\n                <p className={`text-xs capitalize ${colors.text}`}>\n                  {severity}\n                </p>\n              </div>\n            );\n          })}\n        </div>\n      )}\n\n      {/* Severity Filter */}\n      {data && data.recent_violations.length > 0 && (\n        <div className=\"mt-4 flex flex-wrap gap-1\">\n          <button\n            onClick={() => handleFilterChange(null)}\n            className={`rounded-full px-2.5 py-0.5 text-xs font-medium transition-colors ${\n              severityFilter === null\n                ? \"bg-gray-800 text-white\"\n                : \"bg-gray-100 text-gray-600 hover:bg-gray-200\"\n            }`}\n          >\n            All\n          </button>\n          {([\"critical\", \"high\", \"medium\", \"low\"] as const).map((level) => {\n            const colors = getSeverityColors(level);\n            return (\n              <button\n                key={level}\n                onClick={() => handleFilterChange(level)}\n                className={`rounded-full px-2.5 py-0.5 text-xs font-medium capitalize transition-colors ${\n                  severityFilter === level\n                    ? colors.badge\n                    : \"bg-gray-100 text-gray-600 hover:bg-gray-200\"\n                }`}\n              >\n                {level}\n              </button>\n            );\n          })}\n        </div>\n      )}\n\n      {/* Recent Violations List */}\n      {data && data.recent_violations.length > 0 && (\n        <div className=\"mt-4 flex-1 space-y-2 overflow-y-auto\">\n          <h4 className=\"text-sm font-medium text-gray-700\">\n            Recent Violations\n          </h4>\n          {data.recent_violations.map((violation) => {\n            const colors = getSeverityColors(violation.severity);\n            return (\n              <div\n                key={violation.id}\n                className={`rounded-lg border p-3 ${colors.bg} ${colors.border}`}\n              >\n                {/* Violation Header */}\n                <div className=\"flex items-start justify-between gap-2\">\n                  <div className=\"flex items-center gap-2\">\n                    {getSeverityIcon(violation.severity)}\n                    <span\n                      className={`rounded px-1.5 py-0.5 text-xs font-semibold uppercase ${colors.badge}`}\n                    >\n                      {violation.severity}\n                    </span>\n                  </div>\n                  <span className=\"text-xs text-gray-500\">\n                    {formatTimestamp(violation.timestamp)}\n                  </span>\n                </div>\n\n                {/* Rule Name */}\n                <p className=\"mt-2 text-sm font-medium text-gray-900\">\n                  {violation.rule}\n                </p>\n\n                {/* Description */}\n                <p className={`mt-1 text-sm ${colors.text}`}>\n                  {violation.description}\n                </p>\n\n                {/* Framework badge (if available) */}\n                {violation.framework && (\n                  <div className=\"mt-2\">\n                    <span className=\"rounded bg-white bg-opacity-60 px-1.5 py-0.5 text-xs text-gray-700\">\n                      {violation.framework}\n                    </span>\n                  </div>\n                )}\n              </div>\n            );\n          })}\n        </div>\n      )}\n\n      {/* Footer with metadata */}\n      {data && (\n        <div className=\"mt-4 flex items-center justify-between border-t border-gray-100 pt-3 text-xs text-gray-500\">\n          <div className=\"flex items-center gap-4\">\n            <span>\n              Total violations:{\" \"}\n              <span className=\"font-medium text-gray-700\">\n                {data.total_violations}\n              </span>\n            </span>\n            {data.frameworks_analyzed.length > 0 && (\n              <span>\n                Frameworks:{\" \"}\n                <span className=\"font-medium text-gray-700\">\n                  {data.frameworks_analyzed.join(\", \")}\n                </span>\n              </span>\n            )}\n          </div>\n          <span title={data.analysis_timestamp}>\n            {formatTimestamp(data.analysis_timestamp)}\n          </span>\n        </div>\n      )}\n    </div>\n  );\n}\n\nexport default ComplianceWidget;\n",
        "timestamp": "2026-01-04T05:36:41.954466"
      },
      "worktree_state": null,
      "task_intent": {
        "title": "034-add-compliancewidget-to-analytics-dashboard",
        "description": "Create a ComplianceWidget component showing real-time compliance status, compliance rate trends, and policy violation summaries. Follows the established widget pattern with loading/error/empty states, severity coloring, and refresh functionality.",
        "from_plan": true
      },
      "commits_behind_main": 0,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2026-01-03T19:36:40.474379",
  "last_updated": "2026-01-04T05:36:41.972470"
}