{
  "file_path": "src/core/shared/security/tests/test_security_headers.py",
  "main_branch_history": [],
  "task_views": {
    "046-add-security-headers-middleware-to-fastapi-service": {
      "task_id": "046-add-security-headers-middleware-to-fastapi-service",
      "branch_point": {
        "commit_hash": "4a99fe22e8e0087919301b1aa185d4e2c6da716c",
        "content": "",
        "timestamp": "2026-01-03T19:07:31.669524"
      },
      "worktree_state": {
        "content": "\"\"\"\nTests for Security Headers Middleware\nConstitutional Hash: cdd01ef066bc6cf2\n\nTests verify:\n- SecurityHeadersConfig dataclass (defaults, custom config, environment-based configs)\n- Environment-specific configuration methods (development, production, WebSocket, integration)\n- CSP header value generation and custom directives\n- HSTS header value generation with various options\n- SecurityHeadersMiddleware integration with FastAPI\n- All six security headers present in responses\n- add_security_headers convenience function\n\"\"\"\n\nimport os\nimport sys\nfrom unittest.mock import MagicMock, patch\n\nimport pytest\n\nsys.path.insert(0, os.path.join(os.path.dirname(__file__), \"../../..\"))\n\nfrom fastapi import FastAPI  # noqa: E402, I001\nfrom fastapi.testclient import TestClient  # noqa: E402, I001\nfrom starlette.requests import Request  # noqa: E402, I001\n\nfrom shared.security.security_headers import (  # noqa: E402, I001\n    CONSTITUTIONAL_HASH,\n    SecurityHeadersConfig,\n    SecurityHeadersMiddleware,\n    add_security_headers,\n)\n\n\n# ============================================================================\n# SecurityHeadersConfig Tests - Defaults and Basic Configuration\n# ============================================================================\n\n\nclass TestSecurityHeadersConfigDefaults:\n    \"\"\"Test SecurityHeadersConfig default values.\"\"\"\n\n    def test_default_config(self):\n        \"\"\"Test default configuration values.\"\"\"\n        config = SecurityHeadersConfig()\n        assert config.environment == \"production\"\n        assert config.enable_hsts is True\n        assert config.hsts_max_age == 31536000  # 1 year\n        assert config.hsts_include_subdomains is True\n        assert config.hsts_preload is False\n        assert config.custom_csp_directives is None\n        assert config.frame_options == \"DENY\"\n        assert config.referrer_policy == \"strict-origin-when-cross-origin\"\n        assert config.enable_xss_protection is True\n\n    def test_custom_config(self):\n        \"\"\"Test custom configuration values.\"\"\"\n        config = SecurityHeadersConfig(\n            environment=\"development\",\n            enable_hsts=False,\n            hsts_max_age=300,\n            hsts_include_subdomains=False,\n            hsts_preload=True,\n            custom_csp_directives={\"default-src\": [\"'self'\"]},\n            frame_options=\"SAMEORIGIN\",\n            referrer_policy=\"no-referrer\",\n            enable_xss_protection=False,\n        )\n        assert config.environment == \"development\"\n        assert config.enable_hsts is False\n        assert config.hsts_max_age == 300\n        assert config.hsts_include_subdomains is False\n        assert config.hsts_preload is True\n        assert config.custom_csp_directives == {\"default-src\": [\"'self'\"]}\n        assert config.frame_options == \"SAMEORIGIN\"\n        assert config.referrer_policy == \"no-referrer\"\n        assert config.enable_xss_protection is False\n\n\n# ============================================================================\n# SecurityHeadersConfig Tests - from_env Method\n# ============================================================================\n\n\nclass TestSecurityHeadersConfigFromEnv:\n    \"\"\"Test SecurityHeadersConfig.from_env() method.\"\"\"\n\n    def test_from_env_defaults_production(self, monkeypatch):\n        \"\"\"Test from_env with no environment variables (production defaults).\"\"\"\n        # Clear relevant env vars\n        env_vars_to_clear = [\n            \"APP_ENV\",\n            \"SECURITY_HSTS_ENABLED\",\n            \"SECURITY_HSTS_MAX_AGE\",\n            \"SECURITY_FRAME_OPTIONS\",\n        ]\n        for key in env_vars_to_clear:\n            monkeypatch.delenv(key, raising=False)\n\n        config = SecurityHeadersConfig.from_env()\n        assert config.environment == \"production\"\n        assert config.enable_hsts is True\n        assert config.hsts_max_age == 31536000  # 1 year\n\n    def test_from_env_development(self, monkeypatch):\n        \"\"\"Test from_env with development environment.\"\"\"\n        monkeypatch.setenv(\"APP_ENV\", \"development\")\n        monkeypatch.delenv(\"SECURITY_HSTS_ENABLED\", raising=False)\n        monkeypatch.delenv(\"SECURITY_HSTS_MAX_AGE\", raising=False)\n\n        config = SecurityHeadersConfig.from_env()\n        assert config.environment == \"development\"\n        assert config.enable_hsts is False  # Disabled by default in dev\n        assert config.hsts_max_age == 300  # 5 minutes\n\n    def test_from_env_staging(self, monkeypatch):\n        \"\"\"Test from_env with staging environment.\"\"\"\n        monkeypatch.setenv(\"APP_ENV\", \"staging\")\n        monkeypatch.delenv(\"SECURITY_HSTS_ENABLED\", raising=False)\n        monkeypatch.delenv(\"SECURITY_HSTS_MAX_AGE\", raising=False)\n\n        config = SecurityHeadersConfig.from_env()\n        assert config.environment == \"staging\"\n        assert config.enable_hsts is True\n        assert config.hsts_max_age == 86400  # 1 day\n\n    def test_from_env_custom_hsts_enabled(self, monkeypatch):\n        \"\"\"Test from_env with custom HSTS enabled setting.\"\"\"\n        monkeypatch.setenv(\"APP_ENV\", \"development\")\n        monkeypatch.setenv(\"SECURITY_HSTS_ENABLED\", \"true\")\n\n        config = SecurityHeadersConfig.from_env()\n        assert config.enable_hsts is True\n\n    def test_from_env_custom_hsts_disabled(self, monkeypatch):\n        \"\"\"Test from_env with custom HSTS disabled setting.\"\"\"\n        monkeypatch.setenv(\"APP_ENV\", \"production\")\n        monkeypatch.setenv(\"SECURITY_HSTS_ENABLED\", \"false\")\n\n        config = SecurityHeadersConfig.from_env()\n        assert config.enable_hsts is False\n\n    def test_from_env_custom_hsts_max_age(self, monkeypatch):\n        \"\"\"Test from_env with custom HSTS max-age.\"\"\"\n        monkeypatch.setenv(\"APP_ENV\", \"production\")\n        monkeypatch.setenv(\"SECURITY_HSTS_MAX_AGE\", \"7200\")\n\n        config = SecurityHeadersConfig.from_env()\n        assert config.hsts_max_age == 7200\n\n    def test_from_env_custom_frame_options(self, monkeypatch):\n        \"\"\"Test from_env with custom frame options.\"\"\"\n        monkeypatch.delenv(\"APP_ENV\", raising=False)\n        monkeypatch.setenv(\"SECURITY_FRAME_OPTIONS\", \"SAMEORIGIN\")\n\n        config = SecurityHeadersConfig.from_env()\n        assert config.frame_options == \"SAMEORIGIN\"\n\n    def test_from_env_case_insensitive_environment(self, monkeypatch):\n        \"\"\"Test from_env handles case-insensitive environment names.\"\"\"\n        monkeypatch.setenv(\"APP_ENV\", \"PRODUCTION\")\n        config = SecurityHeadersConfig.from_env()\n        assert config.environment == \"production\"\n\n        monkeypatch.setenv(\"APP_ENV\", \"Development\")\n        config = SecurityHeadersConfig.from_env()\n        assert config.environment == \"development\"\n\n\n# ============================================================================\n# SecurityHeadersConfig Tests - Environment-Specific Factories\n# ============================================================================\n\n\nclass TestSecurityHeadersConfigFactories:\n    \"\"\"Test SecurityHeadersConfig factory methods.\"\"\"\n\n    def test_for_development(self):\n        \"\"\"Test for_development creates development-friendly config.\"\"\"\n        config = SecurityHeadersConfig.for_development()\n        assert config.environment == \"development\"\n        assert config.enable_hsts is False\n        assert config.hsts_max_age == 300  # 5 minutes\n        assert config.hsts_include_subdomains is False\n        assert config.custom_csp_directives is not None\n        assert \"default-src\" in config.custom_csp_directives\n        assert \"'self'\" in config.custom_csp_directives[\"default-src\"]\n        assert \"script-src\" in config.custom_csp_directives\n        assert \"'unsafe-inline'\" in config.custom_csp_directives[\"script-src\"]\n        assert \"'unsafe-eval'\" in config.custom_csp_directives[\"script-src\"]\n        assert \"connect-src\" in config.custom_csp_directives\n        assert \"localhost:*\" in config.custom_csp_directives[\"connect-src\"]\n\n    def test_for_production_default(self):\n        \"\"\"Test for_production creates strict production config.\"\"\"\n        config = SecurityHeadersConfig.for_production()\n        assert config.environment == \"production\"\n        assert config.enable_hsts is True\n        assert config.hsts_max_age == 31536000  # 1 year\n        assert config.hsts_include_subdomains is True\n        assert config.hsts_preload is True\n        assert config.custom_csp_directives is not None\n        assert \"default-src\" in config.custom_csp_directives\n        assert config.custom_csp_directives[\"default-src\"] == [\"'self'\"]\n        assert \"script-src\" in config.custom_csp_directives\n        assert config.custom_csp_directives[\"script-src\"] == [\"'self'\"]\n        assert \"frame-ancestors\" in config.custom_csp_directives\n        assert config.custom_csp_directives[\"frame-ancestors\"] == [\"'none'\"]\n        assert config.frame_options == \"DENY\"\n\n    def test_for_production_non_strict(self):\n        \"\"\"Test for_production with strict=False.\"\"\"\n        config = SecurityHeadersConfig.for_production(strict=False)\n        assert config.environment == \"production\"\n        assert config.enable_hsts is True\n        assert config.custom_csp_directives is None\n\n    def test_for_websocket_service(self):\n        \"\"\"Test for_websocket_service creates WebSocket-enabled config.\"\"\"\n        config = SecurityHeadersConfig.for_websocket_service()\n        assert config.environment == \"production\"\n        assert config.enable_hsts is True\n        assert config.hsts_max_age == 31536000\n        assert config.custom_csp_directives is not None\n        assert \"connect-src\" in config.custom_csp_directives\n        assert \"ws:\" in config.custom_csp_directives[\"connect-src\"]\n        assert \"wss:\" in config.custom_csp_directives[\"connect-src\"]\n        assert \"style-src\" in config.custom_csp_directives\n        assert \"'unsafe-inline'\" in config.custom_csp_directives[\"style-src\"]\n\n    def test_for_integration_service(self):\n        \"\"\"Test for_integration_service creates integration-friendly config.\"\"\"\n        config = SecurityHeadersConfig.for_integration_service()\n        assert config.environment == \"production\"\n        assert config.enable_hsts is True\n        assert config.hsts_max_age == 31536000\n        assert config.custom_csp_directives is not None\n        assert \"connect-src\" in config.custom_csp_directives\n        assert \"https:\" in config.custom_csp_directives[\"connect-src\"]\n        assert \"img-src\" in config.custom_csp_directives\n        assert \"https:\" in config.custom_csp_directives[\"img-src\"]\n\n\n# ============================================================================\n# SecurityHeadersConfig Tests - CSP Header Generation\n# ============================================================================\n\n\nclass TestSecurityHeadersConfigCSP:\n    \"\"\"Test CSP header value generation.\"\"\"\n\n    def test_get_csp_header_value_default(self):\n        \"\"\"Test CSP header generation with default directives.\"\"\"\n        config = SecurityHeadersConfig()\n        csp = config.get_csp_header_value()\n\n        assert \"default-src 'self'\" in csp\n        assert \"script-src 'self'\" in csp\n        assert \"style-src 'self'\" in csp\n        assert \"img-src 'self' data:\" in csp\n        assert \"font-src 'self'\" in csp\n        assert \"connect-src 'self'\" in csp\n        assert \"frame-ancestors 'none'\" in csp\n        assert \"base-uri 'self'\" in csp\n        assert \"form-action 'self'\" in csp\n\n    def test_get_csp_header_value_custom_directives(self):\n        \"\"\"Test CSP header generation with custom directives.\"\"\"\n        config = SecurityHeadersConfig(\n            custom_csp_directives={\n                \"default-src\": [\"'self'\", \"https://example.com\"],\n                \"script-src\": [\"'self'\", \"'unsafe-inline'\"],\n                \"connect-src\": [\"'self'\", \"wss://ws.example.com\"],\n            }\n        )\n        csp = config.get_csp_header_value()\n\n        assert \"default-src 'self' https://example.com\" in csp\n        assert \"script-src 'self' 'unsafe-inline'\" in csp\n        assert \"connect-src 'self' wss://ws.example.com\" in csp\n        # Should still have other default directives\n        assert \"base-uri 'self'\" in csp\n        assert \"form-action 'self'\" in csp\n\n    def test_get_csp_header_value_custom_overrides_defaults(self):\n        \"\"\"Test custom CSP directives override defaults.\"\"\"\n        config = SecurityHeadersConfig(\n            custom_csp_directives={\n                \"default-src\": [\"'none'\"],\n                \"script-src\": [\"'self'\", \"https://cdn.example.com\"],\n            }\n        )\n        csp = config.get_csp_header_value()\n\n        # Custom directive should override default\n        assert \"default-src 'none'\" in csp\n        assert \"default-src 'self'\" not in csp\n        assert \"script-src 'self' https://cdn.example.com\" in csp\n\n    def test_get_csp_header_value_websocket_config(self):\n        \"\"\"Test CSP header for WebSocket service config.\"\"\"\n        config = SecurityHeadersConfig.for_websocket_service()\n        csp = config.get_csp_header_value()\n\n        assert \"connect-src 'self' ws: wss:\" in csp\n        assert \"style-src 'self' 'unsafe-inline'\" in csp\n\n    def test_get_csp_header_value_development_config(self):\n        \"\"\"Test CSP header for development config.\"\"\"\n        config = SecurityHeadersConfig.for_development()\n        csp = config.get_csp_header_value()\n\n        assert \"'unsafe-inline'\" in csp\n        assert \"'unsafe-eval'\" in csp\n        assert \"localhost:*\" in csp\n\n\n# ============================================================================\n# SecurityHeadersConfig Tests - HSTS Header Generation\n# ============================================================================\n\n\nclass TestSecurityHeadersConfigHSTS:\n    \"\"\"Test HSTS header value generation.\"\"\"\n\n    def test_get_hsts_header_value_default(self):\n        \"\"\"Test HSTS header generation with defaults.\"\"\"\n        config = SecurityHeadersConfig()\n        hsts = config.get_hsts_header_value()\n\n        assert hsts is not None\n        assert \"max-age=31536000\" in hsts\n        assert \"includeSubDomains\" in hsts\n        assert \"preload\" not in hsts\n\n    def test_get_hsts_header_value_disabled(self):\n        \"\"\"Test HSTS header generation when disabled.\"\"\"\n        config = SecurityHeadersConfig(enable_hsts=False)\n        hsts = config.get_hsts_header_value()\n        assert hsts is None\n\n    def test_get_hsts_header_value_with_preload(self):\n        \"\"\"Test HSTS header generation with preload.\"\"\"\n        config = SecurityHeadersConfig(hsts_preload=True)\n        hsts = config.get_hsts_header_value()\n\n        assert \"max-age=31536000\" in hsts\n        assert \"includeSubDomains\" in hsts\n        assert \"preload\" in hsts\n\n    def test_get_hsts_header_value_without_subdomains(self):\n        \"\"\"Test HSTS header generation without subdomains.\"\"\"\n        config = SecurityHeadersConfig(hsts_include_subdomains=False)\n        hsts = config.get_hsts_header_value()\n\n        assert \"max-age=31536000\" in hsts\n        assert \"includeSubDomains\" not in hsts\n\n    def test_get_hsts_header_value_custom_max_age(self):\n        \"\"\"Test HSTS header generation with custom max-age.\"\"\"\n        config = SecurityHeadersConfig(hsts_max_age=7200)\n        hsts = config.get_hsts_header_value()\n        assert \"max-age=7200\" in hsts\n\n    def test_get_hsts_header_value_development(self):\n        \"\"\"Test HSTS header for development config.\"\"\"\n        config = SecurityHeadersConfig.for_development()\n        hsts = config.get_hsts_header_value()\n        assert hsts is None  # Disabled in development\n\n    def test_get_hsts_header_value_production(self):\n        \"\"\"Test HSTS header for production config.\"\"\"\n        config = SecurityHeadersConfig.for_production()\n        hsts = config.get_hsts_header_value()\n\n        assert hsts is not None\n        assert \"max-age=31536000\" in hsts\n        assert \"includeSubDomains\" in hsts\n        assert \"preload\" in hsts\n\n\n# ============================================================================\n# SecurityHeadersMiddleware Tests - Basic Functionality\n# ============================================================================\n\n\nclass TestSecurityHeadersMiddlewareBasic:\n    \"\"\"Test SecurityHeadersMiddleware basic functionality.\"\"\"\n\n    def create_test_app(self, config: SecurityHeadersConfig = None) -> FastAPI:\n        \"\"\"Create a test FastAPI app with security headers middleware.\"\"\"\n        app = FastAPI()\n        if config:\n            app.add_middleware(SecurityHeadersMiddleware, config=config)\n        else:\n            app.add_middleware(SecurityHeadersMiddleware)\n\n        @app.get(\"/\")\n        async def root():\n            return {\"message\": \"Hello World\"}\n\n        @app.get(\"/api/data\")\n        async def api_data():\n            return {\"data\": [1, 2, 3]}\n\n        @app.post(\"/api/create\")\n        async def api_create(data: dict):\n            return {\"created\": True, \"data\": data}\n\n        return app\n\n    def test_middleware_initialization_default_config(self):\n        \"\"\"Test middleware initializes with default config.\"\"\"\n        app = FastAPI()\n        with patch.dict(os.environ, {}, clear=False):\n            app.add_middleware(SecurityHeadersMiddleware)\n        # Should not raise an exception\n        assert True\n\n    def test_middleware_initialization_custom_config(self):\n        \"\"\"Test middleware initializes with custom config.\"\"\"\n        app = FastAPI()\n        config = SecurityHeadersConfig.for_development()\n        app.add_middleware(SecurityHeadersMiddleware, config=config)\n        # Should not raise an exception\n        assert True\n\n    def test_middleware_adds_all_security_headers(self):\n        \"\"\"Test middleware adds all required security headers.\"\"\"\n        app = self.create_test_app()\n        client = TestClient(app)\n\n        response = client.get(\"/\")\n        assert response.status_code == 200\n\n        # Check all 6 security headers are present\n        assert \"Content-Security-Policy\" in response.headers\n        assert \"X-Content-Type-Options\" in response.headers\n        assert \"X-Frame-Options\" in response.headers\n        assert \"Strict-Transport-Security\" in response.headers\n        assert \"X-XSS-Protection\" in response.headers\n        assert \"Referrer-Policy\" in response.headers\n\n    def test_middleware_content_security_policy_header(self):\n        \"\"\"Test Content-Security-Policy header.\"\"\"\n        app = self.create_test_app()\n        client = TestClient(app)\n\n        response = client.get(\"/\")\n        csp = response.headers.get(\"Content-Security-Policy\")\n\n        assert csp is not None\n        assert \"default-src 'self'\" in csp\n        assert \"script-src 'self'\" in csp\n\n    def test_middleware_x_content_type_options_header(self):\n        \"\"\"Test X-Content-Type-Options header.\"\"\"\n        app = self.create_test_app()\n        client = TestClient(app)\n\n        response = client.get(\"/\")\n        assert response.headers.get(\"X-Content-Type-Options\") == \"nosniff\"\n\n    def test_middleware_x_frame_options_header(self):\n        \"\"\"Test X-Frame-Options header.\"\"\"\n        app = self.create_test_app()\n        client = TestClient(app)\n\n        response = client.get(\"/\")\n        assert response.headers.get(\"X-Frame-Options\") == \"DENY\"\n\n    def test_middleware_strict_transport_security_header(self):\n        \"\"\"Test Strict-Transport-Security header.\"\"\"\n        app = self.create_test_app()\n        client = TestClient(app)\n\n        response = client.get(\"/\")\n        hsts = response.headers.get(\"Strict-Transport-Security\")\n\n        assert hsts is not None\n        assert \"max-age=31536000\" in hsts\n        assert \"includeSubDomains\" in hsts\n\n    def test_middleware_x_xss_protection_header(self):\n        \"\"\"Test X-XSS-Protection header.\"\"\"\n        app = self.create_test_app()\n        client = TestClient(app)\n\n        response = client.get(\"/\")\n        assert response.headers.get(\"X-XSS-Protection\") == \"1; mode=block\"\n\n    def test_middleware_referrer_policy_header(self):\n        \"\"\"Test Referrer-Policy header.\"\"\"\n        app = self.create_test_app()\n        client = TestClient(app)\n\n        response = client.get(\"/\")\n        assert response.headers.get(\"Referrer-Policy\") == \"strict-origin-when-cross-origin\"\n\n    def test_middleware_applies_to_all_endpoints(self):\n        \"\"\"Test middleware applies headers to all endpoints.\"\"\"\n        app = self.create_test_app()\n        client = TestClient(app)\n\n        # Test GET endpoints\n        response1 = client.get(\"/\")\n        response2 = client.get(\"/api/data\")\n\n        for response in [response1, response2]:\n            assert \"Content-Security-Policy\" in response.headers\n            assert \"X-Content-Type-Options\" in response.headers\n            assert \"X-Frame-Options\" in response.headers\n\n    def test_middleware_applies_to_post_requests(self):\n        \"\"\"Test middleware applies headers to POST requests.\"\"\"\n        app = self.create_test_app()\n        client = TestClient(app)\n\n        response = client.post(\"/api/create\", json={\"name\": \"test\"})\n        assert response.status_code == 200\n\n        # Check security headers are present\n        assert \"Content-Security-Policy\" in response.headers\n        assert \"X-Content-Type-Options\" in response.headers\n        assert \"X-Frame-Options\" in response.headers\n\n\n# ============================================================================\n# SecurityHeadersMiddleware Tests - Custom Configurations\n# ============================================================================\n\n\nclass TestSecurityHeadersMiddlewareCustomConfig:\n    \"\"\"Test SecurityHeadersMiddleware with custom configurations.\"\"\"\n\n    def test_middleware_development_config(self):\n        \"\"\"Test middleware with development configuration.\"\"\"\n        app = FastAPI()\n        config = SecurityHeadersConfig.for_development()\n        app.add_middleware(SecurityHeadersMiddleware, config=config)\n\n        @app.get(\"/\")\n        async def root():\n            return {\"message\": \"Dev\"}\n\n        client = TestClient(app)\n        response = client.get(\"/\")\n\n        # HSTS should be disabled in development\n        assert \"Strict-Transport-Security\" not in response.headers\n\n        # CSP should allow unsafe-inline and unsafe-eval\n        csp = response.headers.get(\"Content-Security-Policy\")\n        assert \"'unsafe-inline'\" in csp\n        assert \"'unsafe-eval'\" in csp\n\n    def test_middleware_production_config(self):\n        \"\"\"Test middleware with production configuration.\"\"\"\n        app = FastAPI()\n        config = SecurityHeadersConfig.for_production()\n        app.add_middleware(SecurityHeadersMiddleware, config=config)\n\n        @app.get(\"/\")\n        async def root():\n            return {\"message\": \"Prod\"}\n\n        client = TestClient(app)\n        response = client.get(\"/\")\n\n        # HSTS should be enabled with preload\n        hsts = response.headers.get(\"Strict-Transport-Security\")\n        assert \"max-age=31536000\" in hsts\n        assert \"includeSubDomains\" in hsts\n        assert \"preload\" in hsts\n\n        # CSP should be strict\n        csp = response.headers.get(\"Content-Security-Policy\")\n        assert \"script-src 'self'\" in csp\n        assert \"'unsafe-inline'\" not in csp\n        assert \"'unsafe-eval'\" not in csp\n\n    def test_middleware_websocket_config(self):\n        \"\"\"Test middleware with WebSocket configuration.\"\"\"\n        app = FastAPI()\n        config = SecurityHeadersConfig.for_websocket_service()\n        app.add_middleware(SecurityHeadersMiddleware, config=config)\n\n        @app.get(\"/\")\n        async def root():\n            return {\"message\": \"WebSocket Service\"}\n\n        client = TestClient(app)\n        response = client.get(\"/\")\n\n        # CSP should allow WebSocket connections\n        csp = response.headers.get(\"Content-Security-Policy\")\n        assert \"connect-src 'self' ws: wss:\" in csp\n\n    def test_middleware_integration_service_config(self):\n        \"\"\"Test middleware with integration service configuration.\"\"\"\n        app = FastAPI()\n        config = SecurityHeadersConfig.for_integration_service()\n        app.add_middleware(SecurityHeadersMiddleware, config=config)\n\n        @app.get(\"/\")\n        async def root():\n            return {\"message\": \"Integration Service\"}\n\n        client = TestClient(app)\n        response = client.get(\"/\")\n\n        # CSP should allow HTTPS external connections\n        csp = response.headers.get(\"Content-Security-Policy\")\n        assert \"connect-src 'self' https:\" in csp\n\n    def test_middleware_custom_frame_options(self):\n        \"\"\"Test middleware with custom frame options.\"\"\"\n        app = FastAPI()\n        config = SecurityHeadersConfig(frame_options=\"SAMEORIGIN\")\n        app.add_middleware(SecurityHeadersMiddleware, config=config)\n\n        @app.get(\"/\")\n        async def root():\n            return {\"message\": \"Custom Frame Options\"}\n\n        client = TestClient(app)\n        response = client.get(\"/\")\n        assert response.headers.get(\"X-Frame-Options\") == \"SAMEORIGIN\"\n\n    def test_middleware_custom_referrer_policy(self):\n        \"\"\"Test middleware with custom referrer policy.\"\"\"\n        app = FastAPI()\n        config = SecurityHeadersConfig(referrer_policy=\"no-referrer\")\n        app.add_middleware(SecurityHeadersMiddleware, config=config)\n\n        @app.get(\"/\")\n        async def root():\n            return {\"message\": \"Custom Referrer Policy\"}\n\n        client = TestClient(app)\n        response = client.get(\"/\")\n        assert response.headers.get(\"Referrer-Policy\") == \"no-referrer\"\n\n    def test_middleware_xss_protection_disabled(self):\n        \"\"\"Test middleware with XSS protection disabled.\"\"\"\n        app = FastAPI()\n        config = SecurityHeadersConfig(enable_xss_protection=False)\n        app.add_middleware(SecurityHeadersMiddleware, config=config)\n\n        @app.get(\"/\")\n        async def root():\n            return {\"message\": \"No XSS Protection\"}\n\n        client = TestClient(app)\n        response = client.get(\"/\")\n        assert \"X-XSS-Protection\" not in response.headers\n\n    def test_middleware_hsts_disabled(self):\n        \"\"\"Test middleware with HSTS disabled.\"\"\"\n        app = FastAPI()\n        config = SecurityHeadersConfig(enable_hsts=False)\n        app.add_middleware(SecurityHeadersMiddleware, config=config)\n\n        @app.get(\"/\")\n        async def root():\n            return {\"message\": \"No HSTS\"}\n\n        client = TestClient(app)\n        response = client.get(\"/\")\n        assert \"Strict-Transport-Security\" not in response.headers\n\n\n# ============================================================================\n# add_security_headers Function Tests\n# ============================================================================\n\n\nclass TestAddSecurityHeadersFunction:\n    \"\"\"Test add_security_headers convenience function.\"\"\"\n\n    def test_add_security_headers_default(self):\n        \"\"\"Test add_security_headers with defaults.\"\"\"\n        app = FastAPI()\n\n        with patch.dict(os.environ, {\"APP_ENV\": \"production\"}, clear=False):\n            add_security_headers(app)\n\n        @app.get(\"/\")\n        async def root():\n            return {\"message\": \"Test\"}\n\n        client = TestClient(app)\n        response = client.get(\"/\")\n\n        assert \"Content-Security-Policy\" in response.headers\n        assert \"X-Content-Type-Options\" in response.headers\n\n    def test_add_security_headers_development_environment(self):\n        \"\"\"Test add_security_headers with development environment.\"\"\"\n        app = FastAPI()\n        add_security_headers(app, environment=\"development\")\n\n        @app.get(\"/\")\n        async def root():\n            return {\"message\": \"Dev\"}\n\n        client = TestClient(app)\n        response = client.get(\"/\")\n\n        # HSTS should be disabled in development\n        assert \"Strict-Transport-Security\" not in response.headers\n\n        # CSP should allow unsafe directives\n        csp = response.headers.get(\"Content-Security-Policy\")\n        assert \"'unsafe-inline'\" in csp\n\n    def test_add_security_headers_production_environment(self):\n        \"\"\"Test add_security_headers with production environment.\"\"\"\n        app = FastAPI()\n        add_security_headers(app, environment=\"production\")\n\n        @app.get(\"/\")\n        async def root():\n            return {\"message\": \"Prod\"}\n\n        client = TestClient(app)\n        response = client.get(\"/\")\n\n        # HSTS should be enabled\n        hsts = response.headers.get(\"Strict-Transport-Security\")\n        assert hsts is not None\n        assert \"preload\" in hsts\n\n    def test_add_security_headers_custom_config(self):\n        \"\"\"Test add_security_headers with custom config.\"\"\"\n        app = FastAPI()\n        config = SecurityHeadersConfig(\n            frame_options=\"SAMEORIGIN\",\n            referrer_policy=\"no-referrer\",\n        )\n        add_security_headers(app, config=config)\n\n        @app.get(\"/\")\n        async def root():\n            return {\"message\": \"Custom\"}\n\n        client = TestClient(app)\n        response = client.get(\"/\")\n\n        assert response.headers.get(\"X-Frame-Options\") == \"SAMEORIGIN\"\n        assert response.headers.get(\"Referrer-Policy\") == \"no-referrer\"\n\n    def test_add_security_headers_config_overrides_environment(self):\n        \"\"\"Test custom config parameter overrides environment parameter.\"\"\"\n        app = FastAPI()\n        config = SecurityHeadersConfig(frame_options=\"SAMEORIGIN\")\n        add_security_headers(app, environment=\"development\", config=config)\n\n        @app.get(\"/\")\n        async def root():\n            return {\"message\": \"Override\"}\n\n        client = TestClient(app)\n        response = client.get(\"/\")\n\n        # Custom config should be used\n        assert response.headers.get(\"X-Frame-Options\") == \"SAMEORIGIN\"\n\n\n# ============================================================================\n# Integration Tests\n# ============================================================================\n\n\nclass TestSecurityHeadersIntegration:\n    \"\"\"Integration tests for security headers middleware.\"\"\"\n\n    def test_all_headers_present_in_real_app(self):\n        \"\"\"Test all six security headers are present in a real app.\"\"\"\n        app = FastAPI()\n        add_security_headers(app, environment=\"production\")\n\n        @app.get(\"/health\")\n        async def health():\n            return {\"status\": \"healthy\"}\n\n        @app.get(\"/api/users\")\n        async def users():\n            return {\"users\": []}\n\n        @app.post(\"/api/users\")\n        async def create_user(user: dict):\n            return {\"created\": True}\n\n        client = TestClient(app)\n\n        # Test multiple endpoints\n        endpoints = [\n            (\"GET\", \"/health\"),\n            (\"GET\", \"/api/users\"),\n            (\"POST\", \"/api/users\", {\"name\": \"test\"}),\n        ]\n\n        for method, path, *args in endpoints:\n            if method == \"GET\":\n                response = client.get(path)\n            elif method == \"POST\":\n                response = client.post(path, json=args[0])\n\n            # Verify all 6 headers\n            assert \"Content-Security-Policy\" in response.headers\n            assert \"X-Content-Type-Options\" in response.headers\n            assert \"X-Frame-Options\" in response.headers\n            assert \"Strict-Transport-Security\" in response.headers\n            assert \"X-XSS-Protection\" in response.headers\n            assert \"Referrer-Policy\" in response.headers\n\n    def test_headers_work_with_cors_middleware(self):\n        \"\"\"Test security headers work alongside CORS middleware.\"\"\"\n        from starlette.middleware.cors import CORSMiddleware\n\n        app = FastAPI()\n\n        # Add CORS first (as documented in implementation notes)\n        app.add_middleware(\n            CORSMiddleware,\n            allow_origins=[\"*\"],\n            allow_credentials=True,\n            allow_methods=[\"*\"],\n            allow_headers=[\"*\"],\n        )\n\n        # Add security headers after CORS\n        add_security_headers(app, environment=\"production\")\n\n        @app.get(\"/api/data\")\n        async def data():\n            return {\"data\": \"test\"}\n\n        client = TestClient(app)\n        response = client.get(\"/api/data\")\n\n        # Both CORS and security headers should be present\n        assert \"access-control-allow-origin\" in response.headers\n        assert \"Content-Security-Policy\" in response.headers\n        assert \"X-Content-Type-Options\" in response.headers\n\n    def test_environment_specific_behavior(self):\n        \"\"\"Test different behaviors across environments.\"\"\"\n        environments = {\n            \"development\": SecurityHeadersConfig.for_development(),\n            \"production\": SecurityHeadersConfig.for_production(),\n        }\n\n        for env_name, config in environments.items():\n            app = FastAPI()\n            app.add_middleware(SecurityHeadersMiddleware, config=config)\n\n            @app.get(\"/\")\n            async def root():\n                return {\"env\": env_name}\n\n            client = TestClient(app)\n            response = client.get(\"/\")\n\n            if env_name == \"development\":\n                # Development should not have HSTS\n                assert \"Strict-Transport-Security\" not in response.headers\n                # Development should have relaxed CSP\n                csp = response.headers.get(\"Content-Security-Policy\")\n                assert \"'unsafe-inline'\" in csp\n            elif env_name == \"production\":\n                # Production should have strict HSTS\n                hsts = response.headers.get(\"Strict-Transport-Security\")\n                assert \"max-age=31536000\" in hsts\n                assert \"preload\" in hsts\n                # Production should have strict CSP\n                csp = response.headers.get(\"Content-Security-Policy\")\n                assert \"'unsafe-inline'\" not in csp or \"style-src\" not in csp\n\n\n# ============================================================================\n# Edge Cases and Error Handling\n# ============================================================================\n\n\nclass TestSecurityHeadersEdgeCases:\n    \"\"\"Test edge cases and boundary conditions.\"\"\"\n\n    def test_empty_custom_csp_directives(self):\n        \"\"\"Test config with empty custom CSP directives.\"\"\"\n        config = SecurityHeadersConfig(custom_csp_directives={})\n        csp = config.get_csp_header_value()\n\n        # Should still have default directives\n        assert \"default-src 'self'\" in csp\n        assert \"script-src 'self'\" in csp\n\n    def test_very_long_csp_directive_list(self):\n        \"\"\"Test CSP with many sources in a directive.\"\"\"\n        sources = [\"'self'\"] + [f\"https://cdn{i}.example.com\" for i in range(50)]\n        config = SecurityHeadersConfig(\n            custom_csp_directives={\"script-src\": sources}\n        )\n        csp = config.get_csp_header_value()\n\n        # Should contain all sources\n        assert \"'self'\" in csp\n        assert \"https://cdn0.example.com\" in csp\n        assert \"https://cdn49.example.com\" in csp\n\n    def test_hsts_max_age_zero(self):\n        \"\"\"Test HSTS with max-age of zero.\"\"\"\n        config = SecurityHeadersConfig(hsts_max_age=0)\n        hsts = config.get_hsts_header_value()\n        assert \"max-age=0\" in hsts\n\n    def test_hsts_all_options_disabled(self):\n        \"\"\"Test HSTS with only max-age.\"\"\"\n        config = SecurityHeadersConfig(\n            hsts_include_subdomains=False,\n            hsts_preload=False,\n        )\n        hsts = config.get_hsts_header_value()\n\n        assert \"max-age=31536000\" in hsts\n        assert \"includeSubDomains\" not in hsts\n        assert \"preload\" not in hsts\n\n    def test_middleware_preserves_existing_headers(self):\n        \"\"\"Test middleware preserves existing response headers.\"\"\"\n        app = FastAPI()\n        add_security_headers(app, environment=\"production\")\n\n        @app.get(\"/\")\n        async def root():\n            from fastapi.responses import JSONResponse\n\n            return JSONResponse(\n                content={\"message\": \"test\"},\n                headers={\"X-Custom-Header\": \"custom-value\"},\n            )\n\n        client = TestClient(app)\n        response = client.get(\"/\")\n\n        # Custom header should be preserved\n        assert response.headers.get(\"X-Custom-Header\") == \"custom-value\"\n        # Security headers should also be present\n        assert \"Content-Security-Policy\" in response.headers\n\n\n# ============================================================================\n# Constitutional Compliance Tests\n# ============================================================================\n\n\nclass TestConstitutionalCompliance:\n    \"\"\"Test constitutional hash compliance.\"\"\"\n\n    def test_constitutional_hash_present(self):\n        \"\"\"Constitutional hash should be defined.\"\"\"\n        assert CONSTITUTIONAL_HASH == \"cdd01ef066bc6cf2\"\n\n    def test_constitutional_hash_in_module_docstring(self):\n        \"\"\"Constitutional hash should be in module docstring.\"\"\"\n        from shared.security import security_headers\n\n        assert \"cdd01ef066bc6cf2\" in security_headers.__doc__\n\n\n# ============================================================================\n# Logging Tests\n# ============================================================================\n\n\nclass TestSecurityHeadersLogging:\n    \"\"\"Test logging functionality.\"\"\"\n\n    def test_middleware_logs_initialization(self):\n        \"\"\"Test middleware logs initialization.\"\"\"\n        with patch(\"shared.security.security_headers.logger\") as mock_logger:\n            app = FastAPI()\n            config = SecurityHeadersConfig.for_production()\n            app.add_middleware(SecurityHeadersMiddleware, config=config)\n\n            mock_logger.info.assert_called()\n            call_args = mock_logger.info.call_args[0][0]\n            assert \"Security headers middleware initialized\" in call_args\n            assert \"production\" in call_args\n\n    def test_add_security_headers_logs(self):\n        \"\"\"Test add_security_headers logs addition.\"\"\"\n        with patch(\"shared.security.security_headers.logger\") as mock_logger:\n            app = FastAPI()\n            add_security_headers(app, environment=\"production\")\n\n            mock_logger.info.assert_called()\n            call_args = mock_logger.info.call_args[0][0]\n            assert \"Added security headers middleware\" in call_args\n\n\nif __name__ == \"__main__\":\n    pytest.main([__file__, \"-v\"])\n",
        "last_modified": "2026-01-03T19:08:32.489769"
      },
      "task_intent": {
        "title": "046-add-security-headers-middleware-to-fastapi-service",
        "description": "Multiple FastAPI services (integration-service, compliance-docs, observability dashboard) lack security headers middleware. Missing headers include Content-Security-Policy, X-Content-Type-Options, X-Frame-Options, Strict-Transport-Security, X-XSS-Protection, and Referrer-Policy.",
        "from_plan": true
      },
      "commits_behind_main": 11,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2026-01-03T19:07:31.771572",
  "last_updated": "2026-01-03T19:07:31.774388"
}