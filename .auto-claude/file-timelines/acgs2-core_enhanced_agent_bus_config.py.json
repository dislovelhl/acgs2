{
  "file_path": "src/core/enhanced_agent_bus/config.py",
  "main_branch_history": [],
  "task_views": {
    "056-reduce-excessive-any-type-usage-in-python-codebase": {
      "task_id": "056-reduce-excessive-any-type-usage-in-python-codebase",
      "branch_point": {
        "commit_hash": "fc6e42927298263034acf989773f3200e422ad17",
        "content": "\"\"\"\nACGS-2 Enhanced Agent Bus - Configuration\nConstitutional Hash: cdd01ef066bc6cf2\n\nConfiguration dataclass for the Enhanced Agent Bus.\nFollows the Builder pattern for clean configuration management.\n\"\"\"\n\nimport os\nfrom dataclasses import dataclass, field, replace\nfrom typing import TYPE_CHECKING, Any, Optional\nfrom urllib.parse import urlparse\n\nimport litellm\nfrom litellm.caching import Cache\n\n# Import types conditionally to avoid circular imports\nif TYPE_CHECKING:\n    pass\n\n\n# Import centralized constitutional hash with fallback\ntry:\n    from shared.constants import CONSTITUTIONAL_HASH\nexcept ImportError:\n    CONSTITUTIONAL_HASH = \"cdd01ef066bc6cf2\"\n\n# Default Redis URL with fallback\ntry:\n    from shared.redis_config import get_redis_url\n\n    DEFAULT_REDIS_URL = get_redis_url()\nexcept ImportError:\n    DEFAULT_REDIS_URL = \"redis://localhost:6379\"\n\n\n@dataclass\nclass BusConfiguration:\n    \"\"\"Configuration for EnhancedAgentBus.\n\n    Consolidates all configuration options into a single, immutable dataclass.\n    This follows the Configuration Object pattern for clean dependency management.\n\n    Example usage:\n        # Default configuration\n        config = BusConfiguration()\n\n        # Custom configuration\n        config = BusConfiguration(\n            use_dynamic_policy=True,\n            policy_fail_closed=True,\n            enable_metering=True,\n        )\n\n        # Build configuration from environment\n        config = BusConfiguration.from_environment()\n    \"\"\"\n\n    # Connection settings\n    redis_url: str = DEFAULT_REDIS_URL\n    kafka_bootstrap_servers: str = \"localhost:9092\"\n    audit_service_url: str = \"http://localhost:8001\"\n\n    # Feature flags\n    use_dynamic_policy: bool = False\n    # SECURITY FIX (2025-12): Default to fail-closed for security-first behavior\n    policy_fail_closed: bool = True\n    use_kafka: bool = False\n    use_redis_registry: bool = False\n    use_rust: bool = True\n    enable_metering: bool = True\n\n    # MACI role separation settings\n    # SECURITY FIX (audit finding 2025-12): MACI enabled by default to prevent\n    # G\u00f6del bypass attacks through role separation enforcement.\n    # Set enable_maci=False only for legacy/testing - see for_testing() method.\n    enable_maci: bool = True\n    maci_strict_mode: bool = True\n\n    # LLM Configuration for high-ambiguity intent classification\n    # Added for Spec 001\n    llm_model: str = \"anthropic/claude-3-5-sonnet-20240620\"\n    llm_cache_ttl: int = 3600\n    llm_confidence_threshold: float = 0.8\n    llm_max_tokens: int = 100\n    llm_use_cache: bool = True\n\n    # Optional dependency injections (set to None for defaults)\n    # Note: These are typed as Any to avoid circular imports at runtime\n    registry: Optional[Any] = None\n    router: Optional[Any] = None\n    validator: Optional[Any] = None\n    processor: Optional[Any] = None\n    metering_config: Optional[Any] = None\n\n    # Constitutional settings\n    constitutional_hash: str = field(default=CONSTITUTIONAL_HASH)\n\n    def __post_init__(self) -> None:\n        \"\"\"Validate configuration after initialization.\"\"\"\n        # Ensure constitutional hash is always set\n        if not self.constitutional_hash:\n            self.constitutional_hash = CONSTITUTIONAL_HASH\n\n    @staticmethod\n    def _parse_bool(value: Any) -> bool:\n        \"\"\"Parse various representations of boolean values.\"\"\"\n        if isinstance(value, bool):\n            return value\n        if value is None:\n            return False\n        s = str(value).lower()\n        return s in (\"true\", \"1\", \"yes\", \"on\", \"y\", \"t\")\n\n    @staticmethod\n    def _parse_int(value: Optional[str], default: int) -> int:\n        \"\"\"Parse integer value with fallback to default.\"\"\"\n        if value is None:\n            return default\n        try:\n            return int(value)\n        except ValueError:\n            return default\n\n    @staticmethod\n    def _parse_float(value: Optional[str], default: float) -> float:\n        \"\"\"Parse float value with fallback to default.\"\"\"\n        if value is None:\n            return default\n        try:\n            return float(value)\n        except ValueError:\n            return default\n\n    @classmethod\n    def from_environment(cls) -> \"BusConfiguration\":\n        \"\"\"Load configuration from environment variables.\"\"\"\n        config = cls(\n            redis_url=os.getenv(\"REDIS_URL\", DEFAULT_REDIS_URL),\n            kafka_bootstrap_servers=os.getenv(\"KAFKA_BOOTSTRAP_SERVERS\", \"localhost:9092\"),\n            audit_service_url=os.getenv(\"AUDIT_SERVICE_URL\", \"http://localhost:8001\"),\n            use_dynamic_policy=os.getenv(\"USE_DYNAMIC_POLICY\", \"false\").lower() == \"true\",\n            policy_fail_closed=os.getenv(\"POLICY_FAIL_CLOSED\", \"true\").lower() == \"true\",\n            use_kafka=os.getenv(\"USE_KAFKA\", \"false\").lower() == \"true\",\n            use_redis_registry=os.getenv(\"USE_REDIS_REGISTRY\", \"false\").lower() == \"true\",\n            use_rust=os.getenv(\"USE_RUST\", \"true\").lower() == \"true\",\n            enable_metering=os.getenv(\"ENABLE_METERING\", \"true\").lower() == \"true\",\n            enable_maci=os.getenv(\"ENABLE_MACI\", \"true\").lower() == \"true\",\n            maci_strict_mode=os.getenv(\"MACI_STRICT_MODE\", \"true\").lower() == \"true\",\n            llm_model=os.getenv(\"LLM_MODEL\", \"anthropic/claude-3-5-sonnet-20240620\"),\n            llm_cache_ttl=int(os.getenv(\"LLM_CACHE_TTL\", \"3600\")),\n            llm_confidence_threshold=float(os.getenv(\"LLM_CONFIDENCE_THRESHOLD\", \"0.8\")),\n            llm_max_tokens=int(os.getenv(\"LLM_MAX_TOKENS\", \"100\")),\n            llm_use_cache=os.getenv(\"LLM_USE_CACHE\", \"true\").lower() == \"true\",\n        )\n\n        # Initialize LiteLLM Cache if enabled\n        if config.llm_use_cache:\n            try:\n                parsed_url = urlparse(config.redis_url)\n                litellm.cache = Cache(\n                    type=\"redis\",\n                    host=parsed_url.hostname or \"localhost\",\n                    port=parsed_url.port or 6379,\n                    password=parsed_url.password,\n                )\n            except Exception:\n                # Fallback to in-memory if redis fails or isn't available\n                litellm.cache = Cache()\n\n        return config\n\n    @classmethod\n    def for_testing(cls) -> \"BusConfiguration\":\n        \"\"\"Create a minimal configuration for unit testing.\n\n        Disables all optional features for fast, isolated testing.\n        \"\"\"\n        return cls(\n            use_dynamic_policy=False,\n            policy_fail_closed=False,\n            use_kafka=False,\n            use_redis_registry=False,\n            use_rust=False,\n            enable_metering=False,\n            enable_maci=False,\n            maci_strict_mode=False,\n            # Disable LLM for testing to avoid external API calls\n            llm_enabled=False,\n            enable_ab_testing=False,\n        )\n\n    @classmethod\n    def for_production(cls) -> \"BusConfiguration\":\n        \"\"\"Create a configuration suitable for production use.\n\n        Enables all production features with fail-closed security.\n        \"\"\"\n        return cls(\n            use_dynamic_policy=True,\n            policy_fail_closed=True,\n            use_kafka=True,\n            use_redis_registry=True,\n            use_rust=True,\n            enable_metering=True,\n            enable_maci=True,\n            maci_strict_mode=True,\n            # Enable LLM classification for production\n            llm_enabled=True,\n            llm_confidence_threshold=0.7,\n            enable_ab_testing=False,\n        )\n\n    def with_registry(self, registry: Any) -> \"BusConfiguration\":\n        \"\"\"Return a new configuration with the specified registry.\n\n        Builder pattern method for fluent configuration.\n        Uses dataclasses.replace() for immutable field updates.\n        \"\"\"\n        return replace(self, registry=registry)\n\n    def with_validator(self, validator: Any) -> \"BusConfiguration\":\n        \"\"\"Return a new configuration with the specified validator.\n\n        Builder pattern method for fluent configuration.\n        Uses dataclasses.replace() for immutable field updates.\n        \"\"\"\n        return replace(self, validator=validator)\n\n    def to_dict(self) -> dict:\n        \"\"\"Convert configuration to dictionary for logging/serialization.\"\"\"\n        return {\n            \"redis_url\": self.redis_url,\n            \"kafka_bootstrap_servers\": self.kafka_bootstrap_servers,\n            \"audit_service_url\": self.audit_service_url,\n            \"use_dynamic_policy\": self.use_dynamic_policy,\n            \"policy_fail_closed\": self.policy_fail_closed,\n            \"use_kafka\": self.use_kafka,\n            \"use_redis_registry\": self.use_redis_registry,\n            \"use_rust\": self.use_rust,\n            \"enable_metering\": self.enable_metering,\n            \"enable_maci\": self.enable_maci,\n            \"maci_strict_mode\": self.maci_strict_mode,\n            \"constitutional_hash\": self.constitutional_hash,\n            # LLM classification settings\n            \"llm_enabled\": self.llm_enabled,\n            \"llm_model_version\": self.llm_model_version,\n            \"llm_cache_ttl\": self.llm_cache_ttl,\n            \"llm_confidence_threshold\": self.llm_confidence_threshold,\n            \"llm_max_tokens\": self.llm_max_tokens,\n            # A/B testing settings\n            \"enable_ab_testing\": self.enable_ab_testing,\n            \"ab_test_llm_percentage\": self.ab_test_llm_percentage,\n            # Dependency injection status\n            \"has_custom_registry\": self.registry is not None,\n            \"has_custom_router\": self.router is not None,\n            \"has_custom_validator\": self.validator is not None,\n            \"has_custom_processor\": self.processor is not None,\n            \"has_metering_config\": self.metering_config is not None,\n        }\n\n\ntry:\n    from shared.config import settings\nexcept ImportError:\n    settings = BusConfiguration()  # Use as fallback if shared settings not available\n",
        "timestamp": "2026-01-04T05:35:58.374613"
      },
      "worktree_state": null,
      "task_intent": {
        "title": "056-reduce-excessive-any-type-usage-in-python-codebase",
        "description": "Found 373 occurrences of ': Any' type annotations across 120+ Python files, with high concentrations in integration-service (16 occurrences), src/core/breakthrough (79 occurrences), and src/core/enhanced_agent_bus (50+ occurrences). Excessive use of 'Any' defeats the purpose of type hints and can mask type-related bugs.",
        "from_plan": true
      },
      "commits_behind_main": 0,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2026-01-03T19:36:18.083505",
  "last_updated": "2026-01-04T05:35:58.515394"
}