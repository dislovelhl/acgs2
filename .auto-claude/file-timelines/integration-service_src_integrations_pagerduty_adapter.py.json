{
  "file_path": "integration-service/src/integrations/pagerduty_adapter.py",
  "main_branch_history": [],
  "task_views": {
    "036-add-pagerduty-integration-adapter-for-incident-man": {
      "task_id": "036-add-pagerduty-integration-adapter-for-incident-man",
      "branch_point": {
        "commit_hash": "4a99fe22e8e0087919301b1aa185d4e2c6da716c",
        "content": "",
        "timestamp": "2026-01-03T17:33:31.406851"
      },
      "worktree_state": {
        "content": "\"\"\"\nPagerDuty Integration Adapter\n\nProvides integration with PagerDuty for creating incidents from governance events.\nSupports both Events API v2 for incident creation and REST API for incident management.\n\nFeatures:\n- Events API v2 integration key authentication for incident creation\n- REST API token authentication for incident management\n- Configurable severity to urgency mapping\n- Automatic dedup_key generation\n- Custom event fields support (source, component, group, class)\n- Rate limit handling\n- Incident lifecycle management (create, resolve, escalate, add notes)\n\nExample - Basic incident creation (Events API only):\n    ```python\n    from pydantic import SecretStr\n    from integrations.pagerduty_adapter import PagerDutyAdapter, PagerDutyCredentials\n    from integrations.base import IntegrationEvent, EventSeverity\n    from datetime import datetime\n\n    # Create credentials\n    credentials = PagerDutyCredentials(\n        integration_name=\"Production PagerDuty\",\n        integration_key=SecretStr(\"your-integration-key-here\"),\n    )\n\n    # Initialize adapter\n    adapter = PagerDutyAdapter(credentials)\n    await adapter.authenticate()\n\n    # Create an incident\n    event = IntegrationEvent(\n        event_id=\"evt-123\",\n        event_type=\"policy.violation\",\n        title=\"Critical policy violation detected\",\n        severity=EventSeverity.CRITICAL,\n        timestamp=datetime.utcnow(),\n        policy_id=\"pol-456\",\n        resource_id=\"res-789\",\n    )\n    result = await adapter.send_event(event)\n    ```\n\nExample - Full incident management (both APIs):\n    ```python\n    # Create credentials with both authentication methods\n    credentials = PagerDutyCredentials(\n        integration_name=\"Production PagerDuty\",\n        auth_type=PagerDutyAuthType.BOTH,\n        integration_key=SecretStr(\"your-integration-key\"),\n        api_token=SecretStr(\"your-api-token\"),\n        service_id=\"P1234567\",\n    )\n\n    adapter = PagerDutyAdapter(credentials)\n    await adapter.authenticate()\n\n    # Create incident\n    result = await adapter.send_event(event)\n    dedup_key = result.external_id  # e.g., \"acgs2-evt-123\"\n\n    # Add a note\n    await adapter.add_note(\"P1234\", \"Investigation in progress\")\n\n    # Escalate if needed\n    await adapter.escalate_incident(\"P1234\", \"POLICYID\")\n\n    # Resolve when done\n    await adapter.resolve_incident(dedup_key)\n    ```\n\nExample - Custom configuration:\n    ```python\n    credentials = PagerDutyCredentials(\n        integration_name=\"Dev PagerDuty\",\n        integration_key=SecretStr(\"your-key\"),\n        # Custom severity mapping\n        severity_mapping={\n            \"critical\": \"critical\",\n            \"high\": \"error\",\n            \"medium\": \"warning\",\n            \"low\": \"info\",\n        },\n        # Custom urgency mapping\n        urgency_mapping={\n            \"critical\": \"high\",\n            \"high\": \"high\",\n            \"medium\": \"low\",\n            \"low\": \"low\",\n        },\n        # Custom incident details\n        default_source=\"acgs2-dev\",\n        default_component=\"governance-engine\",\n        default_group=\"policy-violations\",\n        summary_template=\"[{severity}] {title}\",\n        custom_details={\"environment\": \"development\"},\n    )\n    ```\n\"\"\"\n\nimport logging\nfrom enum import Enum\nfrom typing import Any, Dict, List, Optional\n\nimport httpx\nfrom pydantic import Field, SecretStr, field_validator, model_validator\n\nfrom .base import (\n    AuthenticationError,\n    BaseIntegration,\n    DeliveryError,\n    EventSeverity,\n    IntegrationCredentials,\n    IntegrationEvent,\n    IntegrationResult,\n    IntegrationType,\n    RateLimitError,\n)\n\nlogger = logging.getLogger(__name__)\n\n\nclass PagerDutyAuthType(str, Enum):\n    \"\"\"PagerDuty authentication types\"\"\"\n\n    EVENTS_V2 = \"events_v2\"  # Events API v2 (integration_key)\n    REST_API = \"rest_api\"  # REST API (api_token)\n    BOTH = \"both\"  # Both authentication methods\n\n\n# Default urgency mapping from ACGS-2 severity to PagerDuty urgency\n# PagerDuty has only two urgency levels: high and low\nDEFAULT_URGENCY_MAP: Dict[EventSeverity, str] = {\n    EventSeverity.CRITICAL: \"high\",\n    EventSeverity.HIGH: \"high\",\n    EventSeverity.MEDIUM: \"low\",\n    EventSeverity.LOW: \"low\",\n    EventSeverity.INFO: \"low\",\n}\n\n# PagerDuty severity levels (for the payload severity field)\n# This is different from urgency - severity is for classification, urgency is for priority\nDEFAULT_SEVERITY_MAP: Dict[EventSeverity, str] = {\n    EventSeverity.CRITICAL: \"critical\",\n    EventSeverity.HIGH: \"error\",\n    EventSeverity.MEDIUM: \"warning\",\n    EventSeverity.LOW: \"warning\",\n    EventSeverity.INFO: \"info\",\n}\n\n\nclass PagerDutyCredentials(IntegrationCredentials):\n    \"\"\"\n    Credentials for PagerDuty integration.\n\n    Supports both Events API v2 (for incident creation/resolution) and REST API\n    (for incident management operations like adding notes, escalating, etc.).\n\n    Events API v2 (integration_key):\n    - Used for creating, acknowledging, and resolving incidents\n    - Requires integration_key from a PagerDuty service integration\n    - Rate limit: 120 requests per minute\n\n    REST API (api_token):\n    - Used for managing existing incidents (get, update, add notes, escalate)\n    - Requires API token with appropriate permissions\n    - Rate limit: 960 requests per minute\n\n    You can provide one or both authentication methods depending on your needs.\n\n    Example - Events API only (basic incident creation):\n        ```python\n        from pydantic import SecretStr\n\n        credentials = PagerDutyCredentials(\n            integration_name=\"Production Alerts\",\n            integration_key=SecretStr(\"R01234567890ABCDEFGHIJKLMNOPQRS\"),\n        )\n        ```\n\n    Example - REST API only (incident management):\n        ```python\n        credentials = PagerDutyCredentials(\n            integration_name=\"Incident Manager\",\n            auth_type=PagerDutyAuthType.REST_API,\n            api_token=SecretStr(\"u+abcdefghijklmnop-qrstuvwxyz\"),\n            service_id=\"P1234567\",\n        )\n        ```\n\n    Example - Both APIs (full functionality):\n        ```python\n        credentials = PagerDutyCredentials(\n            integration_name=\"Full PagerDuty Integration\",\n            auth_type=PagerDutyAuthType.BOTH,\n            integration_key=SecretStr(\"R01234567890ABCDEFGHIJKLMNOPQRS\"),\n            api_token=SecretStr(\"u+abcdefghijklmnop-qrstuvwxyz\"),\n            service_id=\"P1234567\",\n            escalation_policy=\"P7654321\",\n        )\n        ```\n\n    Example - Custom severity and urgency mapping:\n        ```python\n        credentials = PagerDutyCredentials(\n            integration_name=\"Custom Mapping\",\n            integration_key=SecretStr(\"your-key\"),\n            # Map ACGS-2 severity to PagerDuty severity\n            severity_mapping={\n                \"critical\": \"critical\",\n                \"high\": \"error\",\n                \"medium\": \"warning\",\n                \"low\": \"info\",\n                \"info\": \"info\",\n            },\n            # Map ACGS-2 severity to PagerDuty urgency\n            urgency_mapping={\n                \"critical\": \"high\",\n                \"high\": \"high\",\n                \"medium\": \"low\",\n                \"low\": \"low\",\n                \"info\": \"low\",\n            },\n        )\n        ```\n\n    Example - Custom incident details:\n        ```python\n        credentials = PagerDutyCredentials(\n            integration_name=\"Custom Details\",\n            integration_key=SecretStr(\"your-key\"),\n            default_source=\"acgs2-production\",\n            default_component=\"governance-engine\",\n            default_group=\"policy-violations\",\n            default_class=\"security\",\n            summary_template=\"[{severity}] {event_type}: {title}\",\n            dedup_key_prefix=\"prod-acgs2\",\n            custom_details={\n                \"environment\": \"production\",\n                \"region\": \"us-east-1\",\n                \"team\": \"security-ops\",\n            },\n        )\n        ```\n    \"\"\"\n\n    integration_type: IntegrationType = Field(\n        default=IntegrationType.TICKETING,\n        description=\"Integration type (always TICKETING for PagerDuty)\",\n    )\n\n    # Authentication settings\n    auth_type: PagerDutyAuthType = Field(\n        default=PagerDutyAuthType.EVENTS_V2,\n        description=\"Authentication type (events_v2, rest_api, or both)\",\n    )\n\n    # Events API v2 credentials\n    integration_key: Optional[SecretStr] = Field(\n        None,\n        description=\"PagerDuty Events API v2 integration key (routing key)\",\n    )\n\n    # REST API credentials\n    api_token: Optional[SecretStr] = Field(\n        None,\n        description=\"PagerDuty REST API token\",\n    )\n\n    # Service configuration\n    service_id: Optional[str] = Field(\n        None,\n        description=\"PagerDuty service ID (for REST API operations)\",\n    )\n    escalation_policy: Optional[str] = Field(\n        None,\n        description=\"Default escalation policy ID or name\",\n    )\n\n    # Incident configuration\n    urgency_mapping: Dict[str, str] = Field(\n        default_factory=dict,\n        description=\"Custom severity to urgency mapping (severity -> 'high' or 'low')\",\n    )\n    severity_mapping: Dict[str, str] = Field(\n        default_factory=dict,\n        description=(\n            \"Custom severity to PagerDuty severity mapping \"\n            \"(severity -> 'critical', 'error', 'warning', 'info')\"\n        ),\n    )\n\n    # Custom event fields\n    custom_details: Dict[str, Any] = Field(\n        default_factory=dict,\n        description=\"Additional custom details to include in incident payloads\",\n    )\n    default_source: str = Field(\n        default=\"acgs2\",\n        description=\"Default source for incidents (e.g., 'acgs2', 'governance-platform')\",\n    )\n    default_component: Optional[str] = Field(\n        None,\n        description=\"Default component for incidents\",\n    )\n    default_group: Optional[str] = Field(\n        None,\n        description=\"Default logical grouping for incidents\",\n    )\n    default_class: Optional[str] = Field(\n        None,\n        description=\"Default class/type for incidents\",\n    )\n\n    # Incident content settings\n    include_event_details: bool = Field(\n        default=True,\n        description=\"Include full event details in incident custom_details\",\n    )\n    summary_template: str = Field(\n        default=\"[ACGS-2] {title}\",\n        description=\"Template for incident summary (supports {title}, {event_type}, {severity})\",\n    )\n\n    # Dedup key strategy\n    dedup_key_prefix: str = Field(\n        default=\"acgs2\",\n        description=\"Prefix for dedup_key generation (format: '{prefix}-{event_id}')\",\n    )\n\n    @field_validator(\"integration_key\", \"api_token\")\n    @classmethod\n    def validate_secret_fields(cls, v: Optional[SecretStr]) -> Optional[SecretStr]:\n        \"\"\"Validate secret fields are not empty strings.\"\"\"\n        if v is not None:\n            secret_value = v.get_secret_value()\n            if not secret_value or not secret_value.strip():\n                raise ValueError(\"Secret field cannot be empty\")\n        return v\n\n    @model_validator(mode=\"after\")\n    def validate_auth_credentials(self) -> \"PagerDutyCredentials\":\n        \"\"\"Validate that appropriate credentials are provided for auth type.\"\"\"\n        if self.auth_type == PagerDutyAuthType.EVENTS_V2:\n            if not self.integration_key:\n                raise ValueError(\"integration_key is required for Events API v2 authentication\")\n        elif self.auth_type == PagerDutyAuthType.REST_API:\n            if not self.api_token:\n                raise ValueError(\"api_token is required for REST API authentication\")\n        elif self.auth_type == PagerDutyAuthType.BOTH:\n            if not self.integration_key:\n                raise ValueError(\n                    \"integration_key is required when using both authentication methods\"\n                )\n            if not self.api_token:\n                raise ValueError(\"api_token required when using both auth methods\")\n\n        # If using REST API, service_id should be provided for some operations\n        if self.auth_type in (PagerDutyAuthType.REST_API, PagerDutyAuthType.BOTH):\n            if not self.service_id:\n                logger.warning(\"service_id not provided - some REST API operations may require it\")\n\n        return self\n\n    @model_validator(mode=\"after\")\n    def validate_urgency_mapping(self) -> \"PagerDutyCredentials\":\n        \"\"\"Validate urgency mapping values are valid PagerDuty urgency levels.\"\"\"\n        valid_urgencies = {\"high\", \"low\"}\n        for severity, urgency in self.urgency_mapping.items():\n            if urgency not in valid_urgencies:\n                raise ValueError(\n                    f\"Invalid urgency '{urgency}' for severity '{severity}'. \"\n                    f\"Must be one of: {valid_urgencies}\"\n                )\n        return self\n\n    @model_validator(mode=\"after\")\n    def validate_severity_mapping(self) -> \"PagerDutyCredentials\":\n        \"\"\"Validate severity mapping values are valid PagerDuty severity levels.\"\"\"\n        valid_severities = {\"critical\", \"error\", \"warning\", \"info\"}\n        for severity, pd_severity in self.severity_mapping.items():\n            if pd_severity not in valid_severities:\n                raise ValueError(\n                    f\"Invalid PagerDuty severity '{pd_severity}' for severity '{severity}'. \"\n                    f\"Must be one of: {valid_severities}\"\n                )\n        return self\n\n\nclass PagerDutyAdapter(BaseIntegration):\n    \"\"\"\n    PagerDuty incident management integration adapter.\n\n    Creates incidents in PagerDuty when governance events require attention.\n    Supports both Events API v2 (for incident creation/resolution) and REST API\n    (for incident management operations).\n\n    Features:\n        - Events API v2 integration key authentication for incident creation\n        - REST API token authentication for incident management\n        - Configurable severity to urgency/severity mapping\n        - Automatic dedup_key generation from event_id\n        - Custom event fields support (source, component, group, class)\n        - Rate limit handling (Events API: 120 req/min)\n        - Detailed error reporting\n\n    Example - Basic incident creation:\n        ```python\n        from pydantic import SecretStr\n        from integrations.pagerduty_adapter import PagerDutyAdapter, PagerDutyCredentials\n        from integrations.base import IntegrationEvent, EventSeverity\n        from datetime import datetime\n\n        # Create credentials\n        credentials = PagerDutyCredentials(\n            integration_name=\"Production PagerDuty\",\n            integration_key=SecretStr(\"your-integration-key\"),\n        )\n\n        # Initialize and authenticate\n        adapter = PagerDutyAdapter(credentials)\n        await adapter.authenticate()\n\n        # Create an incident from an event\n        event = IntegrationEvent(\n            event_id=\"evt-123\",\n            event_type=\"policy.violation\",\n            title=\"Critical policy violation detected\",\n            severity=EventSeverity.CRITICAL,\n            timestamp=datetime.utcnow(),\n            policy_id=\"pol-456\",\n            resource_id=\"res-789\",\n        )\n        result = await adapter.send_event(event)\n        if result.success:\n            print(f\"Incident created: {result.external_id}\")\n        ```\n\n    Example - Full incident lifecycle management:\n        ```python\n        # Setup with both APIs for full functionality\n        credentials = PagerDutyCredentials(\n            integration_name=\"Production PagerDuty\",\n            auth_type=PagerDutyAuthType.BOTH,\n            integration_key=SecretStr(\"your-integration-key\"),\n            api_token=SecretStr(\"your-api-token\"),\n            service_id=\"P1234567\",\n        )\n\n        adapter = PagerDutyAdapter(credentials)\n        await adapter.authenticate()\n\n        # Create incident\n        result = await adapter.send_event(event)\n        dedup_key = result.external_id  # e.g., \"acgs2-evt-123\"\n\n        # Get incident details (requires incident ID from PagerDuty)\n        incident_result = await adapter.get_incident(\"P1234\")\n        incident_data = incident_result.error_details\n\n        # Add investigation notes\n        await adapter.add_note(\"P1234\", \"Root cause analysis in progress\")\n        await adapter.add_note(\"P1234\", \"Identified misconfigured resource\")\n\n        # Update incident status\n        await adapter.update_incident(\n            \"P1234\",\n            status=\"acknowledged\",\n        )\n\n        # Escalate if needed\n        await adapter.escalate_incident(\"P1234\", \"ESCALATION_POLICY_ID\")\n\n        # Resolve when fixed\n        await adapter.resolve_incident(dedup_key)\n        ```\n\n    Example - Error handling:\n        ```python\n        from integrations.base import (\n            AuthenticationError,\n            DeliveryError,\n            RateLimitError,\n        )\n\n        adapter = PagerDutyAdapter(credentials)\n\n        try:\n            await adapter.authenticate()\n        except AuthenticationError as e:\n            print(f\"Authentication failed: {e}\")\n            return\n\n        try:\n            result = await adapter.send_event(event)\n            if not result.success:\n                print(f\"Failed: {result.error_message}\")\n        except RateLimitError as e:\n            print(f\"Rate limited, retry after {e.retry_after}s\")\n        except DeliveryError as e:\n            print(f\"Delivery failed: {e}\")\n        ```\n\n    Example - Custom configuration:\n        ```python\n        credentials = PagerDutyCredentials(\n            integration_name=\"Custom PagerDuty\",\n            integration_key=SecretStr(\"your-key\"),\n            # Custom mappings\n            severity_mapping={\"critical\": \"critical\", \"high\": \"error\"},\n            urgency_mapping={\"critical\": \"high\", \"high\": \"high\"},\n            # Custom incident fields\n            default_source=\"acgs2-prod\",\n            default_component=\"governance\",\n            summary_template=\"[{severity}] {event_type}: {title}\",\n            custom_details={\"environment\": \"production\"},\n        )\n\n        adapter = PagerDutyAdapter(\n            credentials,\n            max_retries=3,\n            timeout=30.0,\n        )\n        ```\n    \"\"\"\n\n    # PagerDuty API endpoints\n    EVENTS_API_URL = \"https://events.pagerduty.com/v2/enqueue\"\n    REST_API_URL = \"https://api.pagerduty.com\"\n\n    # Rate limits (requests per minute)\n    EVENTS_API_RATE_LIMIT = 120\n    REST_API_RATE_LIMIT = 960\n\n    def __init__(\n        self,\n        credentials: PagerDutyCredentials,\n        max_retries: int = BaseIntegration.DEFAULT_MAX_RETRIES,\n        timeout: float = BaseIntegration.DEFAULT_TIMEOUT,\n    ):\n        \"\"\"\n        Initialize PagerDuty adapter.\n\n        Args:\n            credentials: PagerDuty credentials and configuration\n            max_retries: Maximum retry attempts for failed operations\n            timeout: HTTP request timeout in seconds\n        \"\"\"\n        super().__init__(credentials, max_retries, timeout)\n        self._pd_credentials = credentials\n\n    @property\n    def pd_credentials(self) -> PagerDutyCredentials:\n        \"\"\"Get typed PagerDuty credentials\"\"\"\n        return self._pd_credentials\n\n    def _get_events_api_headers(self) -> Dict[str, str]:\n        \"\"\"Get headers for Events API v2 requests\"\"\"\n        return {\n            \"Content-Type\": \"application/json\",\n            \"Accept\": \"application/vnd.pagerduty+json;version=2\",\n        }\n\n    def _get_rest_api_headers(self) -> Dict[str, str]:\n        \"\"\"Get headers for REST API requests\"\"\"\n        if not self.pd_credentials.api_token:\n            raise AuthenticationError(\n                \"REST API requires api_token to be configured\",\n                self.name,\n            )\n\n        return {\n            \"Authorization\": f\"Token token={self.pd_credentials.api_token.get_secret_value()}\",\n            \"Content-Type\": \"application/json\",\n            \"Accept\": \"application/vnd.pagerduty+json;version=2\",\n        }\n\n    async def _do_authenticate(self) -> IntegrationResult:\n        \"\"\"\n        Authenticate with PagerDuty and verify credentials.\n\n        For Events API v2: Validates by attempting a test event trigger\n        For REST API: Validates by fetching the current user/abilities\n\n        Returns:\n            IntegrationResult indicating authentication success/failure\n        \"\"\"\n        logger.debug(f\"Authenticating with PagerDuty for '{self.name}'\")\n\n        try:\n            client = await self.get_http_client()\n\n            # For Events API authentication, we'll validate during send_event\n            # since Events API doesn't have a dedicated auth endpoint\n            # For now, we validate the integration_key is set\n            if self.pd_credentials.auth_type in (\n                PagerDutyAuthType.EVENTS_V2,\n                PagerDutyAuthType.BOTH,\n            ):\n                if not self.pd_credentials.integration_key:\n                    return IntegrationResult(\n                        success=False,\n                        integration_name=self.name,\n                        operation=\"authenticate\",\n                        error_code=\"MISSING_INTEGRATION_KEY\",\n                        error_message=\"integration_key is required for Events API v2\",\n                    )\n\n                # Send a test event to validate the integration key\n                # We'll use event_action=\"trigger\" with a test dedup_key\n                test_payload = {\n                    \"routing_key\": self.pd_credentials.integration_key.get_secret_value(),\n                    \"event_action\": \"trigger\",\n                    \"dedup_key\": f\"{self.pd_credentials.dedup_key_prefix}-auth-test\",\n                    \"payload\": {\n                        \"summary\": \"ACGS-2 Integration Authentication Test\",\n                        \"source\": self.pd_credentials.default_source,\n                        \"severity\": \"info\",\n                        \"custom_details\": {\n                            \"test\": True,\n                            \"integration_name\": self.name,\n                        },\n                    },\n                }\n\n                response = await client.post(\n                    self.EVENTS_API_URL,\n                    headers=self._get_events_api_headers(),\n                    json=test_payload,\n                )\n\n                if response.status_code == 202:\n                    # Successfully authenticated with Events API\n                    logger.info(f\"PagerDuty Events API authentication successful for '{self.name}'\")\n\n                    # Immediately resolve the test incident\n                    resolve_payload = {\n                        \"routing_key\": self.pd_credentials.integration_key.get_secret_value(),\n                        \"event_action\": \"resolve\",\n                        \"dedup_key\": f\"{self.pd_credentials.dedup_key_prefix}-auth-test\",\n                    }\n\n                    await client.post(\n                        self.EVENTS_API_URL,\n                        headers=self._get_events_api_headers(),\n                        json=resolve_payload,\n                    )\n\n                    return IntegrationResult(\n                        success=True,\n                        integration_name=self.name,\n                        operation=\"authenticate\",\n                    )\n\n                elif response.status_code == 400:\n                    error_msg = \"Invalid Events API request format\"\n                    try:\n                        error_data = response.json()\n                        error_msg = error_data.get(\"message\", error_msg)\n                    except Exception as e:\n                        logger.debug(f\"Failed to parse error response: {e}\")\n\n                    logger.error(f\"PagerDuty authentication failed: {error_msg}\")\n                    return IntegrationResult(\n                        success=False,\n                        integration_name=self.name,\n                        operation=\"authenticate\",\n                        error_code=\"INVALID_REQUEST\",\n                        error_message=error_msg,\n                    )\n\n                elif response.status_code == 401 or response.status_code == 403:\n                    error_msg = \"Invalid integration_key - check your credentials\"\n                    logger.error(f\"PagerDuty authentication failed: {error_msg}\")\n                    return IntegrationResult(\n                        success=False,\n                        integration_name=self.name,\n                        operation=\"authenticate\",\n                        error_code=\"AUTH_FAILED\",\n                        error_message=error_msg,\n                    )\n\n                elif response.status_code == 429:\n                    retry_after = int(response.headers.get(\"X-Rate-Limit-Reset\", 60))\n                    error_msg = f\"Rate limit exceeded (retry after {retry_after}s)\"\n                    logger.error(f\"PagerDuty authentication failed: {error_msg}\")\n                    return IntegrationResult(\n                        success=False,\n                        integration_name=self.name,\n                        operation=\"authenticate\",\n                        error_code=\"RATE_LIMITED\",\n                        error_message=error_msg,\n                        retry_after=retry_after,\n                    )\n\n                else:\n                    error_msg = f\"Unexpected response: HTTP {response.status_code}\"\n                    logger.error(f\"PagerDuty authentication failed: {error_msg}\")\n                    return IntegrationResult(\n                        success=False,\n                        integration_name=self.name,\n                        operation=\"authenticate\",\n                        error_code=f\"HTTP_{response.status_code}\",\n                        error_message=error_msg,\n                    )\n\n            # For REST API authentication\n            if self.pd_credentials.auth_type in (\n                PagerDutyAuthType.REST_API,\n                PagerDutyAuthType.BOTH,\n            ):\n                if not self.pd_credentials.api_token:\n                    return IntegrationResult(\n                        success=False,\n                        integration_name=self.name,\n                        operation=\"authenticate\",\n                        error_code=\"MISSING_API_TOKEN\",\n                        error_message=\"api_token is required for REST API\",\n                    )\n\n                # Validate REST API token by fetching abilities\n                abilities_url = f\"{self.REST_API_URL}/abilities\"\n\n                response = await client.get(\n                    abilities_url,\n                    headers=self._get_rest_api_headers(),\n                )\n\n                if response.status_code == 200:\n                    logger.info(f\"PagerDuty REST API authentication successful for '{self.name}'\")\n                    return IntegrationResult(\n                        success=True,\n                        integration_name=self.name,\n                        operation=\"authenticate\",\n                    )\n\n                elif response.status_code == 401:\n                    error_msg = \"Invalid api_token - check your credentials\"\n                    logger.error(f\"PagerDuty authentication failed: {error_msg}\")\n                    return IntegrationResult(\n                        success=False,\n                        integration_name=self.name,\n                        operation=\"authenticate\",\n                        error_code=\"AUTH_FAILED\",\n                        error_message=error_msg,\n                    )\n\n                elif response.status_code == 403:\n                    error_msg = \"Access denied - check API token permissions\"\n                    logger.error(f\"PagerDuty authentication failed: {error_msg}\")\n                    return IntegrationResult(\n                        success=False,\n                        integration_name=self.name,\n                        operation=\"authenticate\",\n                        error_code=\"ACCESS_DENIED\",\n                        error_message=error_msg,\n                    )\n\n                else:\n                    error_msg = f\"Unexpected response: HTTP {response.status_code}\"\n                    logger.error(f\"PagerDuty authentication failed: {error_msg}\")\n                    return IntegrationResult(\n                        success=False,\n                        integration_name=self.name,\n                        operation=\"authenticate\",\n                        error_code=f\"HTTP_{response.status_code}\",\n                        error_message=error_msg,\n                    )\n\n        except httpx.TimeoutException as e:\n            raise AuthenticationError(\n                f\"Connection timed out: {str(e)}\",\n                self.name,\n            ) from e\n\n        except httpx.NetworkError as e:\n            raise AuthenticationError(\n                f\"Network error: {str(e)}\",\n                self.name,\n            ) from e\n\n        except Exception as e:\n            error_msg = f\"Unexpected error during authentication: {str(e)}\"\n            logger.error(f\"PagerDuty authentication error: {error_msg}\")\n            raise AuthenticationError(error_msg, self.name) from e\n\n    async def _do_validate(self) -> IntegrationResult:\n        \"\"\"\n        Validate PagerDuty configuration and prerequisites.\n\n        Checks:\n        - Credentials are valid\n        - Service exists and is accessible (if service_id is provided)\n        - Integration key is valid (for Events API)\n        - API token has required permissions (for REST API)\n\n        Returns:\n            IntegrationResult with validation status and any issues found\n        \"\"\"\n        logger.debug(f\"Validating PagerDuty integration '{self.name}'\")\n\n        validation_issues: List[str] = []\n\n        try:\n            client = await self.get_http_client()\n\n            # Validate Events API configuration\n            if self.pd_credentials.auth_type in (\n                PagerDutyAuthType.EVENTS_V2,\n                PagerDutyAuthType.BOTH,\n            ):\n                if not self.pd_credentials.integration_key:\n                    validation_issues.append(\"integration_key is required for Events API v2\")\n\n            # Validate REST API configuration and service\n            if self.pd_credentials.auth_type in (\n                PagerDutyAuthType.REST_API,\n                PagerDutyAuthType.BOTH,\n            ):\n                if not self.pd_credentials.api_token:\n                    validation_issues.append(\"api_token is required for REST API\")\n                elif self.pd_credentials.service_id:\n                    # Validate service exists and is accessible\n                    service_url = f\"{self.REST_API_URL}/services/{self.pd_credentials.service_id}\"\n\n                    response = await client.get(\n                        service_url,\n                        headers=self._get_rest_api_headers(),\n                    )\n\n                    if response.status_code == 200:\n                        service_data = response.json()\n                        service_info = service_data.get(\"service\", {})\n                        service_name = service_info.get(\"name\", \"Unknown\")\n                        logger.debug(\n                            f\"Service '{self.pd_credentials.service_id}' found: {service_name}\"\n                        )\n                    elif response.status_code == 401:\n                        validation_issues.append(\"Authentication failed - invalid api_token\")\n                    elif response.status_code == 404:\n                        validation_issues.append(\n                            f\"Service '{self.pd_credentials.service_id}' not found\"\n                        )\n                    elif response.status_code == 403:\n                        validation_issues.append(\n                            f\"Access denied to service '{self.pd_credentials.service_id}'\"\n                        )\n                    else:\n                        validation_issues.append(\n                            f\"Failed to fetch service: HTTP {response.status_code}\"\n                        )\n\n        except httpx.TimeoutException:\n            validation_issues.append(\"Connection timed out\")\n\n        except httpx.NetworkError as e:\n            validation_issues.append(f\"Network error: {str(e)}\")\n\n        except Exception as e:\n            validation_issues.append(f\"Validation error: {str(e)}\")\n\n        if validation_issues:\n            error_msg = \"; \".join(validation_issues)\n            logger.warning(f\"PagerDuty validation failed for '{self.name}': {error_msg}\")\n            return IntegrationResult(\n                success=False,\n                integration_name=self.name,\n                operation=\"validate\",\n                error_code=\"VALIDATION_FAILED\",\n                error_message=error_msg,\n                error_details={\"issues\": validation_issues},\n            )\n\n        logger.info(f\"PagerDuty validation successful for '{self.name}'\")\n        return IntegrationResult(\n            success=True,\n            integration_name=self.name,\n            operation=\"validate\",\n        )\n\n    async def _do_send_event(self, event: IntegrationEvent) -> IntegrationResult:\n        \"\"\"\n        Create a PagerDuty incident for the governance event.\n\n        Args:\n            event: The governance event to create an incident for\n\n        Returns:\n            IntegrationResult with incident creation status\n\n        Raises:\n            DeliveryError: If incident creation fails\n            RateLimitError: If rate limited by PagerDuty\n        \"\"\"\n        logger.debug(f\"Creating PagerDuty incident for event {event.event_id}\")\n\n        try:\n            client = await self.get_http_client()\n\n            # Build the incident payload\n            incident_data = self._build_incident_payload(event)\n\n            # Create the incident via Events API v2\n            response = await client.post(\n                self.EVENTS_API_URL,\n                headers=self._get_events_api_headers(),\n                json=incident_data,\n            )\n\n            # Handle rate limiting\n            if response.status_code == 429:\n                retry_after = int(response.headers.get(\"X-Rate-Limit-Reset\", 60))\n                raise RateLimitError(\n                    \"PagerDuty rate limit exceeded\",\n                    self.name,\n                    retry_after=retry_after,\n                )\n\n            # Handle success (202 Accepted)\n            if response.status_code == 202:\n                response_data = response.json()\n                dedup_key = response_data.get(\"dedup_key\")\n                status = response_data.get(\"status\")\n                message = response_data.get(\"message\", \"\")\n\n                logger.info(\n                    f\"Created PagerDuty incident for event {event.event_id} \"\n                    f\"(dedup_key: {dedup_key}, status: {status})\"\n                )\n\n                return IntegrationResult(\n                    success=True,\n                    integration_name=self.name,\n                    operation=\"send_event\",\n                    external_id=dedup_key,\n                    error_details={\"status\": status, \"message\": message},\n                )\n\n            # Handle errors\n            if response.status_code == 400:\n                try:\n                    error_data = response.json()\n                    error_msg = error_data.get(\"message\", \"Bad request\")\n                    errors = error_data.get(\"errors\", [])\n                    if errors:\n                        error_msg = f\"{error_msg}: {'; '.join(errors)}\"\n                except Exception:\n                    error_msg = \"Invalid request format\"\n\n                raise DeliveryError(\n                    f\"Failed to create incident: {error_msg}\",\n                    self.name,\n                    details={\"status_code\": 400},\n                )\n\n            elif response.status_code == 401 or response.status_code == 403:\n                raise AuthenticationError(\n                    \"Authentication failed - check integration_key\",\n                    self.name,\n                )\n\n            else:\n                raise DeliveryError(\n                    f\"Unexpected response: HTTP {response.status_code}\",\n                    self.name,\n                    details={\"status_code\": response.status_code},\n                )\n\n        except (RateLimitError, AuthenticationError, DeliveryError):\n            raise\n\n        except httpx.TimeoutException as e:\n            raise DeliveryError(\n                f\"Request timed out: {str(e)}\",\n                self.name,\n                details={\"should_retry\": True},\n            ) from e\n\n        except httpx.NetworkError as e:\n            raise DeliveryError(\n                f\"Network error: {str(e)}\",\n                self.name,\n                details={\"should_retry\": True},\n            ) from e\n\n        except Exception as e:\n            raise DeliveryError(\n                f\"Unexpected error: {str(e)}\",\n                self.name,\n            ) from e\n\n    def _build_incident_payload(self, event: IntegrationEvent) -> Dict[str, Any]:\n        \"\"\"\n        Build the PagerDuty incident creation payload from an event.\n\n        Args:\n            event: The governance event to convert to an incident\n\n        Returns:\n            Dictionary formatted for PagerDuty Events API v2\n        \"\"\"\n        # Generate dedup_key from event_id\n        dedup_key = f\"{self.pd_credentials.dedup_key_prefix}-{event.event_id}\"\n\n        # Build summary from template\n        summary = self.pd_credentials.summary_template.format(\n            title=event.title,\n            event_type=event.event_type,\n            severity=event.severity.value,\n        )\n        # PagerDuty summary max length is 1024 characters\n        if len(summary) > 1024:\n            summary = summary[:1021] + \"...\"\n\n        # Get PagerDuty severity for the event\n        pd_severity = self._get_severity_for_event(event.severity)\n\n        # Build custom details\n        custom_details = {}\n\n        # Add event details if configured\n        if self.pd_credentials.include_event_details:\n            custom_details.update(\n                {\n                    \"event_id\": event.event_id,\n                    \"event_type\": event.event_type,\n                    \"acgs2_severity\": event.severity.value,\n                    \"timestamp\": event.timestamp.isoformat(),\n                }\n            )\n\n            if event.policy_id:\n                custom_details[\"policy_id\"] = event.policy_id\n            if event.resource_id:\n                custom_details[\"resource_id\"] = event.resource_id\n            if event.resource_type:\n                custom_details[\"resource_type\"] = event.resource_type\n            if event.action:\n                custom_details[\"action\"] = event.action\n            if event.outcome:\n                custom_details[\"outcome\"] = event.outcome\n            if event.user_id:\n                custom_details[\"user_id\"] = event.user_id\n            if event.tenant_id:\n                custom_details[\"tenant_id\"] = event.tenant_id\n            if event.correlation_id:\n                custom_details[\"correlation_id\"] = event.correlation_id\n            if event.tags:\n                custom_details[\"tags\"] = event.tags\n            if event.details:\n                custom_details[\"event_details\"] = event.details\n\n        # Add configured custom details\n        custom_details.update(self.pd_credentials.custom_details)\n\n        # Build the payload\n        payload: Dict[str, Any] = {\n            \"summary\": summary,\n            \"source\": self.pd_credentials.default_source,\n            \"severity\": pd_severity,\n        }\n\n        # Add optional fields\n        if event.timestamp:\n            payload[\"timestamp\"] = event.timestamp.isoformat()\n\n        if self.pd_credentials.default_component:\n            payload[\"component\"] = self.pd_credentials.default_component\n\n        if self.pd_credentials.default_group:\n            payload[\"group\"] = self.pd_credentials.default_group\n\n        if self.pd_credentials.default_class:\n            payload[\"class\"] = self.pd_credentials.default_class\n\n        # Add custom details\n        if custom_details:\n            payload[\"custom_details\"] = custom_details\n\n        # Build the full event payload\n        event_payload = {\n            \"routing_key\": self.pd_credentials.integration_key.get_secret_value(),\n            \"event_action\": \"trigger\",\n            \"dedup_key\": dedup_key,\n            \"payload\": payload,\n        }\n\n        return event_payload\n\n    def _get_severity_for_event(self, severity: EventSeverity) -> str:\n        \"\"\"\n        Get PagerDuty severity for a given event severity level.\n\n        Uses custom mapping if configured, otherwise uses defaults.\n\n        Args:\n            severity: Event severity level\n\n        Returns:\n            PagerDuty severity (critical, error, warning, info)\n        \"\"\"\n        # Check custom mapping first\n        custom_severity = self.pd_credentials.severity_mapping.get(severity.value)\n        if custom_severity:\n            return custom_severity\n\n        # Use default mapping\n        return DEFAULT_SEVERITY_MAP.get(severity, \"info\")\n\n    def _get_urgency_for_severity(self, severity: EventSeverity) -> str:\n        \"\"\"\n        Get PagerDuty urgency for a given severity level.\n\n        Uses custom mapping if configured, otherwise uses defaults.\n\n        Args:\n            severity: Event severity level\n\n        Returns:\n            PagerDuty urgency (high or low)\n        \"\"\"\n        # Check custom mapping first\n        custom_urgency = self.pd_credentials.urgency_mapping.get(severity.value)\n        if custom_urgency:\n            return custom_urgency\n\n        # Use default mapping\n        return DEFAULT_URGENCY_MAP.get(severity, \"low\")\n\n    async def _do_test_connection(self) -> IntegrationResult:\n        \"\"\"\n        Test connection to PagerDuty without authenticating.\n\n        Returns:\n            IntegrationResult indicating connection status\n        \"\"\"\n        logger.debug(f\"Testing PagerDuty connection for '{self.name}'\")\n\n        try:\n            client = await self.get_http_client()\n\n            # Test Events API endpoint connectivity\n            # We'll do a HEAD request to check if the endpoint is reachable\n            # Note: Events API doesn't support HEAD, so we'll check using a minimal request\n            response = await client.get(\n                \"https://events.pagerduty.com\",\n                follow_redirects=True,\n            )\n\n            # Any response indicates the service is reachable\n            if response.status_code < 500:\n                return IntegrationResult(\n                    success=True,\n                    integration_name=self.name,\n                    operation=\"test_connection\",\n                )\n            else:\n                return IntegrationResult(\n                    success=False,\n                    integration_name=self.name,\n                    operation=\"test_connection\",\n                    error_code=f\"HTTP_{response.status_code}\",\n                    error_message=f\"Service returned status {response.status_code}\",\n                )\n\n        except httpx.TimeoutException:\n            return IntegrationResult(\n                success=False,\n                integration_name=self.name,\n                operation=\"test_connection\",\n                error_code=\"TIMEOUT\",\n                error_message=f\"Connection timed out after {self.timeout}s\",\n            )\n\n        except httpx.NetworkError as e:\n            return IntegrationResult(\n                success=False,\n                integration_name=self.name,\n                operation=\"test_connection\",\n                error_code=\"NETWORK_ERROR\",\n                error_message=str(e),\n            )\n\n        except Exception as e:\n            return IntegrationResult(\n                success=False,\n                integration_name=self.name,\n                operation=\"test_connection\",\n                error_code=\"UNKNOWN_ERROR\",\n                error_message=str(e),\n            )\n\n    async def get_incident(self, incident_id: str) -> IntegrationResult:\n        \"\"\"\n        Get details of an existing PagerDuty incident.\n\n        Requires REST API authentication (api_token).\n\n        Args:\n            incident_id: The incident ID (e.g., PXXXXX)\n\n        Returns:\n            IntegrationResult with incident details or error\n\n        Raises:\n            AuthenticationError: If not authenticated or REST API not configured\n\n        Example:\n            ```python\n            # Get incident details\n            result = await adapter.get_incident(\"P1234\")\n\n            if result.success:\n                incident = result.error_details  # Incident data\n                print(f\"Incident #{result.external_id}\")\n                print(f\"Status: {incident.get('status')}\")\n                print(f\"URL: {result.external_url}\")\n                print(f\"Title: {incident.get('title')}\")\n                print(f\"Created: {incident.get('created_at')}\")\n            else:\n                print(f\"Error: {result.error_message}\")\n            ```\n        \"\"\"\n        if not self._authenticated:\n            raise AuthenticationError(\"Integration is not authenticated\", self.name)\n\n        if self.pd_credentials.auth_type not in (\n            PagerDutyAuthType.REST_API,\n            PagerDutyAuthType.BOTH,\n        ):\n            raise AuthenticationError(\n                \"REST API authentication required for get_incident\",\n                self.name,\n            )\n\n        logger.debug(f\"Fetching PagerDuty incident {incident_id}\")\n\n        try:\n            client = await self.get_http_client()\n            headers = self._get_rest_api_headers()\n\n            incident_url = f\"{self.REST_API_URL}/incidents/{incident_id}\"\n\n            response = await client.get(\n                incident_url,\n                headers=headers,\n            )\n\n            if response.status_code == 200:\n                response_data = response.json()\n                incident = response_data.get(\"incident\", {})\n                incident_number = incident.get(\"incident_number\")\n                html_url = incident.get(\"html_url\")\n\n                logger.info(f\"Retrieved PagerDuty incident {incident_id}\")\n\n                return IntegrationResult(\n                    success=True,\n                    integration_name=self.name,\n                    operation=\"get_incident\",\n                    external_id=incident_number,\n                    external_url=html_url,\n                    error_details=incident,  # Using error_details to pass incident data\n                )\n\n            elif response.status_code == 404:\n                return IntegrationResult(\n                    success=False,\n                    integration_name=self.name,\n                    operation=\"get_incident\",\n                    error_code=\"NOT_FOUND\",\n                    error_message=f\"Incident {incident_id} not found\",\n                )\n\n            elif response.status_code == 401:\n                return IntegrationResult(\n                    success=False,\n                    integration_name=self.name,\n                    operation=\"get_incident\",\n                    error_code=\"AUTH_FAILED\",\n                    error_message=\"Authentication failed - check api_token\",\n                )\n\n            elif response.status_code == 403:\n                return IntegrationResult(\n                    success=False,\n                    integration_name=self.name,\n                    operation=\"get_incident\",\n                    error_code=\"ACCESS_DENIED\",\n                    error_message=\"Access denied - check API token permissions\",\n                )\n\n            else:\n                return IntegrationResult(\n                    success=False,\n                    integration_name=self.name,\n                    operation=\"get_incident\",\n                    error_code=f\"HTTP_{response.status_code}\",\n                    error_message=f\"Failed to fetch incident: HTTP {response.status_code}\",\n                )\n\n        except AuthenticationError:\n            raise\n\n        except httpx.TimeoutException as e:\n            return IntegrationResult(\n                success=False,\n                integration_name=self.name,\n                operation=\"get_incident\",\n                error_code=\"TIMEOUT\",\n                error_message=f\"Request timed out: {str(e)}\",\n            )\n\n        except httpx.NetworkError as e:\n            return IntegrationResult(\n                success=False,\n                integration_name=self.name,\n                operation=\"get_incident\",\n                error_code=\"NETWORK_ERROR\",\n                error_message=f\"Network error: {str(e)}\",\n            )\n\n        except Exception as e:\n            return IntegrationResult(\n                success=False,\n                integration_name=self.name,\n                operation=\"get_incident\",\n                error_code=\"ERROR\",\n                error_message=str(e),\n            )\n\n    async def update_incident(\n        self,\n        incident_id: str,\n        status: Optional[str] = None,\n        priority: Optional[str] = None,\n        escalation_policy_id: Optional[str] = None,\n        assigned_to_user_ids: Optional[List[str]] = None,\n        **kwargs: Any,\n    ) -> IntegrationResult:\n        \"\"\"\n        Update an existing PagerDuty incident.\n\n        Requires REST API authentication (api_token).\n\n        Args:\n            incident_id: The incident ID (e.g., PXXXXX)\n            status: New incident status (triggered, acknowledged, resolved)\n            priority: Priority reference ID\n            escalation_policy_id: Escalation policy reference ID\n            assigned_to_user_ids: List of user IDs to assign to\n            **kwargs: Additional fields to update\n\n        Returns:\n            IntegrationResult with update status or error\n\n        Raises:\n            AuthenticationError: If not authenticated or REST API not configured\n\n        Example - Update status:\n            ```python\n            # Acknowledge incident\n            result = await adapter.update_incident(\n                \"P1234\",\n                status=\"acknowledged\",\n            )\n            ```\n\n        Example - Assign to users:\n            ```python\n            # Assign to specific users\n            result = await adapter.update_incident(\n                \"P1234\",\n                assigned_to_user_ids=[\"USER123\", \"USER456\"],\n            )\n            ```\n\n        Example - Change escalation policy:\n            ```python\n            # Update escalation policy\n            result = await adapter.update_incident(\n                \"P1234\",\n                escalation_policy_id=\"POLICY789\",\n            )\n            ```\n\n        Example - Multiple updates:\n            ```python\n            # Update multiple fields at once\n            result = await adapter.update_incident(\n                \"P1234\",\n                status=\"acknowledged\",\n                priority=\"P1\",\n                assigned_to_user_ids=[\"USER123\"],\n            )\n            if result.success:\n                print(f\"Updated incident #{result.external_id}\")\n            ```\n        \"\"\"\n        if not self._authenticated:\n            raise AuthenticationError(\"Integration is not authenticated\", self.name)\n\n        if self.pd_credentials.auth_type not in (\n            PagerDutyAuthType.REST_API,\n            PagerDutyAuthType.BOTH,\n        ):\n            raise AuthenticationError(\n                \"REST API authentication required for update_incident\",\n                self.name,\n            )\n\n        logger.debug(f\"Updating PagerDuty incident {incident_id}\")\n\n        try:\n            client = await self.get_http_client()\n            headers = self._get_rest_api_headers()\n\n            # Build update payload\n            update_payload: Dict[str, Any] = {}\n\n            if status:\n                update_payload[\"status\"] = status\n\n            if priority:\n                update_payload[\"priority\"] = {\"id\": priority, \"type\": \"priority_reference\"}\n\n            if escalation_policy_id:\n                update_payload[\"escalation_policy\"] = {\n                    \"id\": escalation_policy_id,\n                    \"type\": \"escalation_policy_reference\",\n                }\n\n            if assigned_to_user_ids:\n                update_payload[\"assignments\"] = [\n                    {\"assignee\": {\"id\": user_id, \"type\": \"user_reference\"}}\n                    for user_id in assigned_to_user_ids\n                ]\n\n            # Add any additional fields\n            update_payload.update(kwargs)\n\n            incident_url = f\"{self.REST_API_URL}/incidents/{incident_id}\"\n\n            response = await client.put(\n                incident_url,\n                headers=headers,\n                json={\"incident\": update_payload},\n            )\n\n            if response.status_code == 200:\n                response_data = response.json()\n                incident = response_data.get(\"incident\", {})\n                incident_number = incident.get(\"incident_number\")\n\n                logger.info(f\"Updated PagerDuty incident {incident_id}\")\n\n                return IntegrationResult(\n                    success=True,\n                    integration_name=self.name,\n                    operation=\"update_incident\",\n                    external_id=incident_number,\n                )\n\n            elif response.status_code == 404:\n                return IntegrationResult(\n                    success=False,\n                    integration_name=self.name,\n                    operation=\"update_incident\",\n                    error_code=\"NOT_FOUND\",\n                    error_message=f\"Incident {incident_id} not found\",\n                )\n\n            elif response.status_code == 400:\n                try:\n                    error_data = response.json()\n                    error_msg = error_data.get(\"error\", {}).get(\"message\", \"Bad request\")\n                except Exception:\n                    error_msg = \"Invalid request format\"\n\n                return IntegrationResult(\n                    success=False,\n                    integration_name=self.name,\n                    operation=\"update_incident\",\n                    error_code=\"BAD_REQUEST\",\n                    error_message=f\"Failed to update incident: {error_msg}\",\n                )\n\n            elif response.status_code == 401:\n                return IntegrationResult(\n                    success=False,\n                    integration_name=self.name,\n                    operation=\"update_incident\",\n                    error_code=\"AUTH_FAILED\",\n                    error_message=\"Authentication failed - check api_token\",\n                )\n\n            elif response.status_code == 403:\n                return IntegrationResult(\n                    success=False,\n                    integration_name=self.name,\n                    operation=\"update_incident\",\n                    error_code=\"ACCESS_DENIED\",\n                    error_message=\"Access denied - check API token permissions\",\n                )\n\n            else:\n                return IntegrationResult(\n                    success=False,\n                    integration_name=self.name,\n                    operation=\"update_incident\",\n                    error_code=f\"HTTP_{response.status_code}\",\n                    error_message=f\"Failed to update incident: HTTP {response.status_code}\",\n                )\n\n        except AuthenticationError:\n            raise\n\n        except httpx.TimeoutException as e:\n            return IntegrationResult(\n                success=False,\n                integration_name=self.name,\n                operation=\"update_incident\",\n                error_code=\"TIMEOUT\",\n                error_message=f\"Request timed out: {str(e)}\",\n            )\n\n        except httpx.NetworkError as e:\n            return IntegrationResult(\n                success=False,\n                integration_name=self.name,\n                operation=\"update_incident\",\n                error_code=\"NETWORK_ERROR\",\n                error_message=f\"Network error: {str(e)}\",\n            )\n\n        except Exception as e:\n            return IntegrationResult(\n                success=False,\n                integration_name=self.name,\n                operation=\"update_incident\",\n                error_code=\"ERROR\",\n                error_message=str(e),\n            )\n\n    async def resolve_incident(self, dedup_key: str) -> IntegrationResult:\n        \"\"\"\n        Resolve an incident using the Events API.\n\n        Requires Events API authentication (integration_key).\n\n        Args:\n            dedup_key: The deduplication key of the incident to resolve\n\n        Returns:\n            IntegrationResult with resolution status or error\n\n        Raises:\n            AuthenticationError: If not authenticated or Events API not configured\n\n        Example:\n            ```python\n            # Create incident and get dedup_key\n            result = await adapter.send_event(event)\n            dedup_key = result.external_id  # e.g., \"acgs2-evt-123\"\n\n            # ... investigate and fix issue ...\n\n            # Resolve the incident\n            resolve_result = await adapter.resolve_incident(dedup_key)\n            if resolve_result.success:\n                print(f\"Incident {dedup_key} resolved successfully\")\n            ```\n\n        Example - Resolve by constructing dedup_key:\n            ```python\n            # If you know the event_id, construct the dedup_key\n            event_id = \"evt-123\"\n            dedup_key = f\"acgs2-{event_id}\"  # Using default prefix\n\n            result = await adapter.resolve_incident(dedup_key)\n            ```\n        \"\"\"\n        if not self._authenticated:\n            raise AuthenticationError(\"Integration is not authenticated\", self.name)\n\n        if self.pd_credentials.auth_type not in (\n            PagerDutyAuthType.EVENTS_V2,\n            PagerDutyAuthType.BOTH,\n        ):\n            raise AuthenticationError(\n                \"Events API authentication required for resolve_incident\",\n                self.name,\n            )\n\n        logger.debug(f\"Resolving PagerDuty incident with dedup_key {dedup_key}\")\n\n        try:\n            client = await self.get_http_client()\n\n            # Build the resolve payload\n            resolve_payload = {\n                \"routing_key\": self.pd_credentials.integration_key.get_secret_value(),\n                \"event_action\": \"resolve\",\n                \"dedup_key\": dedup_key,\n            }\n\n            response = await client.post(\n                self.EVENTS_API_URL,\n                headers=self._get_events_api_headers(),\n                json=resolve_payload,\n            )\n\n            # Handle rate limiting\n            if response.status_code == 429:\n                retry_after = int(response.headers.get(\"X-Rate-Limit-Reset\", 60))\n                return IntegrationResult(\n                    success=False,\n                    integration_name=self.name,\n                    operation=\"resolve_incident\",\n                    error_code=\"RATE_LIMITED\",\n                    error_message=f\"Rate limit exceeded (retry after {retry_after}s)\",\n                    retry_after=retry_after,\n                )\n\n            # Handle success (202 Accepted)\n            if response.status_code == 202:\n                response_data = response.json()\n                status = response_data.get(\"status\")\n                message = response_data.get(\"message\", \"\")\n\n                logger.info(f\"Resolved PagerDuty incident with dedup_key {dedup_key}\")\n\n                return IntegrationResult(\n                    success=True,\n                    integration_name=self.name,\n                    operation=\"resolve_incident\",\n                    external_id=dedup_key,\n                    error_details={\"status\": status, \"message\": message},\n                )\n\n            # Handle errors\n            if response.status_code == 400:\n                try:\n                    error_data = response.json()\n                    error_msg = error_data.get(\"message\", \"Bad request\")\n                except Exception:\n                    error_msg = \"Invalid request format\"\n\n                return IntegrationResult(\n                    success=False,\n                    integration_name=self.name,\n                    operation=\"resolve_incident\",\n                    error_code=\"BAD_REQUEST\",\n                    error_message=f\"Failed to resolve incident: {error_msg}\",\n                )\n\n            elif response.status_code == 401 or response.status_code == 403:\n                return IntegrationResult(\n                    success=False,\n                    integration_name=self.name,\n                    operation=\"resolve_incident\",\n                    error_code=\"AUTH_FAILED\",\n                    error_message=\"Authentication failed - check integration_key\",\n                )\n\n            else:\n                return IntegrationResult(\n                    success=False,\n                    integration_name=self.name,\n                    operation=\"resolve_incident\",\n                    error_code=f\"HTTP_{response.status_code}\",\n                    error_message=f\"Unexpected response: HTTP {response.status_code}\",\n                )\n\n        except AuthenticationError:\n            raise\n\n        except httpx.TimeoutException as e:\n            return IntegrationResult(\n                success=False,\n                integration_name=self.name,\n                operation=\"resolve_incident\",\n                error_code=\"TIMEOUT\",\n                error_message=f\"Request timed out: {str(e)}\",\n            )\n\n        except httpx.NetworkError as e:\n            return IntegrationResult(\n                success=False,\n                integration_name=self.name,\n                operation=\"resolve_incident\",\n                error_code=\"NETWORK_ERROR\",\n                error_message=f\"Network error: {str(e)}\",\n            )\n\n        except Exception as e:\n            return IntegrationResult(\n                success=False,\n                integration_name=self.name,\n                operation=\"resolve_incident\",\n                error_code=\"ERROR\",\n                error_message=str(e),\n            )\n\n    async def add_note(self, incident_id: str, note: str) -> IntegrationResult:\n        \"\"\"\n        Add a note to an existing PagerDuty incident.\n\n        Requires REST API authentication (api_token).\n\n        Args:\n            incident_id: The incident ID (e.g., PXXXXX)\n            note: The note text to add\n\n        Returns:\n            IntegrationResult with note addition status or error\n\n        Raises:\n            AuthenticationError: If not authenticated or REST API not configured\n\n        Example:\n            ```python\n            # Add investigation notes to an incident\n            await adapter.add_note(\n                \"P1234\",\n                \"Root cause identified: misconfigured IAM policy\"\n            )\n\n            await adapter.add_note(\n                \"P1234\",\n                \"Applied fix to production environment\"\n            )\n\n            await adapter.add_note(\n                \"P1234\",\n                \"Monitoring for 30 minutes to confirm resolution\"\n            )\n            ```\n\n        Example - Structured note:\n            ```python\n            import json\n\n            # Add structured note with details\n            note_data = {\n                \"investigation\": \"Root cause analysis complete\",\n                \"root_cause\": \"Misconfigured S3 bucket policy\",\n                \"fix_applied\": \"Updated bucket policy at 14:30 UTC\",\n                \"affected_resources\": [\"s3://bucket-prod\", \"s3://bucket-staging\"],\n            }\n            await adapter.add_note(\n                \"P1234\",\n                f\"Investigation Results:\\n{json.dumps(note_data, indent=2)}\"\n            )\n            ```\n        \"\"\"\n        if not self._authenticated:\n            raise AuthenticationError(\"Integration is not authenticated\", self.name)\n\n        if self.pd_credentials.auth_type not in (\n            PagerDutyAuthType.REST_API,\n            PagerDutyAuthType.BOTH,\n        ):\n            raise AuthenticationError(\n                \"REST API authentication required for add_note\",\n                self.name,\n            )\n\n        logger.debug(f\"Adding note to PagerDuty incident {incident_id}\")\n\n        try:\n            client = await self.get_http_client()\n            headers = self._get_rest_api_headers()\n\n            # Build note payload\n            note_payload = {\n                \"note\": {\n                    \"content\": note,\n                }\n            }\n\n            notes_url = f\"{self.REST_API_URL}/incidents/{incident_id}/notes\"\n\n            response = await client.post(\n                notes_url,\n                headers=headers,\n                json=note_payload,\n            )\n\n            if response.status_code == 201:\n                logger.info(f\"Added note to PagerDuty incident {incident_id}\")\n\n                return IntegrationResult(\n                    success=True,\n                    integration_name=self.name,\n                    operation=\"add_note\",\n                    external_id=incident_id,\n                )\n\n            elif response.status_code == 404:\n                return IntegrationResult(\n                    success=False,\n                    integration_name=self.name,\n                    operation=\"add_note\",\n                    error_code=\"NOT_FOUND\",\n                    error_message=f\"Incident {incident_id} not found\",\n                )\n\n            elif response.status_code == 400:\n                try:\n                    error_data = response.json()\n                    error_msg = error_data.get(\"error\", {}).get(\"message\", \"Bad request\")\n                except Exception:\n                    error_msg = \"Invalid request format\"\n\n                return IntegrationResult(\n                    success=False,\n                    integration_name=self.name,\n                    operation=\"add_note\",\n                    error_code=\"BAD_REQUEST\",\n                    error_message=f\"Failed to add note: {error_msg}\",\n                )\n\n            elif response.status_code == 401:\n                return IntegrationResult(\n                    success=False,\n                    integration_name=self.name,\n                    operation=\"add_note\",\n                    error_code=\"AUTH_FAILED\",\n                    error_message=\"Authentication failed - check api_token\",\n                )\n\n            elif response.status_code == 403:\n                return IntegrationResult(\n                    success=False,\n                    integration_name=self.name,\n                    operation=\"add_note\",\n                    error_code=\"ACCESS_DENIED\",\n                    error_message=\"Access denied - check API token permissions\",\n                )\n\n            else:\n                return IntegrationResult(\n                    success=False,\n                    integration_name=self.name,\n                    operation=\"add_note\",\n                    error_code=f\"HTTP_{response.status_code}\",\n                    error_message=f\"Failed to add note: HTTP {response.status_code}\",\n                )\n\n        except AuthenticationError:\n            raise\n\n        except httpx.TimeoutException as e:\n            return IntegrationResult(\n                success=False,\n                integration_name=self.name,\n                operation=\"add_note\",\n                error_code=\"TIMEOUT\",\n                error_message=f\"Request timed out: {str(e)}\",\n            )\n\n        except httpx.NetworkError as e:\n            return IntegrationResult(\n                success=False,\n                integration_name=self.name,\n                operation=\"add_note\",\n                error_code=\"NETWORK_ERROR\",\n                error_message=f\"Network error: {str(e)}\",\n            )\n\n        except Exception as e:\n            return IntegrationResult(\n                success=False,\n                integration_name=self.name,\n                operation=\"add_note\",\n                error_code=\"ERROR\",\n                error_message=str(e),\n            )\n\n    async def escalate_incident(\n        self, incident_id: str, escalation_policy_id: str\n    ) -> IntegrationResult:\n        \"\"\"\n        Escalate an incident to a different escalation policy.\n\n        This is a convenience method that calls update_incident with the escalation_policy_id.\n        Requires REST API authentication (api_token).\n\n        Args:\n            incident_id: The incident ID (e.g., PXXXXX)\n            escalation_policy_id: The escalation policy ID to escalate to\n\n        Returns:\n            IntegrationResult with escalation status or error\n\n        Raises:\n            AuthenticationError: If not authenticated or REST API not configured\n\n        Example:\n            ```python\n            # Escalate to senior engineer escalation policy\n            result = await adapter.escalate_incident(\n                \"P1234\",\n                \"SENIOR_ENG_POLICY\"\n            )\n\n            if result.success:\n                print(\"Incident escalated to senior engineers\")\n            ```\n\n        Example - Escalate based on severity:\n            ```python\n            # Check incident severity and escalate if critical\n            incident_result = await adapter.get_incident(\"P1234\")\n            incident = incident_result.error_details\n\n            if incident.get(\"urgency\") == \"high\":\n                # Escalate critical incidents\n                await adapter.escalate_incident(\n                    \"P1234\",\n                    \"CRITICAL_ESCALATION_POLICY\"\n                )\n                await adapter.add_note(\n                    \"P1234\",\n                    \"Auto-escalated to critical incident team\"\n                )\n            ```\n        \"\"\"\n        logger.debug(\n            f\"Escalating PagerDuty incident {incident_id} to policy {escalation_policy_id}\"\n        )\n\n        result = await self.update_incident(\n            incident_id,\n            escalation_policy_id=escalation_policy_id,\n        )\n\n        # Update the operation name to reflect escalation\n        if result.success:\n            logger.info(\n                f\"Escalated PagerDuty incident {incident_id} to policy {escalation_policy_id}\"\n            )\n\n        return IntegrationResult(\n            success=result.success,\n            integration_name=result.integration_name,\n            operation=\"escalate_incident\",\n            external_id=result.external_id,\n            external_url=result.external_url,\n            error_code=result.error_code,\n            error_message=result.error_message,\n            error_details=result.error_details,\n            retry_after=result.retry_after,\n        )\n",
        "last_modified": "2026-01-03T18:39:10.912005"
      },
      "task_intent": {
        "title": "036-add-pagerduty-integration-adapter-for-incident-man",
        "description": "Implement a PagerDutyAdapter to create incidents from critical governance violations. Follows the ticketing integration pattern established by JIRA and ServiceNow adapters with severity-to-urgency mapping and incident lifecycle management.",
        "from_plan": true
      },
      "commits_behind_main": 0,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2026-01-03T17:33:31.406858",
  "last_updated": "2026-01-03T17:33:31.409056"
}