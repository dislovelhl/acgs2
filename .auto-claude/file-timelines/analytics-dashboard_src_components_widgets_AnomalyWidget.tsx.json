{
  "file_path": "analytics-dashboard/src/components/widgets/AnomalyWidget.tsx",
  "main_branch_history": [],
  "task_views": {
    "033-add-useanomalies-hook-to-analytics-dashboard": {
      "task_id": "033-add-useanomalies-hook-to-analytics-dashboard",
      "branch_point": {
        "commit_hash": "4a99fe22e8e0087919301b1aa185d4e2c6da716c",
        "content": "/**\n * AnomalyWidget Component\n *\n * Displays detected anomalies in governance metrics including:\n * - Unusual patterns in violations, user activity, or policy changes\n * - Severity scores and labels for each anomaly\n * - Affected metrics details\n */\n\nimport { useCallback, useEffect, useState } from \"react\";\nimport {\n  AlertCircle,\n  AlertTriangle,\n  CheckCircle2,\n  RefreshCw,\n  Shield,\n  XOctagon,\n} from \"lucide-react\";\n\n/** Anomaly data structure from the API */\ninterface AnomalyItem {\n  anomaly_id: string;\n  timestamp: string;\n  severity_score: number;\n  severity_label: \"critical\" | \"high\" | \"medium\" | \"low\";\n  affected_metrics: Record<string, number | string>;\n  description: string;\n}\n\n/** Anomalies response from the API */\ninterface AnomaliesResponse {\n  analysis_timestamp: string;\n  total_records_analyzed: number;\n  anomalies_detected: number;\n  contamination_rate: number;\n  anomalies: AnomalyItem[];\n  model_trained: boolean;\n}\n\n/** Widget loading state */\ntype LoadingState = \"idle\" | \"loading\" | \"success\" | \"error\";\n\n/** API URL from environment */\nconst API_BASE_URL =\n  import.meta.env.VITE_ANALYTICS_API_URL || \"http://localhost:8080\";\n\n/**\n * Gets the appropriate icon for a severity level\n */\nfunction getSeverityIcon(severity: AnomalyItem[\"severity_label\"]): JSX.Element {\n  switch (severity) {\n    case \"critical\":\n      return <XOctagon className=\"h-4 w-4 text-red-600\" />;\n    case \"high\":\n      return <AlertTriangle className=\"h-4 w-4 text-orange-600\" />;\n    case \"medium\":\n      return <AlertCircle className=\"h-4 w-4 text-yellow-600\" />;\n    case \"low\":\n      return <CheckCircle2 className=\"h-4 w-4 text-blue-600\" />;\n    default:\n      return <AlertCircle className=\"h-4 w-4 text-gray-600\" />;\n  }\n}\n\n/**\n * Gets the color classes for a severity level\n */\nfunction getSeverityColors(severity: AnomalyItem[\"severity_label\"]): {\n  bg: string;\n  border: string;\n  text: string;\n  badge: string;\n} {\n  switch (severity) {\n    case \"critical\":\n      return {\n        bg: \"bg-red-50\",\n        border: \"border-red-200\",\n        text: \"text-red-800\",\n        badge: \"bg-red-100 text-red-800\",\n      };\n    case \"high\":\n      return {\n        bg: \"bg-orange-50\",\n        border: \"border-orange-200\",\n        text: \"text-orange-800\",\n        badge: \"bg-orange-100 text-orange-800\",\n      };\n    case \"medium\":\n      return {\n        bg: \"bg-yellow-50\",\n        border: \"border-yellow-200\",\n        text: \"text-yellow-800\",\n        badge: \"bg-yellow-100 text-yellow-800\",\n      };\n    case \"low\":\n      return {\n        bg: \"bg-blue-50\",\n        border: \"border-blue-200\",\n        text: \"text-blue-800\",\n        badge: \"bg-blue-100 text-blue-800\",\n      };\n    default:\n      return {\n        bg: \"bg-gray-50\",\n        border: \"border-gray-200\",\n        text: \"text-gray-800\",\n        badge: \"bg-gray-100 text-gray-800\",\n      };\n  }\n}\n\n/**\n * Formats the timestamp for display\n */\nfunction formatTimestamp(timestamp: string): string {\n  try {\n    const date = new Date(timestamp);\n    return date.toLocaleString(undefined, {\n      dateStyle: \"short\",\n      timeStyle: \"short\",\n    });\n  } catch {\n    return \"Unknown\";\n  }\n}\n\n/**\n * Formats affected metrics for display\n */\nfunction formatAffectedMetrics(\n  metrics: Record<string, number | string>\n): string[] {\n  return Object.entries(metrics).map(([key, value]) => {\n    const formattedKey = key.replace(/_/g, \" \");\n    return `${formattedKey}: ${value}`;\n  });\n}\n\n/**\n * AnomalyWidget - Displays detected anomalies in governance metrics\n *\n * Features:\n * - Fetches anomalies from the analytics API\n * - Shows loading, error, and success states\n * - Displays anomalies grouped by severity\n * - Supports severity filtering\n * - Shows affected metrics for each anomaly\n */\nexport function AnomalyWidget(): JSX.Element {\n  const [data, setData] = useState<AnomaliesResponse | null>(null);\n  const [loadingState, setLoadingState] = useState<LoadingState>(\"idle\");\n  const [error, setError] = useState<string | null>(null);\n  const [severityFilter, setSeverityFilter] = useState<string | null>(null);\n\n  /**\n   * Fetches anomaly data from the API\n   */\n  const fetchAnomalies = useCallback(async () => {\n    setLoadingState(\"loading\");\n    setError(null);\n\n    try {\n      const url = new URL(`${API_BASE_URL}/anomalies`);\n      if (severityFilter) {\n        url.searchParams.set(\"severity\", severityFilter);\n      }\n\n      const response = await fetch(url.toString(), {\n        method: \"GET\",\n        headers: {\n          Accept: \"application/json\",\n        },\n      });\n\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}));\n        throw new Error(\n          errorData.detail || `Failed to fetch anomalies: ${response.status}`\n        );\n      }\n\n      const responseData: AnomaliesResponse = await response.json();\n      setData(responseData);\n      setLoadingState(\"success\");\n    } catch (err) {\n      const message =\n        err instanceof Error ? err.message : \"Failed to load anomalies\";\n      setError(message);\n      setLoadingState(\"error\");\n    }\n  }, [severityFilter]);\n\n  // Fetch anomalies on mount and when filter changes\n  useEffect(() => {\n    fetchAnomalies();\n  }, [fetchAnomalies]);\n\n  /**\n   * Handle refresh button click\n   */\n  const handleRefresh = () => {\n    fetchAnomalies();\n  };\n\n  /**\n   * Handle severity filter change\n   */\n  const handleFilterChange = (severity: string | null) => {\n    setSeverityFilter(severity);\n  };\n\n  // Loading state\n  if (loadingState === \"loading\" && !data) {\n    return (\n      <div className=\"h-full rounded-lg bg-white p-4 shadow\">\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-2\">\n            <Shield className=\"h-5 w-5 text-amber-600\" />\n            <h3 className=\"text-lg font-semibold text-gray-900\">\n              Anomaly Detection\n            </h3>\n          </div>\n        </div>\n        <div className=\"mt-4 space-y-3\">\n          <div className=\"h-4 w-3/4 animate-pulse rounded bg-gray-200\" />\n          <div className=\"h-4 w-full animate-pulse rounded bg-gray-200\" />\n          <div className=\"h-4 w-5/6 animate-pulse rounded bg-gray-200\" />\n        </div>\n      </div>\n    );\n  }\n\n  // Error state\n  if (loadingState === \"error\") {\n    return (\n      <div className=\"h-full rounded-lg bg-white p-4 shadow\">\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-2\">\n            <Shield className=\"h-5 w-5 text-amber-600\" />\n            <h3 className=\"text-lg font-semibold text-gray-900\">\n              Anomaly Detection\n            </h3>\n          </div>\n          <button\n            onClick={handleRefresh}\n            className=\"rounded p-1 text-gray-400 transition-colors hover:bg-gray-100 hover:text-gray-600\"\n            title=\"Retry\"\n            aria-label=\"Retry loading anomalies\"\n          >\n            <RefreshCw className=\"h-4 w-4\" />\n          </button>\n        </div>\n        <div className=\"mt-4 flex flex-col items-center justify-center py-8\">\n          <AlertCircle className=\"h-8 w-8 text-red-500\" />\n          <p className=\"mt-2 text-center text-sm text-red-600\">{error}</p>\n          <button\n            onClick={handleRefresh}\n            className=\"mt-4 rounded-md bg-red-50 px-4 py-2 text-sm font-medium text-red-700 transition-colors hover:bg-red-100\"\n          >\n            Try Again\n          </button>\n        </div>\n      </div>\n    );\n  }\n\n  // No anomalies state\n  if (data && data.anomalies.length === 0) {\n    return (\n      <div className=\"flex h-full flex-col rounded-lg bg-white p-4 shadow\">\n        {/* Header */}\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-2\">\n            <Shield className=\"h-5 w-5 text-amber-600\" />\n            <h3 className=\"text-lg font-semibold text-gray-900\">\n              Anomaly Detection\n            </h3>\n          </div>\n          <button\n            onClick={handleRefresh}\n            disabled={loadingState === \"loading\"}\n            className=\"rounded p-1 text-gray-400 transition-colors hover:bg-gray-100 hover:text-gray-600 disabled:cursor-not-allowed disabled:opacity-50\"\n            title=\"Refresh anomalies\"\n            aria-label=\"Refresh anomalies\"\n          >\n            <RefreshCw\n              className={`h-4 w-4 ${loadingState === \"loading\" ? \"animate-spin\" : \"\"}`}\n            />\n          </button>\n        </div>\n\n        {/* Empty state */}\n        <div className=\"flex flex-1 flex-col items-center justify-center py-8\">\n          <CheckCircle2 className=\"h-12 w-12 text-green-500\" />\n          <p className=\"mt-3 text-lg font-medium text-gray-900\">\n            No Anomalies Detected\n          </p>\n          <p className=\"mt-1 text-center text-sm text-gray-500\">\n            {data.total_records_analyzed} records analyzed\n          </p>\n          <p className=\"text-center text-xs text-gray-400\">\n            Last checked: {formatTimestamp(data.analysis_timestamp)}\n          </p>\n        </div>\n      </div>\n    );\n  }\n\n  // Success state with anomaly data\n  return (\n    <div className=\"flex h-full flex-col rounded-lg bg-white p-4 shadow\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-2\">\n          <Shield className=\"h-5 w-5 text-amber-600\" />\n          <h3 className=\"text-lg font-semibold text-gray-900\">\n            Anomaly Detection\n          </h3>\n          {data && data.anomalies_detected > 0 && (\n            <span className=\"rounded-full bg-amber-100 px-2 py-0.5 text-xs font-medium text-amber-800\">\n              {data.anomalies_detected} found\n            </span>\n          )}\n        </div>\n        <button\n          onClick={handleRefresh}\n          disabled={loadingState === \"loading\"}\n          className=\"rounded p-1 text-gray-400 transition-colors hover:bg-gray-100 hover:text-gray-600 disabled:cursor-not-allowed disabled:opacity-50\"\n          title=\"Refresh anomalies\"\n          aria-label=\"Refresh anomalies\"\n        >\n          <RefreshCw\n            className={`h-4 w-4 ${loadingState === \"loading\" ? \"animate-spin\" : \"\"}`}\n          />\n        </button>\n      </div>\n\n      {/* Severity Filter */}\n      <div className=\"mt-3 flex flex-wrap gap-1\">\n        <button\n          onClick={() => handleFilterChange(null)}\n          className={`rounded-full px-2.5 py-0.5 text-xs font-medium transition-colors ${\n            severityFilter === null\n              ? \"bg-gray-800 text-white\"\n              : \"bg-gray-100 text-gray-600 hover:bg-gray-200\"\n          }`}\n        >\n          All\n        </button>\n        {([\"critical\", \"high\", \"medium\", \"low\"] as const).map((level) => {\n          const colors = getSeverityColors(level);\n          return (\n            <button\n              key={level}\n              onClick={() => handleFilterChange(level)}\n              className={`rounded-full px-2.5 py-0.5 text-xs font-medium capitalize transition-colors ${\n                severityFilter === level\n                  ? colors.badge\n                  : \"bg-gray-100 text-gray-600 hover:bg-gray-200\"\n              }`}\n            >\n              {level}\n            </button>\n          );\n        })}\n      </div>\n\n      {/* Anomalies List */}\n      <div className=\"mt-4 flex-1 space-y-3 overflow-y-auto\">\n        {data?.anomalies.map((anomaly) => {\n          const colors = getSeverityColors(anomaly.severity_label);\n          const affectedMetrics = formatAffectedMetrics(\n            anomaly.affected_metrics\n          );\n\n          return (\n            <div\n              key={anomaly.anomaly_id}\n              className={`rounded-lg border p-3 ${colors.bg} ${colors.border}`}\n            >\n              {/* Anomaly Header */}\n              <div className=\"flex items-start justify-between gap-2\">\n                <div className=\"flex items-center gap-2\">\n                  {getSeverityIcon(anomaly.severity_label)}\n                  <span\n                    className={`rounded px-1.5 py-0.5 text-xs font-semibold uppercase ${colors.badge}`}\n                  >\n                    {anomaly.severity_label}\n                  </span>\n                </div>\n                <span className=\"text-xs text-gray-500\">\n                  {formatTimestamp(anomaly.timestamp)}\n                </span>\n              </div>\n\n              {/* Description */}\n              <p className={`mt-2 text-sm ${colors.text}`}>\n                {anomaly.description || \"Unusual pattern detected in governance metrics\"}\n              </p>\n\n              {/* Affected Metrics */}\n              {affectedMetrics.length > 0 && (\n                <div className=\"mt-2 flex flex-wrap gap-1\">\n                  {affectedMetrics.map((metric, index) => (\n                    <span\n                      key={index}\n                      className=\"rounded bg-white bg-opacity-60 px-1.5 py-0.5 text-xs text-gray-700\"\n                    >\n                      {metric}\n                    </span>\n                  ))}\n                </div>\n              )}\n\n              {/* Severity Score */}\n              <div className=\"mt-2 flex items-center gap-2\">\n                <div className=\"h-1.5 flex-1 rounded-full bg-white bg-opacity-50\">\n                  <div\n                    className={`h-1.5 rounded-full ${\n                      anomaly.severity_label === \"critical\"\n                        ? \"bg-red-600\"\n                        : anomaly.severity_label === \"high\"\n                          ? \"bg-orange-600\"\n                          : anomaly.severity_label === \"medium\"\n                            ? \"bg-yellow-600\"\n                            : \"bg-blue-600\"\n                    }`}\n                    style={{\n                      width: `${Math.max(10, Math.abs(anomaly.severity_score) * 100)}%`,\n                    }}\n                  />\n                </div>\n                <span className=\"text-xs text-gray-600\">\n                  {(anomaly.severity_score * 100).toFixed(0)}%\n                </span>\n              </div>\n            </div>\n          );\n        })}\n      </div>\n\n      {/* Footer with metadata */}\n      <div className=\"mt-4 flex items-center justify-between border-t border-gray-100 pt-3 text-xs text-gray-500\">\n        <div className=\"flex items-center gap-4\">\n          <span>\n            Records analyzed:{\" \"}\n            <span className=\"font-medium text-gray-700\">\n              {data?.total_records_analyzed || 0}\n            </span>\n          </span>\n          <span>\n            Model:{\" \"}\n            <span\n              className={`font-medium ${data?.model_trained ? \"text-green-600\" : \"text-gray-500\"}`}\n            >\n              {data?.model_trained ? \"Trained\" : \"Not trained\"}\n            </span>\n          </span>\n        </div>\n        {data?.analysis_timestamp && (\n          <span title={data.analysis_timestamp}>\n            {formatTimestamp(data.analysis_timestamp)}\n          </span>\n        )}\n      </div>\n    </div>\n  );\n}\n\nexport default AnomalyWidget;\n",
        "timestamp": "2026-01-03T18:32:21.773146"
      },
      "worktree_state": {
        "content": "/**\n * AnomalyWidget Component\n *\n * Displays detected anomalies in governance metrics including:\n * - Unusual patterns in violations, user activity, or policy changes\n * - Severity scores and labels for each anomaly\n * - Affected metrics details\n */\n\nimport { useState } from \"react\";\nimport {\n  AlertCircle,\n  AlertTriangle,\n  CheckCircle2,\n  RefreshCw,\n  Shield,\n  XOctagon,\n} from \"lucide-react\";\nimport type { AnomalyItem } from \"../../types/anomalies\";\nimport { useAnomalies } from \"../../hooks\";\n\n/**\n * Gets the appropriate icon for a severity level\n */\nfunction getSeverityIcon(severity: AnomalyItem[\"severity_label\"]): JSX.Element {\n  switch (severity) {\n    case \"critical\":\n      return <XOctagon className=\"h-4 w-4 text-red-600\" />;\n    case \"high\":\n      return <AlertTriangle className=\"h-4 w-4 text-orange-600\" />;\n    case \"medium\":\n      return <AlertCircle className=\"h-4 w-4 text-yellow-600\" />;\n    case \"low\":\n      return <CheckCircle2 className=\"h-4 w-4 text-blue-600\" />;\n    default:\n      return <AlertCircle className=\"h-4 w-4 text-gray-600\" />;\n  }\n}\n\n/**\n * Gets the color classes for a severity level\n */\nfunction getSeverityColors(severity: AnomalyItem[\"severity_label\"]): {\n  bg: string;\n  border: string;\n  text: string;\n  badge: string;\n} {\n  switch (severity) {\n    case \"critical\":\n      return {\n        bg: \"bg-red-50\",\n        border: \"border-red-200\",\n        text: \"text-red-800\",\n        badge: \"bg-red-100 text-red-800\",\n      };\n    case \"high\":\n      return {\n        bg: \"bg-orange-50\",\n        border: \"border-orange-200\",\n        text: \"text-orange-800\",\n        badge: \"bg-orange-100 text-orange-800\",\n      };\n    case \"medium\":\n      return {\n        bg: \"bg-yellow-50\",\n        border: \"border-yellow-200\",\n        text: \"text-yellow-800\",\n        badge: \"bg-yellow-100 text-yellow-800\",\n      };\n    case \"low\":\n      return {\n        bg: \"bg-blue-50\",\n        border: \"border-blue-200\",\n        text: \"text-blue-800\",\n        badge: \"bg-blue-100 text-blue-800\",\n      };\n    default:\n      return {\n        bg: \"bg-gray-50\",\n        border: \"border-gray-200\",\n        text: \"text-gray-800\",\n        badge: \"bg-gray-100 text-gray-800\",\n      };\n  }\n}\n\n/**\n * Formats the timestamp for display\n */\nfunction formatTimestamp(timestamp: string): string {\n  try {\n    const date = new Date(timestamp);\n    return date.toLocaleString(undefined, {\n      dateStyle: \"short\",\n      timeStyle: \"short\",\n    });\n  } catch {\n    return \"Unknown\";\n  }\n}\n\n/**\n * Formats affected metrics for display\n */\nfunction formatAffectedMetrics(\n  metrics: Record<string, number | string>\n): string[] {\n  return Object.entries(metrics).map(([key, value]) => {\n    const formattedKey = key.replace(/_/g, \" \");\n    return `${formattedKey}: ${value}`;\n  });\n}\n\n/**\n * AnomalyWidget - Displays detected anomalies in governance metrics\n *\n * Features:\n * - Fetches anomalies from the analytics API\n * - Shows loading, error, and success states\n * - Displays anomalies grouped by severity\n * - Supports severity filtering\n * - Shows affected metrics for each anomaly\n */\nexport function AnomalyWidget(): JSX.Element {\n  const [severityFilter, setSeverityFilter] = useState<string | null>(null);\n  const { data, loading, error, refetch } = useAnomalies(severityFilter);\n\n  /**\n   * Handle refresh button click\n   */\n  const handleRefresh = () => {\n    refetch();\n  };\n\n  /**\n   * Handle severity filter change\n   */\n  const handleFilterChange = (severity: string | null) => {\n    setSeverityFilter(severity);\n  };\n\n  // Loading state\n  if (loading && !data) {\n    return (\n      <div className=\"h-full rounded-lg bg-white p-4 shadow\">\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-2\">\n            <Shield className=\"h-5 w-5 text-amber-600\" />\n            <h3 className=\"text-lg font-semibold text-gray-900\">\n              Anomaly Detection\n            </h3>\n          </div>\n        </div>\n        <div className=\"mt-4 space-y-3\">\n          <div className=\"h-4 w-3/4 animate-pulse rounded bg-gray-200\" />\n          <div className=\"h-4 w-full animate-pulse rounded bg-gray-200\" />\n          <div className=\"h-4 w-5/6 animate-pulse rounded bg-gray-200\" />\n        </div>\n      </div>\n    );\n  }\n\n  // Error state\n  if (error) {\n    return (\n      <div className=\"h-full rounded-lg bg-white p-4 shadow\">\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-2\">\n            <Shield className=\"h-5 w-5 text-amber-600\" />\n            <h3 className=\"text-lg font-semibold text-gray-900\">\n              Anomaly Detection\n            </h3>\n          </div>\n          <button\n            onClick={handleRefresh}\n            className=\"rounded p-1 text-gray-400 transition-colors hover:bg-gray-100 hover:text-gray-600\"\n            title=\"Retry\"\n            aria-label=\"Retry loading anomalies\"\n          >\n            <RefreshCw className=\"h-4 w-4\" />\n          </button>\n        </div>\n        <div className=\"mt-4 flex flex-col items-center justify-center py-8\">\n          <AlertCircle className=\"h-8 w-8 text-red-500\" />\n          <p className=\"mt-2 text-center text-sm text-red-600\">{error.message}</p>\n          <button\n            onClick={handleRefresh}\n            className=\"mt-4 rounded-md bg-red-50 px-4 py-2 text-sm font-medium text-red-700 transition-colors hover:bg-red-100\"\n          >\n            Try Again\n          </button>\n        </div>\n      </div>\n    );\n  }\n\n  // No anomalies state\n  if (data && data.anomalies.length === 0) {\n    return (\n      <div className=\"flex h-full flex-col rounded-lg bg-white p-4 shadow\">\n        {/* Header */}\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-2\">\n            <Shield className=\"h-5 w-5 text-amber-600\" />\n            <h3 className=\"text-lg font-semibold text-gray-900\">\n              Anomaly Detection\n            </h3>\n          </div>\n          <button\n            onClick={handleRefresh}\n            disabled={loading}\n            className=\"rounded p-1 text-gray-400 transition-colors hover:bg-gray-100 hover:text-gray-600 disabled:cursor-not-allowed disabled:opacity-50\"\n            title=\"Refresh anomalies\"\n            aria-label=\"Refresh anomalies\"\n          >\n            <RefreshCw\n              className={`h-4 w-4 ${loading ? \"animate-spin\" : \"\"}`}\n            />\n          </button>\n        </div>\n\n        {/* Empty state */}\n        <div className=\"flex flex-1 flex-col items-center justify-center py-8\">\n          <CheckCircle2 className=\"h-12 w-12 text-green-500\" />\n          <p className=\"mt-3 text-lg font-medium text-gray-900\">\n            No Anomalies Detected\n          </p>\n          <p className=\"mt-1 text-center text-sm text-gray-500\">\n            {data.total_records_analyzed} records analyzed\n          </p>\n          <p className=\"text-center text-xs text-gray-400\">\n            Last checked: {formatTimestamp(data.analysis_timestamp)}\n          </p>\n        </div>\n      </div>\n    );\n  }\n\n  // Success state with anomaly data\n  return (\n    <div className=\"flex h-full flex-col rounded-lg bg-white p-4 shadow\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-2\">\n          <Shield className=\"h-5 w-5 text-amber-600\" />\n          <h3 className=\"text-lg font-semibold text-gray-900\">\n            Anomaly Detection\n          </h3>\n          {data && data.anomalies_detected > 0 && (\n            <span className=\"rounded-full bg-amber-100 px-2 py-0.5 text-xs font-medium text-amber-800\">\n              {data.anomalies_detected} found\n            </span>\n          )}\n        </div>\n        <button\n          onClick={handleRefresh}\n          disabled={loading}\n          className=\"rounded p-1 text-gray-400 transition-colors hover:bg-gray-100 hover:text-gray-600 disabled:cursor-not-allowed disabled:opacity-50\"\n          title=\"Refresh anomalies\"\n          aria-label=\"Refresh anomalies\"\n        >\n          <RefreshCw\n            className={`h-4 w-4 ${loading ? \"animate-spin\" : \"\"}`}\n          />\n        </button>\n      </div>\n\n      {/* Severity Filter */}\n      <div className=\"mt-3 flex flex-wrap gap-1\">\n        <button\n          onClick={() => handleFilterChange(null)}\n          className={`rounded-full px-2.5 py-0.5 text-xs font-medium transition-colors ${\n            severityFilter === null\n              ? \"bg-gray-800 text-white\"\n              : \"bg-gray-100 text-gray-600 hover:bg-gray-200\"\n          }`}\n        >\n          All\n        </button>\n        {([\"critical\", \"high\", \"medium\", \"low\"] as const).map((level) => {\n          const colors = getSeverityColors(level);\n          return (\n            <button\n              key={level}\n              onClick={() => handleFilterChange(level)}\n              className={`rounded-full px-2.5 py-0.5 text-xs font-medium capitalize transition-colors ${\n                severityFilter === level\n                  ? colors.badge\n                  : \"bg-gray-100 text-gray-600 hover:bg-gray-200\"\n              }`}\n            >\n              {level}\n            </button>\n          );\n        })}\n      </div>\n\n      {/* Anomalies List */}\n      <div className=\"mt-4 flex-1 space-y-3 overflow-y-auto\">\n        {data?.anomalies.map((anomaly) => {\n          const colors = getSeverityColors(anomaly.severity_label);\n          const affectedMetrics = formatAffectedMetrics(\n            anomaly.affected_metrics\n          );\n\n          return (\n            <div\n              key={anomaly.anomaly_id}\n              className={`rounded-lg border p-3 ${colors.bg} ${colors.border}`}\n            >\n              {/* Anomaly Header */}\n              <div className=\"flex items-start justify-between gap-2\">\n                <div className=\"flex items-center gap-2\">\n                  {getSeverityIcon(anomaly.severity_label)}\n                  <span\n                    className={`rounded px-1.5 py-0.5 text-xs font-semibold uppercase ${colors.badge}`}\n                  >\n                    {anomaly.severity_label}\n                  </span>\n                </div>\n                <span className=\"text-xs text-gray-500\">\n                  {formatTimestamp(anomaly.timestamp)}\n                </span>\n              </div>\n\n              {/* Description */}\n              <p className={`mt-2 text-sm ${colors.text}`}>\n                {anomaly.description || \"Unusual pattern detected in governance metrics\"}\n              </p>\n\n              {/* Affected Metrics */}\n              {affectedMetrics.length > 0 && (\n                <div className=\"mt-2 flex flex-wrap gap-1\">\n                  {affectedMetrics.map((metric, index) => (\n                    <span\n                      key={index}\n                      className=\"rounded bg-white bg-opacity-60 px-1.5 py-0.5 text-xs text-gray-700\"\n                    >\n                      {metric}\n                    </span>\n                  ))}\n                </div>\n              )}\n\n              {/* Severity Score */}\n              <div className=\"mt-2 flex items-center gap-2\">\n                <div className=\"h-1.5 flex-1 rounded-full bg-white bg-opacity-50\">\n                  <div\n                    className={`h-1.5 rounded-full ${\n                      anomaly.severity_label === \"critical\"\n                        ? \"bg-red-600\"\n                        : anomaly.severity_label === \"high\"\n                          ? \"bg-orange-600\"\n                          : anomaly.severity_label === \"medium\"\n                            ? \"bg-yellow-600\"\n                            : \"bg-blue-600\"\n                    }`}\n                    style={{\n                      width: `${Math.max(10, Math.abs(anomaly.severity_score) * 100)}%`,\n                    }}\n                  />\n                </div>\n                <span className=\"text-xs text-gray-600\">\n                  {(anomaly.severity_score * 100).toFixed(0)}%\n                </span>\n              </div>\n            </div>\n          );\n        })}\n      </div>\n\n      {/* Footer with metadata */}\n      <div className=\"mt-4 flex items-center justify-between border-t border-gray-100 pt-3 text-xs text-gray-500\">\n        <div className=\"flex items-center gap-4\">\n          <span>\n            Records analyzed:{\" \"}\n            <span className=\"font-medium text-gray-700\">\n              {data?.total_records_analyzed || 0}\n            </span>\n          </span>\n          <span>\n            Model:{\" \"}\n            <span\n              className={`font-medium ${data?.model_trained ? \"text-green-600\" : \"text-gray-500\"}`}\n            >\n              {data?.model_trained ? \"Trained\" : \"Not trained\"}\n            </span>\n          </span>\n        </div>\n        {data?.analysis_timestamp && (\n          <span title={data.analysis_timestamp}>\n            {formatTimestamp(data.analysis_timestamp)}\n          </span>\n        )}\n      </div>\n    </div>\n  );\n}\n\nexport default AnomalyWidget;\n",
        "last_modified": "2026-01-03T18:36:09.854588"
      },
      "task_intent": {
        "title": "033-add-useanomalies-hook-to-analytics-dashboard",
        "description": "Extract the anomaly fetching logic from AnomalyWidget.tsx into a reusable useAnomalies hook following the existing UseDataResult<T> pattern established in acgs2-observability/monitoring/dashboard/src/hooks/useDashboard.ts. This enables anomaly data to be consumed by other components without duplicating fetch logic.",
        "from_plan": true
      },
      "commits_behind_main": 0,
      "status": "active",
      "merged_at": null
    },
    "054-extract-duplicated-loadingstate-and-api-config-in-": {
      "task_id": "054-extract-duplicated-loadingstate-and-api-config-in-",
      "branch_point": {
        "commit_hash": "4a99fe22e8e0087919301b1aa185d4e2c6da716c",
        "content": "/**\n * AnomalyWidget Component\n *\n * Displays detected anomalies in governance metrics including:\n * - Unusual patterns in violations, user activity, or policy changes\n * - Severity scores and labels for each anomaly\n * - Affected metrics details\n */\n\nimport { useCallback, useEffect, useState } from \"react\";\nimport {\n  AlertCircle,\n  AlertTriangle,\n  CheckCircle2,\n  RefreshCw,\n  Shield,\n  XOctagon,\n} from \"lucide-react\";\n\n/** Anomaly data structure from the API */\ninterface AnomalyItem {\n  anomaly_id: string;\n  timestamp: string;\n  severity_score: number;\n  severity_label: \"critical\" | \"high\" | \"medium\" | \"low\";\n  affected_metrics: Record<string, number | string>;\n  description: string;\n}\n\n/** Anomalies response from the API */\ninterface AnomaliesResponse {\n  analysis_timestamp: string;\n  total_records_analyzed: number;\n  anomalies_detected: number;\n  contamination_rate: number;\n  anomalies: AnomalyItem[];\n  model_trained: boolean;\n}\n\n/** Widget loading state */\ntype LoadingState = \"idle\" | \"loading\" | \"success\" | \"error\";\n\n/** API URL from environment */\nconst API_BASE_URL =\n  import.meta.env.VITE_ANALYTICS_API_URL || \"http://localhost:8080\";\n\n/**\n * Gets the appropriate icon for a severity level\n */\nfunction getSeverityIcon(severity: AnomalyItem[\"severity_label\"]): JSX.Element {\n  switch (severity) {\n    case \"critical\":\n      return <XOctagon className=\"h-4 w-4 text-red-600\" />;\n    case \"high\":\n      return <AlertTriangle className=\"h-4 w-4 text-orange-600\" />;\n    case \"medium\":\n      return <AlertCircle className=\"h-4 w-4 text-yellow-600\" />;\n    case \"low\":\n      return <CheckCircle2 className=\"h-4 w-4 text-blue-600\" />;\n    default:\n      return <AlertCircle className=\"h-4 w-4 text-gray-600\" />;\n  }\n}\n\n/**\n * Gets the color classes for a severity level\n */\nfunction getSeverityColors(severity: AnomalyItem[\"severity_label\"]): {\n  bg: string;\n  border: string;\n  text: string;\n  badge: string;\n} {\n  switch (severity) {\n    case \"critical\":\n      return {\n        bg: \"bg-red-50\",\n        border: \"border-red-200\",\n        text: \"text-red-800\",\n        badge: \"bg-red-100 text-red-800\",\n      };\n    case \"high\":\n      return {\n        bg: \"bg-orange-50\",\n        border: \"border-orange-200\",\n        text: \"text-orange-800\",\n        badge: \"bg-orange-100 text-orange-800\",\n      };\n    case \"medium\":\n      return {\n        bg: \"bg-yellow-50\",\n        border: \"border-yellow-200\",\n        text: \"text-yellow-800\",\n        badge: \"bg-yellow-100 text-yellow-800\",\n      };\n    case \"low\":\n      return {\n        bg: \"bg-blue-50\",\n        border: \"border-blue-200\",\n        text: \"text-blue-800\",\n        badge: \"bg-blue-100 text-blue-800\",\n      };\n    default:\n      return {\n        bg: \"bg-gray-50\",\n        border: \"border-gray-200\",\n        text: \"text-gray-800\",\n        badge: \"bg-gray-100 text-gray-800\",\n      };\n  }\n}\n\n/**\n * Formats the timestamp for display\n */\nfunction formatTimestamp(timestamp: string): string {\n  try {\n    const date = new Date(timestamp);\n    return date.toLocaleString(undefined, {\n      dateStyle: \"short\",\n      timeStyle: \"short\",\n    });\n  } catch {\n    return \"Unknown\";\n  }\n}\n\n/**\n * Formats affected metrics for display\n */\nfunction formatAffectedMetrics(\n  metrics: Record<string, number | string>\n): string[] {\n  return Object.entries(metrics).map(([key, value]) => {\n    const formattedKey = key.replace(/_/g, \" \");\n    return `${formattedKey}: ${value}`;\n  });\n}\n\n/**\n * AnomalyWidget - Displays detected anomalies in governance metrics\n *\n * Features:\n * - Fetches anomalies from the analytics API\n * - Shows loading, error, and success states\n * - Displays anomalies grouped by severity\n * - Supports severity filtering\n * - Shows affected metrics for each anomaly\n */\nexport function AnomalyWidget(): JSX.Element {\n  const [data, setData] = useState<AnomaliesResponse | null>(null);\n  const [loadingState, setLoadingState] = useState<LoadingState>(\"idle\");\n  const [error, setError] = useState<string | null>(null);\n  const [severityFilter, setSeverityFilter] = useState<string | null>(null);\n\n  /**\n   * Fetches anomaly data from the API\n   */\n  const fetchAnomalies = useCallback(async () => {\n    setLoadingState(\"loading\");\n    setError(null);\n\n    try {\n      const url = new URL(`${API_BASE_URL}/anomalies`);\n      if (severityFilter) {\n        url.searchParams.set(\"severity\", severityFilter);\n      }\n\n      const response = await fetch(url.toString(), {\n        method: \"GET\",\n        headers: {\n          Accept: \"application/json\",\n        },\n      });\n\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}));\n        throw new Error(\n          errorData.detail || `Failed to fetch anomalies: ${response.status}`\n        );\n      }\n\n      const responseData: AnomaliesResponse = await response.json();\n      setData(responseData);\n      setLoadingState(\"success\");\n    } catch (err) {\n      const message =\n        err instanceof Error ? err.message : \"Failed to load anomalies\";\n      setError(message);\n      setLoadingState(\"error\");\n    }\n  }, [severityFilter]);\n\n  // Fetch anomalies on mount and when filter changes\n  useEffect(() => {\n    fetchAnomalies();\n  }, [fetchAnomalies]);\n\n  /**\n   * Handle refresh button click\n   */\n  const handleRefresh = () => {\n    fetchAnomalies();\n  };\n\n  /**\n   * Handle severity filter change\n   */\n  const handleFilterChange = (severity: string | null) => {\n    setSeverityFilter(severity);\n  };\n\n  // Loading state\n  if (loadingState === \"loading\" && !data) {\n    return (\n      <div className=\"h-full rounded-lg bg-white p-4 shadow\">\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-2\">\n            <Shield className=\"h-5 w-5 text-amber-600\" />\n            <h3 className=\"text-lg font-semibold text-gray-900\">\n              Anomaly Detection\n            </h3>\n          </div>\n        </div>\n        <div className=\"mt-4 space-y-3\">\n          <div className=\"h-4 w-3/4 animate-pulse rounded bg-gray-200\" />\n          <div className=\"h-4 w-full animate-pulse rounded bg-gray-200\" />\n          <div className=\"h-4 w-5/6 animate-pulse rounded bg-gray-200\" />\n        </div>\n      </div>\n    );\n  }\n\n  // Error state\n  if (loadingState === \"error\") {\n    return (\n      <div className=\"h-full rounded-lg bg-white p-4 shadow\">\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-2\">\n            <Shield className=\"h-5 w-5 text-amber-600\" />\n            <h3 className=\"text-lg font-semibold text-gray-900\">\n              Anomaly Detection\n            </h3>\n          </div>\n          <button\n            onClick={handleRefresh}\n            className=\"rounded p-1 text-gray-400 transition-colors hover:bg-gray-100 hover:text-gray-600\"\n            title=\"Retry\"\n            aria-label=\"Retry loading anomalies\"\n          >\n            <RefreshCw className=\"h-4 w-4\" />\n          </button>\n        </div>\n        <div className=\"mt-4 flex flex-col items-center justify-center py-8\">\n          <AlertCircle className=\"h-8 w-8 text-red-500\" />\n          <p className=\"mt-2 text-center text-sm text-red-600\">{error}</p>\n          <button\n            onClick={handleRefresh}\n            className=\"mt-4 rounded-md bg-red-50 px-4 py-2 text-sm font-medium text-red-700 transition-colors hover:bg-red-100\"\n          >\n            Try Again\n          </button>\n        </div>\n      </div>\n    );\n  }\n\n  // No anomalies state\n  if (data && data.anomalies.length === 0) {\n    return (\n      <div className=\"flex h-full flex-col rounded-lg bg-white p-4 shadow\">\n        {/* Header */}\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-2\">\n            <Shield className=\"h-5 w-5 text-amber-600\" />\n            <h3 className=\"text-lg font-semibold text-gray-900\">\n              Anomaly Detection\n            </h3>\n          </div>\n          <button\n            onClick={handleRefresh}\n            disabled={loadingState === \"loading\"}\n            className=\"rounded p-1 text-gray-400 transition-colors hover:bg-gray-100 hover:text-gray-600 disabled:cursor-not-allowed disabled:opacity-50\"\n            title=\"Refresh anomalies\"\n            aria-label=\"Refresh anomalies\"\n          >\n            <RefreshCw\n              className={`h-4 w-4 ${loadingState === \"loading\" ? \"animate-spin\" : \"\"}`}\n            />\n          </button>\n        </div>\n\n        {/* Empty state */}\n        <div className=\"flex flex-1 flex-col items-center justify-center py-8\">\n          <CheckCircle2 className=\"h-12 w-12 text-green-500\" />\n          <p className=\"mt-3 text-lg font-medium text-gray-900\">\n            No Anomalies Detected\n          </p>\n          <p className=\"mt-1 text-center text-sm text-gray-500\">\n            {data.total_records_analyzed} records analyzed\n          </p>\n          <p className=\"text-center text-xs text-gray-400\">\n            Last checked: {formatTimestamp(data.analysis_timestamp)}\n          </p>\n        </div>\n      </div>\n    );\n  }\n\n  // Success state with anomaly data\n  return (\n    <div className=\"flex h-full flex-col rounded-lg bg-white p-4 shadow\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-2\">\n          <Shield className=\"h-5 w-5 text-amber-600\" />\n          <h3 className=\"text-lg font-semibold text-gray-900\">\n            Anomaly Detection\n          </h3>\n          {data && data.anomalies_detected > 0 && (\n            <span className=\"rounded-full bg-amber-100 px-2 py-0.5 text-xs font-medium text-amber-800\">\n              {data.anomalies_detected} found\n            </span>\n          )}\n        </div>\n        <button\n          onClick={handleRefresh}\n          disabled={loadingState === \"loading\"}\n          className=\"rounded p-1 text-gray-400 transition-colors hover:bg-gray-100 hover:text-gray-600 disabled:cursor-not-allowed disabled:opacity-50\"\n          title=\"Refresh anomalies\"\n          aria-label=\"Refresh anomalies\"\n        >\n          <RefreshCw\n            className={`h-4 w-4 ${loadingState === \"loading\" ? \"animate-spin\" : \"\"}`}\n          />\n        </button>\n      </div>\n\n      {/* Severity Filter */}\n      <div className=\"mt-3 flex flex-wrap gap-1\">\n        <button\n          onClick={() => handleFilterChange(null)}\n          className={`rounded-full px-2.5 py-0.5 text-xs font-medium transition-colors ${\n            severityFilter === null\n              ? \"bg-gray-800 text-white\"\n              : \"bg-gray-100 text-gray-600 hover:bg-gray-200\"\n          }`}\n        >\n          All\n        </button>\n        {([\"critical\", \"high\", \"medium\", \"low\"] as const).map((level) => {\n          const colors = getSeverityColors(level);\n          return (\n            <button\n              key={level}\n              onClick={() => handleFilterChange(level)}\n              className={`rounded-full px-2.5 py-0.5 text-xs font-medium capitalize transition-colors ${\n                severityFilter === level\n                  ? colors.badge\n                  : \"bg-gray-100 text-gray-600 hover:bg-gray-200\"\n              }`}\n            >\n              {level}\n            </button>\n          );\n        })}\n      </div>\n\n      {/* Anomalies List */}\n      <div className=\"mt-4 flex-1 space-y-3 overflow-y-auto\">\n        {data?.anomalies.map((anomaly) => {\n          const colors = getSeverityColors(anomaly.severity_label);\n          const affectedMetrics = formatAffectedMetrics(\n            anomaly.affected_metrics\n          );\n\n          return (\n            <div\n              key={anomaly.anomaly_id}\n              className={`rounded-lg border p-3 ${colors.bg} ${colors.border}`}\n            >\n              {/* Anomaly Header */}\n              <div className=\"flex items-start justify-between gap-2\">\n                <div className=\"flex items-center gap-2\">\n                  {getSeverityIcon(anomaly.severity_label)}\n                  <span\n                    className={`rounded px-1.5 py-0.5 text-xs font-semibold uppercase ${colors.badge}`}\n                  >\n                    {anomaly.severity_label}\n                  </span>\n                </div>\n                <span className=\"text-xs text-gray-500\">\n                  {formatTimestamp(anomaly.timestamp)}\n                </span>\n              </div>\n\n              {/* Description */}\n              <p className={`mt-2 text-sm ${colors.text}`}>\n                {anomaly.description || \"Unusual pattern detected in governance metrics\"}\n              </p>\n\n              {/* Affected Metrics */}\n              {affectedMetrics.length > 0 && (\n                <div className=\"mt-2 flex flex-wrap gap-1\">\n                  {affectedMetrics.map((metric, index) => (\n                    <span\n                      key={index}\n                      className=\"rounded bg-white bg-opacity-60 px-1.5 py-0.5 text-xs text-gray-700\"\n                    >\n                      {metric}\n                    </span>\n                  ))}\n                </div>\n              )}\n\n              {/* Severity Score */}\n              <div className=\"mt-2 flex items-center gap-2\">\n                <div className=\"h-1.5 flex-1 rounded-full bg-white bg-opacity-50\">\n                  <div\n                    className={`h-1.5 rounded-full ${\n                      anomaly.severity_label === \"critical\"\n                        ? \"bg-red-600\"\n                        : anomaly.severity_label === \"high\"\n                          ? \"bg-orange-600\"\n                          : anomaly.severity_label === \"medium\"\n                            ? \"bg-yellow-600\"\n                            : \"bg-blue-600\"\n                    }`}\n                    style={{\n                      width: `${Math.max(10, Math.abs(anomaly.severity_score) * 100)}%`,\n                    }}\n                  />\n                </div>\n                <span className=\"text-xs text-gray-600\">\n                  {(anomaly.severity_score * 100).toFixed(0)}%\n                </span>\n              </div>\n            </div>\n          );\n        })}\n      </div>\n\n      {/* Footer with metadata */}\n      <div className=\"mt-4 flex items-center justify-between border-t border-gray-100 pt-3 text-xs text-gray-500\">\n        <div className=\"flex items-center gap-4\">\n          <span>\n            Records analyzed:{\" \"}\n            <span className=\"font-medium text-gray-700\">\n              {data?.total_records_analyzed || 0}\n            </span>\n          </span>\n          <span>\n            Model:{\" \"}\n            <span\n              className={`font-medium ${data?.model_trained ? \"text-green-600\" : \"text-gray-500\"}`}\n            >\n              {data?.model_trained ? \"Trained\" : \"Not trained\"}\n            </span>\n          </span>\n        </div>\n        {data?.analysis_timestamp && (\n          <span title={data.analysis_timestamp}>\n            {formatTimestamp(data.analysis_timestamp)}\n          </span>\n        )}\n      </div>\n    </div>\n  );\n}\n\nexport default AnomalyWidget;\n",
        "timestamp": "2026-01-03T18:35:24.567548"
      },
      "worktree_state": {
        "content": "/**\n * AnomalyWidget Component\n *\n * Displays detected anomalies in governance metrics including:\n * - Unusual patterns in violations, user activity, or policy changes\n * - Severity scores and labels for each anomaly\n * - Affected metrics details\n */\n\nimport { useCallback, useEffect, useState } from \"react\";\nimport {\n  AlertCircle,\n  AlertTriangle,\n  CheckCircle2,\n  RefreshCw,\n  Shield,\n  XOctagon,\n} from \"lucide-react\";\nimport { LoadingState, API_BASE_URL } from \"../../lib\";\n\n/** Anomaly data structure from the API */\ninterface AnomalyItem {\n  anomaly_id: string;\n  timestamp: string;\n  severity_score: number;\n  severity_label: \"critical\" | \"high\" | \"medium\" | \"low\";\n  affected_metrics: Record<string, number | string>;\n  description: string;\n}\n\n/** Anomalies response from the API */\ninterface AnomaliesResponse {\n  analysis_timestamp: string;\n  total_records_analyzed: number;\n  anomalies_detected: number;\n  contamination_rate: number;\n  anomalies: AnomalyItem[];\n  model_trained: boolean;\n}\n\n/**\n * Gets the appropriate icon for a severity level\n */\nfunction getSeverityIcon(severity: AnomalyItem[\"severity_label\"]): JSX.Element {\n  switch (severity) {\n    case \"critical\":\n      return <XOctagon className=\"h-4 w-4 text-red-600\" />;\n    case \"high\":\n      return <AlertTriangle className=\"h-4 w-4 text-orange-600\" />;\n    case \"medium\":\n      return <AlertCircle className=\"h-4 w-4 text-yellow-600\" />;\n    case \"low\":\n      return <CheckCircle2 className=\"h-4 w-4 text-blue-600\" />;\n    default:\n      return <AlertCircle className=\"h-4 w-4 text-gray-600\" />;\n  }\n}\n\n/**\n * Gets the color classes for a severity level\n */\nfunction getSeverityColors(severity: AnomalyItem[\"severity_label\"]): {\n  bg: string;\n  border: string;\n  text: string;\n  badge: string;\n} {\n  switch (severity) {\n    case \"critical\":\n      return {\n        bg: \"bg-red-50\",\n        border: \"border-red-200\",\n        text: \"text-red-800\",\n        badge: \"bg-red-100 text-red-800\",\n      };\n    case \"high\":\n      return {\n        bg: \"bg-orange-50\",\n        border: \"border-orange-200\",\n        text: \"text-orange-800\",\n        badge: \"bg-orange-100 text-orange-800\",\n      };\n    case \"medium\":\n      return {\n        bg: \"bg-yellow-50\",\n        border: \"border-yellow-200\",\n        text: \"text-yellow-800\",\n        badge: \"bg-yellow-100 text-yellow-800\",\n      };\n    case \"low\":\n      return {\n        bg: \"bg-blue-50\",\n        border: \"border-blue-200\",\n        text: \"text-blue-800\",\n        badge: \"bg-blue-100 text-blue-800\",\n      };\n    default:\n      return {\n        bg: \"bg-gray-50\",\n        border: \"border-gray-200\",\n        text: \"text-gray-800\",\n        badge: \"bg-gray-100 text-gray-800\",\n      };\n  }\n}\n\n/**\n * Formats the timestamp for display\n */\nfunction formatTimestamp(timestamp: string): string {\n  try {\n    const date = new Date(timestamp);\n    return date.toLocaleString(undefined, {\n      dateStyle: \"short\",\n      timeStyle: \"short\",\n    });\n  } catch {\n    return \"Unknown\";\n  }\n}\n\n/**\n * Formats affected metrics for display\n */\nfunction formatAffectedMetrics(\n  metrics: Record<string, number | string>\n): string[] {\n  return Object.entries(metrics).map(([key, value]) => {\n    const formattedKey = key.replace(/_/g, \" \");\n    return `${formattedKey}: ${value}`;\n  });\n}\n\n/**\n * AnomalyWidget - Displays detected anomalies in governance metrics\n *\n * Features:\n * - Fetches anomalies from the analytics API\n * - Shows loading, error, and success states\n * - Displays anomalies grouped by severity\n * - Supports severity filtering\n * - Shows affected metrics for each anomaly\n */\nexport function AnomalyWidget(): JSX.Element {\n  const [data, setData] = useState<AnomaliesResponse | null>(null);\n  const [loadingState, setLoadingState] = useState<LoadingState>(\"idle\");\n  const [error, setError] = useState<string | null>(null);\n  const [severityFilter, setSeverityFilter] = useState<string | null>(null);\n\n  /**\n   * Fetches anomaly data from the API\n   */\n  const fetchAnomalies = useCallback(async () => {\n    setLoadingState(\"loading\");\n    setError(null);\n\n    try {\n      const url = new URL(`${API_BASE_URL}/anomalies`);\n      if (severityFilter) {\n        url.searchParams.set(\"severity\", severityFilter);\n      }\n\n      const response = await fetch(url.toString(), {\n        method: \"GET\",\n        headers: {\n          Accept: \"application/json\",\n        },\n      });\n\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}));\n        throw new Error(\n          errorData.detail || `Failed to fetch anomalies: ${response.status}`\n        );\n      }\n\n      const responseData: AnomaliesResponse = await response.json();\n      setData(responseData);\n      setLoadingState(\"success\");\n    } catch (err) {\n      const message =\n        err instanceof Error ? err.message : \"Failed to load anomalies\";\n      setError(message);\n      setLoadingState(\"error\");\n    }\n  }, [severityFilter]);\n\n  // Fetch anomalies on mount and when filter changes\n  useEffect(() => {\n    fetchAnomalies();\n  }, [fetchAnomalies]);\n\n  /**\n   * Handle refresh button click\n   */\n  const handleRefresh = () => {\n    fetchAnomalies();\n  };\n\n  /**\n   * Handle severity filter change\n   */\n  const handleFilterChange = (severity: string | null) => {\n    setSeverityFilter(severity);\n  };\n\n  // Loading state\n  if (loadingState === \"loading\" && !data) {\n    return (\n      <div className=\"h-full rounded-lg bg-white p-4 shadow\">\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-2\">\n            <Shield className=\"h-5 w-5 text-amber-600\" />\n            <h3 className=\"text-lg font-semibold text-gray-900\">\n              Anomaly Detection\n            </h3>\n          </div>\n        </div>\n        <div className=\"mt-4 space-y-3\">\n          <div className=\"h-4 w-3/4 animate-pulse rounded bg-gray-200\" />\n          <div className=\"h-4 w-full animate-pulse rounded bg-gray-200\" />\n          <div className=\"h-4 w-5/6 animate-pulse rounded bg-gray-200\" />\n        </div>\n      </div>\n    );\n  }\n\n  // Error state\n  if (loadingState === \"error\") {\n    return (\n      <div className=\"h-full rounded-lg bg-white p-4 shadow\">\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-2\">\n            <Shield className=\"h-5 w-5 text-amber-600\" />\n            <h3 className=\"text-lg font-semibold text-gray-900\">\n              Anomaly Detection\n            </h3>\n          </div>\n          <button\n            onClick={handleRefresh}\n            className=\"rounded p-1 text-gray-400 transition-colors hover:bg-gray-100 hover:text-gray-600\"\n            title=\"Retry\"\n            aria-label=\"Retry loading anomalies\"\n          >\n            <RefreshCw className=\"h-4 w-4\" />\n          </button>\n        </div>\n        <div className=\"mt-4 flex flex-col items-center justify-center py-8\">\n          <AlertCircle className=\"h-8 w-8 text-red-500\" />\n          <p className=\"mt-2 text-center text-sm text-red-600\">{error}</p>\n          <button\n            onClick={handleRefresh}\n            className=\"mt-4 rounded-md bg-red-50 px-4 py-2 text-sm font-medium text-red-700 transition-colors hover:bg-red-100\"\n          >\n            Try Again\n          </button>\n        </div>\n      </div>\n    );\n  }\n\n  // No anomalies state\n  if (data && data.anomalies.length === 0) {\n    return (\n      <div className=\"flex h-full flex-col rounded-lg bg-white p-4 shadow\">\n        {/* Header */}\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-2\">\n            <Shield className=\"h-5 w-5 text-amber-600\" />\n            <h3 className=\"text-lg font-semibold text-gray-900\">\n              Anomaly Detection\n            </h3>\n          </div>\n          <button\n            onClick={handleRefresh}\n            disabled={loadingState === \"loading\"}\n            className=\"rounded p-1 text-gray-400 transition-colors hover:bg-gray-100 hover:text-gray-600 disabled:cursor-not-allowed disabled:opacity-50\"\n            title=\"Refresh anomalies\"\n            aria-label=\"Refresh anomalies\"\n          >\n            <RefreshCw\n              className={`h-4 w-4 ${loadingState === \"loading\" ? \"animate-spin\" : \"\"}`}\n            />\n          </button>\n        </div>\n\n        {/* Empty state */}\n        <div className=\"flex flex-1 flex-col items-center justify-center py-8\">\n          <CheckCircle2 className=\"h-12 w-12 text-green-500\" />\n          <p className=\"mt-3 text-lg font-medium text-gray-900\">\n            No Anomalies Detected\n          </p>\n          <p className=\"mt-1 text-center text-sm text-gray-500\">\n            {data.total_records_analyzed} records analyzed\n          </p>\n          <p className=\"text-center text-xs text-gray-400\">\n            Last checked: {formatTimestamp(data.analysis_timestamp)}\n          </p>\n        </div>\n      </div>\n    );\n  }\n\n  // Success state with anomaly data\n  return (\n    <div className=\"flex h-full flex-col rounded-lg bg-white p-4 shadow\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-2\">\n          <Shield className=\"h-5 w-5 text-amber-600\" />\n          <h3 className=\"text-lg font-semibold text-gray-900\">\n            Anomaly Detection\n          </h3>\n          {data && data.anomalies_detected > 0 && (\n            <span className=\"rounded-full bg-amber-100 px-2 py-0.5 text-xs font-medium text-amber-800\">\n              {data.anomalies_detected} found\n            </span>\n          )}\n        </div>\n        <button\n          onClick={handleRefresh}\n          disabled={loadingState === \"loading\"}\n          className=\"rounded p-1 text-gray-400 transition-colors hover:bg-gray-100 hover:text-gray-600 disabled:cursor-not-allowed disabled:opacity-50\"\n          title=\"Refresh anomalies\"\n          aria-label=\"Refresh anomalies\"\n        >\n          <RefreshCw\n            className={`h-4 w-4 ${loadingState === \"loading\" ? \"animate-spin\" : \"\"}`}\n          />\n        </button>\n      </div>\n\n      {/* Severity Filter */}\n      <div className=\"mt-3 flex flex-wrap gap-1\">\n        <button\n          onClick={() => handleFilterChange(null)}\n          className={`rounded-full px-2.5 py-0.5 text-xs font-medium transition-colors ${\n            severityFilter === null\n              ? \"bg-gray-800 text-white\"\n              : \"bg-gray-100 text-gray-600 hover:bg-gray-200\"\n          }`}\n        >\n          All\n        </button>\n        {([\"critical\", \"high\", \"medium\", \"low\"] as const).map((level) => {\n          const colors = getSeverityColors(level);\n          return (\n            <button\n              key={level}\n              onClick={() => handleFilterChange(level)}\n              className={`rounded-full px-2.5 py-0.5 text-xs font-medium capitalize transition-colors ${\n                severityFilter === level\n                  ? colors.badge\n                  : \"bg-gray-100 text-gray-600 hover:bg-gray-200\"\n              }`}\n            >\n              {level}\n            </button>\n          );\n        })}\n      </div>\n\n      {/* Anomalies List */}\n      <div className=\"mt-4 flex-1 space-y-3 overflow-y-auto\">\n        {data?.anomalies.map((anomaly) => {\n          const colors = getSeverityColors(anomaly.severity_label);\n          const affectedMetrics = formatAffectedMetrics(\n            anomaly.affected_metrics\n          );\n\n          return (\n            <div\n              key={anomaly.anomaly_id}\n              className={`rounded-lg border p-3 ${colors.bg} ${colors.border}`}\n            >\n              {/* Anomaly Header */}\n              <div className=\"flex items-start justify-between gap-2\">\n                <div className=\"flex items-center gap-2\">\n                  {getSeverityIcon(anomaly.severity_label)}\n                  <span\n                    className={`rounded px-1.5 py-0.5 text-xs font-semibold uppercase ${colors.badge}`}\n                  >\n                    {anomaly.severity_label}\n                  </span>\n                </div>\n                <span className=\"text-xs text-gray-500\">\n                  {formatTimestamp(anomaly.timestamp)}\n                </span>\n              </div>\n\n              {/* Description */}\n              <p className={`mt-2 text-sm ${colors.text}`}>\n                {anomaly.description || \"Unusual pattern detected in governance metrics\"}\n              </p>\n\n              {/* Affected Metrics */}\n              {affectedMetrics.length > 0 && (\n                <div className=\"mt-2 flex flex-wrap gap-1\">\n                  {affectedMetrics.map((metric, index) => (\n                    <span\n                      key={index}\n                      className=\"rounded bg-white bg-opacity-60 px-1.5 py-0.5 text-xs text-gray-700\"\n                    >\n                      {metric}\n                    </span>\n                  ))}\n                </div>\n              )}\n\n              {/* Severity Score */}\n              <div className=\"mt-2 flex items-center gap-2\">\n                <div className=\"h-1.5 flex-1 rounded-full bg-white bg-opacity-50\">\n                  <div\n                    className={`h-1.5 rounded-full ${\n                      anomaly.severity_label === \"critical\"\n                        ? \"bg-red-600\"\n                        : anomaly.severity_label === \"high\"\n                          ? \"bg-orange-600\"\n                          : anomaly.severity_label === \"medium\"\n                            ? \"bg-yellow-600\"\n                            : \"bg-blue-600\"\n                    }`}\n                    style={{\n                      width: `${Math.max(10, Math.abs(anomaly.severity_score) * 100)}%`,\n                    }}\n                  />\n                </div>\n                <span className=\"text-xs text-gray-600\">\n                  {(anomaly.severity_score * 100).toFixed(0)}%\n                </span>\n              </div>\n            </div>\n          );\n        })}\n      </div>\n\n      {/* Footer with metadata */}\n      <div className=\"mt-4 flex items-center justify-between border-t border-gray-100 pt-3 text-xs text-gray-500\">\n        <div className=\"flex items-center gap-4\">\n          <span>\n            Records analyzed:{\" \"}\n            <span className=\"font-medium text-gray-700\">\n              {data?.total_records_analyzed || 0}\n            </span>\n          </span>\n          <span>\n            Model:{\" \"}\n            <span\n              className={`font-medium ${data?.model_trained ? \"text-green-600\" : \"text-gray-500\"}`}\n            >\n              {data?.model_trained ? \"Trained\" : \"Not trained\"}\n            </span>\n          </span>\n        </div>\n        {data?.analysis_timestamp && (\n          <span title={data.analysis_timestamp}>\n            {formatTimestamp(data.analysis_timestamp)}\n          </span>\n        )}\n      </div>\n    </div>\n  );\n}\n\nexport default AnomalyWidget;\n",
        "last_modified": "2026-01-03T19:10:12.019855"
      },
      "task_intent": {
        "title": "054-extract-duplicated-loadingstate-and-api-config-in-",
        "description": "The analytics-dashboard has 4 widget components (PredictionWidget, AnomalyWidget, InsightWidget, QueryInterface) that each independently define the same LoadingState type and API_BASE_URL constant. This pattern is repeated across 7+ files when including tests, leading to maintenance burden and potential inconsistencies.",
        "from_plan": true
      },
      "commits_behind_main": 0,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2026-01-03T18:32:21.778718",
  "last_updated": "2026-01-03T18:35:24.589150"
}