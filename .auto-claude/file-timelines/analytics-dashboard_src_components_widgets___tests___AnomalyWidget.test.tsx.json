{
  "file_path": "analytics-dashboard/src/components/widgets/__tests__/AnomalyWidget.test.tsx",
  "main_branch_history": [],
  "task_views": {
    "054-extract-duplicated-loadingstate-and-api-config-in-": {
      "task_id": "054-extract-duplicated-loadingstate-and-api-config-in-",
      "branch_point": {
        "commit_hash": "4a99fe22e8e0087919301b1aa185d4e2c6da716c",
        "content": "/**\n * AnomalyWidget Component Tests\n *\n * Tests for the AnomalyWidget component including:\n * - Initial loading state\n * - Displaying detected anomalies\n * - Severity filtering\n * - Empty state handling\n * - Error handling and retry\n * - Integration with analytics-api /anomalies endpoint\n */\n\nimport { describe, it, expect } from \"vitest\";\nimport { render, screen, waitFor, fireEvent } from \"@testing-library/react\";\nimport { http, HttpResponse } from \"msw\";\nimport { server } from \"../../../test/mocks/server\";\nimport { errorHandlers } from \"../../../test/mocks/handlers\";\nimport { AnomalyWidget } from \"../AnomalyWidget\";\n\nconst API_BASE_URL = \"http://localhost:8080\";\n\ndescribe(\"AnomalyWidget\", () => {\n  describe(\"Loading State\", () => {\n    it(\"shows loading skeleton on initial render\", async () => {\n      render(<AnomalyWidget />);\n\n      // Should show Anomaly Detection header during loading\n      expect(screen.getByText(\"Anomaly Detection\")).toBeInTheDocument();\n\n      // Should have loading animation elements\n      const loadingElements = document.querySelectorAll(\".animate-pulse\");\n      expect(loadingElements.length).toBeGreaterThan(0);\n    });\n  });\n\n  describe(\"Successful API Integration\", () => {\n    it(\"displays anomalies from /anomalies endpoint\", async () => {\n      render(<AnomalyWidget />);\n\n      await waitFor(() => {\n        expect(\n          screen.getByText(\"Unusual spike in policy violations detected\")\n        ).toBeInTheDocument();\n      });\n\n      // Should show all three anomalies\n      expect(\n        screen.getByText(\"Moderate increase in access control violations\")\n      ).toBeInTheDocument();\n      expect(\n        screen.getByText(\"Minor anomaly in user activity patterns\")\n      ).toBeInTheDocument();\n    });\n\n    it(\"displays anomaly count badge\", async () => {\n      render(<AnomalyWidget />);\n\n      await waitFor(() => {\n        expect(screen.getByText(\"3 found\")).toBeInTheDocument();\n      });\n    });\n\n    it(\"displays severity labels with correct styling\", async () => {\n      render(<AnomalyWidget />);\n\n      await waitFor(() => {\n        expect(screen.getByText(\"CRITICAL\")).toBeInTheDocument();\n      });\n\n      expect(screen.getByText(\"MEDIUM\")).toBeInTheDocument();\n      expect(screen.getByText(\"LOW\")).toBeInTheDocument();\n    });\n\n    it(\"displays affected metrics for each anomaly\", async () => {\n      render(<AnomalyWidget />);\n\n      await waitFor(() => {\n        // Check for affected metrics from the first anomaly\n        expect(screen.getByText(/violation count: 45/i)).toBeInTheDocument();\n        expect(screen.getByText(/user count: 12/i)).toBeInTheDocument();\n      });\n    });\n\n    it(\"displays analysis metadata in footer\", async () => {\n      render(<AnomalyWidget />);\n\n      await waitFor(() => {\n        expect(\n          screen.getByText(/Records analyzed:/)\n        ).toBeInTheDocument();\n        expect(screen.getByText(\"150\")).toBeInTheDocument();\n        expect(screen.getByText(\"Trained\")).toBeInTheDocument();\n      });\n    });\n  });\n\n  describe(\"Severity Filtering\", () => {\n    it(\"shows all severity filter buttons\", async () => {\n      render(<AnomalyWidget />);\n\n      await waitFor(() => {\n        expect(\n          screen.getByRole(\"button\", { name: \"All\" })\n        ).toBeInTheDocument();\n      });\n\n      expect(\n        screen.getByRole(\"button\", { name: \"critical\" })\n      ).toBeInTheDocument();\n      expect(\n        screen.getByRole(\"button\", { name: \"high\" })\n      ).toBeInTheDocument();\n      expect(\n        screen.getByRole(\"button\", { name: \"medium\" })\n      ).toBeInTheDocument();\n      expect(screen.getByRole(\"button\", { name: \"low\" })).toBeInTheDocument();\n    });\n\n    it(\"filters anomalies by severity when filter is clicked\", async () => {\n      render(<AnomalyWidget />);\n\n      await waitFor(() => {\n        expect(screen.getByText(\"3 found\")).toBeInTheDocument();\n      });\n\n      // Click on \"critical\" filter\n      fireEvent.click(screen.getByRole(\"button\", { name: \"critical\" }));\n\n      // Wait for filtered results\n      await waitFor(() => {\n        // Should only show critical anomaly\n        expect(\n          screen.getByText(\"Unusual spike in policy violations detected\")\n        ).toBeInTheDocument();\n      });\n\n      // Other anomalies should not be visible\n      expect(\n        screen.queryByText(\"Moderate increase in access control violations\")\n      ).not.toBeInTheDocument();\n    });\n  });\n\n  describe(\"Empty State\", () => {\n    it(\"shows no anomalies message when none detected\", async () => {\n      // Override handler to return empty anomalies\n      server.use(\n        http.get(`${API_BASE_URL}/anomalies`, () => {\n          return HttpResponse.json({\n            analysis_timestamp: new Date().toISOString(),\n            total_records_analyzed: 100,\n            anomalies_detected: 0,\n            contamination_rate: 0.1,\n            model_trained: true,\n            anomalies: [],\n          });\n        })\n      );\n\n      render(<AnomalyWidget />);\n\n      await waitFor(() => {\n        expect(screen.getByText(\"No Anomalies Detected\")).toBeInTheDocument();\n      });\n\n      expect(screen.getByText(\"100 records analyzed\")).toBeInTheDocument();\n    });\n  });\n\n  describe(\"Error Handling\", () => {\n    it(\"displays error message when API fails\", async () => {\n      server.use(errorHandlers.anomaliesError);\n\n      render(<AnomalyWidget />);\n\n      await waitFor(() => {\n        expect(\n          screen.getByText(/Anomaly detection service unavailable/)\n        ).toBeInTheDocument();\n      });\n\n      expect(screen.getByText(\"Try Again\")).toBeInTheDocument();\n    });\n\n    it(\"retries fetch when Try Again is clicked\", async () => {\n      server.use(errorHandlers.anomaliesError);\n\n      render(<AnomalyWidget />);\n\n      await waitFor(() => {\n        expect(screen.getByText(\"Try Again\")).toBeInTheDocument();\n      });\n\n      // Reset handlers\n      server.resetHandlers();\n\n      // Click retry\n      fireEvent.click(screen.getByText(\"Try Again\"));\n\n      await waitFor(\n        () => {\n          expect(screen.getByText(\"3 found\")).toBeInTheDocument();\n        },\n        { timeout: 5000 }\n      );\n    });\n  });\n\n  describe(\"Refresh Functionality\", () => {\n    it(\"has a refresh button that reloads data\", async () => {\n      render(<AnomalyWidget />);\n\n      await waitFor(() => {\n        expect(screen.getByText(\"3 found\")).toBeInTheDocument();\n      });\n\n      const refreshButton = screen.getByRole(\"button\", {\n        name: /refresh anomalies/i,\n      });\n      expect(refreshButton).toBeInTheDocument();\n\n      fireEvent.click(refreshButton);\n\n      await waitFor(() => {\n        expect(refreshButton).toBeEnabled();\n      });\n    });\n  });\n\n  describe(\"Accessibility\", () => {\n    it(\"has accessible button labels\", async () => {\n      render(<AnomalyWidget />);\n\n      await waitFor(() => {\n        expect(screen.getByText(\"3 found\")).toBeInTheDocument();\n      });\n\n      expect(\n        screen.getByRole(\"button\", { name: /refresh anomalies/i })\n      ).toBeInTheDocument();\n    });\n\n    it(\"has proper heading structure\", async () => {\n      render(<AnomalyWidget />);\n\n      await waitFor(() => {\n        expect(screen.getByRole(\"heading\", { level: 3 })).toHaveTextContent(\n          \"Anomaly Detection\"\n        );\n      });\n    });\n  });\n});\n",
        "timestamp": "2026-01-03T18:35:24.567548"
      },
      "worktree_state": {
        "content": "/**\n * AnomalyWidget Component Tests\n *\n * Tests for the AnomalyWidget component including:\n * - Initial loading state\n * - Displaying detected anomalies\n * - Severity filtering\n * - Empty state handling\n * - Error handling and retry\n * - Integration with analytics-api /anomalies endpoint\n */\n\nimport { describe, it, expect } from \"vitest\";\nimport { render, screen, waitFor, fireEvent } from \"@testing-library/react\";\nimport { http, HttpResponse } from \"msw\";\nimport { server } from \"../../../test/mocks/server\";\nimport { errorHandlers } from \"../../../test/mocks/handlers\";\nimport { AnomalyWidget } from \"../AnomalyWidget\";\nimport { API_BASE_URL } from \"../../../lib\";\n\ndescribe(\"AnomalyWidget\", () => {\n  describe(\"Loading State\", () => {\n    it(\"shows loading skeleton on initial render\", async () => {\n      render(<AnomalyWidget />);\n\n      // Should show Anomaly Detection header during loading\n      expect(screen.getByText(\"Anomaly Detection\")).toBeInTheDocument();\n\n      // Should have loading animation elements\n      const loadingElements = document.querySelectorAll(\".animate-pulse\");\n      expect(loadingElements.length).toBeGreaterThan(0);\n    });\n  });\n\n  describe(\"Successful API Integration\", () => {\n    it(\"displays anomalies from /anomalies endpoint\", async () => {\n      render(<AnomalyWidget />);\n\n      await waitFor(() => {\n        expect(\n          screen.getByText(\"Unusual spike in policy violations detected\")\n        ).toBeInTheDocument();\n      });\n\n      // Should show all three anomalies\n      expect(\n        screen.getByText(\"Moderate increase in access control violations\")\n      ).toBeInTheDocument();\n      expect(\n        screen.getByText(\"Minor anomaly in user activity patterns\")\n      ).toBeInTheDocument();\n    });\n\n    it(\"displays anomaly count badge\", async () => {\n      render(<AnomalyWidget />);\n\n      await waitFor(() => {\n        expect(screen.getByText(\"3 found\")).toBeInTheDocument();\n      });\n    });\n\n    it(\"displays severity labels with correct styling\", async () => {\n      render(<AnomalyWidget />);\n\n      await waitFor(() => {\n        expect(screen.getByText(\"CRITICAL\")).toBeInTheDocument();\n      });\n\n      expect(screen.getByText(\"MEDIUM\")).toBeInTheDocument();\n      expect(screen.getByText(\"LOW\")).toBeInTheDocument();\n    });\n\n    it(\"displays affected metrics for each anomaly\", async () => {\n      render(<AnomalyWidget />);\n\n      await waitFor(() => {\n        // Check for affected metrics from the first anomaly\n        expect(screen.getByText(/violation count: 45/i)).toBeInTheDocument();\n        expect(screen.getByText(/user count: 12/i)).toBeInTheDocument();\n      });\n    });\n\n    it(\"displays analysis metadata in footer\", async () => {\n      render(<AnomalyWidget />);\n\n      await waitFor(() => {\n        expect(\n          screen.getByText(/Records analyzed:/)\n        ).toBeInTheDocument();\n        expect(screen.getByText(\"150\")).toBeInTheDocument();\n        expect(screen.getByText(\"Trained\")).toBeInTheDocument();\n      });\n    });\n  });\n\n  describe(\"Severity Filtering\", () => {\n    it(\"shows all severity filter buttons\", async () => {\n      render(<AnomalyWidget />);\n\n      await waitFor(() => {\n        expect(\n          screen.getByRole(\"button\", { name: \"All\" })\n        ).toBeInTheDocument();\n      });\n\n      expect(\n        screen.getByRole(\"button\", { name: \"critical\" })\n      ).toBeInTheDocument();\n      expect(\n        screen.getByRole(\"button\", { name: \"high\" })\n      ).toBeInTheDocument();\n      expect(\n        screen.getByRole(\"button\", { name: \"medium\" })\n      ).toBeInTheDocument();\n      expect(screen.getByRole(\"button\", { name: \"low\" })).toBeInTheDocument();\n    });\n\n    it(\"filters anomalies by severity when filter is clicked\", async () => {\n      render(<AnomalyWidget />);\n\n      await waitFor(() => {\n        expect(screen.getByText(\"3 found\")).toBeInTheDocument();\n      });\n\n      // Click on \"critical\" filter\n      fireEvent.click(screen.getByRole(\"button\", { name: \"critical\" }));\n\n      // Wait for filtered results\n      await waitFor(() => {\n        // Should only show critical anomaly\n        expect(\n          screen.getByText(\"Unusual spike in policy violations detected\")\n        ).toBeInTheDocument();\n      });\n\n      // Other anomalies should not be visible\n      expect(\n        screen.queryByText(\"Moderate increase in access control violations\")\n      ).not.toBeInTheDocument();\n    });\n  });\n\n  describe(\"Empty State\", () => {\n    it(\"shows no anomalies message when none detected\", async () => {\n      // Override handler to return empty anomalies\n      server.use(\n        http.get(`${API_BASE_URL}/anomalies`, () => {\n          return HttpResponse.json({\n            analysis_timestamp: new Date().toISOString(),\n            total_records_analyzed: 100,\n            anomalies_detected: 0,\n            contamination_rate: 0.1,\n            model_trained: true,\n            anomalies: [],\n          });\n        })\n      );\n\n      render(<AnomalyWidget />);\n\n      await waitFor(() => {\n        expect(screen.getByText(\"No Anomalies Detected\")).toBeInTheDocument();\n      });\n\n      expect(screen.getByText(\"100 records analyzed\")).toBeInTheDocument();\n    });\n  });\n\n  describe(\"Error Handling\", () => {\n    it(\"displays error message when API fails\", async () => {\n      server.use(errorHandlers.anomaliesError);\n\n      render(<AnomalyWidget />);\n\n      await waitFor(() => {\n        expect(\n          screen.getByText(/Anomaly detection service unavailable/)\n        ).toBeInTheDocument();\n      });\n\n      expect(screen.getByText(\"Try Again\")).toBeInTheDocument();\n    });\n\n    it(\"retries fetch when Try Again is clicked\", async () => {\n      server.use(errorHandlers.anomaliesError);\n\n      render(<AnomalyWidget />);\n\n      await waitFor(() => {\n        expect(screen.getByText(\"Try Again\")).toBeInTheDocument();\n      });\n\n      // Reset handlers\n      server.resetHandlers();\n\n      // Click retry\n      fireEvent.click(screen.getByText(\"Try Again\"));\n\n      await waitFor(\n        () => {\n          expect(screen.getByText(\"3 found\")).toBeInTheDocument();\n        },\n        { timeout: 5000 }\n      );\n    });\n  });\n\n  describe(\"Refresh Functionality\", () => {\n    it(\"has a refresh button that reloads data\", async () => {\n      render(<AnomalyWidget />);\n\n      await waitFor(() => {\n        expect(screen.getByText(\"3 found\")).toBeInTheDocument();\n      });\n\n      const refreshButton = screen.getByRole(\"button\", {\n        name: /refresh anomalies/i,\n      });\n      expect(refreshButton).toBeInTheDocument();\n\n      fireEvent.click(refreshButton);\n\n      await waitFor(() => {\n        expect(refreshButton).toBeEnabled();\n      });\n    });\n  });\n\n  describe(\"Accessibility\", () => {\n    it(\"has accessible button labels\", async () => {\n      render(<AnomalyWidget />);\n\n      await waitFor(() => {\n        expect(screen.getByText(\"3 found\")).toBeInTheDocument();\n      });\n\n      expect(\n        screen.getByRole(\"button\", { name: /refresh anomalies/i })\n      ).toBeInTheDocument();\n    });\n\n    it(\"has proper heading structure\", async () => {\n      render(<AnomalyWidget />);\n\n      await waitFor(() => {\n        expect(screen.getByRole(\"heading\", { level: 3 })).toHaveTextContent(\n          \"Anomaly Detection\"\n        );\n      });\n    });\n  });\n});\n",
        "last_modified": "2026-01-03T19:10:12.021327"
      },
      "task_intent": {
        "title": "054-extract-duplicated-loadingstate-and-api-config-in-",
        "description": "The analytics-dashboard has 4 widget components (PredictionWidget, AnomalyWidget, InsightWidget, QueryInterface) that each independently define the same LoadingState type and API_BASE_URL constant. This pattern is repeated across 7+ files when including tests, leading to maintenance burden and potential inconsistencies.",
        "from_plan": true
      },
      "commits_behind_main": 0,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2026-01-03T18:35:24.594126",
  "last_updated": "2026-01-03T18:35:24.595931"
}