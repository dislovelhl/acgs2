{
  "file_path": "analytics-dashboard/src/components/__tests__/QueryInterface.test.tsx",
  "main_branch_history": [],
  "task_views": {
    "054-extract-duplicated-loadingstate-and-api-config-in-": {
      "task_id": "054-extract-duplicated-loadingstate-and-api-config-in-",
      "branch_point": {
        "commit_hash": "4a99fe22e8e0087919301b1aa185d4e2c6da716c",
        "content": "/**\n * QueryInterface Component Tests\n *\n * Tests for the QueryInterface component including:\n * - Natural language query input\n * - Query submission and response display\n * - Sample query suggestions\n * - Query history tracking\n * - Error handling\n * - Integration with analytics-api /query endpoint\n */\n\nimport { describe, it, expect } from \"vitest\";\nimport {\n  render,\n  screen,\n  waitFor,\n  fireEvent,\n} from \"@testing-library/react\";\nimport userEvent from \"@testing-library/user-event\";\nimport { http, HttpResponse } from \"msw\";\nimport { server } from \"../../test/mocks/server\";\nimport { errorHandlers } from \"../../test/mocks/handlers\";\nimport { QueryInterface } from \"../QueryInterface\";\n\nconst API_BASE_URL = \"http://localhost:8080\";\n\ndescribe(\"QueryInterface\", () => {\n  describe(\"Initial Render\", () => {\n    it(\"renders header and input field\", () => {\n      render(<QueryInterface />);\n\n      expect(screen.getByText(\"Ask About Governance\")).toBeInTheDocument();\n      expect(\n        screen.getByPlaceholderText(/Ask a question about governance data/i)\n      ).toBeInTheDocument();\n    });\n\n    it(\"shows sample query suggestions\", () => {\n      render(<QueryInterface />);\n\n      expect(screen.getByText(\"Try asking:\")).toBeInTheDocument();\n      expect(\n        screen.getByText(\"Show violations this week\")\n      ).toBeInTheDocument();\n      expect(\n        screen.getByText(\"Which policy is violated most?\")\n      ).toBeInTheDocument();\n    });\n\n    it(\"has a submit button\", () => {\n      render(<QueryInterface />);\n\n      expect(screen.getByRole(\"button\", { name: /ask/i })).toBeInTheDocument();\n    });\n  });\n\n  describe(\"Query Input\", () => {\n    it(\"updates input value when typing\", async () => {\n      const user = userEvent.setup();\n      render(<QueryInterface />);\n\n      const input = screen.getByPlaceholderText(\n        /Ask a question about governance data/i\n      );\n      await user.type(input, \"How many violations today?\");\n\n      expect(input).toHaveValue(\"How many violations today?\");\n    });\n\n    it(\"submits query on form submission\", async () => {\n      const user = userEvent.setup();\n      render(<QueryInterface />);\n\n      const input = screen.getByPlaceholderText(\n        /Ask a question about governance data/i\n      );\n      await user.type(input, \"Show violations this week\");\n\n      const submitButton = screen.getByRole(\"button\", { name: /ask/i });\n      await user.click(submitButton);\n\n      // Wait for response\n      await waitFor(() => {\n        expect(screen.getByText(\"Answer\")).toBeInTheDocument();\n      });\n    });\n\n    it(\"disables submit button when input is empty\", () => {\n      render(<QueryInterface />);\n\n      const submitButton = screen.getByRole(\"button\", { name: /ask/i });\n      expect(submitButton).toBeDisabled();\n    });\n\n    it(\"enables submit button when input has text\", async () => {\n      const user = userEvent.setup();\n      render(<QueryInterface />);\n\n      const input = screen.getByPlaceholderText(\n        /Ask a question about governance data/i\n      );\n      await user.type(input, \"Test query\");\n\n      const submitButton = screen.getByRole(\"button\", { name: /ask/i });\n      expect(submitButton).toBeEnabled();\n    });\n  });\n\n  describe(\"Sample Queries\", () => {\n    it(\"submits sample query when clicked\", async () => {\n      const user = userEvent.setup();\n      render(<QueryInterface />);\n\n      const sampleQuery = screen.getByText(\"Show violations this week\");\n      await user.click(sampleQuery);\n\n      // Wait for response\n      await waitFor(() => {\n        expect(screen.getByText(\"Answer\")).toBeInTheDocument();\n      });\n    });\n\n    it(\"hides sample queries after submitting\", async () => {\n      const user = userEvent.setup();\n      render(<QueryInterface />);\n\n      const sampleQuery = screen.getByText(\"Show violations this week\");\n      await user.click(sampleQuery);\n\n      await waitFor(() => {\n        expect(screen.queryByText(\"Try asking:\")).not.toBeInTheDocument();\n      });\n    });\n  });\n\n  describe(\"Query Response Display\", () => {\n    it(\"displays answer from API response\", async () => {\n      const user = userEvent.setup();\n      render(<QueryInterface />);\n\n      const input = screen.getByPlaceholderText(\n        /Ask a question about governance data/i\n      );\n      await user.type(input, \"Show violations this week\");\n\n      const submitButton = screen.getByRole(\"button\", { name: /ask/i });\n      await user.click(submitButton);\n\n      await waitFor(() => {\n        expect(\n          screen.getByText(/There were 23 policy violations this week/)\n        ).toBeInTheDocument();\n      });\n    });\n\n    it(\"displays related data from API response\", async () => {\n      const user = userEvent.setup();\n      render(<QueryInterface />);\n\n      const input = screen.getByPlaceholderText(\n        /Ask a question about governance data/i\n      );\n      await user.type(input, \"Show violations this week\");\n\n      const submitButton = screen.getByRole(\"button\", { name: /ask/i });\n      await user.click(submitButton);\n\n      await waitFor(() => {\n        expect(screen.getByText(\"Related Data\")).toBeInTheDocument();\n        expect(screen.getByText(/total violations:/i)).toBeInTheDocument();\n      });\n    });\n\n    it(\"shows warning when query not fully understood\", async () => {\n      server.use(\n        http.post(`${API_BASE_URL}/query`, async ({ request }) => {\n          const body = await request.json();\n          const question =\n            typeof body === \"object\" && body !== null && \"question\" in body\n              ? (body as { question: string }).question\n              : \"\";\n\n          return HttpResponse.json({\n            query: question,\n            answer: \"I could not fully understand your query.\",\n            data: {},\n            query_understood: false,\n            generated_at: new Date().toISOString(),\n          });\n        })\n      );\n\n      const user = userEvent.setup();\n      render(<QueryInterface />);\n\n      const input = screen.getByPlaceholderText(\n        /Ask a question about governance data/i\n      );\n      await user.type(input, \"xyzabc random text\");\n\n      const submitButton = screen.getByRole(\"button\", { name: /ask/i });\n      await user.click(submitButton);\n\n      await waitFor(() => {\n        expect(\n          screen.getByText(/Could not fully understand your query/)\n        ).toBeInTheDocument();\n      });\n    });\n  });\n\n  describe(\"Query History\", () => {\n    it(\"tracks query history\", async () => {\n      const user = userEvent.setup();\n      render(<QueryInterface />);\n\n      // Submit first query\n      const input = screen.getByPlaceholderText(\n        /Ask a question about governance data/i\n      );\n      await user.type(input, \"First query\");\n      await user.click(screen.getByRole(\"button\", { name: /ask/i }));\n\n      await waitFor(() => {\n        expect(screen.getByText(\"Answer\")).toBeInTheDocument();\n      });\n\n      // Click Ask Another Question\n      await user.click(screen.getByText(\"Ask Another Question\"));\n\n      // Submit second query\n      await user.type(input, \"Second query\");\n      await user.click(screen.getByRole(\"button\", { name: /ask/i }));\n\n      await waitFor(() => {\n        expect(screen.getByText(/Recent queries \\(2\\)/)).toBeInTheDocument();\n      });\n    });\n\n    it(\"can restore previous query from history\", async () => {\n      const user = userEvent.setup();\n      render(<QueryInterface />);\n\n      // Submit a query\n      const input = screen.getByPlaceholderText(\n        /Ask a question about governance data/i\n      );\n      await user.type(input, \"Show violations this week\");\n      await user.click(screen.getByRole(\"button\", { name: /ask/i }));\n\n      await waitFor(() => {\n        expect(screen.getByText(\"Answer\")).toBeInTheDocument();\n      });\n\n      // Click Ask Another\n      await user.click(screen.getByText(\"Ask Another Question\"));\n\n      // Expand history\n      const historyToggle = screen.getByText(/Recent queries/);\n      await user.click(historyToggle);\n\n      // Click history item\n      const historyItem = screen.getByText(\"Show violations this week\");\n      await user.click(historyItem);\n\n      // Should restore the response\n      await waitFor(() => {\n        expect(screen.getByText(\"Answer\")).toBeInTheDocument();\n      });\n    });\n  });\n\n  describe(\"Loading State\", () => {\n    it(\"shows loading spinner during query processing\", async () => {\n      const user = userEvent.setup();\n      render(<QueryInterface />);\n\n      const input = screen.getByPlaceholderText(\n        /Ask a question about governance data/i\n      );\n      await user.type(input, \"Test query\");\n      await user.click(screen.getByRole(\"button\", { name: /ask/i }));\n\n      expect(\n        screen.getByText(\"Processing your query...\")\n      ).toBeInTheDocument();\n    });\n\n    it(\"disables submit button during loading\", async () => {\n      const user = userEvent.setup();\n      render(<QueryInterface />);\n\n      const input = screen.getByPlaceholderText(\n        /Ask a question about governance data/i\n      );\n      await user.type(input, \"Test query\");\n\n      const submitButton = screen.getByRole(\"button\", { name: /ask/i });\n      await user.click(submitButton);\n\n      expect(submitButton).toBeDisabled();\n    });\n  });\n\n  describe(\"Error Handling\", () => {\n    it(\"displays error message when query fails\", async () => {\n      server.use(errorHandlers.queryError);\n\n      const user = userEvent.setup();\n      render(<QueryInterface />);\n\n      const input = screen.getByPlaceholderText(\n        /Ask a question about governance data/i\n      );\n      await user.type(input, \"Test query\");\n      await user.click(screen.getByRole(\"button\", { name: /ask/i }));\n\n      await waitFor(() => {\n        expect(screen.getByText(\"Query Failed\")).toBeInTheDocument();\n        expect(\n          screen.getByText(/Query processing failed/)\n        ).toBeInTheDocument();\n      });\n    });\n\n    it(\"shows retry button on error\", async () => {\n      server.use(errorHandlers.queryError);\n\n      const user = userEvent.setup();\n      render(<QueryInterface />);\n\n      const input = screen.getByPlaceholderText(\n        /Ask a question about governance data/i\n      );\n      await user.type(input, \"Test query\");\n      await user.click(screen.getByRole(\"button\", { name: /ask/i }));\n\n      await waitFor(() => {\n        expect(screen.getByText(\"Try Again\")).toBeInTheDocument();\n      });\n    });\n  });\n\n  describe(\"Clear Functionality\", () => {\n    it(\"clears input and response when Ask Another is clicked\", async () => {\n      const user = userEvent.setup();\n      render(<QueryInterface />);\n\n      const input = screen.getByPlaceholderText(\n        /Ask a question about governance data/i\n      );\n      await user.type(input, \"Show violations this week\");\n      await user.click(screen.getByRole(\"button\", { name: /ask/i }));\n\n      await waitFor(() => {\n        expect(screen.getByText(\"Answer\")).toBeInTheDocument();\n      });\n\n      await user.click(screen.getByText(\"Ask Another Question\"));\n\n      // Input should be cleared\n      expect(input).toHaveValue(\"\");\n\n      // Sample queries should be visible again\n      expect(screen.getByText(\"Try asking:\")).toBeInTheDocument();\n    });\n  });\n\n  describe(\"Accessibility\", () => {\n    it(\"has proper label for input field\", () => {\n      render(<QueryInterface />);\n\n      const input = screen.getByRole(\"textbox\", { name: /query input/i });\n      expect(input).toBeInTheDocument();\n    });\n\n    it(\"has accessible submit button\", () => {\n      render(<QueryInterface />);\n\n      expect(\n        screen.getByRole(\"button\", { name: /submit query/i })\n      ).toBeInTheDocument();\n    });\n  });\n});\n",
        "timestamp": "2026-01-03T18:35:24.567548"
      },
      "worktree_state": {
        "content": "/**\n * QueryInterface Component Tests\n *\n * Tests for the QueryInterface component including:\n * - Natural language query input\n * - Query submission and response display\n * - Sample query suggestions\n * - Query history tracking\n * - Error handling\n * - Integration with analytics-api /query endpoint\n */\n\nimport { describe, it, expect } from \"vitest\";\nimport {\n  render,\n  screen,\n  waitFor,\n  fireEvent,\n} from \"@testing-library/react\";\nimport userEvent from \"@testing-library/user-event\";\nimport { http, HttpResponse } from \"msw\";\nimport { server } from \"../../test/mocks/server\";\nimport { errorHandlers } from \"../../test/mocks/handlers\";\nimport { QueryInterface } from \"../QueryInterface\";\nimport { API_BASE_URL } from \"../../lib\";\n\ndescribe(\"QueryInterface\", () => {\n  describe(\"Initial Render\", () => {\n    it(\"renders header and input field\", () => {\n      render(<QueryInterface />);\n\n      expect(screen.getByText(\"Ask About Governance\")).toBeInTheDocument();\n      expect(\n        screen.getByPlaceholderText(/Ask a question about governance data/i)\n      ).toBeInTheDocument();\n    });\n\n    it(\"shows sample query suggestions\", () => {\n      render(<QueryInterface />);\n\n      expect(screen.getByText(\"Try asking:\")).toBeInTheDocument();\n      expect(\n        screen.getByText(\"Show violations this week\")\n      ).toBeInTheDocument();\n      expect(\n        screen.getByText(\"Which policy is violated most?\")\n      ).toBeInTheDocument();\n    });\n\n    it(\"has a submit button\", () => {\n      render(<QueryInterface />);\n\n      expect(screen.getByRole(\"button\", { name: /ask/i })).toBeInTheDocument();\n    });\n  });\n\n  describe(\"Query Input\", () => {\n    it(\"updates input value when typing\", async () => {\n      const user = userEvent.setup();\n      render(<QueryInterface />);\n\n      const input = screen.getByPlaceholderText(\n        /Ask a question about governance data/i\n      );\n      await user.type(input, \"How many violations today?\");\n\n      expect(input).toHaveValue(\"How many violations today?\");\n    });\n\n    it(\"submits query on form submission\", async () => {\n      const user = userEvent.setup();\n      render(<QueryInterface />);\n\n      const input = screen.getByPlaceholderText(\n        /Ask a question about governance data/i\n      );\n      await user.type(input, \"Show violations this week\");\n\n      const submitButton = screen.getByRole(\"button\", { name: /ask/i });\n      await user.click(submitButton);\n\n      // Wait for response\n      await waitFor(() => {\n        expect(screen.getByText(\"Answer\")).toBeInTheDocument();\n      });\n    });\n\n    it(\"disables submit button when input is empty\", () => {\n      render(<QueryInterface />);\n\n      const submitButton = screen.getByRole(\"button\", { name: /ask/i });\n      expect(submitButton).toBeDisabled();\n    });\n\n    it(\"enables submit button when input has text\", async () => {\n      const user = userEvent.setup();\n      render(<QueryInterface />);\n\n      const input = screen.getByPlaceholderText(\n        /Ask a question about governance data/i\n      );\n      await user.type(input, \"Test query\");\n\n      const submitButton = screen.getByRole(\"button\", { name: /ask/i });\n      expect(submitButton).toBeEnabled();\n    });\n  });\n\n  describe(\"Sample Queries\", () => {\n    it(\"submits sample query when clicked\", async () => {\n      const user = userEvent.setup();\n      render(<QueryInterface />);\n\n      const sampleQuery = screen.getByText(\"Show violations this week\");\n      await user.click(sampleQuery);\n\n      // Wait for response\n      await waitFor(() => {\n        expect(screen.getByText(\"Answer\")).toBeInTheDocument();\n      });\n    });\n\n    it(\"hides sample queries after submitting\", async () => {\n      const user = userEvent.setup();\n      render(<QueryInterface />);\n\n      const sampleQuery = screen.getByText(\"Show violations this week\");\n      await user.click(sampleQuery);\n\n      await waitFor(() => {\n        expect(screen.queryByText(\"Try asking:\")).not.toBeInTheDocument();\n      });\n    });\n  });\n\n  describe(\"Query Response Display\", () => {\n    it(\"displays answer from API response\", async () => {\n      const user = userEvent.setup();\n      render(<QueryInterface />);\n\n      const input = screen.getByPlaceholderText(\n        /Ask a question about governance data/i\n      );\n      await user.type(input, \"Show violations this week\");\n\n      const submitButton = screen.getByRole(\"button\", { name: /ask/i });\n      await user.click(submitButton);\n\n      await waitFor(() => {\n        expect(\n          screen.getByText(/There were 23 policy violations this week/)\n        ).toBeInTheDocument();\n      });\n    });\n\n    it(\"displays related data from API response\", async () => {\n      const user = userEvent.setup();\n      render(<QueryInterface />);\n\n      const input = screen.getByPlaceholderText(\n        /Ask a question about governance data/i\n      );\n      await user.type(input, \"Show violations this week\");\n\n      const submitButton = screen.getByRole(\"button\", { name: /ask/i });\n      await user.click(submitButton);\n\n      await waitFor(() => {\n        expect(screen.getByText(\"Related Data\")).toBeInTheDocument();\n        expect(screen.getByText(/total violations:/i)).toBeInTheDocument();\n      });\n    });\n\n    it(\"shows warning when query not fully understood\", async () => {\n      server.use(\n        http.post(`${API_BASE_URL}/query`, async ({ request }) => {\n          const body = await request.json();\n          const question =\n            typeof body === \"object\" && body !== null && \"question\" in body\n              ? (body as { question: string }).question\n              : \"\";\n\n          return HttpResponse.json({\n            query: question,\n            answer: \"I could not fully understand your query.\",\n            data: {},\n            query_understood: false,\n            generated_at: new Date().toISOString(),\n          });\n        })\n      );\n\n      const user = userEvent.setup();\n      render(<QueryInterface />);\n\n      const input = screen.getByPlaceholderText(\n        /Ask a question about governance data/i\n      );\n      await user.type(input, \"xyzabc random text\");\n\n      const submitButton = screen.getByRole(\"button\", { name: /ask/i });\n      await user.click(submitButton);\n\n      await waitFor(() => {\n        expect(\n          screen.getByText(/Could not fully understand your query/)\n        ).toBeInTheDocument();\n      });\n    });\n  });\n\n  describe(\"Query History\", () => {\n    it(\"tracks query history\", async () => {\n      const user = userEvent.setup();\n      render(<QueryInterface />);\n\n      // Submit first query\n      const input = screen.getByPlaceholderText(\n        /Ask a question about governance data/i\n      );\n      await user.type(input, \"First query\");\n      await user.click(screen.getByRole(\"button\", { name: /ask/i }));\n\n      await waitFor(() => {\n        expect(screen.getByText(\"Answer\")).toBeInTheDocument();\n      });\n\n      // Click Ask Another Question\n      await user.click(screen.getByText(\"Ask Another Question\"));\n\n      // Submit second query\n      await user.type(input, \"Second query\");\n      await user.click(screen.getByRole(\"button\", { name: /ask/i }));\n\n      await waitFor(() => {\n        expect(screen.getByText(/Recent queries \\(2\\)/)).toBeInTheDocument();\n      });\n    });\n\n    it(\"can restore previous query from history\", async () => {\n      const user = userEvent.setup();\n      render(<QueryInterface />);\n\n      // Submit a query\n      const input = screen.getByPlaceholderText(\n        /Ask a question about governance data/i\n      );\n      await user.type(input, \"Show violations this week\");\n      await user.click(screen.getByRole(\"button\", { name: /ask/i }));\n\n      await waitFor(() => {\n        expect(screen.getByText(\"Answer\")).toBeInTheDocument();\n      });\n\n      // Click Ask Another\n      await user.click(screen.getByText(\"Ask Another Question\"));\n\n      // Expand history\n      const historyToggle = screen.getByText(/Recent queries/);\n      await user.click(historyToggle);\n\n      // Click history item\n      const historyItem = screen.getByText(\"Show violations this week\");\n      await user.click(historyItem);\n\n      // Should restore the response\n      await waitFor(() => {\n        expect(screen.getByText(\"Answer\")).toBeInTheDocument();\n      });\n    });\n  });\n\n  describe(\"Loading State\", () => {\n    it(\"shows loading spinner during query processing\", async () => {\n      const user = userEvent.setup();\n      render(<QueryInterface />);\n\n      const input = screen.getByPlaceholderText(\n        /Ask a question about governance data/i\n      );\n      await user.type(input, \"Test query\");\n      await user.click(screen.getByRole(\"button\", { name: /ask/i }));\n\n      expect(\n        screen.getByText(\"Processing your query...\")\n      ).toBeInTheDocument();\n    });\n\n    it(\"disables submit button during loading\", async () => {\n      const user = userEvent.setup();\n      render(<QueryInterface />);\n\n      const input = screen.getByPlaceholderText(\n        /Ask a question about governance data/i\n      );\n      await user.type(input, \"Test query\");\n\n      const submitButton = screen.getByRole(\"button\", { name: /ask/i });\n      await user.click(submitButton);\n\n      expect(submitButton).toBeDisabled();\n    });\n  });\n\n  describe(\"Error Handling\", () => {\n    it(\"displays error message when query fails\", async () => {\n      server.use(errorHandlers.queryError);\n\n      const user = userEvent.setup();\n      render(<QueryInterface />);\n\n      const input = screen.getByPlaceholderText(\n        /Ask a question about governance data/i\n      );\n      await user.type(input, \"Test query\");\n      await user.click(screen.getByRole(\"button\", { name: /ask/i }));\n\n      await waitFor(() => {\n        expect(screen.getByText(\"Query Failed\")).toBeInTheDocument();\n        expect(\n          screen.getByText(/Query processing failed/)\n        ).toBeInTheDocument();\n      });\n    });\n\n    it(\"shows retry button on error\", async () => {\n      server.use(errorHandlers.queryError);\n\n      const user = userEvent.setup();\n      render(<QueryInterface />);\n\n      const input = screen.getByPlaceholderText(\n        /Ask a question about governance data/i\n      );\n      await user.type(input, \"Test query\");\n      await user.click(screen.getByRole(\"button\", { name: /ask/i }));\n\n      await waitFor(() => {\n        expect(screen.getByText(\"Try Again\")).toBeInTheDocument();\n      });\n    });\n  });\n\n  describe(\"Clear Functionality\", () => {\n    it(\"clears input and response when Ask Another is clicked\", async () => {\n      const user = userEvent.setup();\n      render(<QueryInterface />);\n\n      const input = screen.getByPlaceholderText(\n        /Ask a question about governance data/i\n      );\n      await user.type(input, \"Show violations this week\");\n      await user.click(screen.getByRole(\"button\", { name: /ask/i }));\n\n      await waitFor(() => {\n        expect(screen.getByText(\"Answer\")).toBeInTheDocument();\n      });\n\n      await user.click(screen.getByText(\"Ask Another Question\"));\n\n      // Input should be cleared\n      expect(input).toHaveValue(\"\");\n\n      // Sample queries should be visible again\n      expect(screen.getByText(\"Try asking:\")).toBeInTheDocument();\n    });\n  });\n\n  describe(\"Accessibility\", () => {\n    it(\"has proper label for input field\", () => {\n      render(<QueryInterface />);\n\n      const input = screen.getByRole(\"textbox\", { name: /query input/i });\n      expect(input).toBeInTheDocument();\n    });\n\n    it(\"has accessible submit button\", () => {\n      render(<QueryInterface />);\n\n      expect(\n        screen.getByRole(\"button\", { name: /submit query/i })\n      ).toBeInTheDocument();\n    });\n  });\n});\n",
        "last_modified": "2026-01-03T19:10:12.019401"
      },
      "task_intent": {
        "title": "054-extract-duplicated-loadingstate-and-api-config-in-",
        "description": "The analytics-dashboard has 4 widget components (PredictionWidget, AnomalyWidget, InsightWidget, QueryInterface) that each independently define the same LoadingState type and API_BASE_URL constant. This pattern is repeated across 7+ files when including tests, leading to maintenance burden and potential inconsistencies.",
        "from_plan": true
      },
      "commits_behind_main": 0,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2026-01-03T18:35:24.584589",
  "last_updated": "2026-01-03T18:35:24.586628"
}