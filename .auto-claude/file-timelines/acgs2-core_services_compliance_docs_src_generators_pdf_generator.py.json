{
  "file_path": "acgs2-core/services/compliance_docs/src/generators/pdf_generator.py",
  "main_branch_history": [],
  "task_views": {
    "056-reduce-excessive-any-type-usage-in-python-codebase": {
      "task_id": "056-reduce-excessive-any-type-usage-in-python-codebase",
      "branch_point": {
        "commit_hash": "fc6e42927298263034acf989773f3200e422ad17",
        "content": "\"\"\"Constitutional Hash: cdd01ef066bc6cf2\nPDF Document Generator for Compliance Documentation Service\n\nGenerates professional compliance reports in PDF format using ReportLab.\nSupports all compliance frameworks: SOC 2, ISO 27001, GDPR, and EU AI Act.\n\nThis module uses SimpleDocTemplate (not Canvas API) for maintainability\nand provides structured document generation with tables, paragraphs,\nand professional styling.\n\"\"\"\n\nimport io\nimport logging\nimport os\nimport tempfile\nfrom datetime import datetime, timezone\nfrom pathlib import Path\nfrom typing import Any, BinaryIO, Optional, Union\n\nfrom reportlab.lib import colors\nfrom reportlab.lib.enums import TA_CENTER, TA_JUSTIFY, TA_LEFT, TA_RIGHT\nfrom reportlab.lib.pagesizes import letter\nfrom reportlab.lib.styles import ParagraphStyle, getSampleStyleSheet\nfrom reportlab.lib.units import inch\nfrom reportlab.platypus import (\n    ListFlowable,\n    ListItem,\n    PageBreak,\n    Paragraph,\n    SimpleDocTemplate,\n    Spacer,\n    Table,\n    TableStyle,\n)\n\nfrom ..models.base import ComplianceFramework\n\nlogger = logging.getLogger(__name__)\n\n\n# Default output path for generated PDFs\n_DEFAULT_OUTPUT_PATH = Path(tempfile.gettempdir()) / \"compliance-reports\"\n\n\ndef _get_output_path() -> Path:\n    \"\"\"\n    Resolve output path from environment or use default.\n\n    Returns:\n        Path to output directory for generated PDFs.\n    \"\"\"\n    output_path = os.getenv(\"COMPLIANCE_OUTPUT_PATH\")\n    if output_path:\n        return Path(output_path)\n    return _DEFAULT_OUTPUT_PATH\n\n\ndef _ensure_output_dir() -> Path:\n    \"\"\"\n    Ensure the output directory exists.\n\n    Returns:\n        Path to the output directory.\n    \"\"\"\n    output_path = _get_output_path()\n    output_path.mkdir(parents=True, exist_ok=True)\n    return output_path\n\n\nclass CompliancePDFStyles:\n    \"\"\"\n    Custom styles for compliance PDF documents.\n\n    Provides professional, consistent styling across all compliance reports.\n    \"\"\"\n\n    def __init__(self) -> None:\n        \"\"\"Initialize custom PDF styles based on sample stylesheet.\"\"\"\n        self._base_styles = getSampleStyleSheet()\n        self._custom_styles: dict[str, ParagraphStyle] = {}\n        self._create_custom_styles()\n\n    def _create_custom_styles(self) -> None:\n        \"\"\"Create custom paragraph styles for compliance documents.\"\"\"\n        # Document Title Style\n        self._custom_styles[\"DocumentTitle\"] = ParagraphStyle(\n            \"DocumentTitle\",\n            parent=self._base_styles[\"Title\"],\n            fontSize=24,\n            spaceAfter=30,\n            alignment=TA_CENTER,\n            textColor=colors.HexColor(\"#1a365d\"),\n        )\n\n        # Section Header Style\n        self._custom_styles[\"SectionHeader\"] = ParagraphStyle(\n            \"SectionHeader\",\n            parent=self._base_styles[\"Heading1\"],\n            fontSize=16,\n            spaceBefore=20,\n            spaceAfter=12,\n            textColor=colors.HexColor(\"#2c5282\"),\n            borderColor=colors.HexColor(\"#4299e1\"),\n            borderWidth=0,\n            borderPadding=0,\n        )\n\n        # Subsection Header Style\n        self._custom_styles[\"SubsectionHeader\"] = ParagraphStyle(\n            \"SubsectionHeader\",\n            parent=self._base_styles[\"Heading2\"],\n            fontSize=14,\n            spaceBefore=15,\n            spaceAfter=8,\n            textColor=colors.HexColor(\"#2d3748\"),\n        )\n\n        # Body Text Style\n        self._custom_styles[\"BodyText\"] = ParagraphStyle(\n            \"BodyText\",\n            parent=self._base_styles[\"Normal\"],\n            fontSize=10,\n            leading=14,\n            alignment=TA_JUSTIFY,\n            spaceBefore=6,\n            spaceAfter=6,\n        )\n\n        # Table Header Style\n        self._custom_styles[\"TableHeader\"] = ParagraphStyle(\n            \"TableHeader\",\n            parent=self._base_styles[\"Normal\"],\n            fontSize=10,\n            textColor=colors.white,\n            alignment=TA_CENTER,\n            fontName=\"Helvetica-Bold\",\n        )\n\n        # Table Cell Style\n        self._custom_styles[\"TableCell\"] = ParagraphStyle(\n            \"TableCell\",\n            parent=self._base_styles[\"Normal\"],\n            fontSize=9,\n            leading=12,\n            alignment=TA_LEFT,\n        )\n\n        # Control ID Style\n        self._custom_styles[\"ControlID\"] = ParagraphStyle(\n            \"ControlID\",\n            parent=self._base_styles[\"Normal\"],\n            fontSize=9,\n            fontName=\"Helvetica-Bold\",\n            textColor=colors.HexColor(\"#4a5568\"),\n        )\n\n        # Status Compliant Style\n        self._custom_styles[\"StatusCompliant\"] = ParagraphStyle(\n            \"StatusCompliant\",\n            parent=self._base_styles[\"Normal\"],\n            fontSize=9,\n            fontName=\"Helvetica-Bold\",\n            textColor=colors.HexColor(\"#276749\"),\n            alignment=TA_CENTER,\n        )\n\n        # Status Non-Compliant Style\n        self._custom_styles[\"StatusNonCompliant\"] = ParagraphStyle(\n            \"StatusNonCompliant\",\n            parent=self._base_styles[\"Normal\"],\n            fontSize=9,\n            fontName=\"Helvetica-Bold\",\n            textColor=colors.HexColor(\"#c53030\"),\n            alignment=TA_CENTER,\n        )\n\n        # Status Pending Style\n        self._custom_styles[\"StatusPending\"] = ParagraphStyle(\n            \"StatusPending\",\n            parent=self._base_styles[\"Normal\"],\n            fontSize=9,\n            fontName=\"Helvetica-Bold\",\n            textColor=colors.HexColor(\"#c05621\"),\n            alignment=TA_CENTER,\n        )\n\n        # Footer Style\n        self._custom_styles[\"Footer\"] = ParagraphStyle(\n            \"Footer\",\n            parent=self._base_styles[\"Normal\"],\n            fontSize=8,\n            textColor=colors.gray,\n            alignment=TA_CENTER,\n        )\n\n        # Confidential Notice Style\n        self._custom_styles[\"Confidential\"] = ParagraphStyle(\n            \"Confidential\",\n            parent=self._base_styles[\"Normal\"],\n            fontSize=10,\n            fontName=\"Helvetica-Bold\",\n            textColor=colors.HexColor(\"#c53030\"),\n            alignment=TA_CENTER,\n            spaceBefore=20,\n        )\n\n        # Metadata Style\n        self._custom_styles[\"Metadata\"] = ParagraphStyle(\n            \"Metadata\",\n            parent=self._base_styles[\"Normal\"],\n            fontSize=10,\n            textColor=colors.HexColor(\"#4a5568\"),\n            alignment=TA_RIGHT,\n        )\n\n    def get_style(self, style_name: str) -> ParagraphStyle:\n        \"\"\"\n        Get a style by name.\n\n        Args:\n            style_name: Name of the style to retrieve.\n\n        Returns:\n            The requested ParagraphStyle.\n\n        Raises:\n            KeyError: If style is not found in custom or base styles.\n        \"\"\"\n        if style_name in self._custom_styles:\n            return self._custom_styles[style_name]\n        return self._base_styles[style_name]\n\n    @property\n    def all_styles(self) -> dict[str, ParagraphStyle]:\n        \"\"\"Get all available styles.\"\"\"\n        result = {}\n        for style in self._base_styles.byName.values():\n            result[style.name] = style\n        result.update(self._custom_styles)\n        return result\n\n\nclass PDFTableBuilder:\n    \"\"\"\n    Builder class for creating formatted tables in PDF documents.\n\n    Provides methods for creating compliance-specific tables with\n    consistent styling and formatting.\n    \"\"\"\n\n    # Default table style\n    DEFAULT_TABLE_STYLE = TableStyle(\n        [\n            (\"BACKGROUND\", (0, 0), (-1, 0), colors.HexColor(\"#2c5282\")),\n            (\"TEXTCOLOR\", (0, 0), (-1, 0), colors.white),\n            (\"ALIGN\", (0, 0), (-1, -1), \"LEFT\"),\n            (\"FONTNAME\", (0, 0), (-1, 0), \"Helvetica-Bold\"),\n            (\"FONTSIZE\", (0, 0), (-1, 0), 10),\n            (\"BOTTOMPADDING\", (0, 0), (-1, 0), 12),\n            (\"TOPPADDING\", (0, 0), (-1, 0), 12),\n            (\"BACKGROUND\", (0, 1), (-1, -1), colors.white),\n            (\"TEXTCOLOR\", (0, 1), (-1, -1), colors.black),\n            (\"FONTNAME\", (0, 1), (-1, -1), \"Helvetica\"),\n            (\"FONTSIZE\", (0, 1), (-1, -1), 9),\n            (\"BOTTOMPADDING\", (0, 1), (-1, -1), 8),\n            (\"TOPPADDING\", (0, 1), (-1, -1), 8),\n            (\"GRID\", (0, 0), (-1, -1), 0.5, colors.HexColor(\"#e2e8f0\")),\n            (\"VALIGN\", (0, 0), (-1, -1), \"TOP\"),\n            (\"ROWBACKGROUNDS\", (0, 1), (-1, -1), [colors.white, colors.HexColor(\"#f7fafc\")]),\n        ]\n    )\n\n    def __init__(self, styles: CompliancePDFStyles) -> None:\n        \"\"\"\n        Initialize the table builder.\n\n        Args:\n            styles: The PDF styles instance to use.\n        \"\"\"\n        self.styles = styles\n\n    def create_simple_table(\n        self,\n        headers: list[str],\n        rows: list[list[Any]],\n        col_widths: Optional[list[float]] = None,\n        table_style: Optional[TableStyle] = None,\n    ) -> Table:\n        \"\"\"\n        Create a simple table with headers and rows.\n\n        Args:\n            headers: List of column headers.\n            rows: List of rows, each row is a list of cell values.\n            col_widths: Optional list of column widths.\n            table_style: Optional custom table style.\n\n        Returns:\n            A formatted Table object.\n        \"\"\"\n        # Convert all values to Paragraphs for proper text wrapping\n        header_style = self.styles.get_style(\"TableHeader\")\n        cell_style = self.styles.get_style(\"TableCell\")\n\n        formatted_headers = [Paragraph(str(h), header_style) for h in headers]\n        formatted_rows = []\n\n        for row in rows:\n            formatted_row = []\n            for cell in row:\n                if isinstance(cell, Paragraph):\n                    formatted_row.append(cell)\n                else:\n                    formatted_row.append(Paragraph(str(cell) if cell else \"N/A\", cell_style))\n            formatted_rows.append(formatted_row)\n\n        data = [formatted_headers] + formatted_rows\n\n        table = Table(data, colWidths=col_widths, repeatRows=1)\n        table.setStyle(table_style or self.DEFAULT_TABLE_STYLE)\n\n        return table\n\n    def create_evidence_table(\n        self,\n        evidence_records: list[dict[str, Any]],\n        include_status: bool = True,\n    ) -> Table:\n        \"\"\"\n        Create a table for evidence records.\n\n        Args:\n            evidence_records: List of evidence record dictionaries.\n            include_status: Whether to include status column.\n\n        Returns:\n            A formatted Table for evidence display.\n        \"\"\"\n        if include_status:\n            headers = [\"Control ID\", \"Evidence\", \"Type\", \"Collected\", \"Status\"]\n            col_widths = [1.0 * inch, 2.5 * inch, 1.0 * inch, 1.0 * inch, 1.0 * inch]\n        else:\n            headers = [\"Control ID\", \"Evidence\", \"Type\", \"Collected\"]\n            col_widths = [1.0 * inch, 3.0 * inch, 1.0 * inch, 1.0 * inch]\n\n        rows = []\n        for record in evidence_records:\n            row = [\n                record.get(\"control_id\", \"N/A\"),\n                record.get(\"description\", \"N/A\"),\n                record.get(\"evidence_type\", \"N/A\"),\n                self._format_date(record.get(\"collected_at\")),\n            ]\n            if include_status:\n                row.append(self._format_status(record.get(\"status\", \"\")))\n            rows.append(row)\n\n        return self.create_simple_table(headers, rows, col_widths)\n\n    def create_control_mapping_table(\n        self,\n        mappings: list[dict[str, Any]],\n        framework: str,\n    ) -> Table:\n        \"\"\"\n        Create a table for control mappings.\n\n        Args:\n            mappings: List of control mapping dictionaries.\n            framework: The compliance framework name.\n\n        Returns:\n            A formatted Table for control mappings.\n        \"\"\"\n        headers = [\n            f\"{framework.upper()} Control\",\n            \"Guardrail Control\",\n            \"Mapping Rationale\",\n            \"Coverage\",\n        ]\n        col_widths = [1.2 * inch, 1.5 * inch, 3.0 * inch, 0.8 * inch]\n\n        rows = []\n        for mapping in mappings:\n            coverage = mapping.get(\"coverage_percentage\", mapping.get(\"coverage_level\", 100))\n            if isinstance(coverage, int):\n                coverage_str = f\"{coverage}%\"\n            else:\n                coverage_str = str(coverage)\n\n            row = [\n                mapping.get(\"soc2_control_id\")\n                or mapping.get(\"iso27001_control_id\")\n                or mapping.get(\"control_id\", \"N/A\"),\n                mapping.get(\"guardrail_control_name\", \"N/A\"),\n                mapping.get(\"mapping_rationale\", \"N/A\"),\n                coverage_str,\n            ]\n            rows.append(row)\n\n        return self.create_simple_table(headers, rows, col_widths)\n\n    def _format_date(self, value: Any) -> str:\n        \"\"\"Format a datetime value for display.\"\"\"\n        if value is None:\n            return \"N/A\"\n        if isinstance(value, datetime):\n            return value.strftime(\"%Y-%m-%d\")\n        return str(value)\n\n    def _format_status(self, status: Any) -> str:\n        \"\"\"Format a status value for display.\"\"\"\n        if not status:\n            return \"N/A\"\n        status_str = str(status).replace(\"_\", \" \").title()\n        return status_str\n\n\nclass CompliancePDFGenerator:\n    \"\"\"\n    Main PDF generator for compliance documentation.\n\n    Generates professional compliance reports with consistent styling,\n    proper structure, and support for all compliance frameworks.\n    \"\"\"\n\n    def __init__(\n        self,\n        pagesize: tuple = letter,\n        margins: Optional[dict[str, float]] = None,\n    ) -> None:\n        \"\"\"\n        Initialize the PDF generator.\n\n        Args:\n            pagesize: Page size tuple (width, height). Default is US Letter.\n            margins: Optional dict with 'left', 'right', 'top', 'bottom' margins.\n        \"\"\"\n        self.pagesize = pagesize\n        self.margins = margins or {\n            \"left\": 0.75 * inch,\n            \"right\": 0.75 * inch,\n            \"top\": 0.75 * inch,\n            \"bottom\": 0.75 * inch,\n        }\n        self.styles = CompliancePDFStyles()\n        self.table_builder = PDFTableBuilder(self.styles)\n        self._story: list = []\n\n    def _reset_story(self) -> None:\n        \"\"\"Reset the document story for a new document.\"\"\"\n        self._story = []\n\n    def _add_title_page(\n        self,\n        title: str,\n        subtitle: Optional[str] = None,\n        organization: Optional[str] = None,\n        report_date: Optional[datetime] = None,\n        confidentiality: str = \"CONFIDENTIAL\",\n    ) -> None:\n        \"\"\"\n        Add a title page to the document.\n\n        Args:\n            title: Main document title.\n            subtitle: Optional subtitle.\n            organization: Organization name.\n            report_date: Report generation date.\n            confidentiality: Confidentiality level.\n        \"\"\"\n        # Add space from top\n        self._story.append(Spacer(1, 2 * inch))\n\n        # Title\n        self._story.append(Paragraph(title, self.styles.get_style(\"DocumentTitle\")))\n\n        # Subtitle\n        if subtitle:\n            subtitle_style = ParagraphStyle(\n                \"Subtitle\",\n                parent=self.styles.get_style(\"SectionHeader\"),\n                fontSize=14,\n                alignment=TA_CENTER,\n                spaceAfter=30,\n            )\n            self._story.append(Paragraph(subtitle, subtitle_style))\n\n        self._story.append(Spacer(1, inch))\n\n        # Organization\n        if organization:\n            org_style = ParagraphStyle(\n                \"Organization\",\n                parent=self.styles.get_style(\"BodyText\"),\n                fontSize=14,\n                alignment=TA_CENTER,\n            )\n            self._story.append(Paragraph(f\"Prepared for: {organization}\", org_style))\n\n        # Report Date\n        if report_date:\n            date_style = ParagraphStyle(\n                \"ReportDate\",\n                parent=self.styles.get_style(\"BodyText\"),\n                fontSize=12,\n                alignment=TA_CENTER,\n            )\n            date_str = report_date.strftime(\"%B %d, %Y\")\n            self._story.append(Paragraph(f\"Report Date: {date_str}\", date_style))\n\n        self._story.append(Spacer(1, 2 * inch))\n\n        # Confidentiality Notice\n        if confidentiality:\n            self._story.append(\n                Paragraph(\n                    f\"{confidentiality.upper()}\",\n                    self.styles.get_style(\"Confidential\"),\n                )\n            )\n            self._story.append(\n                Paragraph(\n                    \"This document contains confidential information. \"\n                    \"Distribution is restricted to authorized personnel only.\",\n                    self.styles.get_style(\"BodyText\"),\n                )\n            )\n\n        self._story.append(PageBreak())\n\n    def _add_section(\n        self,\n        title: str,\n        content: Optional[str] = None,\n        level: int = 1,\n    ) -> None:\n        \"\"\"\n        Add a section to the document.\n\n        Args:\n            title: Section title.\n            content: Optional section content.\n            level: Heading level (1 or 2).\n        \"\"\"\n        style_name = \"SectionHeader\" if level == 1 else \"SubsectionHeader\"\n        self._story.append(Paragraph(title, self.styles.get_style(style_name)))\n\n        if content:\n            self._story.append(Paragraph(content, self.styles.get_style(\"BodyText\")))\n\n    def _add_paragraph(self, text: str, style: Optional[str] = None) -> None:\n        \"\"\"\n        Add a paragraph to the document.\n\n        Args:\n            text: Paragraph text.\n            style: Optional style name.\n        \"\"\"\n        para_style = self.styles.get_style(style or \"BodyText\")\n        self._story.append(Paragraph(text, para_style))\n\n    def _add_bullet_list(self, items: list[str]) -> None:\n        \"\"\"\n        Add a bullet list to the document.\n\n        Args:\n            items: List of items to include.\n        \"\"\"\n        list_items = []\n        for item in items:\n            list_items.append(\n                ListItem(\n                    Paragraph(item, self.styles.get_style(\"BodyText\")),\n                    bulletColor=colors.HexColor(\"#2c5282\"),\n                )\n            )\n\n        self._story.append(\n            ListFlowable(\n                list_items,\n                bulletType=\"bullet\",\n                start=\"circle\",\n            )\n        )\n\n    def _add_table(self, table: Table) -> None:\n        \"\"\"\n        Add a table to the document.\n\n        Args:\n            table: The Table object to add.\n        \"\"\"\n        self._story.append(Spacer(1, 12))\n        self._story.append(table)\n        self._story.append(Spacer(1, 12))\n\n    def _add_spacer(self, height: float = 12) -> None:\n        \"\"\"\n        Add vertical space to the document.\n\n        Args:\n            height: Height of spacer in points.\n        \"\"\"\n        self._story.append(Spacer(1, height))\n\n    def _add_page_break(self) -> None:\n        \"\"\"Add a page break to the document.\"\"\"\n        self._story.append(PageBreak())\n\n    def _build_document(\n        self,\n        output: Union[str, Path, BinaryIO],\n        metadata: Optional[dict[str, str]] = None,\n    ) -> None:\n        \"\"\"\n        Build the PDF document.\n\n        Args:\n            output: Output file path or file-like object.\n            metadata: Optional document metadata (title, author, subject).\n        \"\"\"\n        if isinstance(output, (str, Path)):\n            output_path = Path(output)\n            output_path.parent.mkdir(parents=True, exist_ok=True)\n            doc = SimpleDocTemplate(\n                str(output_path),\n                pagesize=self.pagesize,\n                leftMargin=self.margins[\"left\"],\n                rightMargin=self.margins[\"right\"],\n                topMargin=self.margins[\"top\"],\n                bottomMargin=self.margins[\"bottom\"],\n            )\n        else:\n            doc = SimpleDocTemplate(\n                output,\n                pagesize=self.pagesize,\n                leftMargin=self.margins[\"left\"],\n                rightMargin=self.margins[\"right\"],\n                topMargin=self.margins[\"top\"],\n                bottomMargin=self.margins[\"bottom\"],\n            )\n\n        # Set document metadata\n        if metadata:\n            doc.title = metadata.get(\"title\", \"Compliance Report\")\n            doc.author = metadata.get(\"author\", \"ACGS Compliance Documentation Service\")\n            doc.subject = metadata.get(\"subject\", \"Compliance Documentation\")\n\n        doc.build(self._story)\n\n    def generate_soc2_report(\n        self,\n        report_data: dict[str, Any],\n        output_path: Optional[Union[str, Path]] = None,\n    ) -> Path:\n        \"\"\"\n        Generate a SOC 2 Type II compliance report.\n\n        Args:\n            report_data: SOC 2 report data dictionary.\n            output_path: Optional output file path.\n\n        Returns:\n            Path to the generated PDF file.\n        \"\"\"\n        self._reset_story()\n\n        org_name = report_data.get(\"organization_name\", \"Organization\")\n        audit_start = report_data.get(\"audit_period_start\")\n        audit_end = report_data.get(\"audit_period_end\")\n\n        # Title page\n        self._add_title_page(\n            title=\"SOC 2 Type II Report\",\n            subtitle=\"Service Organization Control Report\",\n            organization=org_name,\n            report_date=datetime.now(timezone.utc),\n        )\n\n        # Executive Summary\n        self._add_section(\"Executive Summary\")\n        self._add_paragraph(\n            f\"This SOC 2 Type II report covers the {org_name} system \"\n            f\"for the audit period from {self._format_date(audit_start)} \"\n            f\"to {self._format_date(audit_end)}.\"\n        )\n\n        # System Description\n        system_desc = report_data.get(\"system_description\", {})\n        if system_desc:\n            self._add_section(\"System Description\")\n            self._add_paragraph(\n                system_desc.get(\"system_description\", \"System description not provided.\")\n            )\n\n            if system_desc.get(\"principal_service_commitments\"):\n                self._add_section(\"Principal Service Commitments\", level=2)\n                self._add_bullet_list(system_desc[\"principal_service_commitments\"])\n\n            if system_desc.get(\"components\"):\n                self._add_section(\"System Components\", level=2)\n                self._add_bullet_list(system_desc[\"components\"])\n\n        # Trust Service Criteria\n        criteria_sections = report_data.get(\"criteria_sections\", [])\n        if criteria_sections:\n            self._add_page_break()\n            self._add_section(\"Trust Service Criteria\")\n\n            for section in criteria_sections:\n                criteria = section.get(\"criteria\", \"\")\n                criteria_name = str(criteria).replace(\"_\", \" \").title()\n                self._add_section(f\"{criteria_name} Controls\", level=2)\n\n                controls = section.get(\"controls\", [])\n                if controls:\n                    rows = []\n                    for ctrl in controls:\n                        rows.append(\n                            [\n                                ctrl.get(\"control_id\", \"N/A\"),\n                                ctrl.get(\"title\", \"N/A\"),\n                                ctrl.get(\"control_objective\", \"N/A\"),\n                            ]\n                        )\n\n                    table = self.table_builder.create_simple_table(\n                        headers=[\"Control ID\", \"Title\", \"Objective\"],\n                        rows=rows,\n                        col_widths=[1.0 * inch, 2.0 * inch, 3.5 * inch],\n                    )\n                    self._add_table(table)\n\n        # Control Mappings\n        mappings = report_data.get(\"control_mappings\", [])\n        if mappings:\n            self._add_page_break()\n            self._add_section(\"Guardrail Control Mappings\")\n            self._add_paragraph(\n                \"The following table shows how ACGS guardrail controls map to SOC 2 controls.\"\n            )\n            mapping_table = self.table_builder.create_control_mapping_table(\n                [m if isinstance(m, dict) else m.model_dump() for m in mappings],\n                \"SOC2\",\n            )\n            self._add_table(mapping_table)\n\n        # Generate output path if not provided\n        if output_path is None:\n            output_dir = _ensure_output_dir()\n            timestamp = datetime.now(timezone.utc).strftime(\"%Y%m%d_%H%M%S\")\n            output_path = output_dir / f\"soc2_report_{timestamp}.pdf\"\n\n        self._build_document(\n            output_path,\n            metadata={\n                \"title\": \"SOC 2 Type II Report\",\n                \"author\": \"ACGS Compliance Documentation Service\",\n                \"subject\": f\"SOC 2 Report for {org_name}\",\n            },\n        )\n\n        logger.info(f\"Generated SOC 2 report: {output_path}\")\n        return Path(output_path)\n\n    def generate_iso27001_report(\n        self,\n        report_data: dict[str, Any],\n        output_path: Optional[Union[str, Path]] = None,\n    ) -> Path:\n        \"\"\"\n        Generate an ISO 27001:2022 compliance report.\n\n        Args:\n            report_data: ISO 27001 report data dictionary.\n            output_path: Optional output file path.\n\n        Returns:\n            Path to the generated PDF file.\n        \"\"\"\n        self._reset_story()\n\n        org_name = report_data.get(\"organization_name\", \"Organization\")\n        scope = report_data.get(\"isms_scope\", \"\")\n\n        # Title page\n        self._add_title_page(\n            title=\"ISO 27001:2022 Compliance Report\",\n            subtitle=\"Information Security Management System\",\n            organization=org_name,\n            report_date=datetime.now(timezone.utc),\n        )\n\n        # ISMS Scope\n        self._add_section(\"ISMS Scope\")\n        self._add_paragraph(scope or \"ISMS scope not specified.\")\n\n        # Statement of Applicability\n        soa = report_data.get(\"statement_of_applicability\", {})\n        if soa:\n            self._add_section(\"Statement of Applicability\")\n            entries = soa.get(\"entries\", [])\n\n            if entries:\n                rows = []\n                for entry in entries[:20]:  # Limit for display\n                    status = entry.get(\"implementation_status\", \"not_implemented\")\n                    status_display = str(status).replace(\"_\", \" \").title()\n                    rows.append(\n                        [\n                            entry.get(\"control_id\", \"N/A\"),\n                            entry.get(\"control_title\", \"N/A\"),\n                            str(entry.get(\"applicability\", \"applicable\")).replace(\"_\", \" \").title(),\n                            status_display,\n                        ]\n                    )\n\n                table = self.table_builder.create_simple_table(\n                    headers=[\"Control ID\", \"Title\", \"Applicability\", \"Status\"],\n                    rows=rows,\n                    col_widths=[1.0 * inch, 2.5 * inch, 1.2 * inch, 1.3 * inch],\n                )\n                self._add_table(table)\n\n        # Theme Sections\n        theme_sections = report_data.get(\"theme_sections\", [])\n        if theme_sections:\n            self._add_page_break()\n            self._add_section(\"Control Themes\")\n\n            for section in theme_sections:\n                theme = section.get(\"theme\", \"\")\n                theme_name = str(theme).replace(\"_\", \" \").title()\n                self._add_section(f\"{theme_name} Controls\", level=2)\n\n                impl_pct = section.get(\"implementation_percentage\", 0)\n                self._add_paragraph(f\"Implementation Progress: {impl_pct:.1f}%\")\n\n        # Generate output path if not provided\n        if output_path is None:\n            output_dir = _ensure_output_dir()\n            timestamp = datetime.now(timezone.utc).strftime(\"%Y%m%d_%H%M%S\")\n            output_path = output_dir / f\"iso27001_report_{timestamp}.pdf\"\n\n        self._build_document(\n            output_path,\n            metadata={\n                \"title\": \"ISO 27001:2022 Compliance Report\",\n                \"author\": \"ACGS Compliance Documentation Service\",\n                \"subject\": f\"ISO 27001 Report for {org_name}\",\n            },\n        )\n\n        logger.info(f\"Generated ISO 27001 report: {output_path}\")\n        return Path(output_path)\n\n    def generate_gdpr_report(\n        self,\n        report_data: dict[str, Any],\n        output_path: Optional[Union[str, Path]] = None,\n    ) -> Path:\n        \"\"\"\n        Generate a GDPR Article 30 compliance report.\n\n        Args:\n            report_data: GDPR report data dictionary.\n            output_path: Optional output file path.\n\n        Returns:\n            Path to the generated PDF file.\n        \"\"\"\n        self._reset_story()\n\n        org_name = report_data.get(\"organization_name\", \"Organization\")\n        entity_role = report_data.get(\"entity_role\", \"controller\")\n\n        # Title page\n        self._add_title_page(\n            title=\"GDPR Article 30 Report\",\n            subtitle=\"Records of Processing Activities\",\n            organization=org_name,\n            report_date=datetime.now(timezone.utc),\n        )\n\n        # Entity Role\n        self._add_section(\"Data Protection Role\")\n        self._add_paragraph(\n            f\"This organization operates as a data {str(entity_role).replace('_', ' ')} \"\n            f\"under the General Data Protection Regulation (GDPR).\"\n        )\n\n        # Controller Record\n        controller_record = report_data.get(\"controller_record\")\n        if controller_record:\n            self._add_section(\"Controller Information (Article 30(1))\")\n\n            contact = controller_record.get(\"controller_contact\", {})\n            if contact:\n                self._add_paragraph(\n                    f\"<b>Controller:</b> {controller_record.get('controller_name', 'N/A')}<br/>\"\n                    f\"<b>Contact:</b> {contact.get('name', 'N/A')}<br/>\"\n                    f\"<b>Email:</b> {contact.get('email', 'N/A')}\"\n                )\n\n            # DPO Information\n            dpo = controller_record.get(\"dpo\")\n            if dpo:\n                self._add_section(\"Data Protection Officer\", level=2)\n                self._add_paragraph(\n                    f\"<b>Name:</b> {dpo.get('name', 'N/A')}<br/>\"\n                    f\"<b>Email:</b> {dpo.get('email', 'N/A')}\"\n                )\n\n            # Processing Activities\n            activities = controller_record.get(\"processing_activities\", [])\n            if activities:\n                self._add_page_break()\n                self._add_section(\"Processing Activities\")\n\n                rows = []\n                for activity in activities[:15]:  # Limit for display\n                    purposes = activity.get(\"purposes\", [])\n                    purposes_str = \", \".join(purposes[:2]) if purposes else \"N/A\"\n                    if len(purposes) > 2:\n                        purposes_str += \"...\"\n\n                    rows.append(\n                        [\n                            activity.get(\"name\", \"N/A\"),\n                            purposes_str,\n                            activity.get(\"status\", \"N/A\").replace(\"_\", \" \").title(),\n                        ]\n                    )\n\n                table = self.table_builder.create_simple_table(\n                    headers=[\"Activity\", \"Purposes\", \"Status\"],\n                    rows=rows,\n                    col_widths=[2.0 * inch, 3.0 * inch, 1.5 * inch],\n                )\n                self._add_table(table)\n\n        # Data Flows\n        data_flows = report_data.get(\"data_flows\", [])\n        if data_flows:\n            self._add_section(\"Data Flow Mappings\")\n\n            rows = []\n            for flow in data_flows[:10]:  # Limit for display\n                rows.append(\n                    [\n                        flow.get(\"name\", \"N/A\"),\n                        flow.get(\"data_source\", \"N/A\"),\n                        flow.get(\"data_destination\", \"N/A\"),\n                        \"Yes\" if flow.get(\"crosses_border\") else \"No\",\n                    ]\n                )\n\n            table = self.table_builder.create_simple_table(\n                headers=[\"Flow Name\", \"Source\", \"Destination\", \"Cross-Border\"],\n                rows=rows,\n                col_widths=[1.8 * inch, 1.5 * inch, 1.5 * inch, 1.2 * inch],\n            )\n            self._add_table(table)\n\n        # Generate output path if not provided\n        if output_path is None:\n            output_dir = _ensure_output_dir()\n            timestamp = datetime.now(timezone.utc).strftime(\"%Y%m%d_%H%M%S\")\n            output_path = output_dir / f\"gdpr_report_{timestamp}.pdf\"\n\n        self._build_document(\n            output_path,\n            metadata={\n                \"title\": \"GDPR Article 30 Report\",\n                \"author\": \"ACGS Compliance Documentation Service\",\n                \"subject\": f\"GDPR Report for {org_name}\",\n            },\n        )\n\n        logger.info(f\"Generated GDPR report: {output_path}\")\n        return Path(output_path)\n\n    def generate_euaiact_report(\n        self,\n        report_data: dict[str, Any],\n        output_path: Optional[Union[str, Path]] = None,\n    ) -> Path:\n        \"\"\"\n        Generate an EU AI Act compliance report.\n\n        Args:\n            report_data: EU AI Act report data dictionary.\n            output_path: Optional output file path.\n\n        Returns:\n            Path to the generated PDF file.\n        \"\"\"\n        self._reset_story()\n\n        org_name = report_data.get(\"organization_name\", \"Organization\")\n        org_role = report_data.get(\"organization_role\", \"provider\")\n\n        # Title page\n        self._add_title_page(\n            title=\"EU AI Act Compliance Report\",\n            subtitle=\"Regulation (EU) 2024/1689\",\n            organization=org_name,\n            report_date=datetime.now(timezone.utc),\n        )\n\n        # Organization Role\n        self._add_section(\"Organization Role\")\n        self._add_paragraph(\n            f\"This organization operates as an AI system {str(org_role).replace('_', ' ')} \"\n            f\"under the EU AI Act.\"\n        )\n\n        # AI Systems Summary\n        ai_systems = report_data.get(\"ai_systems\", [])\n        high_risk_count = report_data.get(\"high_risk_systems_count\", 0)\n        limited_risk_count = report_data.get(\"limited_risk_systems_count\", 0)\n        minimal_risk_count = report_data.get(\"minimal_risk_systems_count\", 0)\n\n        self._add_section(\"AI Systems Overview\")\n        self._add_paragraph(\n            f\"<b>Total AI Systems:</b> {len(ai_systems)}<br/>\"\n            f\"<b>High-Risk Systems:</b> {high_risk_count}<br/>\"\n            f\"<b>Limited-Risk Systems:</b> {limited_risk_count}<br/>\"\n            f\"<b>Minimal-Risk Systems:</b> {minimal_risk_count}\"\n        )\n\n        # Risk Assessments\n        risk_assessments = report_data.get(\"risk_assessments\", [])\n        if risk_assessments:\n            self._add_page_break()\n            self._add_section(\"Risk Assessments\")\n\n            rows = []\n            for assessment in risk_assessments[:10]:  # Limit for display\n                risk_level = assessment.get(\"risk_level\", \"N/A\")\n                rows.append(\n                    [\n                        assessment.get(\"system_name\", \"N/A\"),\n                        str(risk_level).replace(\"_\", \" \").title(),\n                        assessment.get(\"high_risk_category\", \"N/A\") or \"N/A\",\n                        self._format_date(assessment.get(\"assessment_date\")),\n                    ]\n                )\n\n            table = self.table_builder.create_simple_table(\n                headers=[\"System\", \"Risk Level\", \"Category\", \"Assessment Date\"],\n                rows=rows,\n                col_widths=[2.0 * inch, 1.2 * inch, 1.5 * inch, 1.3 * inch],\n            )\n            self._add_table(table)\n\n        # Conformity Assessments\n        conformity_assessments = report_data.get(\"conformity_assessments\", [])\n        if conformity_assessments:\n            self._add_section(\"Conformity Assessments\")\n\n            rows = []\n            for assessment in conformity_assessments[:10]:  # Limit for display\n                rows.append(\n                    [\n                        assessment.get(\"system_id\", \"N/A\"),\n                        str(assessment.get(\"assessment_type\", \"N/A\")).replace(\"_\", \" \").title(),\n                        assessment.get(\"assessment_result\", \"N/A\").title(),\n                        assessment.get(\"certificate_number\", \"N/A\") or \"N/A\",\n                    ]\n                )\n\n            table = self.table_builder.create_simple_table(\n                headers=[\"System ID\", \"Assessment Type\", \"Result\", \"Certificate\"],\n                rows=rows,\n                col_widths=[1.5 * inch, 1.5 * inch, 1.2 * inch, 1.8 * inch],\n            )\n            self._add_table(table)\n\n        # Generate output path if not provided\n        if output_path is None:\n            output_dir = _ensure_output_dir()\n            timestamp = datetime.now(timezone.utc).strftime(\"%Y%m%d_%H%M%S\")\n            output_path = output_dir / f\"euaiact_report_{timestamp}.pdf\"\n\n        self._build_document(\n            output_path,\n            metadata={\n                \"title\": \"EU AI Act Compliance Report\",\n                \"author\": \"ACGS Compliance Documentation Service\",\n                \"subject\": f\"EU AI Act Report for {org_name}\",\n            },\n        )\n\n        logger.info(f\"Generated EU AI Act report: {output_path}\")\n        return Path(output_path)\n\n    def _format_date(self, value: Any) -> str:\n        \"\"\"Format a datetime value for display.\"\"\"\n        if value is None:\n            return \"N/A\"\n        if isinstance(value, datetime):\n            return value.strftime(\"%Y-%m-%d\")\n        return str(value)\n\n\ndef generate_pdf(\n    report_data: dict[str, Any],\n    framework: Union[str, ComplianceFramework],\n    output_path: Optional[Union[str, Path]] = None,\n    pagesize: tuple = letter,\n) -> Path:\n    \"\"\"\n    Generate a PDF compliance report for the specified framework.\n\n    This is the main entry point for PDF generation.\n\n    Args:\n        report_data: Report data dictionary containing all compliance information.\n        framework: Compliance framework (soc2, iso27001, gdpr, euaiact).\n        output_path: Optional output file path. If not provided, a default path is used.\n        pagesize: Page size tuple. Default is US Letter.\n\n    Returns:\n        Path to the generated PDF file.\n\n    Raises:\n        ValueError: If the framework is not supported.\n\n    Example:\n        >>> from acgs2.services.compliance_docs.src.generators.pdf_generator import generate_pdf\n        >>> path = generate_pdf(\n        ...     report_data={\"organization_name\": \"Acme Corp\", ...},\n        ...     framework=\"soc2\",\n        ... )\n        >>> print(f\"Report generated at: {path}\")\n    \"\"\"\n    generator = CompliancePDFGenerator(pagesize=pagesize)\n\n    # Normalize framework\n    if isinstance(framework, ComplianceFramework):\n        framework_str = framework.value\n    else:\n        framework_str = str(framework).lower()\n\n    if framework_str == \"soc2\":\n        return generator.generate_soc2_report(report_data, output_path)\n    elif framework_str == \"iso27001\":\n        return generator.generate_iso27001_report(report_data, output_path)\n    elif framework_str == \"gdpr\":\n        return generator.generate_gdpr_report(report_data, output_path)\n    elif framework_str == \"euaiact\":\n        return generator.generate_euaiact_report(report_data, output_path)\n    else:\n        raise ValueError(\n            f\"Unsupported framework: {framework}. \"\n            f\"Supported frameworks: soc2, iso27001, gdpr, euaiact\"\n        )\n\n\ndef generate_pdf_to_buffer(\n    report_data: dict[str, Any],\n    framework: Union[str, ComplianceFramework],\n    pagesize: tuple = letter,\n) -> io.BytesIO:\n    \"\"\"\n    Generate a PDF compliance report to an in-memory buffer.\n\n    This is useful for streaming responses without writing to disk.\n\n    Args:\n        report_data: Report data dictionary containing all compliance information.\n        framework: Compliance framework (soc2, iso27001, gdpr, euaiact).\n        pagesize: Page size tuple. Default is US Letter.\n\n    Returns:\n        BytesIO buffer containing the generated PDF.\n\n    Raises:\n        ValueError: If the framework is not supported.\n\n    Example:\n        >>> buffer = generate_pdf_to_buffer(report_data, \"soc2\")\n        >>> # Use buffer.getvalue() to get bytes for streaming\n    \"\"\"\n    buffer = io.BytesIO()\n    generator = CompliancePDFGenerator(pagesize=pagesize)\n\n    # Normalize framework\n    if isinstance(framework, ComplianceFramework):\n        framework_str = framework.value\n    else:\n        framework_str = str(framework).lower()\n\n    # Reset story and build report\n    generator._reset_story()\n\n    if framework_str == \"soc2\":\n        org_name = report_data.get(\"organization_name\", \"Organization\")\n        generator._add_title_page(\n            title=\"SOC 2 Type II Report\",\n            subtitle=\"Service Organization Control Report\",\n            organization=org_name,\n            report_date=datetime.now(timezone.utc),\n        )\n        generator._add_section(\"Report Content\")\n        generator._add_paragraph(\n            \"Full SOC 2 report content. See generate_pdf() for complete implementation.\"\n        )\n    elif framework_str == \"iso27001\":\n        org_name = report_data.get(\"organization_name\", \"Organization\")\n        generator._add_title_page(\n            title=\"ISO 27001:2022 Compliance Report\",\n            organization=org_name,\n            report_date=datetime.now(timezone.utc),\n        )\n    elif framework_str == \"gdpr\":\n        org_name = report_data.get(\"organization_name\", \"Organization\")\n        generator._add_title_page(\n            title=\"GDPR Article 30 Report\",\n            organization=org_name,\n            report_date=datetime.now(timezone.utc),\n        )\n    elif framework_str == \"euaiact\":\n        org_name = report_data.get(\"organization_name\", \"Organization\")\n        generator._add_title_page(\n            title=\"EU AI Act Compliance Report\",\n            organization=org_name,\n            report_date=datetime.now(timezone.utc),\n        )\n    else:\n        raise ValueError(\n            f\"Unsupported framework: {framework}. \"\n            f\"Supported frameworks: soc2, iso27001, gdpr, euaiact\"\n        )\n\n    generator._build_document(\n        buffer,\n        metadata={\n            \"title\": f\"{framework_str.upper()} Compliance Report\",\n            \"author\": \"ACGS Compliance Documentation Service\",\n        },\n    )\n\n    buffer.seek(0)\n    return buffer\n",
        "timestamp": "2026-01-04T05:35:58.374613"
      },
      "worktree_state": null,
      "task_intent": {
        "title": "056-reduce-excessive-any-type-usage-in-python-codebase",
        "description": "Found 373 occurrences of ': Any' type annotations across 120+ Python files, with high concentrations in integration-service (16 occurrences), acgs2-core/breakthrough (79 occurrences), and acgs2-core/enhanced_agent_bus (50+ occurrences). Excessive use of 'Any' defeats the purpose of type hints and can mask type-related bugs.",
        "from_plan": true
      },
      "commits_behind_main": 0,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2026-01-03T19:36:18.257192",
  "last_updated": "2026-01-04T05:35:58.582386"
}