{
  "file_path": "src/core/services/compliance_docs/src/generators/xlsx_generator.py",
  "main_branch_history": [],
  "task_views": {
    "056-reduce-excessive-any-type-usage-in-python-codebase": {
      "task_id": "056-reduce-excessive-any-type-usage-in-python-codebase",
      "branch_point": {
        "commit_hash": "fc6e42927298263034acf989773f3200e422ad17",
        "content": "\"\"\"Constitutional Hash: cdd01ef066bc6cf2\nXLSX Document Generator for Compliance Documentation Service\n\nGenerates professional compliance evidence matrices and reports in XLSX format\nusing openpyxl. Supports all compliance frameworks: SOC 2, ISO 27001, GDPR,\nand EU AI Act.\n\nThis module uses write_only mode for large files (>10k rows) to optimize\nmemory usage. Python datetime objects are automatically converted to Excel\ndates.\n\nNote: Excel uses 1-indexed rows/columns in user-facing documentation.\n\"\"\"\n\nimport io\nimport logging\nimport os\nimport tempfile\nfrom datetime import datetime, timezone\nfrom pathlib import Path\nfrom typing import Any, BinaryIO, Optional, Union\n\nfrom openpyxl import Workbook\nfrom openpyxl.styles import (\n    Alignment,\n    Border,\n    Font,\n    PatternFill,\n    Side,\n)\nfrom openpyxl.utils import get_column_letter\nfrom openpyxl.worksheet.worksheet import Worksheet\n\nfrom ..models.base import ComplianceFramework\n\nlogger = logging.getLogger(__name__)\n\n\n# Default output path for generated XLSX files\n_DEFAULT_OUTPUT_PATH = Path(tempfile.gettempdir()) / \"compliance-reports\"\n\n# Threshold for using write_only mode (10,000 rows)\nLARGE_FILE_THRESHOLD = 10000\n\n\ndef _get_output_path() -> Path:\n    \"\"\"\n    Resolve output path from environment or use default.\n\n    Returns:\n        Path to output directory for generated XLSX files.\n    \"\"\"\n    output_path = os.getenv(\"COMPLIANCE_OUTPUT_PATH\")\n    if output_path:\n        return Path(output_path)\n    return _DEFAULT_OUTPUT_PATH\n\n\ndef _ensure_output_dir() -> Path:\n    \"\"\"\n    Ensure the output directory exists.\n\n    Returns:\n        Path to the output directory.\n    \"\"\"\n    output_path = _get_output_path()\n    output_path.mkdir(parents=True, exist_ok=True)\n    return output_path\n\n\nclass ComplianceXLSXStyles:\n    \"\"\"\n    Custom styles for compliance XLSX documents.\n\n    Provides professional, consistent styling across all compliance spreadsheets.\n    \"\"\"\n\n    # Color definitions (hex without #)\n    PRIMARY_COLOR = \"1A365D\"  # Dark blue\n    SECONDARY_COLOR = \"2C5282\"  # Medium blue\n    HEADER_BG_COLOR = \"2C5282\"  # Blue for headers\n    HEADER_TEXT_COLOR = \"FFFFFF\"  # White text\n    ALT_ROW_COLOR = \"F7FAFC\"  # Light gray\n    SUCCESS_COLOR = \"276749\"  # Green\n    DANGER_COLOR = \"C53030\"  # Red\n    WARNING_COLOR = \"C05621\"  # Orange\n    BORDER_COLOR = \"E2E8F0\"  # Light gray border\n\n    def __init__(self) -> None:\n        \"\"\"Initialize XLSX styles.\"\"\"\n        self._create_styles()\n\n    def _create_styles(self) -> None:\n        \"\"\"Create reusable style objects.\"\"\"\n        # Font styles\n        self.title_font = Font(\n            name=\"Calibri\",\n            size=16,\n            bold=True,\n            color=self.PRIMARY_COLOR,\n        )\n\n        self.header_font = Font(\n            name=\"Calibri\",\n            size=11,\n            bold=True,\n            color=self.HEADER_TEXT_COLOR,\n        )\n\n        self.subheader_font = Font(\n            name=\"Calibri\",\n            size=12,\n            bold=True,\n            color=self.SECONDARY_COLOR,\n        )\n\n        self.body_font = Font(\n            name=\"Calibri\",\n            size=10,\n            color=\"2D3748\",\n        )\n\n        self.bold_font = Font(\n            name=\"Calibri\",\n            size=10,\n            bold=True,\n            color=\"2D3748\",\n        )\n\n        self.success_font = Font(\n            name=\"Calibri\",\n            size=10,\n            bold=True,\n            color=self.SUCCESS_COLOR,\n        )\n\n        self.danger_font = Font(\n            name=\"Calibri\",\n            size=10,\n            bold=True,\n            color=self.DANGER_COLOR,\n        )\n\n        self.warning_font = Font(\n            name=\"Calibri\",\n            size=10,\n            bold=True,\n            color=self.WARNING_COLOR,\n        )\n\n        # Fill styles\n        self.header_fill = PatternFill(\n            start_color=self.HEADER_BG_COLOR,\n            end_color=self.HEADER_BG_COLOR,\n            fill_type=\"solid\",\n        )\n\n        self.alt_row_fill = PatternFill(\n            start_color=self.ALT_ROW_COLOR,\n            end_color=self.ALT_ROW_COLOR,\n            fill_type=\"solid\",\n        )\n\n        self.success_fill = PatternFill(\n            start_color=\"C6F6D5\",\n            end_color=\"C6F6D5\",\n            fill_type=\"solid\",\n        )\n\n        self.danger_fill = PatternFill(\n            start_color=\"FED7D7\",\n            end_color=\"FED7D7\",\n            fill_type=\"solid\",\n        )\n\n        self.warning_fill = PatternFill(\n            start_color=\"FEEBC8\",\n            end_color=\"FEEBC8\",\n            fill_type=\"solid\",\n        )\n\n        # Border styles\n        thin_border = Side(style=\"thin\", color=self.BORDER_COLOR)\n        self.border = Border(\n            left=thin_border,\n            right=thin_border,\n            top=thin_border,\n            bottom=thin_border,\n        )\n\n        # Alignment styles\n        self.center_align = Alignment(\n            horizontal=\"center\",\n            vertical=\"center\",\n            wrap_text=True,\n        )\n\n        self.left_align = Alignment(\n            horizontal=\"left\",\n            vertical=\"center\",\n            wrap_text=True,\n        )\n\n        self.wrap_align = Alignment(\n            horizontal=\"left\",\n            vertical=\"top\",\n            wrap_text=True,\n        )\n\n    def get_status_style(self, status: str) -> tuple[Font, Optional[PatternFill]]:\n        \"\"\"\n        Get font and fill for a status value.\n\n        Args:\n            status: Status string (e.g., 'effective', 'compliant', 'completed').\n\n        Returns:\n            Tuple of (font, fill) for the status.\n        \"\"\"\n        status_lower = str(status).lower().replace(\"_\", \" \")\n\n        if any(\n            word in status_lower\n            for word in [\"effective\", \"compliant\", \"completed\", \"passed\", \"yes\"]\n        ):\n            return self.success_font, self.success_fill\n        elif any(word in status_lower for word in [\"ineffective\", \"non-compliant\", \"failed\", \"no\"]):\n            return self.danger_font, self.danger_fill\n        elif any(word in status_lower for word in [\"partial\", \"in progress\", \"pending\", \"review\"]):\n            return self.warning_font, self.warning_fill\n\n        return self.body_font, None\n\n\nclass XLSXTableBuilder:\n    \"\"\"\n    Builder class for creating formatted tables in XLSX worksheets.\n\n    Provides methods for creating compliance-specific tables with\n    consistent styling and formatting.\n    \"\"\"\n\n    def __init__(\n        self,\n        workbook: Workbook,\n        styles: ComplianceXLSXStyles,\n        write_only: bool = False,\n    ) -> None:\n        \"\"\"\n        Initialize the table builder.\n\n        Args:\n            workbook: The Workbook instance to add sheets to.\n            styles: The XLSX styles instance to use.\n            write_only: Whether workbook is in write_only mode.\n        \"\"\"\n        self.workbook = workbook\n        self.styles = styles\n        self.write_only = write_only\n\n    def create_evidence_sheet(\n        self,\n        sheet_name: str,\n        headers: list[str],\n        rows: list[list[Any]],\n        col_widths: Optional[list[int]] = None,\n        status_column: Optional[int] = None,\n    ) -> Worksheet:\n        \"\"\"\n        Create a worksheet with evidence data.\n\n        Args:\n            sheet_name: Name for the worksheet.\n            headers: List of column headers.\n            rows: List of rows, each row is a list of cell values.\n            col_widths: Optional list of column widths.\n            status_column: Optional column index (0-based) for status styling.\n\n        Returns:\n            The created Worksheet.\n        \"\"\"\n        if self.write_only:\n            ws = self.workbook.create_sheet(sheet_name)\n            # In write_only mode, append rows directly\n            ws.append(headers)\n            for row in rows:\n                ws.append(row)\n            return ws\n\n        # Normal mode with full styling\n        ws = self.workbook.create_sheet(sheet_name)\n\n        # Add header row\n        for col_idx, header in enumerate(headers, start=1):\n            cell = ws.cell(row=1, column=col_idx, value=header)\n            cell.font = self.styles.header_font\n            cell.fill = self.styles.header_fill\n            cell.alignment = self.styles.center_align\n            cell.border = self.styles.border\n\n        # Add data rows\n        for row_idx, row_data in enumerate(rows, start=2):\n            for col_idx, value in enumerate(row_data, start=1):\n                cell = ws.cell(row=row_idx, column=col_idx, value=value)\n                cell.font = self.styles.body_font\n                cell.alignment = self.styles.left_align\n                cell.border = self.styles.border\n\n                # Apply alternating row colors\n                if row_idx % 2 == 0:\n                    cell.fill = self.styles.alt_row_fill\n\n                # Apply status styling\n                if status_column is not None and col_idx == status_column + 1:\n                    status_font, status_fill = self.styles.get_status_style(\n                        str(value) if value else \"\"\n                    )\n                    cell.font = status_font\n                    if status_fill:\n                        cell.fill = status_fill\n\n        # Set column widths\n        if col_widths:\n            for col_idx, width in enumerate(col_widths, start=1):\n                ws.column_dimensions[get_column_letter(col_idx)].width = width\n        else:\n            # Auto-size based on headers\n            for col_idx, header in enumerate(headers, start=1):\n                ws.column_dimensions[get_column_letter(col_idx)].width = max(\n                    len(str(header)) + 4, 12\n                )\n\n        # Freeze header row\n        ws.freeze_panes = \"A2\"\n\n        return ws\n\n    def create_summary_sheet(\n        self,\n        sheet_name: str,\n        summary_data: list[tuple[str, Any]],\n    ) -> Worksheet:\n        \"\"\"\n        Create a summary sheet with key-value pairs.\n\n        Args:\n            sheet_name: Name for the worksheet.\n            summary_data: List of (label, value) tuples.\n\n        Returns:\n            The created Worksheet.\n        \"\"\"\n        if self.write_only:\n            ws = self.workbook.create_sheet(sheet_name)\n            for label, value in summary_data:\n                ws.append([label, value])\n            return ws\n\n        ws = self.workbook.create_sheet(sheet_name)\n\n        for row_idx, (label, value) in enumerate(summary_data, start=1):\n            # Label cell\n            label_cell = ws.cell(row=row_idx, column=1, value=label)\n            label_cell.font = self.styles.bold_font\n            label_cell.alignment = self.styles.left_align\n            label_cell.border = self.styles.border\n\n            # Value cell\n            value_cell = ws.cell(row=row_idx, column=2, value=value)\n            value_cell.font = self.styles.body_font\n            value_cell.alignment = self.styles.left_align\n            value_cell.border = self.styles.border\n\n        # Set column widths\n        ws.column_dimensions[\"A\"].width = 30\n        ws.column_dimensions[\"B\"].width = 50\n\n        return ws\n\n\nclass ComplianceXLSXGenerator:\n    \"\"\"\n    Main XLSX generator for compliance documentation.\n\n    Generates professional compliance evidence matrices and reports with\n    consistent styling, proper structure, and support for all frameworks.\n    \"\"\"\n\n    def __init__(\n        self,\n        write_only: bool = False,\n    ) -> None:\n        \"\"\"\n        Initialize the XLSX generator.\n\n        Args:\n            write_only: Enable write_only mode for large files (>10k rows).\n                       In write_only mode, cells cannot be styled individually.\n        \"\"\"\n        self.write_only = write_only\n        self._workbook: Optional[Workbook] = None\n        self._styles: Optional[ComplianceXLSXStyles] = None\n        self._table_builder: Optional[XLSXTableBuilder] = None\n\n    def _create_workbook(self, estimated_rows: int = 0) -> Workbook:\n        \"\"\"\n        Create a new Workbook instance.\n\n        Args:\n            estimated_rows: Estimated number of rows for auto write_only decision.\n\n        Returns:\n            A new Workbook.\n        \"\"\"\n        # Auto-enable write_only for large files\n        use_write_only = self.write_only or estimated_rows > LARGE_FILE_THRESHOLD\n\n        self._workbook = Workbook(write_only=use_write_only)\n        self._styles = ComplianceXLSXStyles()\n        self._table_builder = XLSXTableBuilder(\n            self._workbook, self._styles, write_only=use_write_only\n        )\n\n        # Remove default sheet in normal mode\n        if not use_write_only and \"Sheet\" in self._workbook.sheetnames:\n            del self._workbook[\"Sheet\"]\n\n        return self._workbook\n\n    def _format_date(self, value: Any) -> Any:\n        \"\"\"\n        Format a datetime value for Excel.\n\n        Note: openpyxl auto-converts Python datetime to Excel dates.\n\n        Args:\n            value: Value to format.\n\n        Returns:\n            Formatted value (datetime or string).\n        \"\"\"\n        if value is None:\n            return \"N/A\"\n        if isinstance(value, datetime):\n            return value  # Excel auto-converts\n        return str(value)\n\n    def _format_status(self, status: Any) -> str:\n        \"\"\"Format a status value for display.\"\"\"\n        if not status:\n            return \"N/A\"\n        return str(status).replace(\"_\", \" \").title()\n\n    def _save_workbook(\n        self,\n        output: Union[str, Path, BinaryIO],\n    ) -> None:\n        \"\"\"\n        Save the workbook to a file or buffer.\n\n        Args:\n            output: Output file path or file-like object.\n        \"\"\"\n        if isinstance(output, (str, Path)):\n            output_path = Path(output)\n            output_path.parent.mkdir(parents=True, exist_ok=True)\n            self._workbook.save(str(output_path))\n        else:\n            self._workbook.save(output)\n\n    def generate_soc2_matrix(\n        self,\n        report_data: dict[str, Any],\n        output_path: Optional[Union[str, Path]] = None,\n    ) -> Path:\n        \"\"\"\n        Generate a SOC 2 evidence matrix in XLSX format.\n\n        Args:\n            report_data: SOC 2 report data dictionary.\n            output_path: Optional output file path.\n\n        Returns:\n            Path to the generated XLSX file.\n        \"\"\"\n        evidence_records = report_data.get(\"evidence_records\", [])\n        self._create_workbook(len(evidence_records))\n\n        org_name = report_data.get(\"organization_name\", \"Organization\")\n        audit_start = report_data.get(\"audit_period_start\")\n        audit_end = report_data.get(\"audit_period_end\")\n\n        # Summary sheet\n        summary_data = [\n            (\"Report Type\", \"SOC 2 Type II Evidence Matrix\"),\n            (\"Organization\", org_name),\n            (\"Audit Period Start\", self._format_date(audit_start)),\n            (\"Audit Period End\", self._format_date(audit_end)),\n            (\"Generated At\", datetime.now(timezone.utc)),\n            (\"Total Controls\", report_data.get(\"total_controls\", 0)),\n            (\"Controls Tested\", report_data.get(\"controls_tested\", 0)),\n            (\"Controls Effective\", report_data.get(\"controls_effective\", 0)),\n            (\"Controls with Exceptions\", report_data.get(\"controls_with_exceptions\", 0)),\n        ]\n        self._table_builder.create_summary_sheet(\"Summary\", summary_data)\n\n        # Evidence Matrix sheet\n        headers = [\n            \"Control ID\",\n            \"Criteria\",\n            \"Title\",\n            \"Evidence Description\",\n            \"Evidence Type\",\n            \"Collected Date\",\n            \"Design Effectiveness\",\n            \"Operating Effectiveness\",\n            \"Exceptions\",\n            \"Status\",\n        ]\n\n        rows = []\n        for record in evidence_records:\n            rows.append(\n                [\n                    record.get(\"control_id\", \"N/A\"),\n                    self._format_status(record.get(\"criteria\", \"\")),\n                    record.get(\"title\", \"N/A\"),\n                    record.get(\"description\", \"N/A\"),\n                    record.get(\"evidence_type\", \"N/A\"),\n                    self._format_date(record.get(\"collected_at\")),\n                    self._format_status(record.get(\"design_effectiveness\", \"\")),\n                    self._format_status(record.get(\"operating_effectiveness\", \"\")),\n                    record.get(\"exceptions_noted\", 0),\n                    self._format_status(record.get(\"status\", \"\")),\n                ]\n            )\n\n        self._table_builder.create_evidence_sheet(\n            sheet_name=\"Evidence Matrix\",\n            headers=headers,\n            rows=rows,\n            col_widths=[12, 18, 25, 40, 15, 15, 20, 20, 12, 15],\n            status_column=9,  # Status column (0-indexed)\n        )\n\n        # Control Mappings sheet\n        mappings = report_data.get(\"control_mappings\", [])\n        if mappings:\n            mapping_headers = [\n                \"SOC 2 Control ID\",\n                \"Guardrail Control ID\",\n                \"Guardrail Control Name\",\n                \"Mapping Rationale\",\n                \"Coverage %\",\n                \"Gaps\",\n            ]\n            mapping_rows = []\n            for m in mappings:\n                mapping_data = m if isinstance(m, dict) else m.model_dump()\n                mapping_rows.append(\n                    [\n                        mapping_data.get(\"soc2_control_id\", \"N/A\"),\n                        mapping_data.get(\"guardrail_control_id\", \"N/A\"),\n                        mapping_data.get(\"guardrail_control_name\", \"N/A\"),\n                        mapping_data.get(\"mapping_rationale\", \"N/A\"),\n                        mapping_data.get(\"coverage_percentage\", 100),\n                        \", \".join(mapping_data.get(\"gaps\", [])) or \"None\",\n                    ]\n                )\n\n            self._table_builder.create_evidence_sheet(\n                sheet_name=\"Control Mappings\",\n                headers=mapping_headers,\n                rows=mapping_rows,\n                col_widths=[18, 20, 25, 45, 12, 30],\n            )\n\n        # Trust Service Criteria breakdown sheets\n        criteria_sections = report_data.get(\"criteria_sections\", [])\n        for section in criteria_sections:\n            criteria = section.get(\"criteria\", \"unknown\")\n            criteria_name = str(criteria).replace(\"_\", \" \").title()\n\n            controls = section.get(\"controls\", [])\n            if controls:\n                tsc_headers = [\"Control ID\", \"Title\", \"Objective\", \"Guidance\"]\n                tsc_rows = []\n                for ctrl in controls:\n                    tsc_rows.append(\n                        [\n                            ctrl.get(\"control_id\", \"N/A\"),\n                            ctrl.get(\"title\", \"N/A\"),\n                            ctrl.get(\"control_objective\", \"N/A\"),\n                            ctrl.get(\"implementation_guidance\", \"N/A\") or \"N/A\",\n                        ]\n                    )\n\n                # Truncate sheet name to Excel's 31 char limit\n                sheet_name = f\"TSC - {criteria_name}\"[:31]\n                self._table_builder.create_evidence_sheet(\n                    sheet_name=sheet_name,\n                    headers=tsc_headers,\n                    rows=tsc_rows,\n                    col_widths=[15, 30, 40, 40],\n                )\n\n        # Generate output path if not provided\n        if output_path is None:\n            output_dir = _ensure_output_dir()\n            timestamp = datetime.now(timezone.utc).strftime(\"%Y%m%d_%H%M%S\")\n            output_path = output_dir / f\"soc2_matrix_{timestamp}.xlsx\"\n\n        self._save_workbook(output_path)\n\n        logger.info(f\"Generated SOC 2 XLSX matrix: {output_path}\")\n        return Path(output_path)\n\n    def generate_iso27001_matrix(\n        self,\n        report_data: dict[str, Any],\n        output_path: Optional[Union[str, Path]] = None,\n    ) -> Path:\n        \"\"\"\n        Generate an ISO 27001 evidence matrix in XLSX format.\n\n        Args:\n            report_data: ISO 27001 report data dictionary.\n            output_path: Optional output file path.\n\n        Returns:\n            Path to the generated XLSX file.\n        \"\"\"\n        evidence_records = report_data.get(\"evidence_records\", [])\n        self._create_workbook(len(evidence_records))\n\n        org_name = report_data.get(\"organization_name\", \"Organization\")\n        scope = report_data.get(\"isms_scope\", \"\")\n\n        # Summary sheet\n        summary_data = [\n            (\"Report Type\", \"ISO 27001:2022 Annex A Evidence Matrix\"),\n            (\"Organization\", org_name),\n            (\"ISMS Scope\", scope or \"Not specified\"),\n            (\"Generated At\", datetime.now(timezone.utc)),\n            (\"Total Controls\", report_data.get(\"total_controls\", 93)),\n            (\"Applicable Controls\", report_data.get(\"applicable_controls\", 0)),\n            (\"Implemented Controls\", report_data.get(\"implemented_controls\", 0)),\n            (\n                \"Implementation Percentage\",\n                f\"{report_data.get('implementation_percentage', 0):.1f}%\",\n            ),\n        ]\n        self._table_builder.create_summary_sheet(\"Summary\", summary_data)\n\n        # Statement of Applicability sheet\n        soa = report_data.get(\"statement_of_applicability\", {})\n        entries = soa.get(\"entries\", [])\n        if entries:\n            soa_headers = [\n                \"Control ID\",\n                \"Control Title\",\n                \"Theme\",\n                \"Applicable\",\n                \"Justification\",\n                \"Implementation Status\",\n                \"Implementation Method\",\n                \"Evidence Reference\",\n            ]\n            soa_rows = []\n            for entry in entries:\n                soa_rows.append(\n                    [\n                        entry.get(\"control_id\", \"N/A\"),\n                        entry.get(\"control_title\", \"N/A\"),\n                        self._format_status(entry.get(\"theme\", \"\")),\n                        \"Yes\" if entry.get(\"applicability\") in [\"applicable\", True] else \"No\",\n                        entry.get(\"justification\", \"N/A\") or \"N/A\",\n                        self._format_status(entry.get(\"implementation_status\", \"\")),\n                        entry.get(\"implementation_method\", \"N/A\") or \"N/A\",\n                        entry.get(\"evidence_reference\", \"N/A\") or \"N/A\",\n                    ]\n                )\n\n            self._table_builder.create_evidence_sheet(\n                sheet_name=\"Statement of Applicability\",\n                headers=soa_headers,\n                rows=soa_rows,\n                col_widths=[12, 35, 20, 12, 35, 20, 25, 25],\n                status_column=5,  # Implementation Status column\n            )\n\n        # Evidence Matrix sheet\n        if evidence_records:\n            evidence_headers = [\n                \"Control ID\",\n                \"Theme\",\n                \"Evidence Description\",\n                \"Evidence Type\",\n                \"Source\",\n                \"Collected Date\",\n                \"Status\",\n                \"Notes\",\n            ]\n            evidence_rows = []\n            for record in evidence_records:\n                evidence_rows.append(\n                    [\n                        record.get(\"control_id\", \"N/A\"),\n                        self._format_status(record.get(\"theme\", \"\")),\n                        record.get(\"description\", \"N/A\"),\n                        record.get(\"evidence_type\", \"N/A\"),\n                        record.get(\"source\", \"N/A\") or \"N/A\",\n                        self._format_date(record.get(\"collected_at\")),\n                        self._format_status(record.get(\"status\", \"\")),\n                        record.get(\"notes\", \"N/A\") or \"N/A\",\n                    ]\n                )\n\n            self._table_builder.create_evidence_sheet(\n                sheet_name=\"Evidence Matrix\",\n                headers=evidence_headers,\n                rows=evidence_rows,\n                col_widths=[12, 20, 40, 15, 20, 15, 15, 30],\n                status_column=6,\n            )\n\n        # Theme breakdown sheets\n        theme_sections = report_data.get(\"theme_sections\", [])\n        for section in theme_sections:\n            theme = section.get(\"theme\", \"unknown\")\n            theme_name = str(theme).replace(\"_\", \" \").title()\n\n            controls = section.get(\"controls\", [])\n            if controls:\n                theme_headers = [\n                    \"Control ID\",\n                    \"Title\",\n                    \"Description\",\n                    \"Status\",\n                ]\n                theme_rows = []\n                for ctrl in controls:\n                    theme_rows.append(\n                        [\n                            ctrl.get(\"control_id\", \"N/A\"),\n                            ctrl.get(\"title\", \"N/A\"),\n                            ctrl.get(\"description\", \"N/A\"),\n                            self._format_status(ctrl.get(\"status\", \"\")),\n                        ]\n                    )\n\n                # Truncate sheet name to Excel's 31 char limit\n                sheet_name = theme_name[:31]\n                self._table_builder.create_evidence_sheet(\n                    sheet_name=sheet_name,\n                    headers=theme_headers,\n                    rows=theme_rows,\n                    col_widths=[12, 30, 50, 18],\n                    status_column=3,\n                )\n\n        # Generate output path if not provided\n        if output_path is None:\n            output_dir = _ensure_output_dir()\n            timestamp = datetime.now(timezone.utc).strftime(\"%Y%m%d_%H%M%S\")\n            output_path = output_dir / f\"iso27001_matrix_{timestamp}.xlsx\"\n\n        self._save_workbook(output_path)\n\n        logger.info(f\"Generated ISO 27001 XLSX matrix: {output_path}\")\n        return Path(output_path)\n\n    def generate_gdpr_matrix(\n        self,\n        report_data: dict[str, Any],\n        output_path: Optional[Union[str, Path]] = None,\n    ) -> Path:\n        \"\"\"\n        Generate a GDPR Article 30 records matrix in XLSX format.\n\n        Args:\n            report_data: GDPR report data dictionary.\n            output_path: Optional output file path.\n\n        Returns:\n            Path to the generated XLSX file.\n        \"\"\"\n        processing_activities = []\n        controller_record = report_data.get(\"controller_record\", {})\n        if controller_record:\n            processing_activities = controller_record.get(\"processing_activities\", [])\n\n        self._create_workbook(len(processing_activities))\n\n        org_name = report_data.get(\"organization_name\", \"Organization\")\n        entity_role = report_data.get(\"entity_role\", \"controller\")\n\n        # Summary sheet\n        summary_data = [\n            (\"Report Type\", \"GDPR Article 30 Records of Processing\"),\n            (\"Organization\", org_name),\n            (\"Entity Role\", self._format_status(entity_role)),\n            (\"Generated At\", datetime.now(timezone.utc)),\n            (\"Total Processing Activities\", len(processing_activities)),\n            (\"Controller\", controller_record.get(\"controller_name\", \"N/A\")),\n        ]\n\n        # Add DPO info if available\n        dpo = controller_record.get(\"dpo\", {})\n        if dpo:\n            summary_data.append((\"DPO Name\", dpo.get(\"name\", \"N/A\")))\n            summary_data.append((\"DPO Email\", dpo.get(\"email\", \"N/A\")))\n\n        self._table_builder.create_summary_sheet(\"Summary\", summary_data)\n\n        # Processing Activities sheet (Article 30(1))\n        if processing_activities:\n            pa_headers = [\n                \"Activity Name\",\n                \"Processing ID\",\n                \"Purposes\",\n                \"Lawful Basis\",\n                \"Data Subject Categories\",\n                \"Personal Data Categories\",\n                \"Recipients\",\n                \"Third Country Transfers\",\n                \"Retention Period\",\n                \"Security Measures\",\n                \"Status\",\n            ]\n            pa_rows = []\n            for activity in processing_activities:\n                purposes = activity.get(\"purposes\", [])\n                purposes_str = \", \".join(purposes[:3])\n                if len(purposes) > 3:\n                    purposes_str += f\" (+{len(purposes) - 3} more)\"\n\n                recipients = activity.get(\"recipients\", [])\n                recipients_str = \", \".join(\n                    [\n                        r.get(\"name\", str(r)) if isinstance(r, dict) else str(r)\n                        for r in recipients[:2]\n                    ]\n                )\n                if len(recipients) > 2:\n                    recipients_str += f\" (+{len(recipients) - 2} more)\"\n\n                data_subjects = activity.get(\"data_subject_categories\", [])\n                data_categories = activity.get(\"personal_data_categories\", [])\n\n                pa_rows.append(\n                    [\n                        activity.get(\"name\", \"N/A\"),\n                        activity.get(\"processing_id\", \"N/A\"),\n                        purposes_str or \"N/A\",\n                        self._format_status(activity.get(\"lawful_basis\", \"\")),\n                        \", \".join(data_subjects[:2]) if data_subjects else \"N/A\",\n                        \", \".join(data_categories[:2]) if data_categories else \"N/A\",\n                        recipients_str or \"N/A\",\n                        \"Yes\" if activity.get(\"third_country_transfers\") else \"No\",\n                        activity.get(\"retention_period\", \"N/A\") or \"N/A\",\n                        activity.get(\"security_measures_summary\", \"N/A\") or \"N/A\",\n                        self._format_status(activity.get(\"status\", \"\")),\n                    ]\n                )\n\n            self._table_builder.create_evidence_sheet(\n                sheet_name=\"Processing Activities\",\n                headers=pa_headers,\n                rows=pa_rows,\n                col_widths=[25, 15, 30, 18, 25, 25, 25, 15, 20, 25, 15],\n                status_column=10,\n            )\n\n        # Data Flows sheet\n        data_flows = report_data.get(\"data_flows\", [])\n        if data_flows:\n            df_headers = [\n                \"Flow Name\",\n                \"Flow ID\",\n                \"Data Source\",\n                \"Data Destination\",\n                \"Data Categories\",\n                \"Crosses Border\",\n                \"Transfer Mechanism\",\n                \"Encryption in Transit\",\n            ]\n            df_rows = []\n            for flow in data_flows:\n                categories = flow.get(\"data_categories\", [])\n                df_rows.append(\n                    [\n                        flow.get(\"name\", \"N/A\"),\n                        flow.get(\"flow_id\", \"N/A\"),\n                        flow.get(\"data_source\", \"N/A\"),\n                        flow.get(\"data_destination\", \"N/A\"),\n                        \", \".join(categories[:3]) if categories else \"N/A\",\n                        \"Yes\" if flow.get(\"crosses_border\") else \"No\",\n                        flow.get(\"transfer_mechanism\", \"N/A\") or \"N/A\",\n                        \"Yes\" if flow.get(\"encrypted_in_transit\") else \"No\",\n                    ]\n                )\n\n            self._table_builder.create_evidence_sheet(\n                sheet_name=\"Data Flows\",\n                headers=df_headers,\n                rows=df_rows,\n                col_widths=[25, 15, 25, 25, 30, 15, 25, 18],\n            )\n\n        # Security Measures sheet\n        security_measures = report_data.get(\"security_measures\", [])\n        if security_measures:\n            sm_headers = [\n                \"Measure ID\",\n                \"Category\",\n                \"Description\",\n                \"Implementation Status\",\n                \"Last Reviewed\",\n            ]\n            sm_rows = []\n            for measure in security_measures:\n                measure_data = (\n                    measure if isinstance(measure, dict) else {\"description\": str(measure)}\n                )\n                sm_rows.append(\n                    [\n                        measure_data.get(\"measure_id\", \"N/A\"),\n                        self._format_status(measure_data.get(\"category\", \"\")),\n                        measure_data.get(\"description\", str(measure)),\n                        self._format_status(measure_data.get(\"status\", \"implemented\")),\n                        self._format_date(measure_data.get(\"last_reviewed\")),\n                    ]\n                )\n\n            self._table_builder.create_evidence_sheet(\n                sheet_name=\"Security Measures\",\n                headers=sm_headers,\n                rows=sm_rows,\n                col_widths=[15, 20, 50, 20, 15],\n                status_column=3,\n            )\n\n        # Generate output path if not provided\n        if output_path is None:\n            output_dir = _ensure_output_dir()\n            timestamp = datetime.now(timezone.utc).strftime(\"%Y%m%d_%H%M%S\")\n            output_path = output_dir / f\"gdpr_matrix_{timestamp}.xlsx\"\n\n        self._save_workbook(output_path)\n\n        logger.info(f\"Generated GDPR XLSX matrix: {output_path}\")\n        return Path(output_path)\n\n    def generate_euaiact_matrix(\n        self,\n        report_data: dict[str, Any],\n        output_path: Optional[Union[str, Path]] = None,\n    ) -> Path:\n        \"\"\"\n        Generate an EU AI Act compliance matrix in XLSX format.\n\n        Args:\n            report_data: EU AI Act report data dictionary.\n            output_path: Optional output file path.\n\n        Returns:\n            Path to the generated XLSX file.\n        \"\"\"\n        ai_systems = report_data.get(\"ai_systems\", [])\n        self._create_workbook(len(ai_systems))\n\n        org_name = report_data.get(\"organization_name\", \"Organization\")\n        org_role = report_data.get(\"organization_role\", \"provider\")\n\n        # Summary sheet\n        high_risk = report_data.get(\"high_risk_systems_count\", 0)\n        limited_risk = report_data.get(\"limited_risk_systems_count\", 0)\n        minimal_risk = report_data.get(\"minimal_risk_systems_count\", 0)\n\n        summary_data = [\n            (\"Report Type\", \"EU AI Act Compliance Matrix\"),\n            (\"Organization\", org_name),\n            (\"Organization Role\", self._format_status(org_role)),\n            (\"Generated At\", datetime.now(timezone.utc)),\n            (\"Total AI Systems\", len(ai_systems)),\n            (\"High-Risk Systems\", high_risk),\n            (\"Limited-Risk Systems\", limited_risk),\n            (\"Minimal-Risk Systems\", minimal_risk),\n        ]\n        self._table_builder.create_summary_sheet(\"Summary\", summary_data)\n\n        # AI Systems Inventory sheet\n        if ai_systems:\n            sys_headers = [\n                \"System ID\",\n                \"System Name\",\n                \"Risk Level\",\n                \"High-Risk Category\",\n                \"Intended Purpose\",\n                \"Provider/Deployer\",\n                \"Compliance Status\",\n                \"Last Assessment\",\n            ]\n            sys_rows = []\n            for system in ai_systems:\n                sys_rows.append(\n                    [\n                        system.get(\"system_id\", \"N/A\"),\n                        system.get(\"system_name\", \"N/A\"),\n                        self._format_status(system.get(\"risk_level\", \"\")),\n                        system.get(\"high_risk_category\", \"N/A\") or \"N/A\",\n                        (\n                            system.get(\"intended_purpose\", \"N/A\")[:50] + \"...\"\n                            if len(system.get(\"intended_purpose\", \"\")) > 50\n                            else system.get(\"intended_purpose\", \"N/A\")\n                        ),\n                        self._format_status(system.get(\"provider_role\", \"\")),\n                        self._format_status(system.get(\"compliance_status\", \"\")),\n                        self._format_date(system.get(\"last_assessment_date\")),\n                    ]\n                )\n\n            self._table_builder.create_evidence_sheet(\n                sheet_name=\"AI Systems Inventory\",\n                headers=sys_headers,\n                rows=sys_rows,\n                col_widths=[15, 25, 15, 20, 35, 18, 18, 15],\n                status_column=6,\n            )\n\n        # Risk Assessments sheet\n        risk_assessments = report_data.get(\"risk_assessments\", [])\n        if risk_assessments:\n            ra_headers = [\n                \"Assessment ID\",\n                \"System Name\",\n                \"Risk Level\",\n                \"High-Risk Category\",\n                \"Assessment Date\",\n                \"Assessor\",\n                \"Key Findings\",\n                \"Recommendations\",\n            ]\n            ra_rows = []\n            for assessment in risk_assessments:\n                ra_rows.append(\n                    [\n                        assessment.get(\"assessment_id\", \"N/A\"),\n                        assessment.get(\"system_name\", \"N/A\"),\n                        self._format_status(assessment.get(\"risk_level\", \"\")),\n                        assessment.get(\"high_risk_category\", \"N/A\") or \"N/A\",\n                        self._format_date(assessment.get(\"assessment_date\")),\n                        assessment.get(\"assessor\", \"N/A\") or \"N/A\",\n                        assessment.get(\"key_findings\", \"N/A\") or \"N/A\",\n                        assessment.get(\"recommendations\", \"N/A\") or \"N/A\",\n                    ]\n                )\n\n            self._table_builder.create_evidence_sheet(\n                sheet_name=\"Risk Assessments\",\n                headers=ra_headers,\n                rows=ra_rows,\n                col_widths=[15, 25, 15, 20, 15, 20, 35, 35],\n            )\n\n        # Conformity Assessments sheet\n        conformity_assessments = report_data.get(\"conformity_assessments\", [])\n        if conformity_assessments:\n            ca_headers = [\n                \"System ID\",\n                \"Assessment Type\",\n                \"Assessment Date\",\n                \"Result\",\n                \"Certificate Number\",\n                \"Expiry Date\",\n                \"Notified Body\",\n                \"Notes\",\n            ]\n            ca_rows = []\n            for ca in conformity_assessments:\n                ca_rows.append(\n                    [\n                        ca.get(\"system_id\", \"N/A\"),\n                        self._format_status(ca.get(\"assessment_type\", \"\")),\n                        self._format_date(ca.get(\"assessment_date\")),\n                        self._format_status(ca.get(\"assessment_result\", \"\")),\n                        ca.get(\"certificate_number\", \"N/A\") or \"N/A\",\n                        self._format_date(ca.get(\"expiry_date\")),\n                        ca.get(\"notified_body\", \"N/A\") or \"N/A\",\n                        ca.get(\"notes\", \"N/A\") or \"N/A\",\n                    ]\n                )\n\n            self._table_builder.create_evidence_sheet(\n                sheet_name=\"Conformity Assessments\",\n                headers=ca_headers,\n                rows=ca_rows,\n                col_widths=[15, 22, 15, 15, 20, 15, 25, 30],\n                status_column=3,\n            )\n\n        # Technical Documentation Checklist (Annex IV)\n        tech_docs = report_data.get(\"technical_documentation\", [])\n        if tech_docs:\n            td_headers = [\n                \"System Name\",\n                \"General Description\",\n                \"Elements & Development\",\n                \"Monitoring & Functioning\",\n                \"Risk Management\",\n                \"Data Governance\",\n                \"Human Oversight\",\n                \"Overall Status\",\n            ]\n            td_rows = []\n            for doc in tech_docs:\n                reqs = doc.get(\"annex_iv_requirements\", {})\n                td_rows.append(\n                    [\n                        doc.get(\"system_name\", \"N/A\"),\n                        \"Complete\" if reqs.get(\"general_description\") else \"Incomplete\",\n                        \"Complete\" if reqs.get(\"elements_development\") else \"Incomplete\",\n                        \"Complete\" if reqs.get(\"monitoring_functioning\") else \"Incomplete\",\n                        \"Complete\" if reqs.get(\"risk_management\") else \"Incomplete\",\n                        \"Complete\" if reqs.get(\"data_governance\") else \"Incomplete\",\n                        \"Complete\" if reqs.get(\"human_oversight\") else \"Incomplete\",\n                        self._format_status(doc.get(\"documentation_status\", \"\")),\n                    ]\n                )\n\n            self._table_builder.create_evidence_sheet(\n                sheet_name=\"Technical Documentation\",\n                headers=td_headers,\n                rows=td_rows,\n                col_widths=[25, 18, 20, 20, 18, 18, 18, 15],\n                status_column=7,\n            )\n\n        # Generate output path if not provided\n        if output_path is None:\n            output_dir = _ensure_output_dir()\n            timestamp = datetime.now(timezone.utc).strftime(\"%Y%m%d_%H%M%S\")\n            output_path = output_dir / f\"euaiact_matrix_{timestamp}.xlsx\"\n\n        self._save_workbook(output_path)\n\n        logger.info(f\"Generated EU AI Act XLSX matrix: {output_path}\")\n        return Path(output_path)\n\n\ndef generate_xlsx(\n    report_data: dict[str, Any],\n    framework: Union[str, ComplianceFramework],\n    output_path: Optional[Union[str, Path]] = None,\n    write_only: bool = False,\n) -> Path:\n    \"\"\"\n    Generate an XLSX compliance evidence matrix for the specified framework.\n\n    This is the main entry point for XLSX generation.\n\n    Args:\n        report_data: Report data dictionary containing all compliance information.\n        framework: Compliance framework (soc2, iso27001, gdpr, euaiact).\n        output_path: Optional output file path. If not provided, a default path is used.\n        write_only: Enable write_only mode for large files. Automatically enabled\n                   when data exceeds 10,000 rows.\n\n    Returns:\n        Path to the generated XLSX file.\n\n    Raises:\n        ValueError: If the framework is not supported.\n\n    Example:\n        >>> from acgs2.services.compliance_docs.src.generators.xlsx_generator import (\n        ...     generate_xlsx\n        ... )\n        >>> path = generate_xlsx(\n        ...     report_data={\"organization_name\": \"Acme Corp\", ...},\n        ...     framework=\"soc2\",\n        ... )\n        >>> print(f\"Matrix generated at: {path}\")\n    \"\"\"\n    generator = ComplianceXLSXGenerator(write_only=write_only)\n\n    # Normalize framework\n    if isinstance(framework, ComplianceFramework):\n        framework_str = framework.value\n    else:\n        framework_str = str(framework).lower()\n\n    if framework_str == \"soc2\":\n        return generator.generate_soc2_matrix(report_data, output_path)\n    elif framework_str == \"iso27001\":\n        return generator.generate_iso27001_matrix(report_data, output_path)\n    elif framework_str == \"gdpr\":\n        return generator.generate_gdpr_matrix(report_data, output_path)\n    elif framework_str == \"euaiact\":\n        return generator.generate_euaiact_matrix(report_data, output_path)\n    else:\n        raise ValueError(\n            f\"Unsupported framework: {framework}. \"\n            f\"Supported frameworks: soc2, iso27001, gdpr, euaiact\"\n        )\n\n\ndef generate_xlsx_to_buffer(\n    report_data: dict[str, Any],\n    framework: Union[str, ComplianceFramework],\n    write_only: bool = False,\n) -> io.BytesIO:\n    \"\"\"\n    Generate an XLSX compliance evidence matrix to an in-memory buffer.\n\n    This is useful for streaming responses without writing to disk.\n\n    Args:\n        report_data: Report data dictionary containing all compliance information.\n        framework: Compliance framework (soc2, iso27001, gdpr, euaiact).\n        write_only: Enable write_only mode for large files.\n\n    Returns:\n        BytesIO buffer containing the generated XLSX.\n\n    Raises:\n        ValueError: If the framework is not supported.\n\n    Example:\n        >>> buffer = generate_xlsx_to_buffer(report_data, \"soc2\")\n        >>> # Use buffer.getvalue() to get bytes for streaming\n    \"\"\"\n    buffer = io.BytesIO()\n    generator = ComplianceXLSXGenerator(write_only=write_only)\n\n    # Normalize framework\n    if isinstance(framework, ComplianceFramework):\n        framework_str = framework.value\n    else:\n        framework_str = str(framework).lower()\n\n    # Create workbook and generate content\n    org_name = report_data.get(\"organization_name\", \"Organization\")\n\n    if framework_str == \"soc2\":\n        generator._create_workbook()\n        summary_data = [\n            (\"Report Type\", \"SOC 2 Type II Evidence Matrix\"),\n            (\"Organization\", org_name),\n            (\"Generated At\", datetime.now(timezone.utc)),\n        ]\n        generator._table_builder.create_summary_sheet(\"Summary\", summary_data)\n        generator._table_builder.create_evidence_sheet(\n            sheet_name=\"Evidence Matrix\",\n            headers=[\"Control ID\", \"Criteria\", \"Description\", \"Status\"],\n            rows=[[\"See generate_xlsx() for full implementation\", \"\", \"\", \"\"]],\n        )\n    elif framework_str == \"iso27001\":\n        generator._create_workbook()\n        summary_data = [\n            (\"Report Type\", \"ISO 27001:2022 Annex A Evidence Matrix\"),\n            (\"Organization\", org_name),\n            (\"Generated At\", datetime.now(timezone.utc)),\n        ]\n        generator._table_builder.create_summary_sheet(\"Summary\", summary_data)\n        generator._table_builder.create_evidence_sheet(\n            sheet_name=\"Evidence Matrix\",\n            headers=[\"Control ID\", \"Theme\", \"Description\", \"Status\"],\n            rows=[[\"See generate_xlsx() for full implementation\", \"\", \"\", \"\"]],\n        )\n    elif framework_str == \"gdpr\":\n        generator._create_workbook()\n        summary_data = [\n            (\"Report Type\", \"GDPR Article 30 Records\"),\n            (\"Organization\", org_name),\n            (\"Generated At\", datetime.now(timezone.utc)),\n        ]\n        generator._table_builder.create_summary_sheet(\"Summary\", summary_data)\n        generator._table_builder.create_evidence_sheet(\n            sheet_name=\"Processing Activities\",\n            headers=[\"Activity\", \"Purposes\", \"Data Categories\", \"Status\"],\n            rows=[[\"See generate_xlsx() for full implementation\", \"\", \"\", \"\"]],\n        )\n    elif framework_str == \"euaiact\":\n        generator._create_workbook()\n        summary_data = [\n            (\"Report Type\", \"EU AI Act Compliance Matrix\"),\n            (\"Organization\", org_name),\n            (\"Generated At\", datetime.now(timezone.utc)),\n        ]\n        generator._table_builder.create_summary_sheet(\"Summary\", summary_data)\n        generator._table_builder.create_evidence_sheet(\n            sheet_name=\"AI Systems\",\n            headers=[\"System ID\", \"Name\", \"Risk Level\", \"Status\"],\n            rows=[[\"See generate_xlsx() for full implementation\", \"\", \"\", \"\"]],\n        )\n    else:\n        raise ValueError(\n            f\"Unsupported framework: {framework}. \"\n            f\"Supported frameworks: soc2, iso27001, gdpr, euaiact\"\n        )\n\n    generator._save_workbook(buffer)\n    buffer.seek(0)\n    return buffer\n",
        "timestamp": "2026-01-04T05:35:58.374613"
      },
      "worktree_state": null,
      "task_intent": {
        "title": "056-reduce-excessive-any-type-usage-in-python-codebase",
        "description": "Found 373 occurrences of ': Any' type annotations across 120+ Python files, with high concentrations in integration-service (16 occurrences), src/core/breakthrough (79 occurrences), and src/core/enhanced_agent_bus (50+ occurrences). Excessive use of 'Any' defeats the purpose of type hints and can mask type-related bugs.",
        "from_plan": true
      },
      "commits_behind_main": 0,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2026-01-03T19:36:18.080211",
  "last_updated": "2026-01-04T05:35:58.646510"
}