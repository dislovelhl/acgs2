{
  "file_path": "analytics-dashboard/src/layouts/DashboardGrid.tsx",
  "main_branch_history": [],
  "task_views": {
    "034-add-compliancewidget-to-analytics-dashboard": {
      "task_id": "034-add-compliancewidget-to-analytics-dashboard",
      "branch_point": {
        "commit_hash": "fc6e42927298263034acf989773f3200e422ad17",
        "content": "/**\n * DashboardGrid Component\n *\n * Implements a customizable dashboard layout using react-grid-layout.\n * Features:\n * - Drag-and-drop widget repositioning\n * - Responsive layouts for different screen sizes\n * - localStorage persistence for user layouts\n * - Automatic grid layout with widget placeholders\n */\n\nimport { useCallback, useEffect, useRef, useState } from \"react\";\nimport { Responsive, WidthProvider, Layout, Layouts } from \"react-grid-layout\";\nimport { GripVertical, Lock, RotateCcw, Unlock } from \"lucide-react\";\n\n// Import required CSS for react-grid-layout\nimport \"react-grid-layout/css/styles.css\";\nimport \"react-resizable/css/styles.css\";\n\n// Import widget components\nimport { InsightWidget } from \"../components/widgets/InsightWidget\";\nimport { AnomalyWidget } from \"../components/widgets/AnomalyWidget\";\nimport { PredictionWidget } from \"../components/widgets/PredictionWidget\";\nimport { ComplianceWidget } from \"../components/widgets/ComplianceWidget\";\nimport { Tooltip } from \"../components/common/Tooltip\";\n\n// Create responsive grid layout component\nconst ResponsiveGridLayout = WidthProvider(Responsive);\n\n/** localStorage key for persisting layout */\nconst LAYOUT_STORAGE_KEY = \"acgs-analytics-dashboard-layout\";\n\n/** Widget identifiers */\ntype WidgetId = \"insights\" | \"anomalies\" | \"predictions\" | \"compliance\";\n\n/** Widget configuration */\ninterface WidgetConfig {\n  id: WidgetId;\n  title: string;\n  component: React.ReactNode;\n  defaultLayout: {\n    x: number;\n    y: number;\n    w: number;\n    h: number;\n    minW?: number;\n    minH?: number;\n  };\n}\n\n/** Default widget configurations */\nconst WIDGET_CONFIGS: WidgetConfig[] = [\n  {\n    id: \"insights\",\n    title: \"AI Insights\",\n    component: <InsightWidget />,\n    defaultLayout: { x: 0, y: 0, w: 6, h: 10, minW: 3, minH: 6 },\n  },\n  {\n    id: \"anomalies\",\n    title: \"Anomaly Detection\",\n    component: <AnomalyWidget />,\n    defaultLayout: { x: 6, y: 0, w: 6, h: 10, minW: 3, minH: 6 },\n  },\n  {\n    id: \"predictions\",\n    title: \"Violation Forecast\",\n    component: <PredictionWidget />,\n    defaultLayout: { x: 0, y: 10, w: 12, h: 12, minW: 6, minH: 8 },\n  },\n  {\n    id: \"compliance\",\n    title: \"Compliance Status\",\n    component: <ComplianceWidget />,\n    defaultLayout: { x: 0, y: 20, w: 6, h: 10, minW: 3, minH: 6 },\n  },\n];\n\n/** Breakpoint definitions for responsive layouts */\nconst BREAKPOINTS = { lg: 1200, md: 996, sm: 768, xs: 480, xxs: 0 };\n\n/** Column definitions per breakpoint */\nconst COLS = { lg: 12, md: 10, sm: 6, xs: 4, xxs: 2 };\n\n/** Row height in pixels */\nconst ROW_HEIGHT = 30;\n\n/**\n * Generates default layouts for all breakpoints\n */\nfunction generateDefaultLayouts(): Layouts {\n  const layouts: Layouts = {};\n\n  // Large screens (lg) - full 2-column layout\n  layouts.lg = WIDGET_CONFIGS.map((widget) => ({\n    i: widget.id,\n    ...widget.defaultLayout,\n  }));\n\n  // Medium screens (md) - slightly condensed\n  layouts.md = WIDGET_CONFIGS.map((widget) => ({\n    i: widget.id,\n    x: widget.id === \"predictions\" ? 0 : widget.defaultLayout.x === 0 ? 0 : 5,\n    y: widget.defaultLayout.y,\n    w: widget.id === \"predictions\" ? 10 : 5,\n    h: widget.defaultLayout.h,\n    minW: widget.defaultLayout.minW,\n    minH: widget.defaultLayout.minH,\n  }));\n\n  // Small screens (sm) - stacked layout\n  layouts.sm = WIDGET_CONFIGS.map((widget, index) => ({\n    i: widget.id,\n    x: 0,\n    y: index * 10,\n    w: 6,\n    h: widget.id === \"predictions\" ? 12 : 10,\n    minW: Math.min(widget.defaultLayout.minW || 3, 6),\n    minH: widget.defaultLayout.minH,\n  }));\n\n  // Extra small screens (xs) - compact stacked layout\n  layouts.xs = WIDGET_CONFIGS.map((widget, index) => ({\n    i: widget.id,\n    x: 0,\n    y: index * 10,\n    w: 4,\n    h: widget.id === \"predictions\" ? 12 : 10,\n    minW: Math.min(widget.defaultLayout.minW || 3, 4),\n    minH: widget.defaultLayout.minH,\n  }));\n\n  // Tiny screens (xxs) - fully stacked\n  layouts.xxs = WIDGET_CONFIGS.map((widget, index) => ({\n    i: widget.id,\n    x: 0,\n    y: index * 12,\n    w: 2,\n    h: 12,\n    minW: 2,\n    minH: widget.defaultLayout.minH,\n  }));\n\n  return layouts;\n}\n\n/**\n * Saves layouts to localStorage\n */\nfunction saveLayoutsToStorage(layouts: Layouts): void {\n  try {\n    localStorage.setItem(LAYOUT_STORAGE_KEY, JSON.stringify(layouts));\n  } catch (error) {\n    // Handle localStorage errors gracefully (e.g., quota exceeded)\n    if (error instanceof Error) {\n      console.warn(\"Failed to save dashboard layout:\", error.message);\n    }\n  }\n}\n\n/**\n * Loads layouts from localStorage with validation\n */\nfunction loadLayoutsFromStorage(): Layouts | null {\n  try {\n    const storedLayouts = localStorage.getItem(LAYOUT_STORAGE_KEY);\n    if (!storedLayouts) {\n      return null;\n    }\n\n    const parsed = JSON.parse(storedLayouts);\n\n    // Validate that parsed data is a valid Layouts object\n    if (typeof parsed !== \"object\" || parsed === null) {\n      console.warn(\"Invalid layout data in localStorage, resetting to default\");\n      localStorage.removeItem(LAYOUT_STORAGE_KEY);\n      return null;\n    }\n\n    // Validate that each breakpoint contains valid layout arrays\n    const validBreakpoints = Object.keys(BREAKPOINTS);\n    for (const breakpoint of validBreakpoints) {\n      if (parsed[breakpoint]) {\n        if (!Array.isArray(parsed[breakpoint])) {\n          console.warn(\n            `Invalid layout for breakpoint ${breakpoint}, resetting to default`\n          );\n          localStorage.removeItem(LAYOUT_STORAGE_KEY);\n          return null;\n        }\n\n        // Validate each layout item has required properties\n        for (const item of parsed[breakpoint]) {\n          if (\n            typeof item.i !== \"string\" ||\n            typeof item.x !== \"number\" ||\n            typeof item.y !== \"number\" ||\n            typeof item.w !== \"number\" ||\n            typeof item.h !== \"number\"\n          ) {\n            console.warn(\n              `Invalid layout item in ${breakpoint}, resetting to default`\n            );\n            localStorage.removeItem(LAYOUT_STORAGE_KEY);\n            return null;\n          }\n        }\n      }\n    }\n\n    return parsed as Layouts;\n  } catch (error) {\n    // Handle corrupted JSON or other parsing errors\n    if (error instanceof Error) {\n      console.warn(\n        \"Failed to parse dashboard layout from localStorage:\",\n        error.message\n      );\n    }\n    localStorage.removeItem(LAYOUT_STORAGE_KEY);\n    return null;\n  }\n}\n\n/**\n * DashboardGrid - Main dashboard component with draggable/resizable widgets\n *\n * Features:\n * - Drag and drop widget repositioning\n * - Widget resizing\n * - Responsive layouts for different screen sizes\n * - Layout persistence to localStorage\n * - Layout lock toggle\n * - Reset to default layout\n */\nexport function DashboardGrid(): JSX.Element {\n  const containerRef = useRef<HTMLDivElement>(null);\n  const [mounted, setMounted] = useState(false);\n  const [layouts, setLayouts] = useState<Layouts>(() => {\n    // Try to load from storage, fall back to defaults\n    return loadLayoutsFromStorage() || generateDefaultLayouts();\n  });\n  const [isLocked, setIsLocked] = useState(false);\n\n  // Set mounted state after component mounts (prevents hydration issues)\n  useEffect(() => {\n    setMounted(true);\n  }, []);\n\n  /**\n   * Handle layout changes from react-grid-layout\n   * Persists new layouts to localStorage\n   */\n  const handleLayoutChange = useCallback(\n    (currentLayout: Layout[], allLayouts: Layouts) => {\n      setLayouts(allLayouts);\n      saveLayoutsToStorage(allLayouts);\n    },\n    []\n  );\n\n  /**\n   * Reset layouts to default configuration\n   */\n  const handleResetLayout = useCallback(() => {\n    const defaultLayouts = generateDefaultLayouts();\n    setLayouts(defaultLayouts);\n    saveLayoutsToStorage(defaultLayouts);\n  }, []);\n\n  /**\n   * Toggle layout lock state\n   */\n  const handleToggleLock = useCallback(() => {\n    setIsLocked((prev) => !prev);\n  }, []);\n\n  // Don't render grid until mounted to prevent hydration mismatch\n  if (!mounted) {\n    return (\n      <div className=\"flex h-96 items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"mx-auto h-8 w-8 animate-spin rounded-full border-4 border-indigo-600 border-t-transparent\"></div>\n          <p className=\"mt-4 text-sm text-gray-500\">Loading dashboard...</p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div ref={containerRef} className=\"dashboard-grid\">\n      {/* Dashboard Controls */}\n      <div className=\"mb-4 flex items-center justify-between\">\n        <div className=\"flex items-center gap-2 text-sm text-gray-500\">\n          <GripVertical className=\"h-4 w-4\" />\n          <span>Drag widgets to rearrange</span>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <Tooltip\n            content={\n              isLocked ? (\n                <div className=\"max-w-xs\">\n                  <strong>Layout Locked</strong>\n                  <p className=\"mt-1 text-xs\">\n                    Widgets cannot be moved or resized. Click to unlock and\n                    enable rearranging.\n                  </p>\n                </div>\n              ) : (\n                <div className=\"max-w-xs\">\n                  <strong>Layout Unlocked</strong>\n                  <p className=\"mt-1 text-xs\">\n                    Widgets can be freely rearranged and resized. Click to lock\n                    and prevent changes.\n                  </p>\n                </div>\n              )\n            }\n            position=\"bottom\"\n          >\n            <button\n              onClick={handleToggleLock}\n              className={`flex items-center gap-1.5 rounded-md px-3 py-1.5 text-sm font-medium transition-colors ${\n                isLocked\n                  ? \"bg-yellow-100 text-yellow-700 hover:bg-yellow-200\"\n                  : \"bg-gray-100 text-gray-600 hover:bg-gray-200\"\n              }`}\n              title={isLocked ? \"Unlock layout\" : \"Lock layout\"}\n              aria-label={isLocked ? \"Unlock layout\" : \"Lock layout\"}\n            >\n              {isLocked ? (\n                <>\n                  <Lock className=\"h-4 w-4\" />\n                  Locked\n                </>\n              ) : (\n                <>\n                  <Unlock className=\"h-4 w-4\" />\n                  Unlocked\n                </>\n              )}\n            </button>\n          </Tooltip>\n          <Tooltip\n            content={\n              <div className=\"max-w-xs\">\n                <strong>Reset Layout</strong>\n                <p className=\"mt-1 text-xs\">\n                  Restore all widgets to their default positions and sizes.\n                  Custom arrangements will be lost.\n                </p>\n              </div>\n            }\n            position=\"bottom\"\n          >\n            <button\n              onClick={handleResetLayout}\n              className=\"flex items-center gap-1.5 rounded-md bg-gray-100 px-3 py-1.5 text-sm font-medium text-gray-600 transition-colors hover:bg-gray-200\"\n              title=\"Reset to default layout\"\n              aria-label=\"Reset to default layout\"\n            >\n              <RotateCcw className=\"h-4 w-4\" />\n              Reset Layout\n            </button>\n          </Tooltip>\n        </div>\n      </div>\n\n      {/* Responsive Grid Layout */}\n      <ResponsiveGridLayout\n        className=\"layout\"\n        layouts={layouts}\n        breakpoints={BREAKPOINTS}\n        cols={COLS}\n        rowHeight={ROW_HEIGHT}\n        onLayoutChange={handleLayoutChange}\n        isDraggable={!isLocked}\n        isResizable={!isLocked}\n        draggableHandle=\".widget-drag-handle\"\n        margin={[16, 16]}\n        containerPadding={[0, 0]}\n        useCSSTransforms={true}\n        compactType=\"vertical\"\n        preventCollision={false}\n      >\n        {WIDGET_CONFIGS.map((widget) => (\n          <div\n            key={widget.id}\n            className=\"widget-container relative overflow-hidden rounded-lg bg-white shadow-lg\"\n          >\n            {/* Drag handle - only visible when layout is unlocked */}\n            {!isLocked && (\n              <div\n                className=\"widget-drag-handle absolute left-0 right-0 top-0 z-10 flex cursor-move items-center justify-center bg-gradient-to-b from-gray-100 to-transparent py-1 opacity-0 transition-opacity hover:opacity-100\"\n                title={`Drag to move ${widget.title}`}\n              >\n                <div className=\"flex items-center gap-1 rounded-full bg-gray-200 px-2 py-0.5 text-xs text-gray-600\">\n                  <GripVertical className=\"h-3 w-3\" />\n                  <span>Drag</span>\n                </div>\n              </div>\n            )}\n            {/* Widget content */}\n            <div className=\"h-full w-full\">{widget.component}</div>\n          </div>\n        ))}\n      </ResponsiveGridLayout>\n\n      {/* Custom styles for grid layout */}\n      <style>{`\n        .react-grid-item {\n          transition: all 200ms ease;\n          transition-property: left, top;\n        }\n        .react-grid-item.cssTransforms {\n          transition-property: transform;\n        }\n        .react-grid-item.resizing {\n          z-index: 1;\n          will-change: width, height;\n        }\n        .react-grid-item.react-draggable-dragging {\n          transition: none;\n          z-index: 3;\n          will-change: transform;\n        }\n        .react-grid-item.dropping {\n          visibility: hidden;\n        }\n        .react-grid-item.react-grid-placeholder {\n          background: rgb(99 102 241 / 0.2);\n          border-radius: 0.5rem;\n          transition-duration: 100ms;\n          z-index: 2;\n          user-select: none;\n        }\n        .react-resizable-handle {\n          position: absolute;\n          width: 20px;\n          height: 20px;\n        }\n        .react-resizable-handle::after {\n          content: \"\";\n          position: absolute;\n          right: 4px;\n          bottom: 4px;\n          width: 8px;\n          height: 8px;\n          border-right: 2px solid rgba(0, 0, 0, 0.3);\n          border-bottom: 2px solid rgba(0, 0, 0, 0.3);\n        }\n        .react-resizable-handle-sw {\n          bottom: 0;\n          left: 0;\n          cursor: sw-resize;\n          transform: rotate(90deg);\n        }\n        .react-resizable-handle-se {\n          bottom: 0;\n          right: 0;\n          cursor: se-resize;\n        }\n        .react-resizable-handle-nw {\n          top: 0;\n          left: 0;\n          cursor: nw-resize;\n          transform: rotate(180deg);\n        }\n        .react-resizable-handle-ne {\n          top: 0;\n          right: 0;\n          cursor: ne-resize;\n          transform: rotate(270deg);\n        }\n        .react-resizable-handle-w,\n        .react-resizable-handle-e {\n          top: 50%;\n          margin-top: -10px;\n          cursor: ew-resize;\n        }\n        .react-resizable-handle-w {\n          left: 0;\n          transform: rotate(135deg);\n        }\n        .react-resizable-handle-e {\n          right: 0;\n          transform: rotate(315deg);\n        }\n        .react-resizable-handle-n,\n        .react-resizable-handle-s {\n          left: 50%;\n          margin-left: -10px;\n          cursor: ns-resize;\n        }\n        .react-resizable-handle-n {\n          top: 0;\n          transform: rotate(225deg);\n        }\n        .react-resizable-handle-s {\n          bottom: 0;\n          transform: rotate(45deg);\n        }\n        .widget-container:hover .widget-drag-handle {\n          opacity: 1;\n        }\n      `}</style>\n    </div>\n  );\n}\n\nexport default DashboardGrid;\n",
        "timestamp": "2026-01-04T05:36:41.954466"
      },
      "worktree_state": null,
      "task_intent": {
        "title": "034-add-compliancewidget-to-analytics-dashboard",
        "description": "Create a ComplianceWidget component showing real-time compliance status, compliance rate trends, and policy violation summaries. Follows the established widget pattern with loading/error/empty states, severity coloring, and refresh functionality.",
        "from_plan": true
      },
      "commits_behind_main": 0,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2026-01-03T19:36:40.458257",
  "last_updated": "2026-01-04T05:36:41.966537"
}