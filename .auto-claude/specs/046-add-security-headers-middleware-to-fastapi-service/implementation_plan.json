{
  "spec_id": "046-add-security-headers-middleware-to-fastapi-service",
  "spec_title": "Add Security Headers Middleware to FastAPI Services",
  "feature": "Add Security Headers Middleware to FastAPI Services",
  "description": "Multiple FastAPI services (integration-service, compliance-docs, observability dashboard) lack security headers middleware. Missing headers include Content-Security-Policy, X-Content-Type-Options, X-Frame-Options, Strict-Transport-Security, X-XSS-Protection, and Referrer-Policy.",
  "created_at": "2026-01-03T21:27:51.559Z",
  "updated_at": "2026-01-04T00:08:36.133Z",
  "status": "done",
  "planStatus": "completed",
  "workflow_type": "development",
  "spec_file": "spec.md",
  "phases": [
    {
      "phase_id": "phase-1",
      "phase_name": "Setup and Core Middleware Implementation",
      "description": "Create reusable security headers middleware in the shared security module",
      "subtasks": [
        {
          "subtask_id": "1.1",
          "description": "Create security_headers.py module in src/core/shared/security/",
          "status": "completed",
          "dependencies": [],
          "acceptance_criteria": [
            "File created at src/core/shared/security/security_headers.py",
            "Module includes SecurityHeadersConfig dataclass for configuration",
            "Module includes SecurityHeadersMiddleware class",
            "Middleware implements all required headers: Content-Security-Policy, X-Content-Type-Options, X-Frame-Options, Strict-Transport-Security, X-XSS-Protection, Referrer-Policy",
            "Middleware supports configurable environments (development, staging, production)",
            "Includes proper type hints and docstrings",
            "Includes Constitutional Hash reference for governance compliance"
          ],
          "estimated_effort": "medium"
        },
        {
          "subtask_id": "1.2",
          "description": "Update src/core/shared/security/__init__.py to export security headers middleware",
          "status": "completed",
          "dependencies": [
            "1.1"
          ],
          "acceptance_criteria": [
            "Import SecurityHeadersMiddleware and SecurityHeadersConfig",
            "Add exports to __all__ list",
            "Verify imports work correctly"
          ],
          "estimated_effort": "small"
        },
        {
          "subtask_id": "1.3",
          "description": "Create comprehensive unit tests for security headers middleware",
          "status": "completed",
          "dependencies": [
            "1.1"
          ],
          "acceptance_criteria": [
            "Create test file at src/core/shared/security/tests/test_security_headers.py",
            "Test all security headers are present in responses",
            "Test environment-specific configurations (dev vs prod)",
            "Test custom CSP directives",
            "Test HSTS settings for different environments",
            "Test middleware integration with FastAPI",
            "All tests pass with >90% code coverage"
          ],
          "estimated_effort": "medium"
        }
      ]
    },
    {
      "phase_id": "phase-2",
      "phase_name": "Integration with Integration Service",
      "description": "Add security headers middleware to integration-service",
      "subtasks": [
        {
          "subtask_id": "2.1",
          "description": "Integrate security headers middleware into integration-service/src/main.py",
          "status": "completed",
          "dependencies": [
            "1.1",
            "1.2"
          ],
          "acceptance_criteria": [
            "Import SecurityHeadersMiddleware from shared security module",
            "Add middleware to FastAPI app after CORS middleware",
            "Configure appropriate CSP for integration service (allows webhooks, external integrations)",
            "Set environment-aware HSTS settings",
            "Service starts without errors",
            "All existing endpoints continue to work"
          ],
          "estimated_effort": "small"
        },
        {
          "subtask_id": "2.2",
          "description": "Add integration tests for integration-service security headers",
          "status": "completed",
          "dependencies": [
            "2.1"
          ],
          "acceptance_criteria": [
            "Create or update integration-service/tests/test_security_headers.py",
            "Test GET /health endpoint returns all security headers",
            "Test GET / root endpoint returns all security headers",
            "Test POST endpoints return security headers",
            "Verify CSP header allows necessary third-party connections",
            "All tests pass"
          ],
          "estimated_effort": "small"
        }
      ]
    },
    {
      "phase_id": "phase-3",
      "phase_name": "Integration with Compliance Docs Service",
      "description": "Add security headers middleware to compliance-docs service",
      "subtasks": [
        {
          "subtask_id": "3.1",
          "description": "Integrate security headers middleware into src/core/services/compliance_docs/src/main.py",
          "status": "completed",
          "dependencies": [
            "1.1",
            "1.2"
          ],
          "acceptance_criteria": [
            "Import SecurityHeadersMiddleware from shared security module",
            "Add middleware to FastAPI app after CORS middleware",
            "Configure strict CSP appropriate for documentation service",
            "Set production-grade HSTS settings",
            "Service starts without errors",
            "All existing endpoints continue to work"
          ],
          "estimated_effort": "small"
        },
        {
          "subtask_id": "3.2",
          "description": "Add integration tests for compliance-docs service security headers",
          "status": "completed",
          "dependencies": [
            "3.1"
          ],
          "acceptance_criteria": [
            "Create or update src/core/services/compliance_docs/tests/test_security_headers.py",
            "Test GET /health endpoint returns all security headers",
            "Test GET /ready endpoint returns all security headers",
            "Test GET / root endpoint returns all security headers",
            "Test EU AI Act endpoints return security headers",
            "Verify strict CSP configuration",
            "All tests pass"
          ],
          "estimated_effort": "small"
        }
      ]
    },
    {
      "phase_id": "phase-4",
      "phase_name": "Integration with Observability Dashboard",
      "description": "Add security headers middleware to observability dashboard API",
      "subtasks": [
        {
          "subtask_id": "4.1",
          "description": "Integrate security headers middleware into acgs2-observability/monitoring/dashboard_api.py",
          "status": "completed",
          "dependencies": [
            "1.1",
            "1.2"
          ],
          "acceptance_criteria": [
            "Import SecurityHeadersMiddleware from shared security module (handle import path correctly)",
            "Add middleware to FastAPI app in create_dashboard_app() function after CORS middleware",
            "Configure CSP to allow WebSocket connections for /dashboard/ws endpoint",
            "Set appropriate security headers for dashboard UI",
            "Service starts without errors",
            "All existing endpoints including WebSocket continue to work"
          ],
          "estimated_effort": "medium"
        },
        {
          "subtask_id": "4.2",
          "description": "Add integration tests for observability dashboard security headers",
          "status": "completed",
          "dependencies": [
            "4.1"
          ],
          "acceptance_criteria": [
            "Create or update acgs2-observability/tests/monitoring/test_dashboard_security.py",
            "Test GET /health endpoint returns all security headers",
            "Test GET /dashboard/overview endpoint returns all security headers",
            "Test GET /dashboard/metrics endpoint returns all security headers",
            "Test WebSocket upgrade respects security requirements",
            "Verify CSP allows WebSocket connections",
            "All tests pass"
          ],
          "estimated_effort": "medium"
        }
      ]
    },
    {
      "phase_id": "phase-5",
      "phase_name": "Documentation and Verification",
      "description": "Document changes and verify complete implementation",
      "subtasks": [
        {
          "subtask_id": "5.1",
          "description": "Create comprehensive documentation for security headers implementation",
          "status": "completed",
          "dependencies": [
            "2.1",
            "3.1",
            "4.1"
          ],
          "acceptance_criteria": [
            "Document security headers configuration options",
            "Document how to customize CSP for different services",
            "Document environment-specific behavior",
            "Include examples of adding middleware to new services",
            "Document testing approach for security headers",
            "Include security header verification checklist"
          ],
          "estimated_effort": "small"
        },
        {
          "subtask_id": "5.2",
          "description": "Run end-to-end verification of all services",
          "status": "completed",
          "dependencies": [
            "2.2",
            "3.2",
            "4.2",
            "5.1"
          ],
          "acceptance_criteria": [
            "All unit tests pass (pytest)",
            "All integration tests pass",
            "Verify integration-service returns all 6 security headers on all endpoints",
            "Verify compliance-docs service returns all 6 security headers on all endpoints",
            "Verify observability dashboard returns all 6 security headers on all endpoints",
            "Manual curl/HTTP verification of headers on running services",
            "No breaking changes to existing functionality",
            "All services start and function correctly"
          ],
          "estimated_effort": "medium"
        },
        {
          "subtask_id": "5.3",
          "description": "Update build-progress.txt with completion summary",
          "status": "completed",
          "dependencies": [
            "5.2"
          ],
          "acceptance_criteria": [
            "Document all changes made",
            "List all files created and modified",
            "Summarize test results",
            "Note any configuration options or environment variables",
            "Include verification steps performed"
          ],
          "estimated_effort": "small"
        }
      ]
    }
  ],
  "services_involved": [
    "integration-service",
    "compliance-docs",
    "observability-dashboard"
  ],
  "qa_checklist": [
    "All unit tests pass with >90% coverage for security headers middleware",
    "All integration tests pass for all three services",
    "Security headers present on all HTTP responses for all three services",
    "Content-Security-Policy configured appropriately for each service type",
    "X-Content-Type-Options: nosniff present on all responses",
    "X-Frame-Options: DENY present on all responses",
    "Strict-Transport-Security configured with appropriate max-age",
    "X-XSS-Protection: 1; mode=block present on all responses",
    "Referrer-Policy: strict-origin-when-cross-origin present on all responses",
    "WebSocket connections work correctly with security headers",
    "CORS functionality not impacted by security headers",
    "No performance degradation from middleware",
    "Environment-specific configurations work correctly (dev vs prod)",
    "Documentation complete and accurate",
    "No breaking changes to existing APIs"
  ],
  "final_acceptance": [
    "Reusable SecurityHeadersMiddleware created in shared security module",
    "All three services (integration-service, compliance-docs, observability dashboard) have security headers middleware integrated",
    "All six required security headers implemented: Content-Security-Policy, X-Content-Type-Options, X-Frame-Options, Strict-Transport-Security, X-XSS-Protection, Referrer-Policy",
    "Comprehensive test coverage (unit + integration) for security headers",
    "All existing functionality continues to work without breaking changes",
    "Documentation complete for implementation and usage",
    "All tests pass successfully"
  ],
  "implementation_notes": [
    "The src/core/shared/security/__init__.py already mentions 'Security headers enforcement' but it's not implemented yet",
    "Need to handle import paths correctly for acgs2-observability which is outside src/core",
    "CSP needs to be tailored for each service: integration-service needs external API access, observability needs WebSocket support",
    "HSTS should have different settings for development (shorter max-age or disabled) vs production (longer max-age)",
    "Consider making headers configurable via environment variables for flexibility",
    "All services already have CORS middleware, security headers should be added after CORS",
    "Constitutional Hash (cdd01ef066bc6cf2) should be included in security module for governance compliance"
  ],
  "qa_iteration_history": [
    {
      "iteration": 1,
      "status": "error",
      "timestamp": "2026-01-03T23:33:27.081596+00:00",
      "issues": [
        {
          "title": "QA error",
          "description": "QA agent did not update implementation_plan.json"
        }
      ]
    },
    {
      "iteration": 2,
      "status": "error",
      "timestamp": "2026-01-03T23:38:25.329828+00:00",
      "issues": [
        {
          "title": "QA error",
          "description": "QA agent did not update implementation_plan.json"
        }
      ]
    },
    {
      "iteration": 3,
      "status": "approved",
      "timestamp": "2026-01-03T23:44:11.615794+00:00",
      "issues": [],
      "duration_seconds": 346.29
    }
  ],
  "qa_stats": {
    "total_iterations": 3,
    "last_iteration": 3,
    "last_status": "approved",
    "issues_by_type": {
      "unknown": 2
    }
  },
  "qa_signoff": {
    "status": "approved",
    "qa_session": 0,
    "issues_found": [
      {
        "description": "None"
      }
    ],
    "tests_passed": {},
    "timestamp": "2026-01-03T23:43:41.194204+00:00",
    "ready_for_qa_revalidation": false
  },
  "last_updated": "2026-01-03T23:43:41.194213+00:00",
  "recoveryNote": "Task recovered from stuck state at 2026-01-04T00:08:04.981Z"
}