openapi: 3.0.3
info:
  title: ACGS-2 API
  description: |
    ACGS-2 (Advanced Constitutional Governance System) API

    This API provides access to the ACGS-2 Enhanced Agent Bus and supporting services
    for constitutional AI governance and compliance validation.
  version: 1.0.0
  contact:
    name: ACGS Team
    email: contact@acgs2.org
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8080
    description: Development API Gateway
  - url: http://localhost:8000
    description: Agent Bus Direct
  - url: https://api.acgs2.org
    description: Production API

security:
  - bearerAuth: []

paths:
  /health:
    get:
      summary: Health Check
      description: Check the health status of the API Gateway
      tags:
        - Health
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
        '503':
          description: Service is unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /services:
    get:
      summary: List Services
      description: Get a list of all available services and their health status
      tags:
        - Services
      responses:
        '200':
          description: List of services
          content:
            application/json:
              schema:
                type: object
                additionalProperties:
                  type: object
                  properties:
                    url:
                      type: string
                      format: uri
                    status:
                      type: string
                      enum: [configured, running]
                    health:
                      type: string
                      enum: [healthy, unhealthy, unreachable]

  /messages:
    post:
      summary: Send Message
      description: Send a message to the Enhanced Agent Bus for processing
      tags:
        - Messages
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MessageRequest'
            examples:
              user_request:
                summary: User Request Message
                value:
                  content: "Please analyze this document for compliance"
                  message_type: user_request
                  priority: normal
                  sender: "user-123"
                  tenant_id: "tenant-456"
                  metadata:
                    document_id: "doc-789"
                    analysis_type: "compliance"
              system_alert:
                summary: System Alert Message
                value:
                  content: "Security alert: Unauthorized access detected"
                  message_type: system_alert
                  priority: high
                  sender: "security-monitor"
                  tenant_id: "system"
                  metadata:
                    alert_type: "security"
                    severity: "high"
                    source_ip: "192.168.1.100"
      responses:
        '200':
          description: Message accepted for processing
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          description: Invalid request data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /messages/{message_id}:
    get:
      summary: Get Message Status
      description: Get the processing status of a specific message
      tags:
        - Messages
      parameters:
        - name: message_id
          in: path
          required: true
          schema:
            type: string
          description: Unique identifier of the message
      responses:
        '200':
          description: Message status retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  message_id:
                    type: string
                  status:
                    type: string
                    enum: [pending, processing, completed, failed]
                  timestamp:
                    type: string
                    format: date-time
                  result:
                    type: object
                    description: Processing result (if completed)
        '404':
          description: Message not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /stats:
    get:
      summary: Get Statistics
      description: Get processing statistics and metrics
      tags:
        - Monitoring
      responses:
        '200':
          description: Statistics retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  total_messages:
                    type: integer
                    description: Total messages processed
                  active_connections:
                    type: integer
                    description: Currently active connections
                  uptime_seconds:
                    type: integer
                    description: Service uptime in seconds
                  average_response_time:
                    type: number
                    description: Average response time in milliseconds
                  error_rate:
                    type: number
                    description: Error rate percentage
        '503':
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /policies/validate:
    post:
      summary: Validate Policy
      description: Validate a policy against constitutional requirements
      tags:
        - Policies
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                policy_name:
                  type: string
                  description: Name of the policy
                rules:
                  type: array
                  items:
                    type: object
                    properties:
                      condition:
                        type: string
                        description: Policy condition in Rego syntax
                      action:
                        type: string
                        enum: [allow, deny]
                        description: Action to take
                metadata:
                  type: object
                  description: Additional policy metadata
              required:
                - policy_name
                - rules
            examples:
              data_retention_policy:
                summary: Data Retention Policy
                value:
                  policy_name: "data_retention_policy"
                  rules:
                    - condition: "data.age > 2555"  # 7 years in days
                      action: "allow"  # Allow deletion
                  metadata:
                    description: "Policy for data retention compliance"
                    category: "data_governance"
                    version: "1.0"
      responses:
        '200':
          description: Policy validation result
          content:
            application/json:
              schema:
                type: object
                properties:
                  valid:
                    type: boolean
                    description: Whether the policy is valid
                  policy_hash:
                    type: string
                    description: Constitutional hash of the validated policy
                  validation_timestamp:
                    type: string
                    format: date-time
                  violations:
                    type: array
                    items:
                      type: string
                    description: List of validation violations (if any)
                  recommendations:
                    type: array
                    items:
                      type: string
                    description: Suggested improvements
        '400':
          description: Invalid policy format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    MessageRequest:
      type: object
      properties:
        content:
          type: string
          description: The message content
          example: "Please analyze this document for compliance"
        message_type:
          type: string
          enum: [user_request, system_alert, policy_update, audit_event]
          description: Type of message
          default: user_request
        priority:
          type: string
          enum: [low, normal, high, critical]
          description: Message processing priority
          default: normal
        sender:
          type: string
          description: Identifier of the message sender
          example: "user-123"
        recipient:
          type: string
          description: Identifier of the message recipient (optional)
          nullable: true
        tenant_id:
          type: string
          description: Tenant identifier for multi-tenancy
          example: "tenant-456"
        metadata:
          type: object
          description: Additional metadata for the message
          additionalProperties: true
      required:
        - content
        - sender

    MessageResponse:
      type: object
      properties:
        message_id:
          type: string
          description: Unique identifier for the message
          example: "msg-123456"
        status:
          type: string
          enum: [accepted, rejected, error]
          description: Processing status
        timestamp:
          type: string
          format: date-time
          description: When the message was processed
        details:
          type: object
          description: Additional processing details
          additionalProperties: true

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, unhealthy]
          description: Overall health status
        service:
          type: string
          description: Service name
          example: "api-gateway"
        version:
          type: string
          description: Service version
          example: "1.0.0"
        timestamp:
          type: string
          format: date-time
          description: Health check timestamp

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: Error type or code
        message:
          type: string
          description: Human-readable error message
        details:
          type: object
          description: Additional error details
          additionalProperties: true
        timestamp:
          type: string
          format: date-time
          description: Error timestamp

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT token for authentication. Include in Authorization header as:
        `Authorization: Bearer <your-jwt-token>`

tags:
  - name: Health
    description: Health check and monitoring endpoints
  - name: Messages
    description: Message processing and management
  - name: Services
    description: Service discovery and status
  - name: Policies
    description: Policy validation and management
  - name: Monitoring
    description: System monitoring and statistics
